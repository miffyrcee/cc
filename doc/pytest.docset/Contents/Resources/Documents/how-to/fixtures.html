
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>How to use fixtures — pytest documentation</title>
<link href="../_static/pygments.css" rel="stylesheet" type="text/css"/>
<link href="../_static/basic.css" rel="stylesheet" type="text/css"/>
<link href="../_static/pygments_pytest.css" rel="stylesheet" type="text/css"/>
<script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
<script src="../_static/jquery.js"></script>
<script src="../_static/underscore.js"></script>
<script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
<script src="../_static/doctools.js"></script>
<script src="../_static/sphinx_highlight.js"></script>
<link href="../_static/favicon.png" rel="shortcut icon"/>
<link href="../search.html" rel="search" title="Search"/>
<link href="mark.html" rel="next" title="How to mark test functions with attributes"/>
<link href="assert.html" rel="prev" title="How to write and report assertions in tests"/>
<script>DOCUMENTATION_OPTIONS.URL_ROOT = '';</script>
</head><body>
<div aria-label="related navigation" class="related" role="navigation">
<h3>Navigation</h3>
<ul>
<li class="right" style="margin-right: 10px">
<a href="../py-modindex.html" title="Python Module Index">modules</a></li>
<li class="right">
<a accesskey="N" href="mark.html" title="How to mark test functions with attributes">next</a> |</li>
<li class="right">
<a accesskey="P" href="assert.html" title="How to write and report assertions in tests">previous</a> |</li>
<li class="nav-item nav-item-0"><a href="../contents.html">pytest-7.3</a> »</li>
<li class="nav-item nav-item-this"><a href="">How to use fixtures</a></li>
</ul>
</div>
<div class="document">
<div class="documentwrapper">
<div class="body" role="main">
<section id="how-to-use-fixtures">
<a class="dashAnchor" name="//apple_ref/cpp/Section/How to use fixtures"></a><span id="how-to-fixtures"></span><h1>How to use fixtures<a class="headerlink" href="#how-to-use-fixtures" title="Permalink to this heading">¶</a></h1>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../explanation/fixtures.html#about-fixtures"><span class="std std-ref">About fixtures</span></a></p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../reference/fixtures.html#reference-fixtures"><span class="std std-ref">Fixtures reference</span></a></p>
</div>
<section id="requesting-fixtures">
<h2>“Requesting” fixtures<a class="headerlink" href="#requesting-fixtures" title="Permalink to this heading">¶</a></h2>
<p>At a basic level, test functions request fixtures they require by declaring
them as arguments.</p>
<p>When pytest goes to run a test, it looks at the parameters in that test
function’s signature, and then searches for fixtures that have the same names as
those parameters. Once pytest finds them, it runs those fixtures, captures what
they returned (if anything), and passes those objects into the test function as
arguments.</p>
<section id="quick-example">
<h3>Quick example<a class="headerlink" href="#quick-example" title="Permalink to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytest</span>


<span class="k">class</span> <span class="nc">Fruit</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cubed</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">cube</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cubed</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">class</span> <span class="nc">FruitSalad</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">fruit_bowl</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fruit</span> <span class="o">=</span> <span class="n">fruit_bowl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cube_fruit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_cube_fruit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">fruit</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fruit</span><span class="p">:</span>
            <span class="n">fruit</span><span class="o">.</span><span class="n">cube</span><span class="p">()</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">fruit_bowl</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">Fruit</span><span class="p">(</span><span class="s2">"apple"</span><span class="p">),</span> <span class="n">Fruit</span><span class="p">(</span><span class="s2">"banana"</span><span class="p">)]</span>


<span class="k">def</span> <span class="nf">test_fruit_salad</span><span class="p">(</span><span class="n">fruit_bowl</span><span class="p">):</span>
    <span class="c1"># Act</span>
    <span class="n">fruit_salad</span> <span class="o">=</span> <span class="n">FruitSalad</span><span class="p">(</span><span class="o">*</span><span class="n">fruit_bowl</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">fruit</span><span class="o">.</span><span class="n">cubed</span> <span class="k">for</span> <span class="n">fruit</span> <span class="ow">in</span> <span class="n">fruit_salad</span><span class="o">.</span><span class="n">fruit</span><span class="p">)</span>
</pre></div>
</div>
<p>In this example, <code class="docutils literal notranslate"><span class="pre">test_fruit_salad</span></code> “<strong>requests</strong>” <code class="docutils literal notranslate"><span class="pre">fruit_bowl</span></code> (i.e.
<code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">test_fruit_salad(fruit_bowl):</span></code>), and when pytest sees this, it will
execute the <code class="docutils literal notranslate"><span class="pre">fruit_bowl</span></code> fixture function and pass the object it returns into
<code class="docutils literal notranslate"><span class="pre">test_fruit_salad</span></code> as the <code class="docutils literal notranslate"><span class="pre">fruit_bowl</span></code> argument.</p>
<p>Here’s roughly
what’s happening if we were to do it by hand:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fruit_bowl</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">Fruit</span><span class="p">(</span><span class="s2">"apple"</span><span class="p">),</span> <span class="n">Fruit</span><span class="p">(</span><span class="s2">"banana"</span><span class="p">)]</span>


<span class="k">def</span> <span class="nf">test_fruit_salad</span><span class="p">(</span><span class="n">fruit_bowl</span><span class="p">):</span>
    <span class="c1"># Act</span>
    <span class="n">fruit_salad</span> <span class="o">=</span> <span class="n">FruitSalad</span><span class="p">(</span><span class="o">*</span><span class="n">fruit_bowl</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">fruit</span><span class="o">.</span><span class="n">cubed</span> <span class="k">for</span> <span class="n">fruit</span> <span class="ow">in</span> <span class="n">fruit_salad</span><span class="o">.</span><span class="n">fruit</span><span class="p">)</span>


<span class="c1"># Arrange</span>
<span class="n">bowl</span> <span class="o">=</span> <span class="n">fruit_bowl</span><span class="p">()</span>
<span class="n">test_fruit_salad</span><span class="p">(</span><span class="n">fruit_bowl</span><span class="o">=</span><span class="n">bowl</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="fixtures-can-request-other-fixtures">
<h3>Fixtures can <strong>request</strong> other fixtures<a class="headerlink" href="#fixtures-can-request-other-fixtures" title="Permalink to this heading">¶</a></h3>
<p>One of pytest’s greatest strengths is its extremely flexible fixture system. It
allows us to boil down complex requirements for tests into more simple and
organized functions, where we only need to have each one describe the things
they are dependent on. We’ll get more into this further down, but for now,
here’s a quick example to demonstrate how fixtures can use other fixtures:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of test_append.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">first_entry</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">"a"</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="n">first_entry</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">first_entry</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_string</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="c1"># Act</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"b"</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">"a"</span><span class="p">,</span> <span class="s2">"b"</span><span class="p">]</span>
</pre></div>
</div>
<p>Notice that this is the same example from above, but very little changed. The
fixtures in pytest <strong>request</strong> fixtures just like tests. All the same
<strong>requesting</strong> rules apply to fixtures that do for tests. Here’s how this
example would work if we did it by hand:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">first_entry</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">"a"</span>


<span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="n">first_entry</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">first_entry</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_string</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="c1"># Act</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"b"</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">"a"</span><span class="p">,</span> <span class="s2">"b"</span><span class="p">]</span>


<span class="n">entry</span> <span class="o">=</span> <span class="n">first_entry</span><span class="p">()</span>
<span class="n">the_list</span> <span class="o">=</span> <span class="n">order</span><span class="p">(</span><span class="n">first_entry</span><span class="o">=</span><span class="n">entry</span><span class="p">)</span>
<span class="n">test_string</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">the_list</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="fixtures-are-reusable">
<h3>Fixtures are reusable<a class="headerlink" href="#fixtures-are-reusable" title="Permalink to this heading">¶</a></h3>
<p>One of the things that makes pytest’s fixture system so powerful, is that it
gives us the ability to define a generic setup step that can be reused over and
over, just like a normal function would be used. Two different tests can request
the same fixture and have pytest give each test their own result from that
fixture.</p>
<p>This is extremely useful for making sure tests aren’t affected by each other. We
can use this system to make sure each test gets its own fresh batch of data and
is starting from a clean state so it can provide consistent, repeatable results.</p>
<p>Here’s an example of how this can come in handy:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of test_append.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">first_entry</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">"a"</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="n">first_entry</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">first_entry</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_string</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="c1"># Act</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"b"</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">"a"</span><span class="p">,</span> <span class="s2">"b"</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_int</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="c1"># Act</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">"a"</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
<p>Each test here is being given its own copy of that <code class="docutils literal notranslate"><span class="pre">list</span></code> object,
which means the <code class="docutils literal notranslate"><span class="pre">order</span></code> fixture is getting executed twice (the same
is true for the <code class="docutils literal notranslate"><span class="pre">first_entry</span></code> fixture). If we were to do this by hand as
well, it would look something like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">first_entry</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">"a"</span>


<span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="n">first_entry</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">first_entry</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_string</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="c1"># Act</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"b"</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">"a"</span><span class="p">,</span> <span class="s2">"b"</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_int</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
    <span class="c1"># Act</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="s2">"a"</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>


<span class="n">entry</span> <span class="o">=</span> <span class="n">first_entry</span><span class="p">()</span>
<span class="n">the_list</span> <span class="o">=</span> <span class="n">order</span><span class="p">(</span><span class="n">first_entry</span><span class="o">=</span><span class="n">entry</span><span class="p">)</span>
<span class="n">test_string</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">the_list</span><span class="p">)</span>

<span class="n">entry</span> <span class="o">=</span> <span class="n">first_entry</span><span class="p">()</span>
<span class="n">the_list</span> <span class="o">=</span> <span class="n">order</span><span class="p">(</span><span class="n">first_entry</span><span class="o">=</span><span class="n">entry</span><span class="p">)</span>
<span class="n">test_int</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">the_list</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="a-test-fixture-can-request-more-than-one-fixture-at-a-time">
<h3>A test/fixture can <strong>request</strong> more than one fixture at a time<a class="headerlink" href="#a-test-fixture-can-request-more-than-one-fixture-at-a-time" title="Permalink to this heading">¶</a></h3>
<p>Tests and fixtures aren’t limited to <strong>requesting</strong> a single fixture at a time.
They can request as many as they like. Here’s another quick example to
demonstrate:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of test_append.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">first_entry</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">"a"</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">second_entry</span><span class="p">():</span>
    <span class="k">return</span> <span class="mi">2</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="n">first_entry</span><span class="p">,</span> <span class="n">second_entry</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">first_entry</span><span class="p">,</span> <span class="n">second_entry</span><span class="p">]</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">expected_list</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span><span class="s2">"a"</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_string</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">expected_list</span><span class="p">):</span>
    <span class="c1"># Act</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">3.0</span><span class="p">)</span>

    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="n">expected_list</span>
</pre></div>
</div>
</section>
<section id="fixtures-can-be-requested-more-than-once-per-test-return-values-are-cached">
<h3>Fixtures can be <strong>requested</strong> more than once per test (return values are cached)<a class="headerlink" href="#fixtures-can-be-requested-more-than-once-per-test-return-values-are-cached" title="Permalink to this heading">¶</a></h3>
<p>Fixtures can also be <strong>requested</strong> more than once during the same test, and
pytest won’t execute them again for that test. This means we can <strong>request</strong>
fixtures in multiple fixtures that are dependent on them (and even again in the
test itself) without those fixtures being executed more than once.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of test_append.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">first_entry</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">"a"</span>


<span class="c1"># Arrange</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">order</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[]</span>


<span class="c1"># Act</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">append_first</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">first_entry</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">first_entry</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_string_only</span><span class="p">(</span><span class="n">append_first</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">first_entry</span><span class="p">):</span>
    <span class="c1"># Assert</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="n">first_entry</span><span class="p">]</span>
</pre></div>
</div>
<p>If a <strong>requested</strong> fixture was executed once for every time it was <strong>requested</strong>
during a test, then this test would fail because both <code class="docutils literal notranslate"><span class="pre">append_first</span></code> and
<code class="docutils literal notranslate"><span class="pre">test_string_only</span></code> would see <code class="docutils literal notranslate"><span class="pre">order</span></code> as an empty list (i.e. <code class="docutils literal notranslate"><span class="pre">[]</span></code>), but
since the return value of <code class="docutils literal notranslate"><span class="pre">order</span></code> was cached (along with any side effects
executing it may have had) after the first time it was called, both the test and
<code class="docutils literal notranslate"><span class="pre">append_first</span></code> were referencing the same object, and the test saw the effect
<code class="docutils literal notranslate"><span class="pre">append_first</span></code> had on that object.</p>
</section>
</section>
<section id="autouse-fixtures-fixtures-you-don-t-have-to-request">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Autouse fixtures (fixtures you don’t have to request)"></a><span id="autouse-fixtures"></span><a class="dashAnchor" name="//apple_ref/cpp/Section/Autouse fixtures (fixtures you don’t have to request)"></a><span id="autouse"></span><h2>Autouse fixtures (fixtures you don’t have to request)<a class="headerlink" href="#autouse-fixtures-fixtures-you-don-t-have-to-request" title="Permalink to this heading">¶</a></h2>
<p>Sometimes you may want to have a fixture (or even several) that you know all
your tests will depend on. “Autouse” fixtures are a convenient way to make all
tests automatically <strong>request</strong> them. This can cut out a
lot of redundant <strong>requests</strong>, and can even provide more advanced fixture usage
(more on that further down).</p>
<p>We can make a fixture an autouse fixture by passing in <code class="docutils literal notranslate"><span class="pre">autouse=True</span></code> to the
fixture’s decorator. Here’s a simple example for how they can be used:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of test_append.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">first_entry</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">"a"</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="n">first_entry</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[]</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">append_first</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">first_entry</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">first_entry</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_string_only</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">first_entry</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="n">first_entry</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">test_string_and_int</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">first_entry</span><span class="p">):</span>
    <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">order</span> <span class="o">==</span> <span class="p">[</span><span class="n">first_entry</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
<p>In this example, the <code class="docutils literal notranslate"><span class="pre">append_first</span></code> fixture is an autouse fixture. Because it
happens automatically, both tests are affected by it, even though neither test
<strong>requested</strong> it. That doesn’t mean they <em>can’t</em> be <strong>requested</strong> though; just
that it isn’t <em>necessary</em>.</p>
</section>
<section id="scope-sharing-fixtures-across-classes-modules-packages-or-session">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Scope: sharing fixtures across classes, modules, packages or session"></a><span id="smtpshared"></span><h2>Scope: sharing fixtures across classes, modules, packages or session<a class="headerlink" href="#scope-sharing-fixtures-across-classes-modules-packages-or-session" title="Permalink to this heading">¶</a></h2>
<p>Fixtures requiring network access depend on connectivity and are
usually time-expensive to create.  Extending the previous example, we
can add a <code class="docutils literal notranslate"><span class="pre">scope="module"</span></code> parameter to the
<a class="reference internal" href="../reference/reference.html#pytest.fixture" title="pytest.fixture"><code class="xref py py-func docutils literal notranslate"><span class="pre">@pytest.fixture</span></code></a> invocation
to cause a <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> fixture function, responsible to create a connection to a preexisting SMTP server, to only be invoked
once per test <em>module</em> (the default is to invoke once per test <em>function</em>).
Multiple test functions in a test module will thus
each receive the same <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> fixture instance, thus saving time.
Possible values for <code class="docutils literal notranslate"><span class="pre">scope</span></code> are: <code class="docutils literal notranslate"><span class="pre">function</span></code>, <code class="docutils literal notranslate"><span class="pre">class</span></code>, <code class="docutils literal notranslate"><span class="pre">module</span></code>, <code class="docutils literal notranslate"><span class="pre">package</span></code> or <code class="docutils literal notranslate"><span class="pre">session</span></code>.</p>
<p>The next example puts the fixture function into a separate <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> file
so that tests from multiple test modules in the directory can
access the fixture function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of conftest.py</span>
<span class="kn">import</span> <span class="nn">smtplib</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">"module"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">smtp_connection</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP</span><span class="p">(</span><span class="s2">"smtp.gmail.com"</span><span class="p">,</span> <span class="mi">587</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_module.py</span>


<span class="k">def</span> <span class="nf">test_ehlo</span><span class="p">(</span><span class="n">smtp_connection</span><span class="p">):</span>
    <span class="n">response</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">smtp_connection</span><span class="o">.</span><span class="n">ehlo</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">response</span> <span class="o">==</span> <span class="mi">250</span>
    <span class="k">assert</span> <span class="sa">b</span><span class="s2">"smtp.gmail.com"</span> <span class="ow">in</span> <span class="n">msg</span>
    <span class="k">assert</span> <span class="mi">0</span>  <span class="c1"># for demo purposes</span>


<span class="k">def</span> <span class="nf">test_noop</span><span class="p">(</span><span class="n">smtp_connection</span><span class="p">):</span>
    <span class="n">response</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">smtp_connection</span><span class="o">.</span><span class="n">noop</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">response</span> <span class="o">==</span> <span class="mi">250</span>
    <span class="k">assert</span> <span class="mi">0</span>  <span class="c1"># for demo purposes</span>
</pre></div>
</div>
<p>Here, the <code class="docutils literal notranslate"><span class="pre">test_ehlo</span></code> needs the <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> fixture value.  pytest
will discover and call the <a class="reference internal" href="../reference/reference.html#pytest.fixture" title="pytest.fixture"><code class="xref py py-func docutils literal notranslate"><span class="pre">@pytest.fixture</span></code></a>
marked <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> fixture function.  Running the test looks like this:</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest test_module.py
<span class="-Color -Color-Bold">=========================== test session starts ============================</span>
platform linux -- Python 3.x.y, pytest-7.x.y, pluggy-1.x.y
rootdir: /home/sweet/project
collected 2 items

test_module.py <span class="-Color -Color-Red">FF</span>                                                    <span class="-Color -Color-Red">[100%]</span>

================================= FAILURES =================================
<span class="-Color -Color-Bold -Color-Bold-Red">________________________________ test_ehlo _________________________________</span>

smtp_connection = &lt;smtplib.SMTP object at 0xdeadbeef0001&gt;

    def test_ehlo(smtp_connection):
        response, msg = smtp_connection.ehlo()
        assert response == 250
        assert b"smtp.gmail.com" in msg
&gt;       assert 0  # for demo purposes
<span class="-Color -Color-Bold -Color-Bold-Red">E       assert 0</span>

<span class="-Color -Color-Bold -Color-Bold-Red">test_module.py</span>:7: AssertionError
<span class="-Color -Color-Bold -Color-Bold-Red">________________________________ test_noop _________________________________</span>

smtp_connection = &lt;smtplib.SMTP object at 0xdeadbeef0001&gt;

    def test_noop(smtp_connection):
        response, msg = smtp_connection.noop()
        assert response == 250
&gt;       assert 0  # for demo purposes
<span class="-Color -Color-Bold -Color-Bold-Red">E       assert 0</span>

<span class="-Color -Color-Bold -Color-Bold-Red">test_module.py</span>:13: AssertionError
<span class="-Color -Color-Bold -Color-Bold-Cyan">========================= short test summary info ==========================</span>
<span class="-Color -Color-Red">FAILED</span> test_module.py::<span class="-Color -Color-Bold">test_ehlo</span> - assert 0
<span class="-Color -Color-Red">FAILED</span> test_module.py::<span class="-Color -Color-Bold">test_noop</span> - assert 0
<span class="-Color -Color-Red">============================ </span><span class="-Color -Color-Bold -Color-Bold-Red">2 failed</span><span class="-Color -Color-Red"> in 0.12s =============================</span>
</pre></div>
</div>
<p>You see the two <code class="docutils literal notranslate"><span class="pre">assert</span> <span class="pre">0</span></code> failing and more importantly you can also see
that the <strong>exactly same</strong> <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> object was passed into the
two test functions because pytest shows the incoming argument values in the
traceback.  As a result, the two test functions using <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> run
as quick as a single one because they reuse the same instance.</p>
<p>If you decide that you rather want to have a session-scoped <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code>
instance, you can simply declare it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">"session"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">smtp_connection</span><span class="p">():</span>
    <span class="c1"># the returned fixture value will be shared for</span>
    <span class="c1"># all tests requesting it</span>
    <span class="o">...</span>
</pre></div>
</div>
<section id="fixture-scopes">
<h3>Fixture scopes<a class="headerlink" href="#fixture-scopes" title="Permalink to this heading">¶</a></h3>
<p>Fixtures are created when first requested by a test, and are destroyed based on their <code class="docutils literal notranslate"><span class="pre">scope</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">function</span></code>: the default scope, the fixture is destroyed at the end of the test.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">class</span></code>: the fixture is destroyed during teardown of the last test in the class.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">module</span></code>: the fixture is destroyed during teardown of the last test in the module.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">package</span></code>: the fixture is destroyed during teardown of the last test in the package.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">session</span></code>: the fixture is destroyed at the end of the test session.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Pytest only caches one instance of a fixture at a time, which
means that when using a parametrized fixture, pytest may invoke a fixture more than once in
the given scope.</p>
</div>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Dynamic scope"></a><section id="dynamic-scope">
<span id="id1"></span><h3>Dynamic scope<a class="headerlink" href="#dynamic-scope" title="Permalink to this heading">¶</a></h3>
<div class="versionadded">
<p><span class="versionmodified added">New in version 5.2.</span></p>
</div>
<p>In some cases, you might want to change the scope of the fixture without changing the code.
To do that, pass a callable to <code class="docutils literal notranslate"><span class="pre">scope</span></code>. The callable must return a string with a valid scope
and will be executed only once - during the fixture definition. It will be called with two
keyword arguments - <code class="docutils literal notranslate"><span class="pre">fixture_name</span></code> as a string and <code class="docutils literal notranslate"><span class="pre">config</span></code> with a configuration object.</p>
<p>This can be especially useful when dealing with fixtures that need time for setup, like spawning
a docker container. You can use the command-line argument to control the scope of the spawned
containers for different environments. See the example below.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">determine_scope</span><span class="p">(</span><span class="n">fixture_name</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">"--keep-containers"</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">"session"</span>
    <span class="k">return</span> <span class="s2">"function"</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="n">determine_scope</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">docker_container</span><span class="p">():</span>
    <span class="k">yield</span> <span class="n">spawn_container</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<section id="teardown-cleanup-aka-fixture-finalization">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Teardown/Cleanup (AKA Fixture finalization)"></a><span id="finalization"></span><h2>Teardown/Cleanup (AKA Fixture finalization)<a class="headerlink" href="#teardown-cleanup-aka-fixture-finalization" title="Permalink to this heading">¶</a></h2>
<p>When we run our tests, we’ll want to make sure they clean up after themselves so
they don’t mess with any other tests (and also so that we don’t leave behind a
mountain of test data to bloat the system). Fixtures in pytest offer a very
useful teardown system, which allows us to define the specific steps necessary
for each fixture to clean up after itself.</p>
<p>This system can be leveraged in two ways.</p>
<section id="yield-fixtures-recommended">
<a class="dashAnchor" name="//apple_ref/cpp/Section/1. yield fixtures (recommended)"></a><span id="yield-fixtures"></span><h3>1. <code class="docutils literal notranslate"><span class="pre">yield</span></code> fixtures (recommended)<a class="headerlink" href="#yield-fixtures-recommended" title="Permalink to this heading">¶</a></h3>
<p>“Yield” fixtures <code class="docutils literal notranslate"><span class="pre">yield</span></code> instead of <code class="docutils literal notranslate"><span class="pre">return</span></code>. With these
fixtures, we can run some code and pass an object back to the requesting
fixture/test, just like with the other fixtures. The only differences are:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">return</span></code> is swapped out for <code class="docutils literal notranslate"><span class="pre">yield</span></code>.</p></li>
<li><p>Any teardown code for that fixture is placed <em>after</em> the <code class="docutils literal notranslate"><span class="pre">yield</span></code>.</p></li>
</ol>
<p>Once pytest figures out a linear order for the fixtures, it will run each one up
until it returns or yields, and then move on to the next fixture in the list to
do the same thing.</p>
<p>Once the test is finished, pytest will go back down the list of fixtures, but in
the <em>reverse order</em>, taking each one that yielded, and running the code inside
it that was <em>after</em> the <code class="docutils literal notranslate"><span class="pre">yield</span></code> statement.</p>
<p>As a simple example, consider this basic email module:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of emaillib.py</span>
<span class="k">class</span> <span class="nc">MailAdminClient</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">MailUser</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">delete_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="c1"># do some cleanup</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">MailUser</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inbox</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">send_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">other</span><span class="o">.</span><span class="n">inbox</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear_mailbox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inbox</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">Email</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subject</span> <span class="o">=</span> <span class="n">subject</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>
</pre></div>
</div>
<p>Let’s say we want to test sending email from one user to another. We’ll have to
first make each user, then send the email from one user to the other, and
finally assert that the other user received that message in their inbox. If we
want to clean up after the test runs, we’ll likely have to make sure the other
user’s mailbox is emptied before deleting that user, otherwise the system may
complain.</p>
<p>Here’s what that might look like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_emaillib.py</span>
<span class="kn">from</span> <span class="nn">emaillib</span> <span class="kn">import</span> <span class="n">Email</span><span class="p">,</span> <span class="n">MailAdminClient</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">mail_admin</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">MailAdminClient</span><span class="p">()</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">sending_user</span><span class="p">(</span><span class="n">mail_admin</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">mail_admin</span><span class="o">.</span><span class="n">create_user</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">user</span>
    <span class="n">mail_admin</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">receiving_user</span><span class="p">(</span><span class="n">mail_admin</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">mail_admin</span><span class="o">.</span><span class="n">create_user</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">user</span>
    <span class="n">user</span><span class="o">.</span><span class="n">clear_mailbox</span><span class="p">()</span>
    <span class="n">mail_admin</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_email_received</span><span class="p">(</span><span class="n">sending_user</span><span class="p">,</span> <span class="n">receiving_user</span><span class="p">):</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="s2">"Hey!"</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="s2">"How's it going?"</span><span class="p">)</span>
    <span class="n">sending_user</span><span class="o">.</span><span class="n">send_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">receiving_user</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">email</span> <span class="ow">in</span> <span class="n">receiving_user</span><span class="o">.</span><span class="n">inbox</span>
</pre></div>
</div>
<p>Because <code class="docutils literal notranslate"><span class="pre">receiving_user</span></code> is the last fixture to run during setup, it’s the first to run
during teardown.</p>
<p>There is a risk that even having the order right on the teardown side of things
doesn’t guarantee a safe cleanup. That’s covered in a bit more detail in
<a class="reference internal" href="#safe-teardowns"><span class="std std-ref">Safe teardowns</span></a>.</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -q test_emaillib.py
<span class="-Color -Color-Green">.</span>                                                                    <span class="-Color -Color-Green">[100%]</span>
<span class="-Color -Color-Bold -Color-Bold-Green">1 passed</span><span class="-Color -Color-Green"> in 0.12s</span>
</pre></div>
</div>
<section id="handling-errors-for-yield-fixture">
<h4>Handling errors for yield fixture<a class="headerlink" href="#handling-errors-for-yield-fixture" title="Permalink to this heading">¶</a></h4>
<p>If a yield fixture raises an exception before yielding, pytest won’t try to run
the teardown code after that yield fixture’s <code class="docutils literal notranslate"><span class="pre">yield</span></code> statement. But, for every
fixture that has already run successfully for that test, pytest will still
attempt to tear them down as it normally would.</p>
</section>
</section>
<section id="adding-finalizers-directly">
<h3>2. Adding finalizers directly<a class="headerlink" href="#adding-finalizers-directly" title="Permalink to this heading">¶</a></h3>
<p>While yield fixtures are considered to be the cleaner and more straightforward
option, there is another choice, and that is to add “finalizer” functions
directly to the test’s <a class="reference internal" href="#request-context">request-context</a> object. It brings a similar result as
yield fixtures, but requires a bit more verbosity.</p>
<p>In order to use this approach, we have to request the <a class="reference internal" href="#request-context">request-context</a> object
(just like we would request another fixture) in the fixture we need to add
teardown code for, and then pass a callable, containing that teardown code, to
its <code class="docutils literal notranslate"><span class="pre">addfinalizer</span></code> method.</p>
<p>We have to be careful though, because pytest will run that finalizer once it’s
been added, even if that fixture raises an exception after adding the finalizer.
So to make sure we don’t run the finalizer code when we wouldn’t need to, we
would only add the finalizer once the fixture would have done something that
we’d need to teardown.</p>
<p>Here’s how the previous example would look using the <code class="docutils literal notranslate"><span class="pre">addfinalizer</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_emaillib.py</span>
<span class="kn">from</span> <span class="nn">emaillib</span> <span class="kn">import</span> <span class="n">Email</span><span class="p">,</span> <span class="n">MailAdminClient</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">mail_admin</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">MailAdminClient</span><span class="p">()</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">sending_user</span><span class="p">(</span><span class="n">mail_admin</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">mail_admin</span><span class="o">.</span><span class="n">create_user</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">user</span>
    <span class="n">mail_admin</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">receiving_user</span><span class="p">(</span><span class="n">mail_admin</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">mail_admin</span><span class="o">.</span><span class="n">create_user</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">delete_user</span><span class="p">():</span>
        <span class="n">mail_admin</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

    <span class="n">request</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="n">delete_user</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">user</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">email</span><span class="p">(</span><span class="n">sending_user</span><span class="p">,</span> <span class="n">receiving_user</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="n">_email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="s2">"Hey!"</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="s2">"How's it going?"</span><span class="p">)</span>
    <span class="n">sending_user</span><span class="o">.</span><span class="n">send_email</span><span class="p">(</span><span class="n">_email</span><span class="p">,</span> <span class="n">receiving_user</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">empty_mailbox</span><span class="p">():</span>
        <span class="n">receiving_user</span><span class="o">.</span><span class="n">clear_mailbox</span><span class="p">()</span>

    <span class="n">request</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="n">empty_mailbox</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_email</span>


<span class="k">def</span> <span class="nf">test_email_received</span><span class="p">(</span><span class="n">receiving_user</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">email</span> <span class="ow">in</span> <span class="n">receiving_user</span><span class="o">.</span><span class="n">inbox</span>
</pre></div>
</div>
<p>It’s a bit longer than yield fixtures and a bit more complex, but it
does offer some nuances for when you’re in a pinch.</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -q test_emaillib.py
<span class="-Color -Color-Green">.</span>                                                                    <span class="-Color -Color-Green">[100%]</span>
<span class="-Color -Color-Bold -Color-Bold-Green">1 passed</span><span class="-Color -Color-Green"> in 0.12s</span>
</pre></div>
</div>
<section id="note-on-finalizer-order">
<h4>Note on finalizer order<a class="headerlink" href="#note-on-finalizer-order" title="Permalink to this heading">¶</a></h4>
<p>Finalizers are executed in a first-in-last-out order.
For yield fixtures, the first teardown code to run is from the right-most fixture, i.e. the last test parameter.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_finalizers.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="k">def</span> <span class="nf">test_bar</span><span class="p">(</span><span class="n">fix_w_yield1</span><span class="p">,</span> <span class="n">fix_w_yield2</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"test_bar"</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">fix_w_yield1</span><span class="p">():</span>
    <span class="k">yield</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"after_yield_1"</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">fix_w_yield2</span><span class="p">():</span>
    <span class="k">yield</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"after_yield_2"</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -s test_finalizers.py
<span class="-Color -Color-Bold">=========================== test session starts ============================</span>
platform linux -- Python 3.x.y, pytest-7.x.y, pluggy-1.x.y
rootdir: /home/sweet/project
collected 1 item

test_finalizers.py test_bar
.after_yield_2
after_yield_1


<span class="-Color -Color-Green">============================ </span><span class="-Color -Color-Bold -Color-Bold-Green">1 passed</span><span class="-Color -Color-Green"> in 0.12s =============================</span>
</pre></div>
</div>
<p>For finalizers, the first fixture to run is last call to <code class="docutils literal notranslate"><span class="pre">request.addfinalizer</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_finalizers.py</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">fix_w_finalizers</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="nb">print</span><span class="p">,</span> <span class="s2">"finalizer_2"</span><span class="p">))</span>
    <span class="n">request</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="nb">print</span><span class="p">,</span> <span class="s2">"finalizer_1"</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">test_bar</span><span class="p">(</span><span class="n">fix_w_finalizers</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"test_bar"</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -s test_finalizers.py
<span class="-Color -Color-Bold">=========================== test session starts ============================</span>
platform linux -- Python 3.x.y, pytest-7.x.y, pluggy-1.x.y
rootdir: /home/sweet/project
collected 1 item

test_finalizers.py test_bar
.finalizer_1
finalizer_2


<span class="-Color -Color-Green">============================ </span><span class="-Color -Color-Bold -Color-Bold-Green">1 passed</span><span class="-Color -Color-Green"> in 0.12s =============================</span>
</pre></div>
</div>
<p>This is so because yield fixtures use <code class="docutils literal notranslate"><span class="pre">addfinalizer</span></code> behind the scenes: when the fixture executes, <code class="docutils literal notranslate"><span class="pre">addfinalizer</span></code> registers a function that resumes the generator, which in turn calls the teardown code.</p>
</section>
</section>
</section>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Safe teardowns"></a><section id="safe-teardowns">
<span id="id2"></span><h2>Safe teardowns<a class="headerlink" href="#safe-teardowns" title="Permalink to this heading">¶</a></h2>
<p>The fixture system of pytest is <em>very</em> powerful, but it’s still being run by a
computer, so it isn’t able to figure out how to safely teardown everything we
throw at it. If we aren’t careful, an error in the wrong spot might leave stuff
from our tests behind, and that can cause further issues pretty quickly.</p>
<p>For example, consider the following tests (based off of the mail example from
above):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_emaillib.py</span>
<span class="kn">from</span> <span class="nn">emaillib</span> <span class="kn">import</span> <span class="n">Email</span><span class="p">,</span> <span class="n">MailAdminClient</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">setup</span><span class="p">():</span>
    <span class="n">mail_admin</span> <span class="o">=</span> <span class="n">MailAdminClient</span><span class="p">()</span>
    <span class="n">sending_user</span> <span class="o">=</span> <span class="n">mail_admin</span><span class="o">.</span><span class="n">create_user</span><span class="p">()</span>
    <span class="n">receiving_user</span> <span class="o">=</span> <span class="n">mail_admin</span><span class="o">.</span><span class="n">create_user</span><span class="p">()</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="s2">"Hey!"</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="s2">"How's it going?"</span><span class="p">)</span>
    <span class="n">sending_user</span><span class="o">.</span><span class="n">send_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">receiving_user</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">receiving_user</span><span class="p">,</span> <span class="n">email</span>
    <span class="n">receiving_user</span><span class="o">.</span><span class="n">clear_mailbox</span><span class="p">()</span>
    <span class="n">mail_admin</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">sending_user</span><span class="p">)</span>
    <span class="n">mail_admin</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">receiving_user</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_email_received</span><span class="p">(</span><span class="n">setup</span><span class="p">):</span>
    <span class="n">receiving_user</span><span class="p">,</span> <span class="n">email</span> <span class="o">=</span> <span class="n">setup</span>
    <span class="k">assert</span> <span class="n">email</span> <span class="ow">in</span> <span class="n">receiving_user</span><span class="o">.</span><span class="n">inbox</span>
</pre></div>
</div>
<p>This version is a lot more compact, but it’s also harder to read, doesn’t have a
very descriptive fixture name, and none of the fixtures can be reused easily.</p>
<p>There’s also a more serious issue, which is that if any of those steps in the
setup raise an exception, none of the teardown code will run.</p>
<p>One option might be to go with the <code class="docutils literal notranslate"><span class="pre">addfinalizer</span></code> method instead of yield
fixtures, but that might get pretty complex and difficult to maintain (and it
wouldn’t be compact anymore).</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -q test_emaillib.py
<span class="-Color -Color-Green">.</span>                                                                    <span class="-Color -Color-Green">[100%]</span>
<span class="-Color -Color-Bold -Color-Bold-Green">1 passed</span><span class="-Color -Color-Green"> in 0.12s</span>
</pre></div>
</div>
<a class="dashAnchor" name="//apple_ref/cpp/Section/Safe fixture structure"></a><section id="safe-fixture-structure">
<span id="id3"></span><h3>Safe fixture structure<a class="headerlink" href="#safe-fixture-structure" title="Permalink to this heading">¶</a></h3>
<p>The safest and simplest fixture structure requires limiting fixtures to only
making one state-changing action each, and then bundling them together with
their teardown code, as <a class="reference internal" href="#yield-fixtures"><span class="std std-ref">the email examples above</span></a> showed.</p>
<p>The chance that a state-changing operation can fail but still modify state is
negligible, as most of these operations tend to be <a class="reference external" href="https://en.wikipedia.org/wiki/Transaction_processing">transaction</a>-based (at least at the
level of testing where state could be left behind). So if we make sure that any
successful state-changing action gets torn down by moving it to a separate
fixture function and separating it from other, potentially failing
state-changing actions, then our tests will stand the best chance at leaving
the test environment the way they found it.</p>
<p>For an example, let’s say we have a website with a login page, and we have
access to an admin API where we can generate users. For our test, we want to:</p>
<ol class="arabic simple">
<li><p>Create a user through that admin API</p></li>
<li><p>Launch a browser using Selenium</p></li>
<li><p>Go to the login page of our site</p></li>
<li><p>Log in as the user we created</p></li>
<li><p>Assert that their name is in the header of the landing page</p></li>
</ol>
<p>We wouldn’t want to leave that user in the system, nor would we want to leave
that browser session running, so we’ll want to make sure the fixtures that
create those things clean up after themselves.</p>
<p>Here’s what that might look like:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For this example, certain fixtures (i.e. <code class="docutils literal notranslate"><span class="pre">base_url</span></code> and
<code class="docutils literal notranslate"><span class="pre">admin_credentials</span></code>) are implied to exist elsewhere. So for now, let’s
assume they exist, and we’re just not looking at them.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urljoin</span>

<span class="kn">from</span> <span class="nn">selenium.webdriver</span> <span class="kn">import</span> <span class="n">Chrome</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">src.utils.pages</span> <span class="kn">import</span> <span class="n">LoginPage</span><span class="p">,</span> <span class="n">LandingPage</span>
<span class="kn">from</span> <span class="nn">src.utils</span> <span class="kn">import</span> <span class="n">AdminApiClient</span>
<span class="kn">from</span> <span class="nn">src.utils.data_types</span> <span class="kn">import</span> <span class="n">User</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">admin_client</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="n">admin_credentials</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">AdminApiClient</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="o">**</span><span class="n">admin_credentials</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">user</span><span class="p">(</span><span class="n">admin_client</span><span class="p">):</span>
    <span class="n">_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Susan"</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="sa">f</span><span class="s2">"testuser-</span><span class="si">{</span><span class="n">uuid4</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">"P4$$word"</span><span class="p">)</span>
    <span class="n">admin_client</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">_user</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">_user</span>
    <span class="n">admin_client</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">_user</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">driver</span><span class="p">():</span>
    <span class="n">_driver</span> <span class="o">=</span> <span class="n">Chrome</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">_driver</span>
    <span class="n">_driver</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">base_url</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
    <span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="s2">"/login"</span><span class="p">))</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">LoginPage</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span>
    <span class="n">page</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">landing_page</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">login</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">LandingPage</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_name_on_landing_page_after_login</span><span class="p">(</span><span class="n">landing_page</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">landing_page</span><span class="o">.</span><span class="n">header</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">"Welcome, </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">!"</span>
</pre></div>
</div>
<p>The way the dependencies are laid out means it’s unclear if the <code class="docutils literal notranslate"><span class="pre">user</span></code>
fixture would execute before the <code class="docutils literal notranslate"><span class="pre">driver</span></code> fixture. But that’s ok, because
those are atomic operations, and so it doesn’t matter which one runs first
because the sequence of events for the test is still <a class="reference external" href="https://en.wikipedia.org/wiki/Linearizability">linearizable</a>. But what <em>does</em> matter is
that, no matter which one runs first, if the one raises an exception while the
other would not have, neither will have left anything behind. If <code class="docutils literal notranslate"><span class="pre">driver</span></code>
executes before <code class="docutils literal notranslate"><span class="pre">user</span></code>, and <code class="docutils literal notranslate"><span class="pre">user</span></code> raises an exception, the driver will
still quit, and the user was never made. And if <code class="docutils literal notranslate"><span class="pre">driver</span></code> was the one to raise
the exception, then the driver would never have been started and the user would
never have been made.</p>
</section>
</section>
<section id="running-multiple-assert-statements-safely">
<h2>Running multiple <code class="docutils literal notranslate"><span class="pre">assert</span></code> statements safely<a class="headerlink" href="#running-multiple-assert-statements-safely" title="Permalink to this heading">¶</a></h2>
<p>Sometimes you may want to run multiple asserts after doing all that setup, which
makes sense as, in more complex systems, a single action can kick off multiple
behaviors. pytest has a convenient way of handling this and it combines a bunch
of what we’ve gone over so far.</p>
<p>All that’s needed is stepping up to a larger scope, then having the <strong>act</strong>
step defined as an autouse fixture, and finally, making sure all the fixtures
are targeting that higher level scope.</p>
<p>Let’s pull <a class="reference internal" href="#safe-fixture-structure"><span class="std std-ref">an example from above</span></a>, and tweak it a
bit. Let’s say that in addition to checking for a welcome message in the header,
we also want to check for a sign out button, and a link to the user’s profile.</p>
<p>Let’s take a look at how we can structure that so we can run multiple asserts
without having to repeat all those steps again.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For this example, certain fixtures (i.e. <code class="docutils literal notranslate"><span class="pre">base_url</span></code> and
<code class="docutils literal notranslate"><span class="pre">admin_credentials</span></code>) are implied to exist elsewhere. So for now, let’s
assume they exist, and we’re just not looking at them.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># contents of tests/end_to_end/test_login.py</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urljoin</span>

<span class="kn">from</span> <span class="nn">selenium.webdriver</span> <span class="kn">import</span> <span class="n">Chrome</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">src.utils.pages</span> <span class="kn">import</span> <span class="n">LoginPage</span><span class="p">,</span> <span class="n">LandingPage</span>
<span class="kn">from</span> <span class="nn">src.utils</span> <span class="kn">import</span> <span class="n">AdminApiClient</span>
<span class="kn">from</span> <span class="nn">src.utils.data_types</span> <span class="kn">import</span> <span class="n">User</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">"class"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">admin_client</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="n">admin_credentials</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">AdminApiClient</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="o">**</span><span class="n">admin_credentials</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">"class"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">user</span><span class="p">(</span><span class="n">admin_client</span><span class="p">):</span>
    <span class="n">_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Susan"</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="sa">f</span><span class="s2">"testuser-</span><span class="si">{</span><span class="n">uuid4</span><span class="p">()</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">"P4$$word"</span><span class="p">)</span>
    <span class="n">admin_client</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">_user</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">_user</span>
    <span class="n">admin_client</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">_user</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">"class"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">driver</span><span class="p">():</span>
    <span class="n">_driver</span> <span class="o">=</span> <span class="n">Chrome</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">_driver</span>
    <span class="n">_driver</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">"class"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">landing_page</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">login</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">LandingPage</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TestLandingPageSuccess</span><span class="p">:</span>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">"class"</span><span class="p">,</span> <span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">driver</span><span class="p">,</span> <span class="n">base_url</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">urljoin</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="s2">"/login"</span><span class="p">))</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">LoginPage</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span>
        <span class="n">page</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_name_in_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">landing_page</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">landing_page</span><span class="o">.</span><span class="n">header</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">"Welcome, </span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">!"</span>

    <span class="k">def</span> <span class="nf">test_sign_out_button</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">landing_page</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">landing_page</span><span class="o">.</span><span class="n">sign_out_button</span><span class="o">.</span><span class="n">is_displayed</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_profile_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">landing_page</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="n">profile_href</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"/profile?id=</span><span class="si">{</span><span class="n">user</span><span class="o">.</span><span class="n">profile_id</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">landing_page</span><span class="o">.</span><span class="n">profile_link</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s2">"href"</span><span class="p">)</span> <span class="o">==</span> <span class="n">profile_href</span>
</pre></div>
</div>
<p>Notice that the methods are only referencing <code class="docutils literal notranslate"><span class="pre">self</span></code> in the signature as a
formality. No state is tied to the actual test class as it might be in the
<code class="docutils literal notranslate"><span class="pre">unittest.TestCase</span></code> framework. Everything is managed by the pytest fixture
system.</p>
<p>Each method only has to request the fixtures that it actually needs without
worrying about order. This is because the <strong>act</strong> fixture is an autouse fixture,
and it made sure all the other fixtures executed before it. There’s no more
changes of state that need to take place, so the tests are free to make as many
non-state-changing queries as they want without risking stepping on the toes of
the other tests.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">login</span></code> fixture is defined inside the class as well, because not every one
of the other tests in the module will be expecting a successful login, and the <strong>act</strong> may need to
be handled a little differently for another test class. For example, if we
wanted to write another test scenario around submitting bad credentials, we
could handle it by adding something like this to the test file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TestLandingPageBadCredentials</span><span class="p">:</span>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">"class"</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">faux_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="n">_user</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">_user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="s2">"badpass"</span>
        <span class="k">return</span> <span class="n">_user</span>

    <span class="k">def</span> <span class="nf">test_raises_bad_credentials_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">login_page</span><span class="p">,</span> <span class="n">faux_user</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">BadCredentialsException</span><span class="p">):</span>
            <span class="n">login_page</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">faux_user</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="fixtures-can-introspect-the-requesting-test-context">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Fixtures can introspect the requesting test context"></a><span id="request-context"></span><h2>Fixtures can introspect the requesting test context<a class="headerlink" href="#fixtures-can-introspect-the-requesting-test-context" title="Permalink to this heading">¶</a></h2>
<p>Fixture functions can accept the <a class="reference internal" href="../reference/reference.html#pytest.FixtureRequest" title="_pytest.fixtures.FixtureRequest"><code class="xref py py-class docutils literal notranslate"><span class="pre">request</span></code></a> object
to introspect the “requesting” test function, class or module context.
Further extending the previous <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> fixture example, let’s
read an optional server URL from the test module which uses our fixture:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of conftest.py</span>
<span class="kn">import</span> <span class="nn">smtplib</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">"module"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">smtp_connection</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">server</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="s2">"smtpserver"</span><span class="p">,</span> <span class="s2">"smtp.gmail.com"</span><span class="p">)</span>
    <span class="n">smtp_connection</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="mi">587</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">smtp_connection</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"finalizing </span><span class="si">{</span><span class="n">smtp_connection</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">server</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
    <span class="n">smtp_connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>We use the <code class="docutils literal notranslate"><span class="pre">request.module</span></code> attribute to optionally obtain an
<code class="docutils literal notranslate"><span class="pre">smtpserver</span></code> attribute from the test module.  If we just execute
again, nothing much has changed:</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -s -q --tb=no test_module.py
FFfinalizing &lt;smtplib.SMTP object at 0xdeadbeef0002&gt; (smtp.gmail.com)

<span class="-Color -Color-Bold -Color-Bold-Cyan">========================= short test summary info ==========================</span>
<span class="-Color -Color-Red">FAILED</span> test_module.py::<span class="-Color -Color-Bold">test_ehlo</span> - assert 0
<span class="-Color -Color-Red">FAILED</span> test_module.py::<span class="-Color -Color-Bold">test_noop</span> - assert 0
<span class="-Color -Color-Bold -Color-Bold-Red">2 failed</span><span class="-Color -Color-Red"> in 0.12s</span>
</pre></div>
</div>
<p>Let’s quickly create another test module that actually sets the
server URL in its module namespace:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_anothersmtp.py</span>

<span class="n">smtpserver</span> <span class="o">=</span> <span class="s2">"mail.python.org"</span>  <span class="c1"># will be read by smtp fixture</span>


<span class="k">def</span> <span class="nf">test_showhelo</span><span class="p">(</span><span class="n">smtp_connection</span><span class="p">):</span>
    <span class="k">assert</span> <span class="mi">0</span><span class="p">,</span> <span class="n">smtp_connection</span><span class="o">.</span><span class="n">helo</span><span class="p">()</span>
</pre></div>
</div>
<p>Running it:</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -qq --tb=short test_anothersmtp.py
<span class="-Color -Color-Red">F</span>                                                                    <span class="-Color -Color-Red">[100%]</span>
================================= FAILURES =================================
<span class="-Color -Color-Bold -Color-Bold-Red">______________________________ test_showhelo _______________________________</span>
<span class="-Color -Color-Bold -Color-Bold-Red">test_anothersmtp.py</span>:6: in test_showhelo
    assert 0, smtp_connection.helo()
<span class="-Color -Color-Bold -Color-Bold-Red">E   AssertionError: (250, b'mail.python.org')</span>
<span class="-Color -Color-Bold -Color-Bold-Red">E   assert 0</span>
------------------------- Captured stdout teardown -------------------------
finalizing &lt;smtplib.SMTP object at 0xdeadbeef0003&gt; (mail.python.org)
<span class="-Color -Color-Bold -Color-Bold-Cyan">========================= short test summary info ==========================</span>
<span class="-Color -Color-Red">FAILED</span> test_anothersmtp.py::<span class="-Color -Color-Bold">test_showhelo</span> - AssertionError: (250, b'mail....
</pre></div>
</div>
<p>voila! The <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> fixture function picked up our mail server name
from the module namespace.</p>
</section>
<section id="using-markers-to-pass-data-to-fixtures">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Using markers to pass data to fixtures"></a><span id="using-markers"></span><h2>Using markers to pass data to fixtures<a class="headerlink" href="#using-markers-to-pass-data-to-fixtures" title="Permalink to this heading">¶</a></h2>
<p>Using the <a class="reference internal" href="../reference/reference.html#pytest.FixtureRequest" title="_pytest.fixtures.FixtureRequest"><code class="xref py py-class docutils literal notranslate"><span class="pre">request</span></code></a> object, a fixture can also access
markers which are applied to a test function. This can be useful to pass data
into a fixture from a test:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">fixt</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">marker</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">get_closest_marker</span><span class="p">(</span><span class="s2">"fixt_data"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">marker</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Handle missing marker in some way...</span>
        <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">marker</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Do something with the data</span>
    <span class="k">return</span> <span class="n">data</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">fixt_data</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_fixt</span><span class="p">(</span><span class="n">fixt</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">fixt</span> <span class="o">==</span> <span class="mi">42</span>
</pre></div>
</div>
</section>
<section id="factories-as-fixtures">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Factories as fixtures"></a><span id="fixture-factory"></span><h2>Factories as fixtures<a class="headerlink" href="#factories-as-fixtures" title="Permalink to this heading">¶</a></h2>
<p>The “factory as fixture” pattern can help in situations where the result
of a fixture is needed multiple times in a single test. Instead of returning
data directly, the fixture instead returns a function which generates the data.
This function can then be called multiple times in the test.</p>
<p>Factories can have parameters as needed:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">make_customer_record</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">_make_customer_record</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">"name"</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s2">"orders"</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="k">return</span> <span class="n">_make_customer_record</span>


<span class="k">def</span> <span class="nf">test_customer_records</span><span class="p">(</span><span class="n">make_customer_record</span><span class="p">):</span>
    <span class="n">customer_1</span> <span class="o">=</span> <span class="n">make_customer_record</span><span class="p">(</span><span class="s2">"Lisa"</span><span class="p">)</span>
    <span class="n">customer_2</span> <span class="o">=</span> <span class="n">make_customer_record</span><span class="p">(</span><span class="s2">"Mike"</span><span class="p">)</span>
    <span class="n">customer_3</span> <span class="o">=</span> <span class="n">make_customer_record</span><span class="p">(</span><span class="s2">"Meredith"</span><span class="p">)</span>
</pre></div>
</div>
<p>If the data created by the factory requires managing, the fixture can take care of that:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">make_customer_record</span><span class="p">():</span>
    <span class="n">created_records</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_make_customer_record</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Customer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">orders</span><span class="o">=</span><span class="p">[])</span>
        <span class="n">created_records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">record</span>

    <span class="k">yield</span> <span class="n">_make_customer_record</span>

    <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">created_records</span><span class="p">:</span>
        <span class="n">record</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">test_customer_records</span><span class="p">(</span><span class="n">make_customer_record</span><span class="p">):</span>
    <span class="n">customer_1</span> <span class="o">=</span> <span class="n">make_customer_record</span><span class="p">(</span><span class="s2">"Lisa"</span><span class="p">)</span>
    <span class="n">customer_2</span> <span class="o">=</span> <span class="n">make_customer_record</span><span class="p">(</span><span class="s2">"Mike"</span><span class="p">)</span>
    <span class="n">customer_3</span> <span class="o">=</span> <span class="n">make_customer_record</span><span class="p">(</span><span class="s2">"Meredith"</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="parametrizing-fixtures">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Parametrizing fixtures"></a><span id="fixture-parametrize"></span><h2>Parametrizing fixtures<a class="headerlink" href="#parametrizing-fixtures" title="Permalink to this heading">¶</a></h2>
<p>Fixture functions can be parametrized in which case they will be called
multiple times, each time executing the set of dependent tests, i.e. the
tests that depend on this fixture.  Test functions usually do not need
to be aware of their re-running.  Fixture parametrization helps to
write exhaustive functional tests for components which themselves can be
configured in multiple ways.</p>
<p>Extending the previous example, we can flag the fixture to create two
<code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> fixture instances which will cause all tests using the fixture
to run twice.  The fixture function gets access to each parameter
through the special <code class="xref py py-class docutils literal notranslate"><span class="pre">request</span></code> object:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of conftest.py</span>
<span class="kn">import</span> <span class="nn">smtplib</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">"module"</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s2">"smtp.gmail.com"</span><span class="p">,</span> <span class="s2">"mail.python.org"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">smtp_connection</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">smtp_connection</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="mi">587</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">smtp_connection</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"finalizing </span><span class="si">{</span><span class="n">smtp_connection</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">smtp_connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>The main change is the declaration of <code class="docutils literal notranslate"><span class="pre">params</span></code> with
<a class="reference internal" href="../reference/reference.html#pytest.fixture" title="pytest.fixture"><code class="xref py py-func docutils literal notranslate"><span class="pre">@pytest.fixture</span></code></a>, a list of values
for each of which the fixture function will execute and can access
a value via <code class="docutils literal notranslate"><span class="pre">request.param</span></code>.  No test function code needs to change.
So let’s just do another run:</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -q test_module.py
<span class="-Color -Color-Red">FFFF</span>                                                                 <span class="-Color -Color-Red">[100%]</span>
================================= FAILURES =================================
<span class="-Color -Color-Bold -Color-Bold-Red">________________________ test_ehlo[smtp.gmail.com] _________________________</span>

smtp_connection = &lt;smtplib.SMTP object at 0xdeadbeef0004&gt;

    def test_ehlo(smtp_connection):
        response, msg = smtp_connection.ehlo()
        assert response == 250
        assert b"smtp.gmail.com" in msg
&gt;       assert 0  # for demo purposes
<span class="-Color -Color-Bold -Color-Bold-Red">E       assert 0</span>

<span class="-Color -Color-Bold -Color-Bold-Red">test_module.py</span>:7: AssertionError
<span class="-Color -Color-Bold -Color-Bold-Red">________________________ test_noop[smtp.gmail.com] _________________________</span>

smtp_connection = &lt;smtplib.SMTP object at 0xdeadbeef0004&gt;

    def test_noop(smtp_connection):
        response, msg = smtp_connection.noop()
        assert response == 250
&gt;       assert 0  # for demo purposes
<span class="-Color -Color-Bold -Color-Bold-Red">E       assert 0</span>

<span class="-Color -Color-Bold -Color-Bold-Red">test_module.py</span>:13: AssertionError
<span class="-Color -Color-Bold -Color-Bold-Red">________________________ test_ehlo[mail.python.org] ________________________</span>

smtp_connection = &lt;smtplib.SMTP object at 0xdeadbeef0005&gt;

    def test_ehlo(smtp_connection):
        response, msg = smtp_connection.ehlo()
        assert response == 250
&gt;       assert b"smtp.gmail.com" in msg
<span class="-Color -Color-Bold -Color-Bold-Red">E       AssertionError: assert b'smtp.gmail.com' in b'mail.python.org\nPIPELINING\nSIZE 51200000\nETRN\nSTARTTLS\nAUTH DIGEST-MD5 NTLM CRAM-MD5\nENHANCEDSTATUSCODES\n8BITMIME\nDSN\nSMTPUTF8\nCHUNKING'</span>

<span class="-Color -Color-Bold -Color-Bold-Red">test_module.py</span>:6: AssertionError
-------------------------- Captured stdout setup ---------------------------
finalizing &lt;smtplib.SMTP object at 0xdeadbeef0004&gt;
<span class="-Color -Color-Bold -Color-Bold-Red">________________________ test_noop[mail.python.org] ________________________</span>

smtp_connection = &lt;smtplib.SMTP object at 0xdeadbeef0005&gt;

    def test_noop(smtp_connection):
        response, msg = smtp_connection.noop()
        assert response == 250
&gt;       assert 0  # for demo purposes
<span class="-Color -Color-Bold -Color-Bold-Red">E       assert 0</span>

<span class="-Color -Color-Bold -Color-Bold-Red">test_module.py</span>:13: AssertionError
------------------------- Captured stdout teardown -------------------------
finalizing &lt;smtplib.SMTP object at 0xdeadbeef0005&gt;
<span class="-Color -Color-Bold -Color-Bold-Cyan">========================= short test summary info ==========================</span>
<span class="-Color -Color-Red">FAILED</span> test_module.py::<span class="-Color -Color-Bold">test_ehlo[smtp.gmail.com]</span> - assert 0
<span class="-Color -Color-Red">FAILED</span> test_module.py::<span class="-Color -Color-Bold">test_noop[smtp.gmail.com]</span> - assert 0
<span class="-Color -Color-Red">FAILED</span> test_module.py::<span class="-Color -Color-Bold">test_ehlo[mail.python.org]</span> - AssertionError: asser...
<span class="-Color -Color-Red">FAILED</span> test_module.py::<span class="-Color -Color-Bold">test_noop[mail.python.org]</span> - assert 0
<span class="-Color -Color-Bold -Color-Bold-Red">4 failed</span><span class="-Color -Color-Red"> in 0.12s</span>
</pre></div>
</div>
<p>We see that our two test functions each ran twice, against the different
<code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> instances.  Note also, that with the <code class="docutils literal notranslate"><span class="pre">mail.python.org</span></code>
connection the second test fails in <code class="docutils literal notranslate"><span class="pre">test_ehlo</span></code> because a
different server string is expected than what arrived.</p>
<p>pytest will build a string that is the test ID for each fixture value
in a parametrized fixture, e.g. <code class="docutils literal notranslate"><span class="pre">test_ehlo[smtp.gmail.com]</span></code> and
<code class="docutils literal notranslate"><span class="pre">test_ehlo[mail.python.org]</span></code> in the above examples.  These IDs can
be used with <code class="docutils literal notranslate"><span class="pre">-k</span></code> to select specific cases to run, and they will
also identify the specific case when one is failing.  Running pytest
with <code class="docutils literal notranslate"><span class="pre">--collect-only</span></code> will show the generated IDs.</p>
<p>Numbers, strings, booleans and <code class="docutils literal notranslate"><span class="pre">None</span></code> will have their usual string
representation used in the test ID. For other objects, pytest will
make a string based on the argument name.  It is possible to customise
the string used in a test ID for a certain fixture value by using the
<code class="docutils literal notranslate"><span class="pre">ids</span></code> keyword argument:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_ids.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="s2">"spam"</span><span class="p">,</span> <span class="s2">"ham"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">a</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>


<span class="k">def</span> <span class="nf">test_a</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">idfn</span><span class="p">(</span><span class="n">fixture_value</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">fixture_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">"eggs"</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ids</span><span class="o">=</span><span class="n">idfn</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">b</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>


<span class="k">def</span> <span class="nf">test_b</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>The above shows how <code class="docutils literal notranslate"><span class="pre">ids</span></code> can be either a list of strings to use or
a function which will be called with the fixture value and then
has to return a string to use.  In the latter case if the function
returns <code class="docutils literal notranslate"><span class="pre">None</span></code> then pytest’s auto-generated ID will be used.</p>
<p>Running the above tests results in the following test IDs being used:</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest --collect-only
<span class="-Color -Color-Bold">=========================== test session starts ============================</span>
platform linux -- Python 3.x.y, pytest-7.x.y, pluggy-1.x.y
rootdir: /home/sweet/project
collected 12 items

&lt;Module test_anothersmtp.py&gt;
  &lt;Function test_showhelo[smtp.gmail.com]&gt;
  &lt;Function test_showhelo[mail.python.org]&gt;
&lt;Module test_emaillib.py&gt;
  &lt;Function test_email_received&gt;
&lt;Module test_finalizers.py&gt;
  &lt;Function test_bar&gt;
&lt;Module test_ids.py&gt;
  &lt;Function test_a[spam]&gt;
  &lt;Function test_a[ham]&gt;
  &lt;Function test_b[eggs]&gt;
  &lt;Function test_b[1]&gt;
&lt;Module test_module.py&gt;
  &lt;Function test_ehlo[smtp.gmail.com]&gt;
  &lt;Function test_noop[smtp.gmail.com]&gt;
  &lt;Function test_ehlo[mail.python.org]&gt;
  &lt;Function test_noop[mail.python.org]&gt;

======================= 12 tests collected in 0.12s ========================
</pre></div>
</div>
</section>
<section id="using-marks-with-parametrized-fixtures">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Using marks with parametrized fixtures"></a><span id="fixture-parametrize-marks"></span><h2>Using marks with parametrized fixtures<a class="headerlink" href="#using-marks-with-parametrized-fixtures" title="Permalink to this heading">¶</a></h2>
<p><a class="reference internal" href="../reference/reference.html#pytest.param" title="pytest.param"><code class="xref py py-func docutils literal notranslate"><span class="pre">pytest.param()</span></code></a> can be used to apply marks in values sets of parametrized fixtures in the same way
that they can be used with <a class="reference internal" href="parametrize.html#pytest-mark-parametrize"><span class="std std-ref">@pytest.mark.parametrize</span></a>.</p>
<p>Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_fixture_marks.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pytest</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">marks</span><span class="o">=</span><span class="n">pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">skip</span><span class="p">)])</span>
<span class="k">def</span> <span class="nf">data_set</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>


<span class="k">def</span> <span class="nf">test_data</span><span class="p">(</span><span class="n">data_set</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>Running this test will <em>skip</em> the invocation of <code class="docutils literal notranslate"><span class="pre">data_set</span></code> with value <code class="docutils literal notranslate"><span class="pre">2</span></code>:</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest test_fixture_marks.py -v
<span class="-Color -Color-Bold">=========================== test session starts ============================</span>
platform linux -- Python 3.x.y, pytest-7.x.y, pluggy-1.x.y -- $PYTHON_PREFIX/bin/python
cachedir: .pytest_cache
rootdir: /home/sweet/project
<span class="-Color -Color-Bold">collecting ...</span> collected 3 items

test_fixture_marks.py::test_data[0] <span class="-Color -Color-Green">PASSED</span>                           <span class="-Color -Color-Green">[ 33%]</span>
test_fixture_marks.py::test_data[1] <span class="-Color -Color-Green">PASSED</span>                           <span class="-Color -Color-Green">[ 66%]</span>
test_fixture_marks.py::test_data[2] <span class="-Color -Color-Yellow">SKIPPED</span> (unconditional skip)     <span class="-Color -Color-Yellow">[100%]</span>

<span class="-Color -Color-Yellow">======================= </span><span class="-Color -Color-Green">2 passed</span>, <span class="-Color -Color-Bold -Color-Bold-Yellow">1 skipped</span><span class="-Color -Color-Yellow"> in 0.12s =======================</span>
</pre></div>
</div>
</section>
<section id="modularity-using-fixtures-from-a-fixture-function">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Modularity: using fixtures from a fixture function"></a><span id="interdependent-fixtures"></span><h2>Modularity: using fixtures from a fixture function<a class="headerlink" href="#modularity-using-fixtures-from-a-fixture-function" title="Permalink to this heading">¶</a></h2>
<p>In addition to using fixtures in test functions, fixture functions
can use other fixtures themselves.  This contributes to a modular design
of your fixtures and allows re-use of framework-specific fixtures across
many projects.  As a simple example, we can extend the previous example
and instantiate an object <code class="docutils literal notranslate"><span class="pre">app</span></code> where we stick the already defined
<code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> resource into it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_appsetup.py</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="k">class</span> <span class="nc">App</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smtp_connection</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smtp_connection</span> <span class="o">=</span> <span class="n">smtp_connection</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">"module"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">app</span><span class="p">(</span><span class="n">smtp_connection</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">App</span><span class="p">(</span><span class="n">smtp_connection</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_smtp_connection_exists</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">app</span><span class="o">.</span><span class="n">smtp_connection</span>
</pre></div>
</div>
<p>Here we declare an <code class="docutils literal notranslate"><span class="pre">app</span></code> fixture which receives the previously defined
<code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> fixture and instantiates an <code class="docutils literal notranslate"><span class="pre">App</span></code> object with it.  Let’s run it:</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -v test_appsetup.py
<span class="-Color -Color-Bold">=========================== test session starts ============================</span>
platform linux -- Python 3.x.y, pytest-7.x.y, pluggy-1.x.y -- $PYTHON_PREFIX/bin/python
cachedir: .pytest_cache
rootdir: /home/sweet/project
<span class="-Color -Color-Bold">collecting ...</span> collected 2 items

test_appsetup.py::test_smtp_connection_exists[smtp.gmail.com] <span class="-Color -Color-Green">PASSED</span> <span class="-Color -Color-Green">[ 50%]</span>
test_appsetup.py::test_smtp_connection_exists[mail.python.org] <span class="-Color -Color-Green">PASSED</span> <span class="-Color -Color-Green">[100%]</span>

<span class="-Color -Color-Green">============================ </span><span class="-Color -Color-Bold -Color-Bold-Green">2 passed</span><span class="-Color -Color-Green"> in 0.12s =============================</span>
</pre></div>
</div>
<p>Due to the parametrization of <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code>, the test will run twice with two
different <code class="docutils literal notranslate"><span class="pre">App</span></code> instances and respective smtp servers.  There is no
need for the <code class="docutils literal notranslate"><span class="pre">app</span></code> fixture to be aware of the <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code>
parametrization because pytest will fully analyse the fixture dependency graph.</p>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">app</span></code> fixture has a scope of <code class="docutils literal notranslate"><span class="pre">module</span></code> and uses a
module-scoped <code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> fixture.  The example would still work if
<code class="docutils literal notranslate"><span class="pre">smtp_connection</span></code> was cached on a <code class="docutils literal notranslate"><span class="pre">session</span></code> scope: it is fine for fixtures to use
“broader” scoped fixtures but not the other way round:
A session-scoped fixture could not use a module-scoped one in a
meaningful way.</p>
</section>
<section id="automatic-grouping-of-tests-by-fixture-instances">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Automatic grouping of tests by fixture instances"></a><span id="automatic-per-resource-grouping"></span><h2>Automatic grouping of tests by fixture instances<a class="headerlink" href="#automatic-grouping-of-tests-by-fixture-instances" title="Permalink to this heading">¶</a></h2>
<p>pytest minimizes the number of active fixtures during test runs.
If you have a parametrized fixture, then all the tests using it will
first execute with one instance and then finalizers are called
before the next fixture instance is created.  Among other things,
this eases testing of applications which create and use global state.</p>
<p>The following example uses two parametrized fixtures, one of which is
scoped on a per-module basis, and all the functions perform <code class="docutils literal notranslate"><span class="pre">print</span></code> calls
to show the setup/teardown flow:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_module.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">"module"</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s2">"mod1"</span><span class="p">,</span> <span class="s2">"mod2"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">modarg</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">param</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"  SETUP modarg"</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">param</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"  TEARDOWN modarg"</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">"function"</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">otherarg</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">param</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"  SETUP otherarg"</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">param</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"  TEARDOWN otherarg"</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_0</span><span class="p">(</span><span class="n">otherarg</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"  RUN test0 with otherarg"</span><span class="p">,</span> <span class="n">otherarg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_1</span><span class="p">(</span><span class="n">modarg</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"  RUN test1 with modarg"</span><span class="p">,</span> <span class="n">modarg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_2</span><span class="p">(</span><span class="n">otherarg</span><span class="p">,</span> <span class="n">modarg</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"  RUN test2 with otherarg </span><span class="si">{</span><span class="n">otherarg</span><span class="si">}</span><span class="s2"> and modarg </span><span class="si">{</span><span class="n">modarg</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s run the tests in verbose mode and with looking at the print-output:</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -v -s test_module.py
<span class="-Color -Color-Bold">=========================== test session starts ============================</span>
platform linux -- Python 3.x.y, pytest-7.x.y, pluggy-1.x.y -- $PYTHON_PREFIX/bin/python
cachedir: .pytest_cache
rootdir: /home/sweet/project
<span class="-Color -Color-Bold">collecting ...</span> collected 8 items

test_module.py::test_0[1]   SETUP otherarg 1
  RUN test0 with otherarg 1
PASSED  TEARDOWN otherarg 1

test_module.py::test_0[2]   SETUP otherarg 2
  RUN test0 with otherarg 2
PASSED  TEARDOWN otherarg 2

test_module.py::test_1[mod1]   SETUP modarg mod1
  RUN test1 with modarg mod1
PASSED
test_module.py::test_2[mod1-1]   SETUP otherarg 1
  RUN test2 with otherarg 1 and modarg mod1
PASSED  TEARDOWN otherarg 1

test_module.py::test_2[mod1-2]   SETUP otherarg 2
  RUN test2 with otherarg 2 and modarg mod1
PASSED  TEARDOWN otherarg 2

test_module.py::test_1[mod2]   TEARDOWN modarg mod1
  SETUP modarg mod2
  RUN test1 with modarg mod2
PASSED
test_module.py::test_2[mod2-1]   SETUP otherarg 1
  RUN test2 with otherarg 1 and modarg mod2
PASSED  TEARDOWN otherarg 1

test_module.py::test_2[mod2-2]   SETUP otherarg 2
  RUN test2 with otherarg 2 and modarg mod2
PASSED  TEARDOWN otherarg 2
  TEARDOWN modarg mod2


<span class="-Color -Color-Green">============================ </span><span class="-Color -Color-Bold -Color-Bold-Green">8 passed</span><span class="-Color -Color-Green"> in 0.12s =============================</span>
</pre></div>
</div>
<p>You can see that the parametrized module-scoped <code class="docutils literal notranslate"><span class="pre">modarg</span></code> resource caused an
ordering of test execution that lead to the fewest possible “active” resources.
The finalizer for the <code class="docutils literal notranslate"><span class="pre">mod1</span></code> parametrized resource was executed before the
<code class="docutils literal notranslate"><span class="pre">mod2</span></code> resource was setup.</p>
<p>In particular notice that test_0 is completely independent and finishes first.
Then test_1 is executed with <code class="docutils literal notranslate"><span class="pre">mod1</span></code>, then test_2 with <code class="docutils literal notranslate"><span class="pre">mod1</span></code>, then test_1
with <code class="docutils literal notranslate"><span class="pre">mod2</span></code> and finally test_2 with <code class="docutils literal notranslate"><span class="pre">mod2</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">otherarg</span></code> parametrized resource (having function scope) was set up before
and teared down after every test that used it.</p>
</section>
<section id="use-fixtures-in-classes-and-modules-with-usefixtures">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Use fixtures in classes and modules with usefixtures"></a><span id="usefixtures"></span><h2>Use fixtures in classes and modules with <code class="docutils literal notranslate"><span class="pre">usefixtures</span></code><a class="headerlink" href="#use-fixtures-in-classes-and-modules-with-usefixtures" title="Permalink to this heading">¶</a></h2>
<p>Sometimes test functions do not directly need access to a fixture object.
For example, tests may require to operate with an empty directory as the
current working directory but otherwise do not care for the concrete
directory.  Here is how you can use the standard <a class="reference external" href="https://docs.python.org/3/library/tempfile.html#module-tempfile" title="(in Python v3.11)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">tempfile</span></code></a>
and pytest fixtures to
achieve it.  We separate the creation of the fixture into a <code class="file docutils literal notranslate"><span class="pre">conftest.py</span></code>
file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of conftest.py</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tempfile</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">cleandir</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">newpath</span><span class="p">:</span>
        <span class="n">old_cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">newpath</span><span class="p">)</span>
        <span class="k">yield</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">old_cwd</span><span class="p">)</span>
</pre></div>
</div>
<p>and declare its use in a test module via a <code class="docutils literal notranslate"><span class="pre">usefixtures</span></code> marker:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of test_setenv.py</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s2">"cleandir"</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TestDirectoryInit</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">test_cwd_starts_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span> <span class="o">==</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"myfile"</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"hello"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_cwd_again_starts_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span> <span class="o">==</span> <span class="p">[]</span>
</pre></div>
</div>
<p>Due to the <code class="docutils literal notranslate"><span class="pre">usefixtures</span></code> marker, the <code class="docutils literal notranslate"><span class="pre">cleandir</span></code> fixture
will be required for the execution of each test method, just as if
you specified a “cleandir” function argument to each of them.  Let’s run it
to verify our fixture is activated and the tests pass:</p>
<div class="highlight-pytest notranslate"><div class="highlight"><pre><span></span>$ pytest -q
<span class="-Color -Color-Green">..</span>                                                                   <span class="-Color -Color-Green">[100%]</span>
<span class="-Color -Color-Bold -Color-Bold-Green">2 passed</span><span class="-Color -Color-Green"> in 0.12s</span>
</pre></div>
</div>
<p>You can specify multiple fixtures like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s2">"cleandir"</span><span class="p">,</span> <span class="s2">"anotherfixture"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>and you may specify fixture usage at the test module level using <a class="reference internal" href="../reference/reference.html#globalvar-pytestmark"><code class="xref std std-globalvar docutils literal notranslate"><span class="pre">pytestmark</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pytestmark</span> <span class="o">=</span> <span class="n">pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s2">"cleandir"</span><span class="p">)</span>
</pre></div>
</div>
<p>It is also possible to put fixtures required by all tests in your project
into an ini-file:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="c1"># content of pytest.ini</span>
<span class="k">[pytest]</span>
<span class="na">usefixtures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">cleandir</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Note this mark has no effect in <strong>fixture functions</strong>. For example,
this <strong>will not work as expected</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s2">"my_other_fixture"</span><span class="p">)</span>
<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">my_fixture_that_sadly_wont_use_my_other_fixture</span><span class="p">():</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Currently this will not generate any error or warning, but this is intended
to be handled by <a class="reference external" href="https://github.com/pytest-dev/pytest/issues/3664">issue #3664</a>.</p>
</div>
</section>
<section id="overriding-fixtures-on-various-levels">
<a class="dashAnchor" name="//apple_ref/cpp/Section/Overriding fixtures on various levels"></a><span id="override-fixtures"></span><h2>Overriding fixtures on various levels<a class="headerlink" href="#overriding-fixtures-on-various-levels" title="Permalink to this heading">¶</a></h2>
<p>In relatively large test suite, you most likely need to <code class="docutils literal notranslate"><span class="pre">override</span></code> a <code class="docutils literal notranslate"><span class="pre">global</span></code> or <code class="docutils literal notranslate"><span class="pre">root</span></code> fixture with a <code class="docutils literal notranslate"><span class="pre">locally</span></code>
defined one, keeping the test code readable and maintainable.</p>
<section id="override-a-fixture-on-a-folder-conftest-level">
<h3>Override a fixture on a folder (conftest) level<a class="headerlink" href="#override-a-fixture-on-a-folder-conftest-level" title="Permalink to this heading">¶</a></h3>
<p>Given the tests file structure is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tests</span><span class="o">/</span>
    <span class="n">conftest</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># content of tests/conftest.py</span>
        <span class="kn">import</span> <span class="nn">pytest</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
        <span class="k">def</span> <span class="nf">username</span><span class="p">():</span>
            <span class="k">return</span> <span class="s1">'username'</span>

    <span class="n">test_something</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># content of tests/test_something.py</span>
        <span class="k">def</span> <span class="nf">test_username</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">username</span> <span class="o">==</span> <span class="s1">'username'</span>

    <span class="n">subfolder</span><span class="o">/</span>
        <span class="n">conftest</span><span class="o">.</span><span class="n">py</span>
            <span class="c1"># content of tests/subfolder/conftest.py</span>
            <span class="kn">import</span> <span class="nn">pytest</span>

            <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
            <span class="k">def</span> <span class="nf">username</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
                <span class="k">return</span> <span class="s1">'overridden-'</span> <span class="o">+</span> <span class="n">username</span>

        <span class="n">test_something_else</span><span class="o">.</span><span class="n">py</span>
            <span class="c1"># content of tests/subfolder/test_something_else.py</span>
            <span class="k">def</span> <span class="nf">test_username</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">username</span> <span class="o">==</span> <span class="s1">'overridden-username'</span>
</pre></div>
</div>
<p>As you can see, a fixture with the same name can be overridden for certain test folder level.
Note that the <code class="docutils literal notranslate"><span class="pre">base</span></code> or <code class="docutils literal notranslate"><span class="pre">super</span></code> fixture can be accessed from the <code class="docutils literal notranslate"><span class="pre">overriding</span></code>
fixture easily - used in the example above.</p>
</section>
<section id="override-a-fixture-on-a-test-module-level">
<h3>Override a fixture on a test module level<a class="headerlink" href="#override-a-fixture-on-a-test-module-level" title="Permalink to this heading">¶</a></h3>
<p>Given the tests file structure is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tests</span><span class="o">/</span>
    <span class="n">conftest</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># content of tests/conftest.py</span>
        <span class="kn">import</span> <span class="nn">pytest</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
        <span class="k">def</span> <span class="nf">username</span><span class="p">():</span>
            <span class="k">return</span> <span class="s1">'username'</span>

    <span class="n">test_something</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># content of tests/test_something.py</span>
        <span class="kn">import</span> <span class="nn">pytest</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
        <span class="k">def</span> <span class="nf">username</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">'overridden-'</span> <span class="o">+</span> <span class="n">username</span>

        <span class="k">def</span> <span class="nf">test_username</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">username</span> <span class="o">==</span> <span class="s1">'overridden-username'</span>

    <span class="n">test_something_else</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># content of tests/test_something_else.py</span>
        <span class="kn">import</span> <span class="nn">pytest</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
        <span class="k">def</span> <span class="nf">username</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">'overridden-else-'</span> <span class="o">+</span> <span class="n">username</span>

        <span class="k">def</span> <span class="nf">test_username</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">username</span> <span class="o">==</span> <span class="s1">'overridden-else-username'</span>
</pre></div>
</div>
<p>In the example above, a fixture with the same name can be overridden for certain test module.</p>
</section>
<section id="override-a-fixture-with-direct-test-parametrization">
<h3>Override a fixture with direct test parametrization<a class="headerlink" href="#override-a-fixture-with-direct-test-parametrization" title="Permalink to this heading">¶</a></h3>
<p>Given the tests file structure is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tests</span><span class="o">/</span>
    <span class="n">conftest</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># content of tests/conftest.py</span>
        <span class="kn">import</span> <span class="nn">pytest</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
        <span class="k">def</span> <span class="nf">username</span><span class="p">():</span>
            <span class="k">return</span> <span class="s1">'username'</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
        <span class="k">def</span> <span class="nf">other_username</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">'other-'</span> <span class="o">+</span> <span class="n">username</span>

    <span class="n">test_something</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># content of tests/test_something.py</span>
        <span class="kn">import</span> <span class="nn">pytest</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">'username'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'directly-overridden-username'</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">test_username</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">username</span> <span class="o">==</span> <span class="s1">'directly-overridden-username'</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s1">'username'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'directly-overridden-username-other'</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">test_username_other</span><span class="p">(</span><span class="n">other_username</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">other_username</span> <span class="o">==</span> <span class="s1">'other-directly-overridden-username-other'</span>
</pre></div>
</div>
<p>In the example above, a fixture value is overridden by the test parameter value. Note that the value of the fixture
can be overridden this way even if the test doesn’t use it directly (doesn’t mention it in the function prototype).</p>
</section>
<section id="override-a-parametrized-fixture-with-non-parametrized-one-and-vice-versa">
<h3>Override a parametrized fixture with non-parametrized one and vice versa<a class="headerlink" href="#override-a-parametrized-fixture-with-non-parametrized-one-and-vice-versa" title="Permalink to this heading">¶</a></h3>
<p>Given the tests file structure is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tests</span><span class="o">/</span>
    <span class="n">conftest</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># content of tests/conftest.py</span>
        <span class="kn">import</span> <span class="nn">pytest</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">'one'</span><span class="p">,</span> <span class="s1">'two'</span><span class="p">,</span> <span class="s1">'three'</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">parametrized_username</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
        <span class="k">def</span> <span class="nf">non_parametrized_username</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">'username'</span>

    <span class="n">test_something</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># content of tests/test_something.py</span>
        <span class="kn">import</span> <span class="nn">pytest</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
        <span class="k">def</span> <span class="nf">parametrized_username</span><span class="p">():</span>
            <span class="k">return</span> <span class="s1">'overridden-username'</span>

        <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s1">'one'</span><span class="p">,</span> <span class="s1">'two'</span><span class="p">,</span> <span class="s1">'three'</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">non_parametrized_username</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">param</span>

        <span class="k">def</span> <span class="nf">test_username</span><span class="p">(</span><span class="n">parametrized_username</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">parametrized_username</span> <span class="o">==</span> <span class="s1">'overridden-username'</span>

        <span class="k">def</span> <span class="nf">test_parametrized_username</span><span class="p">(</span><span class="n">non_parametrized_username</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">non_parametrized_username</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'one'</span><span class="p">,</span> <span class="s1">'two'</span><span class="p">,</span> <span class="s1">'three'</span><span class="p">]</span>

    <span class="n">test_something_else</span><span class="o">.</span><span class="n">py</span>
        <span class="c1"># content of tests/test_something_else.py</span>
        <span class="k">def</span> <span class="nf">test_username</span><span class="p">(</span><span class="n">parametrized_username</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">parametrized_username</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'one'</span><span class="p">,</span> <span class="s1">'two'</span><span class="p">,</span> <span class="s1">'three'</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">test_username</span><span class="p">(</span><span class="n">non_parametrized_username</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">non_parametrized_username</span> <span class="o">==</span> <span class="s1">'username'</span>
</pre></div>
</div>
<p>In the example above, a parametrized fixture is overridden with a non-parametrized version, and
a non-parametrized fixture is overridden with a parametrized version for certain test module.
The same applies for the test folder level obviously.</p>
</section>
</section>
<section id="using-fixtures-from-other-projects">
<h2>Using fixtures from other projects<a class="headerlink" href="#using-fixtures-from-other-projects" title="Permalink to this heading">¶</a></h2>
<p>Usually projects that provide pytest support will use <a class="reference internal" href="writing_plugins.html#setuptools-entry-points"><span class="std std-ref">entry points</span></a>,
so just installing those projects into an environment will make those fixtures available for use.</p>
<p>In case you want to use fixtures from a project that does not use entry points, you can
define <a class="reference internal" href="../reference/reference.html#globalvar-pytest_plugins"><code class="xref std std-globalvar docutils literal notranslate"><span class="pre">pytest_plugins</span></code></a> in your top <code class="docutils literal notranslate"><span class="pre">conftest.py</span></code> file to register that module
as a plugin.</p>
<p>Suppose you have some fixtures in <code class="docutils literal notranslate"><span class="pre">mylibrary.fixtures</span></code> and you want to reuse them into your
<code class="docutils literal notranslate"><span class="pre">app/tests</span></code> directory.</p>
<p>All you need to do is to define <a class="reference internal" href="../reference/reference.html#globalvar-pytest_plugins"><code class="xref std std-globalvar docutils literal notranslate"><span class="pre">pytest_plugins</span></code></a> in <code class="docutils literal notranslate"><span class="pre">app/tests/conftest.py</span></code>
pointing to that module.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pytest_plugins</span> <span class="o">=</span> <span class="s2">"mylibrary.fixtures"</span>
</pre></div>
</div>
<p>This effectively registers <code class="docutils literal notranslate"><span class="pre">mylibrary.fixtures</span></code> as a plugin, making all its fixtures and
hooks available to tests in <code class="docutils literal notranslate"><span class="pre">app/tests</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Sometimes users will <em>import</em> fixtures from other projects for use, however this is not
recommended: importing fixtures into a module will register them in pytest
as <em>defined</em> in that module.</p>
<p>This has minor consequences, such as appearing multiple times in <code class="docutils literal notranslate"><span class="pre">pytest</span> <span class="pre">--help</span></code>,
but it is not <strong>recommended</strong> because this behavior might change/stop working
in future versions.</p>
</div>
</section>
</section>
<div class="clearer"></div>
</div>
</div>
<span id="sidebar-top"></span>
<div class="clearer"></div>
</div>
<div class="footer" role="contentinfo">
        © Copyright 2015, holger krekel and pytest-dev team.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
    </div>
<script src="../_static/version_warning_offset.js"></script>
</body>
</html>