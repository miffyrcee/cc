


<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>_pytest.config &#8212; pytest documentation</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/pygments_pytest.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <script>DOCUMENTATION_OPTIONS.URL_ROOT = '../../';</script>
   
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../contents.html">pytest-6.2</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">_pytest.config</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <h1>Source code for _pytest.config</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Command line options, ini-file and conftest.py processing.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">collections.abc</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shlex</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">lru_cache</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">TracebackType</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Generator</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">IO</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterator</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Sequence</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Set</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TextIO</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Type</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">import</span> <span class="nn">py</span>
<span class="kn">from</span> <span class="nn">pluggy</span> <span class="kn">import</span> <span class="n">HookimplMarker</span>
<span class="kn">from</span> <span class="nn">pluggy</span> <span class="kn">import</span> <span class="n">HookspecMarker</span>
<span class="kn">from</span> <span class="nn">pluggy</span> <span class="kn">import</span> <span class="n">PluginManager</span>

<span class="kn">import</span> <span class="nn">_pytest._code</span>
<span class="kn">import</span> <span class="nn">_pytest.deprecated</span>
<span class="kn">import</span> <span class="nn">_pytest.hookspec</span>
<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="n">PrintHelp</span> <span class="k">as</span> <span class="n">PrintHelp</span>
<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="n">UsageError</span> <span class="k">as</span> <span class="n">UsageError</span>
<span class="kn">from</span> <span class="nn">.findpaths</span> <span class="kn">import</span> <span class="n">determine_setup</span>
<span class="kn">from</span> <span class="nn">_pytest._code</span> <span class="kn">import</span> <span class="n">ExceptionInfo</span>
<span class="kn">from</span> <span class="nn">_pytest._code</span> <span class="kn">import</span> <span class="n">filter_traceback</span>
<span class="kn">from</span> <span class="nn">_pytest._io</span> <span class="kn">import</span> <span class="n">TerminalWriter</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">final</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">importlib_metadata</span>
<span class="kn">from</span> <span class="nn">_pytest.outcomes</span> <span class="kn">import</span> <span class="n">fail</span>
<span class="kn">from</span> <span class="nn">_pytest.outcomes</span> <span class="kn">import</span> <span class="n">Skipped</span>
<span class="kn">from</span> <span class="nn">_pytest.pathlib</span> <span class="kn">import</span> <span class="n">bestrelpath</span>
<span class="kn">from</span> <span class="nn">_pytest.pathlib</span> <span class="kn">import</span> <span class="n">import_path</span>
<span class="kn">from</span> <span class="nn">_pytest.pathlib</span> <span class="kn">import</span> <span class="n">ImportMode</span>
<span class="kn">from</span> <span class="nn">_pytest.store</span> <span class="kn">import</span> <span class="n">Store</span>
<span class="kn">from</span> <span class="nn">_pytest.warning_types</span> <span class="kn">import</span> <span class="n">PytestConfigWarning</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>

    <span class="kn">from</span> <span class="nn">_pytest._code.code</span> <span class="kn">import</span> <span class="n">_TracebackStyle</span>
    <span class="kn">from</span> <span class="nn">_pytest.terminal</span> <span class="kn">import</span> <span class="n">TerminalReporter</span>
    <span class="kn">from</span> <span class="nn">.argparsing</span> <span class="kn">import</span> <span class="n">Argument</span>


<span class="n">_PluggyPlugin</span> <span class="o">=</span> <span class="nb">object</span>
<span class="sd">&quot;&quot;&quot;A type to represent plugin objects.</span>

<span class="sd">Plugins can be any namespace, so we can&#39;t narrow it down much, but we use an</span>
<span class="sd">alias to make the intent clear.</span>

<span class="sd">Ideally this type would be provided by pluggy itself.</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="n">hookimpl</span> <span class="o">=</span> <span class="n">HookimplMarker</span><span class="p">(</span><span class="s2">&quot;pytest&quot;</span><span class="p">)</span>
<span class="n">hookspec</span> <span class="o">=</span> <span class="n">HookspecMarker</span><span class="p">(</span><span class="s2">&quot;pytest&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="ExitCode"><a class="viewcode-back" href="../../reference.html#pytest.ExitCode">[docs]</a><span class="nd">@final</span>
<span class="k">class</span> <span class="nc">ExitCode</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Encodes the valid exit codes by pytest.</span>

<span class="sd">    Currently users and plugins may supply other exit codes as well.</span>

<span class="sd">    .. versionadded:: 5.0</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#: Tests passed.</span>
    <span class="n">OK</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1">#: Tests failed.</span>
    <span class="n">TESTS_FAILED</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1">#: pytest was interrupted.</span>
    <span class="n">INTERRUPTED</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="c1">#: An internal error got in the way.</span>
    <span class="n">INTERNAL_ERROR</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="c1">#: pytest was misused.</span>
    <span class="n">USAGE_ERROR</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="c1">#: pytest couldn&#39;t find tests.</span>
    <span class="n">NO_TESTS_COLLECTED</span> <span class="o">=</span> <span class="mi">5</span></div>


<span class="k">class</span> <span class="nc">ConftestImportFailure</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">,</span>
        <span class="n">excinfo</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="ne">Exception</span><span class="p">],</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">TracebackType</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">excinfo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">excinfo</span> <span class="o">=</span> <span class="n">excinfo</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2"> (from </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">excinfo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">excinfo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">filter_traceback_for_conftest_import_failure</span><span class="p">(</span>
    <span class="n">entry</span><span class="p">:</span> <span class="n">_pytest</span><span class="o">.</span><span class="n">_code</span><span class="o">.</span><span class="n">TracebackEntry</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Filter tracebacks entries which point to pytest internals or importlib.</span>

<span class="sd">    Make a special case for importlib because we use it to import test modules and conftest files</span>
<span class="sd">    in _pytest.pathlib.import_path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">filter_traceback</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;importlib&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../reference.html#pytest.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">plugins</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_PluggyPlugin</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">ExitCode</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Perform an in-process test run.</span>

<span class="sd">    :param args: List of command line arguments.</span>
<span class="sd">    :param plugins: List of plugin objects to be auto-registered during initialization.</span>

<span class="sd">    :returns: An exit code.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">_prepareconfig</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">plugins</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ConftestImportFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">exc_info</span> <span class="o">=</span> <span class="n">ExceptionInfo</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">excinfo</span><span class="p">)</span>
            <span class="n">tw</span> <span class="o">=</span> <span class="n">TerminalWriter</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="n">tw</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ImportError while loading conftest &#39;</span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">,</span> <span class="n">red</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">exc_info</span><span class="o">.</span><span class="n">traceback</span> <span class="o">=</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">traceback</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">filter_traceback_for_conftest_import_failure</span>
            <span class="p">)</span>
            <span class="n">exc_repr</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">exc_info</span><span class="o">.</span><span class="n">getrepr</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;short&quot;</span><span class="p">,</span> <span class="n">chain</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">traceback</span>
                <span class="k">else</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">exconly</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">formatted_tb</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc_repr</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">formatted_tb</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
                <span class="n">tw</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(),</span> <span class="n">red</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ExitCode</span><span class="o">.</span><span class="n">USAGE_ERROR</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ret</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ExitCode</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">pytest_cmdline_main</span><span class="p">(</span>
                    <span class="n">config</span><span class="o">=</span><span class="n">config</span>
                <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ExitCode</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ret</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">config</span><span class="o">.</span><span class="n">_ensure_unconfigure</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">UsageError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">tw</span> <span class="o">=</span> <span class="n">TerminalWriter</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">tw</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">red</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ExitCode</span><span class="o">.</span><span class="n">USAGE_ERROR</span></div>


<span class="k">def</span> <span class="nf">console_main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;The CLI entry point of pytest.</span>

<span class="sd">    This function is not meant for programmable use; use `main()` instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># https://docs.python.org/3/library/signal.html#note-on-sigpipe</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">main</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">code</span>
    <span class="k">except</span> <span class="ne">BrokenPipeError</span><span class="p">:</span>
        <span class="c1"># Python flushes standard streams on exit; redirect remaining output</span>
        <span class="c1"># to devnull to avoid another BrokenPipeError at shutdown</span>
        <span class="n">devnull</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_WRONLY</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">devnull</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
        <span class="k">return</span> <span class="mi">1</span>  <span class="c1"># Python exits with error code 1 on EPIPE</span>


<span class="k">class</span> <span class="nc">cmdline</span><span class="p">:</span>  <span class="c1"># compatibility namespace</span>
    <span class="n">main</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">filename_arg</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">optname</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Argparse type validator for filename arguments.</span>

<span class="sd">    :path: Path of filename.</span>
<span class="sd">    :optname: Name of the option.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">UsageError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">optname</span><span class="si">}</span><span class="s2"> must be a filename, given: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">path</span>


<span class="k">def</span> <span class="nf">directory_arg</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">optname</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Argparse type validator for directory arguments.</span>

<span class="sd">    :path: Path of directory.</span>
<span class="sd">    :optname: Name of the option.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">UsageError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">optname</span><span class="si">}</span><span class="s2"> must be a directory, given: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">path</span>


<span class="c1"># Plugins that cannot be disabled via &quot;-p no:X&quot; currently.</span>
<span class="n">essential_plugins</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;mark&quot;</span><span class="p">,</span>
    <span class="s2">&quot;main&quot;</span><span class="p">,</span>
    <span class="s2">&quot;runner&quot;</span><span class="p">,</span>
    <span class="s2">&quot;fixtures&quot;</span><span class="p">,</span>
    <span class="s2">&quot;helpconfig&quot;</span><span class="p">,</span>  <span class="c1"># Provides -p.</span>
<span class="p">)</span>

<span class="n">default_plugins</span> <span class="o">=</span> <span class="n">essential_plugins</span> <span class="o">+</span> <span class="p">(</span>
    <span class="s2">&quot;python&quot;</span><span class="p">,</span>
    <span class="s2">&quot;terminal&quot;</span><span class="p">,</span>
    <span class="s2">&quot;debugging&quot;</span><span class="p">,</span>
    <span class="s2">&quot;unittest&quot;</span><span class="p">,</span>
    <span class="s2">&quot;capture&quot;</span><span class="p">,</span>
    <span class="s2">&quot;skipping&quot;</span><span class="p">,</span>
    <span class="s2">&quot;tmpdir&quot;</span><span class="p">,</span>
    <span class="s2">&quot;monkeypatch&quot;</span><span class="p">,</span>
    <span class="s2">&quot;recwarn&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pastebin&quot;</span><span class="p">,</span>
    <span class="s2">&quot;nose&quot;</span><span class="p">,</span>
    <span class="s2">&quot;assertion&quot;</span><span class="p">,</span>
    <span class="s2">&quot;junitxml&quot;</span><span class="p">,</span>
    <span class="s2">&quot;doctest&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cacheprovider&quot;</span><span class="p">,</span>
    <span class="s2">&quot;freeze_support&quot;</span><span class="p">,</span>
    <span class="s2">&quot;setuponly&quot;</span><span class="p">,</span>
    <span class="s2">&quot;setupplan&quot;</span><span class="p">,</span>
    <span class="s2">&quot;stepwise&quot;</span><span class="p">,</span>
    <span class="s2">&quot;warnings&quot;</span><span class="p">,</span>
    <span class="s2">&quot;logging&quot;</span><span class="p">,</span>
    <span class="s2">&quot;reports&quot;</span><span class="p">,</span>
    <span class="o">*</span><span class="p">([</span><span class="s2">&quot;unraisableexception&quot;</span><span class="p">,</span> <span class="s2">&quot;threadexception&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]),</span>
    <span class="s2">&quot;faulthandler&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">builtin_plugins</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">default_plugins</span><span class="p">)</span>
<span class="n">builtin_plugins</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;pytester&quot;</span><span class="p">)</span>
<span class="n">builtin_plugins</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;pytester_assertions&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">plugins</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_PluggyPlugin</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Config&quot;</span><span class="p">:</span>
    <span class="c1"># subsequent calls to main will create a fresh instance</span>
    <span class="n">pluginmanager</span> <span class="o">=</span> <span class="n">PytestPluginManager</span><span class="p">()</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span>
        <span class="n">pluginmanager</span><span class="p">,</span>
        <span class="n">invocation_params</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">InvocationParams</span><span class="p">(</span>
            <span class="n">args</span><span class="o">=</span><span class="n">args</span> <span class="ow">or</span> <span class="p">(),</span> <span class="n">plugins</span><span class="o">=</span><span class="n">plugins</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">(),</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Handle any &quot;-p no:plugin&quot; args.</span>
        <span class="n">pluginmanager</span><span class="o">.</span><span class="n">consider_preparse</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">exclude_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">default_plugins</span><span class="p">:</span>
        <span class="n">pluginmanager</span><span class="o">.</span><span class="n">import_plugin</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">config</span>


<span class="k">def</span> <span class="nf">get_plugin_manager</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="s2">&quot;PytestPluginManager&quot;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Obtain a new instance of the</span>
<span class="sd">    :py:class:`_pytest.config.PytestPluginManager`, with default plugins</span>
<span class="sd">    already loaded.</span>

<span class="sd">    This function can be used by integration with other tools, like hooking</span>
<span class="sd">    into pytest to run tests into an IDE.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">get_config</span><span class="p">()</span><span class="o">.</span><span class="n">pluginmanager</span>


<span class="k">def</span> <span class="nf">_prepareconfig</span><span class="p">(</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">plugins</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_PluggyPlugin</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Config&quot;</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;`args` parameter expected to be a list of strings, got: </span><span class="si">{!r}</span><span class="s2"> (type: </span><span class="si">{}</span><span class="s2">)&quot;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">args</span><span class="p">)))</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">plugins</span><span class="p">)</span>
    <span class="n">pluginmanager</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">pluginmanager</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">plugins</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="n">plugins</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">pluginmanager</span><span class="o">.</span><span class="n">consider_pluginarg</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pluginmanager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">pluginmanager</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">pytest_cmdline_parse</span><span class="p">(</span>
            <span class="n">pluginmanager</span><span class="o">=</span><span class="n">pluginmanager</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">config</span>
    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">_ensure_unconfigure</span><span class="p">()</span>
        <span class="k">raise</span>


<div class="viewcode-block" id="PytestPluginManager"><a class="viewcode-back" href="../../reference.html#pytest.PytestPluginManager">[docs]</a><span class="nd">@final</span>
<span class="k">class</span> <span class="nc">PytestPluginManager</span><span class="p">(</span><span class="n">PluginManager</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A :py:class:`pluggy.PluginManager &lt;pluggy.PluginManager&gt;` with</span>
<span class="sd">    additional pytest-specific functionality:</span>

<span class="sd">    * Loading plugins from the command line, ``PYTEST_PLUGINS`` env variable and</span>
<span class="sd">      ``pytest_plugins`` global variables found in plugins being loaded.</span>
<span class="sd">    * ``conftest.py`` loading during start-up.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">_pytest.assertion</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;pytest&quot;</span><span class="p">)</span>
        <span class="c1"># The objects are module objects, only used generically.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conftest_plugins</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># State related to local conftest plugins.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dirpath2confmods</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conftestpath2mod</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_confcutdir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_noconftest</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_duplicatepaths</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># plugins that were explicitly skipped with pytest.skip</span>
        <span class="c1"># list of (module name, skip reason)</span>
        <span class="c1"># previously we would issue a warning when a plugin was skipped, but</span>
        <span class="c1"># since we refactored warnings as first citizens of Config, they are</span>
        <span class="c1"># just stored here to be used later.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skipped_plugins</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_hookspecs</span><span class="p">(</span><span class="n">_pytest</span><span class="o">.</span><span class="n">hookspec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PYTEST_DEBUG&quot;</span><span class="p">):</span>
            <span class="n">err</span><span class="p">:</span> <span class="n">IO</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>
            <span class="n">encoding</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s2">&quot;encoding&quot;</span><span class="p">,</span> <span class="s2">&quot;utf8&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">fileno</span><span class="p">()),</span> <span class="n">mode</span><span class="o">=</span><span class="n">err</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">buffering</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">setwriter</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">write</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enable_tracing</span><span class="p">()</span>

        <span class="c1"># Config._consider_importhook will set a real object if required.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rewrite_hook</span> <span class="o">=</span> <span class="n">_pytest</span><span class="o">.</span><span class="n">assertion</span><span class="o">.</span><span class="n">DummyRewriteHook</span><span class="p">()</span>
        <span class="c1"># Used to know when we are importing conftests after the pytest_configure stage.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configured</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="PytestPluginManager.parse_hookimpl_opts"><a class="viewcode-back" href="../../reference.html#pytest.PytestPluginManager.parse_hookimpl_opts">[docs]</a>    <span class="k">def</span> <span class="nf">parse_hookimpl_opts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plugin</span><span class="p">:</span> <span class="n">_PluggyPlugin</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># pytest hooks are always prefixed with &quot;pytest_&quot;,</span>
        <span class="c1"># so we avoid accessing possibly non-readable attributes</span>
        <span class="c1"># (see issue #1073).</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;pytest_&quot;</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="c1"># Ignore names which can not be hooks.</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;pytest_plugins&quot;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">parse_hookimpl_opts</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="c1"># Consider only actual functions for hooks (#3775).</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isroutine</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># Collect unmarked hooks as long as they have the `pytest_&#39; prefix.</span>
        <span class="k">if</span> <span class="n">opts</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;pytest_&quot;</span><span class="p">):</span>
            <span class="n">opts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">opts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># TODO: DeprecationWarning, people should use hookimpl</span>
            <span class="c1"># https://github.com/pytest-dev/pytest/issues/4562</span>
            <span class="n">known_marks</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="s2">&quot;pytestmark&quot;</span><span class="p">,</span> <span class="p">[])}</span>

            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;tryfirst&quot;</span><span class="p">,</span> <span class="s2">&quot;trylast&quot;</span><span class="p">,</span> <span class="s2">&quot;optionalhook&quot;</span><span class="p">,</span> <span class="s2">&quot;hookwrapper&quot;</span><span class="p">):</span>
                <span class="n">opts</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">known_marks</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">opts</span></div>

<div class="viewcode-block" id="PytestPluginManager.parse_hookspec_opts"><a class="viewcode-back" href="../../reference.html#pytest.PytestPluginManager.parse_hookspec_opts">[docs]</a>    <span class="k">def</span> <span class="nf">parse_hookspec_opts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_or_class</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">parse_hookspec_opts</span><span class="p">(</span><span class="n">module_or_class</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">opts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module_or_class</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;pytest_&quot;</span><span class="p">):</span>
                <span class="c1"># todo: deprecate hookspec hacks</span>
                <span class="c1"># https://github.com/pytest-dev/pytest/issues/4562</span>
                <span class="n">known_marks</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="s2">&quot;pytestmark&quot;</span><span class="p">,</span> <span class="p">[])}</span>
                <span class="n">opts</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;firstresult&quot;</span><span class="p">:</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="s2">&quot;firstresult&quot;</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="s2">&quot;firstresult&quot;</span> <span class="ow">in</span> <span class="n">known_marks</span><span class="p">,</span>
                    <span class="s2">&quot;historic&quot;</span><span class="p">:</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="s2">&quot;historic&quot;</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="s2">&quot;historic&quot;</span> <span class="ow">in</span> <span class="n">known_marks</span><span class="p">,</span>
                <span class="p">}</span>
        <span class="k">return</span> <span class="n">opts</span></div>

<div class="viewcode-block" id="PytestPluginManager.register"><a class="viewcode-back" href="../../reference.html#pytest.PytestPluginManager.register">[docs]</a>    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">plugin</span><span class="p">:</span> <span class="n">_PluggyPlugin</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">_pytest</span><span class="o">.</span><span class="n">deprecated</span><span class="o">.</span><span class="n">DEPRECATED_EXTERNAL_PLUGINS</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="n">PytestConfigWarning</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> plugin has been merged into the core, &quot;</span>
                    <span class="s2">&quot;please remove it from your requirements.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">ret</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">pytest_plugin_registered</span><span class="o">.</span><span class="n">call_historic</span><span class="p">(</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">plugin</span><span class="o">=</span><span class="n">plugin</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plugin</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">consider_module</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div>

<div class="viewcode-block" id="PytestPluginManager.getplugin"><a class="viewcode-back" href="../../reference.html#pytest.PytestPluginManager.getplugin">[docs]</a>    <span class="k">def</span> <span class="nf">getplugin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># Support deprecated naming because plugins (xdist e.g.) use it.</span>
        <span class="n">plugin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_PluggyPlugin</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_plugin</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">plugin</span></div>

<div class="viewcode-block" id="PytestPluginManager.hasplugin"><a class="viewcode-back" href="../../reference.html#pytest.PytestPluginManager.hasplugin">[docs]</a>    <span class="k">def</span> <span class="nf">hasplugin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return whether a plugin with the given name is registered.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_plugin</span><span class="p">(</span><span class="n">name</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">pytest_configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="s2">&quot;Config&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;:meta private:&quot;&quot;&quot;</span>
        <span class="c1"># XXX now that the pluginmanager exposes hookimpl(tryfirst...)</span>
        <span class="c1"># we should remove tryfirst/trylast as markers.</span>
        <span class="n">config</span><span class="o">.</span><span class="n">addinivalue_line</span><span class="p">(</span>
            <span class="s2">&quot;markers&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tryfirst: mark a hook implementation function such that the &quot;</span>
            <span class="s2">&quot;plugin machinery will try to call it first/as early as possible.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">addinivalue_line</span><span class="p">(</span>
            <span class="s2">&quot;markers&quot;</span><span class="p">,</span>
            <span class="s2">&quot;trylast: mark a hook implementation function such that the &quot;</span>
            <span class="s2">&quot;plugin machinery will try to call it last/as late as possible.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configured</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1">#</span>
    <span class="c1"># Internal API for local conftest plugin handling.</span>
    <span class="c1">#</span>
    <span class="k">def</span> <span class="nf">_set_initial_conftests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Load initial conftest files given a preparsed &quot;namespace&quot;.</span>

<span class="sd">        As conftest files may add their own command line options which have</span>
<span class="sd">        arguments (&#39;--my-opt somepath&#39;) we might get some false positives.</span>
<span class="sd">        All builtin and 3rd party plugins will have been loaded, however, so</span>
<span class="sd">        common options will not confuse our logic here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_confcutdir</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">current</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">namespace</span><span class="o">.</span><span class="n">confcutdir</span><span class="p">,</span> <span class="nb">abs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">namespace</span><span class="o">.</span><span class="n">confcutdir</span>
            <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_noconftest</span> <span class="o">=</span> <span class="n">namespace</span><span class="o">.</span><span class="n">noconftest</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_using_pyargs</span> <span class="o">=</span> <span class="n">namespace</span><span class="o">.</span><span class="n">pyargs</span>
        <span class="n">testpaths</span> <span class="o">=</span> <span class="n">namespace</span><span class="o">.</span><span class="n">file_or_dir</span>
        <span class="n">foundanchor</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">testpath</span> <span class="ow">in</span> <span class="n">testpaths</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">testpath</span><span class="p">)</span>
            <span class="c1"># remove node-id syntax</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;::&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
            <span class="n">anchor</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">abs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">anchor</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>  <span class="c1"># we found some file object</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_try_load_conftest</span><span class="p">(</span><span class="n">anchor</span><span class="p">,</span> <span class="n">namespace</span><span class="o">.</span><span class="n">importmode</span><span class="p">)</span>
                <span class="n">foundanchor</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">foundanchor</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_try_load_conftest</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">namespace</span><span class="o">.</span><span class="n">importmode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_try_load_conftest</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">anchor</span><span class="p">:</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">,</span> <span class="n">importmode</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ImportMode</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_getconftestmodules</span><span class="p">(</span><span class="n">anchor</span><span class="p">,</span> <span class="n">importmode</span><span class="p">)</span>
        <span class="c1"># let&#39;s also consider test* subdirs</span>
        <span class="k">if</span> <span class="n">anchor</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">anchor</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s2">&quot;test*&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_getconftestmodules</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">importmode</span><span class="p">)</span>

    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_getconftestmodules</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">,</span> <span class="n">importmode</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ImportMode</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_noconftest</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">():</span>
            <span class="n">directory</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">dirpath</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">directory</span> <span class="o">=</span> <span class="n">path</span>

        <span class="c1"># XXX these days we may rather want to use config.rootpath</span>
        <span class="c1"># and allow users to opt into looking into the rootdir parent</span>
        <span class="c1"># directories instead of requiring to specify confcutdir.</span>
        <span class="n">clist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">directory</span><span class="o">.</span><span class="n">parts</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_confcutdir</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_confcutdir</span><span class="o">.</span><span class="n">relto</span><span class="p">(</span><span class="n">parent</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">conftestpath</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;conftest.py&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">conftestpath</span><span class="o">.</span><span class="n">isfile</span><span class="p">():</span>
                <span class="n">mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_importconftest</span><span class="p">(</span><span class="n">conftestpath</span><span class="p">,</span> <span class="n">importmode</span><span class="p">)</span>
                <span class="n">clist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dirpath2confmods</span><span class="p">[</span><span class="n">directory</span><span class="p">]</span> <span class="o">=</span> <span class="n">clist</span>
        <span class="k">return</span> <span class="n">clist</span>

    <span class="k">def</span> <span class="nf">_rget_with_confmod</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">,</span> <span class="n">importmode</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ImportMode</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">modules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getconftestmodules</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">importmode</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">modules</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">mod</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_importconftest</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">conftestpath</span><span class="p">:</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">,</span> <span class="n">importmode</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ImportMode</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">:</span>
        <span class="c1"># Use a resolved Path object as key to avoid loading the same conftest</span>
        <span class="c1"># twice with build systems that create build directories containing</span>
        <span class="c1"># symlinks to actual files.</span>
        <span class="c1"># Using Path().resolve() is better than py.path.realpath because</span>
        <span class="c1"># it resolves to the correct path/drive in case-insensitive file systems (#5792)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">conftestpath</span><span class="p">))</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conftestpath2mod</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">pkgpath</span> <span class="o">=</span> <span class="n">conftestpath</span><span class="o">.</span><span class="n">pypkgpath</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pkgpath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_ensure_removed_sysmodule</span><span class="p">(</span><span class="n">conftestpath</span><span class="o">.</span><span class="n">purebasename</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">import_path</span><span class="p">(</span><span class="n">conftestpath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">importmode</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">e</span><span class="o">.</span><span class="n">__traceback__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">exc_info</span> <span class="o">=</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">e</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ConftestImportFailure</span><span class="p">(</span><span class="n">conftestpath</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_non_top_pytest_plugins</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">conftestpath</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_conftest_plugins</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conftestpath2mod</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod</span>
        <span class="n">dirpath</span> <span class="o">=</span> <span class="n">conftestpath</span><span class="o">.</span><span class="n">dirpath</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dirpath</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirpath2confmods</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">mods</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirpath2confmods</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">path</span> <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">relto</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span> <span class="ow">or</span> <span class="n">path</span> <span class="o">==</span> <span class="n">dirpath</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">mod</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mods</span>
                    <span class="n">mods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;loading conftestmodule </span><span class="si">{</span><span class="n">mod</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consider_conftest</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mod</span>

    <span class="k">def</span> <span class="nf">_check_non_top_pytest_plugins</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">mod</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">,</span> <span class="n">conftestpath</span><span class="p">:</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s2">&quot;pytest_plugins&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configured</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_using_pyargs</span>
        <span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Defining &#39;pytest_plugins&#39; in a non-top-level conftest is no longer supported:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;It affects the entire test suite instead of just below the conftest as expected.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;  </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Please move it to a top level conftest file at the rootdir:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;  </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;For more information, visit:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;  https://docs.pytest.org/en/stable/deprecations.html#pytest-plugins-in-non-top-level-conftest-files&quot;</span>
            <span class="p">)</span>
            <span class="n">fail</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">conftestpath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_confcutdir</span><span class="p">),</span> <span class="n">pytrace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># API for bootstrapping plugin loading</span>
    <span class="c1">#</span>
    <span class="c1">#</span>

<div class="viewcode-block" id="PytestPluginManager.consider_preparse"><a class="viewcode-back" href="../../reference.html#pytest.PytestPluginManager.consider_preparse">[docs]</a>    <span class="k">def</span> <span class="nf">consider_preparse</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">exclude_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="s2">&quot;-p&quot;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">parg</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                        <span class="k">return</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">opt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-p&quot;</span><span class="p">):</span>
                    <span class="n">parg</span> <span class="o">=</span> <span class="n">opt</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">exclude_only</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">parg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;no:&quot;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">consider_pluginarg</span><span class="p">(</span><span class="n">parg</span><span class="p">)</span></div>

<div class="viewcode-block" id="PytestPluginManager.consider_pluginarg"><a class="viewcode-back" href="../../reference.html#pytest.PytestPluginManager.consider_pluginarg">[docs]</a>    <span class="k">def</span> <span class="nf">consider_pluginarg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;no:&quot;</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">essential_plugins</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UsageError</span><span class="p">(</span><span class="s2">&quot;plugin </span><span class="si">%s</span><span class="s2"> cannot be disabled&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

            <span class="c1"># PR #4304: remove stepwise if cacheprovider is blocked.</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;cacheprovider&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_blocked</span><span class="p">(</span><span class="s2">&quot;stepwise&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_blocked</span><span class="p">(</span><span class="s2">&quot;pytest_stepwise&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">set_blocked</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;pytest_&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_blocked</span><span class="p">(</span><span class="s2">&quot;pytest_&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">arg</span>
            <span class="c1"># Unblock the plugin.  None indicates that it has been blocked.</span>
            <span class="c1"># There is no interface with pluggy for this.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name2plugin</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name2plugin</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;pytest_&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name2plugin</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pytest_&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name2plugin</span><span class="p">[</span><span class="s2">&quot;pytest_&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">import_plugin</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">consider_entry_points</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="PytestPluginManager.consider_conftest"><a class="viewcode-back" href="../../reference.html#pytest.PytestPluginManager.consider_conftest">[docs]</a>    <span class="k">def</span> <span class="nf">consider_conftest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conftestmodule</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">conftestmodule</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">conftestmodule</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span></div>

<div class="viewcode-block" id="PytestPluginManager.consider_env"><a class="viewcode-back" href="../../reference.html#pytest.PytestPluginManager.consider_env">[docs]</a>    <span class="k">def</span> <span class="nf">consider_env</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_import_plugin_specs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PYTEST_PLUGINS&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="PytestPluginManager.consider_module"><a class="viewcode-back" href="../../reference.html#pytest.PytestPluginManager.consider_module">[docs]</a>    <span class="k">def</span> <span class="nf">consider_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mod</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_import_plugin_specs</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s2">&quot;pytest_plugins&quot;</span><span class="p">,</span> <span class="p">[]))</span></div>

    <span class="k">def</span> <span class="nf">_import_plugin_specs</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plugins</span> <span class="o">=</span> <span class="n">_get_plugin_specs_as_list</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">import_spec</span> <span class="ow">in</span> <span class="n">plugins</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">import_plugin</span><span class="p">(</span><span class="n">import_spec</span><span class="p">)</span>

<div class="viewcode-block" id="PytestPluginManager.import_plugin"><a class="viewcode-back" href="../../reference.html#pytest.PytestPluginManager.import_plugin">[docs]</a>    <span class="k">def</span> <span class="nf">import_plugin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">consider_entry_points</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Import a plugin with ``modname``.</span>

<span class="sd">        If ``consider_entry_points`` is True, entry point names are also</span>
<span class="sd">        considered to find a plugin.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Most often modname refers to builtin modules, e.g. &quot;pytester&quot;,</span>
        <span class="c1"># &quot;terminal&quot; or &quot;capture&quot;.  Those plugins are registered under their</span>
        <span class="c1"># basename for historic purposes but must be imported with the</span>
        <span class="c1"># _pytest prefix.</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">modname</span><span class="p">,</span> <span class="nb">str</span><span class="p">),</span> <span class="p">(</span>
            <span class="s2">&quot;module name as text required, got </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">modname</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_blocked</span><span class="p">(</span><span class="n">modname</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_plugin</span><span class="p">(</span><span class="n">modname</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">importspec</span> <span class="o">=</span> <span class="s2">&quot;_pytest.&quot;</span> <span class="o">+</span> <span class="n">modname</span> <span class="k">if</span> <span class="n">modname</span> <span class="ow">in</span> <span class="n">builtin_plugins</span> <span class="k">else</span> <span class="n">modname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rewrite_hook</span><span class="o">.</span><span class="n">mark_rewrite</span><span class="p">(</span><span class="n">importspec</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">consider_entry_points</span><span class="p">:</span>
            <span class="n">loaded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_setuptools_entrypoints</span><span class="p">(</span><span class="s2">&quot;pytest11&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">modname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">loaded</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="nb">__import__</span><span class="p">(</span><span class="n">importspec</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s1">&#39;Error importing plugin &quot;</span><span class="si">{}</span><span class="s1">&quot;: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">modname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="p">)</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="k">except</span> <span class="n">Skipped</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skipped_plugins</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">modname</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">msg</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">importspec</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">modname</span><span class="p">)</span></div></div>


<span class="k">def</span> <span class="nf">_get_plugin_specs_as_list</span><span class="p">(</span>
    <span class="n">specs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Parse a plugins specification into a list of plugin names.&quot;&quot;&quot;</span>
    <span class="c1"># None means empty.</span>
    <span class="k">if</span> <span class="n">specs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="c1"># Workaround for #3899 - a submodule which happens to be called &quot;pytest_plugins&quot;.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="c1"># Comma-separated list.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">specs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">specs</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="c1"># Direct specification.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">UsageError</span><span class="p">(</span>
        <span class="s2">&quot;Plugins may be specified as a sequence or a &#39;,&#39;-separated string of plugin names. Got: </span><span class="si">%r</span><span class="s2">&quot;</span>
        <span class="o">%</span> <span class="n">specs</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_ensure_removed_sysmodule</span><span class="p">(</span><span class="n">modname</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">modname</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">Notset</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;NOTSET&gt;&quot;</span>


<span class="n">notset</span> <span class="o">=</span> <span class="n">Notset</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_iter_rewritable_modules</span><span class="p">(</span><span class="n">package_files</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Given an iterable of file names in a source distribution, return the &quot;names&quot; that should</span>
<span class="sd">    be marked for assertion rewrite.</span>

<span class="sd">    For example the package &quot;pytest_mock/__init__.py&quot; should be added as &quot;pytest_mock&quot; in</span>
<span class="sd">    the assertion rewrite mechanism.</span>

<span class="sd">    This function has to deal with dist-info based distributions and egg based distributions</span>
<span class="sd">    (which are still very much in use for &quot;editable&quot; installs).</span>

<span class="sd">    Here are the file names as seen in a dist-info based distribution:</span>

<span class="sd">        pytest_mock/__init__.py</span>
<span class="sd">        pytest_mock/_version.py</span>
<span class="sd">        pytest_mock/plugin.py</span>
<span class="sd">        pytest_mock.egg-info/PKG-INFO</span>

<span class="sd">    Here are the file names as seen in an egg based distribution:</span>

<span class="sd">        src/pytest_mock/__init__.py</span>
<span class="sd">        src/pytest_mock/_version.py</span>
<span class="sd">        src/pytest_mock/plugin.py</span>
<span class="sd">        src/pytest_mock.egg-info/PKG-INFO</span>
<span class="sd">        LICENSE</span>
<span class="sd">        setup.py</span>

<span class="sd">    We have to take in account those two distribution flavors in order to determine which</span>
<span class="sd">    names should be considered for assertion rewriting.</span>

<span class="sd">    More information:</span>
<span class="sd">        https://github.com/pytest-dev/pytest-mock/issues/167</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">package_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">package_files</span><span class="p">)</span>
    <span class="n">seen_some</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">package_files</span><span class="p">:</span>
        <span class="n">is_simple_module</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fn</span> <span class="ow">and</span> <span class="n">fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.py&quot;</span><span class="p">)</span>
        <span class="n">is_package</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;__init__.py&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_simple_module</span><span class="p">:</span>
            <span class="n">module_name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="c1"># we ignore &quot;setup.py&quot; at the root of the distribution</span>
            <span class="k">if</span> <span class="n">module_name</span> <span class="o">!=</span> <span class="s2">&quot;setup&quot;</span><span class="p">:</span>
                <span class="n">seen_some</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">yield</span> <span class="n">module_name</span>
        <span class="k">elif</span> <span class="n">is_package</span><span class="p">:</span>
            <span class="n">package_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="n">seen_some</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">yield</span> <span class="n">package_name</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">seen_some</span><span class="p">:</span>
        <span class="c1"># At this point we did not find any packages or modules suitable for assertion</span>
        <span class="c1"># rewriting, so we try again by stripping the first path component (to account for</span>
        <span class="c1"># &quot;src&quot; based source trees for example).</span>
        <span class="c1"># This approach lets us have the common case continue to be fast, as egg-distributions</span>
        <span class="c1"># are rarer.</span>
        <span class="n">new_package_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">package_files</span><span class="p">:</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">new_fn</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">if</span> <span class="n">new_fn</span><span class="p">:</span>
                <span class="n">new_package_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_package_files</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="n">_iter_rewritable_modules</span><span class="p">(</span><span class="n">new_package_files</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_args_converter</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>


<div class="viewcode-block" id="Config"><a class="viewcode-back" href="../../reference.html#pytest.Config">[docs]</a><span class="nd">@final</span>
<span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Access to configuration values, pluginmanager and plugin hooks.</span>

<span class="sd">    :param PytestPluginManager pluginmanager:</span>

<span class="sd">    :param InvocationParams invocation_params:</span>
<span class="sd">        Object containing parameters regarding the :func:`pytest.main`</span>
<span class="sd">        invocation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Config.InvocationParams"><a class="viewcode-back" href="../../reference.html#pytest.Config.InvocationParams">[docs]</a>    <span class="nd">@final</span>
    <span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">class</span> <span class="nc">InvocationParams</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Holds parameters passed during :func:`pytest.main`.</span>

<span class="sd">        The object attributes are read-only.</span>

<span class="sd">        .. versionadded:: 5.1</span>

<span class="sd">        .. note::</span>

<span class="sd">            Note that the environment variable ``PYTEST_ADDOPTS`` and the ``addopts``</span>
<span class="sd">            ini option are handled by pytest, not being included in the ``args`` attribute.</span>

<span class="sd">            Plugins accessing ``InvocationParams`` must be aware of that.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">args</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">converter</span><span class="o">=</span><span class="n">_args_converter</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;The command-line arguments as passed to :func:`pytest.main`.</span>

<span class="sd">        :type: Tuple[str, ...]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plugins</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_PluggyPlugin</span><span class="p">]]])</span>
        <span class="sd">&quot;&quot;&quot;Extra plugins, might be `None`.</span>

<span class="sd">        :type: Optional[Sequence[Union[str, plugin]]]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">dir</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;The directory from which :func:`pytest.main` was invoked.</span>

<span class="sd">        :type: pathlib.Path</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pluginmanager</span><span class="p">:</span> <span class="n">PytestPluginManager</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">invocation_params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InvocationParams</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">.argparsing</span> <span class="kn">import</span> <span class="n">Parser</span><span class="p">,</span> <span class="n">FILE_OR_DIR</span>

        <span class="k">if</span> <span class="n">invocation_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">invocation_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">InvocationParams</span><span class="p">(</span>
                <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">plugins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">()</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">option</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;Access to command line option as attributes.</span>

<span class="sd">        :type: argparse.Namespace</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">invocation_params</span> <span class="o">=</span> <span class="n">invocation_params</span>
        <span class="sd">&quot;&quot;&quot;The parameters with which pytest was invoked.</span>

<span class="sd">        :type: InvocationParams</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">_a</span> <span class="o">=</span> <span class="n">FILE_OR_DIR</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span> <span class="o">=</span> <span class="n">Parser</span><span class="p">(</span>
            <span class="n">usage</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;%(prog)s [options] [</span><span class="si">{</span><span class="n">_a</span><span class="si">}</span><span class="s2">] [</span><span class="si">{</span><span class="n">_a</span><span class="si">}</span><span class="s2">] [...]&quot;</span><span class="p">,</span>
            <span class="n">processopt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_processopt</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pluginmanager</span> <span class="o">=</span> <span class="n">pluginmanager</span>
        <span class="sd">&quot;&quot;&quot;The plugin manager handles plugin registration and hook invocation.</span>

<span class="sd">        :type: PytestPluginManager</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">hook</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inicache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_override_ini</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_opt2dest</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># A place where plugins can store information on the config for their</span>
        <span class="c1"># own use. Currently only intended for internal plugins.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store</span> <span class="o">=</span> <span class="n">Store</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;pytestconfig&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configured</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">pytest_addoption</span><span class="o">.</span><span class="n">call_historic</span><span class="p">(</span>
            <span class="n">kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">parser</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="p">,</span> <span class="n">pluginmanager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pluginmanager</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">_pytest.cacheprovider</span> <span class="kn">import</span> <span class="n">Cache</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Cache</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">invocation_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The directory from which pytest was invoked.</span>

<span class="sd">        Prefer to use :attr:`invocation_params.dir &lt;InvocationParams.dir&gt;`,</span>
<span class="sd">        which is a :class:`pathlib.Path`.</span>

<span class="sd">        :type: py.path.local</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invocation_params</span><span class="o">.</span><span class="n">dir</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rootpath</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The path to the :ref:`rootdir &lt;rootdir&gt;`.</span>

<span class="sd">        :type: pathlib.Path</span>

<span class="sd">        .. versionadded:: 6.1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rootpath</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rootdir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The path to the :ref:`rootdir &lt;rootdir&gt;`.</span>

<span class="sd">        Prefer to use :attr:`rootpath`, which is a :class:`pathlib.Path`.</span>

<span class="sd">        :type: py.path.local</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rootpath</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inipath</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;The path to the :ref:`configfile &lt;configfiles&gt;`.</span>

<span class="sd">        :type: Optional[pathlib.Path]</span>

<span class="sd">        .. versionadded:: 6.1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inipath</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inifile</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;The path to the :ref:`configfile &lt;configfiles&gt;`.</span>

<span class="sd">        Prefer to use :attr:`inipath`, which is a :class:`pathlib.Path`.</span>

<span class="sd">        :type: Optional[py.path.local]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inipath</span><span class="p">))</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inipath</span> <span class="k">else</span> <span class="kc">None</span>

<div class="viewcode-block" id="Config.add_cleanup"><a class="viewcode-back" href="../../reference.html#pytest.Config.add_cleanup">[docs]</a>    <span class="k">def</span> <span class="nf">add_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="kc">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add a function to be called when the config object gets out of</span>
<span class="sd">        use (usually coninciding with pytest_unconfigure).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_do_configure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configured</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configured</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">pytest_configure</span><span class="o">.</span><span class="n">call_historic</span><span class="p">(</span><span class="n">kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_ensure_unconfigure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configured</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_configured</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">pytest_unconfigure</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">pytest_configure</span><span class="o">.</span><span class="n">_call_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup</span><span class="p">:</span>
            <span class="n">fin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">fin</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_terminal_writer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TerminalWriter</span><span class="p">:</span>
        <span class="n">terminalreporter</span><span class="p">:</span> <span class="n">TerminalReporter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">get_plugin</span><span class="p">(</span>
            <span class="s2">&quot;terminalreporter&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">terminalreporter</span><span class="o">.</span><span class="n">_tw</span>

    <span class="k">def</span> <span class="nf">pytest_cmdline_parse</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">pluginmanager</span><span class="p">:</span> <span class="n">PytestPluginManager</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Config&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">UsageError</span><span class="p">:</span>

            <span class="c1"># Handle --version and --help here in a minimal fashion.</span>
            <span class="c1"># This gets done via helpconfig normally, but its</span>
            <span class="c1"># pytest_cmdline_main is not called in case of errors.</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">,</span> <span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;--version&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">_pytest.helpconfig</span> <span class="kn">import</span> <span class="n">showversion</span>

                <span class="n">showversion</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">,</span> <span class="s2">&quot;help&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;--help&quot;</span> <span class="ow">in</span> <span class="n">args</span> <span class="ow">or</span> <span class="s2">&quot;-h&quot;</span> <span class="ow">in</span> <span class="n">args</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">_getparser</span><span class="p">()</span><span class="o">.</span><span class="n">print_help</span><span class="p">()</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">NOTE: displaying only minimal help due to UsageError.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="k">raise</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">notify_exception</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">excinfo</span><span class="p">:</span> <span class="n">ExceptionInfo</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">],</span>
        <span class="n">option</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">option</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="s2">&quot;fulltrace&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">style</span><span class="p">:</span> <span class="n">_TracebackStyle</span> <span class="o">=</span> <span class="s2">&quot;long&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">style</span> <span class="o">=</span> <span class="s2">&quot;native&quot;</span>
        <span class="n">excrepr</span> <span class="o">=</span> <span class="n">excinfo</span><span class="o">.</span><span class="n">getrepr</span><span class="p">(</span>
            <span class="n">funcargs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">showlocals</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="s2">&quot;showlocals&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span>
        <span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">pytest_internalerror</span><span class="p">(</span><span class="n">excrepr</span><span class="o">=</span><span class="n">excrepr</span><span class="p">,</span> <span class="n">excinfo</span><span class="o">=</span><span class="n">excinfo</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">excrepr</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;INTERNALERROR&gt; </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">line</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">cwd_relative_nodeid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodeid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># nodeid&#39;s are relative to the rootpath, compute relative to cwd.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">invocation_params</span><span class="o">.</span><span class="n">dir</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rootpath</span><span class="p">:</span>
            <span class="n">fullpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rootpath</span> <span class="o">/</span> <span class="n">nodeid</span>
            <span class="n">nodeid</span> <span class="o">=</span> <span class="n">bestrelpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invocation_params</span><span class="o">.</span><span class="n">dir</span><span class="p">,</span> <span class="n">fullpath</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nodeid</span>

<div class="viewcode-block" id="Config.fromdictargs"><a class="viewcode-back" href="../../reference.html#pytest.Config.fromdictargs">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">fromdictargs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">option_dict</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Config&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Constructor usable for subprocesses.&quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">option_dict</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">addopts</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">plugins</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">consider_pluginarg</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">config</span></div>

    <span class="k">def</span> <span class="nf">_processopt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opt</span><span class="p">:</span> <span class="s2">&quot;Argument&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">opt</span><span class="o">.</span><span class="n">_short_opts</span> <span class="o">+</span> <span class="n">opt</span><span class="o">.</span><span class="n">_long_opts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_opt2dest</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">dest</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">dest</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">dest</span><span class="p">,</span> <span class="n">opt</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>

    <span class="nd">@hookimpl</span><span class="p">(</span><span class="n">trylast</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">pytest_load_initial_conftests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">early_config</span><span class="p">:</span> <span class="s2">&quot;Config&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">_set_initial_conftests</span><span class="p">(</span><span class="n">early_config</span><span class="o">.</span><span class="n">known_args_namespace</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_initini</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ns</span><span class="p">,</span> <span class="n">unknown_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">parse_known_and_unknown_args</span><span class="p">(</span>
            <span class="n">args</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">rootpath</span><span class="p">,</span> <span class="n">inipath</span><span class="p">,</span> <span class="n">inicfg</span> <span class="o">=</span> <span class="n">determine_setup</span><span class="p">(</span>
            <span class="n">ns</span><span class="o">.</span><span class="n">inifilename</span><span class="p">,</span>
            <span class="n">ns</span><span class="o">.</span><span class="n">file_or_dir</span> <span class="o">+</span> <span class="n">unknown_args</span><span class="p">,</span>
            <span class="n">rootdir_cmd_arg</span><span class="o">=</span><span class="n">ns</span><span class="o">.</span><span class="n">rootdir</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rootpath</span> <span class="o">=</span> <span class="n">rootpath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inipath</span> <span class="o">=</span> <span class="n">inipath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inicfg</span> <span class="o">=</span> <span class="n">inicfg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">extra_info</span><span class="p">[</span><span class="s2">&quot;rootdir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rootpath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">extra_info</span><span class="p">[</span><span class="s2">&quot;inifile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inipath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">addini</span><span class="p">(</span><span class="s2">&quot;addopts&quot;</span><span class="p">,</span> <span class="s2">&quot;extra command line options&quot;</span><span class="p">,</span> <span class="s2">&quot;args&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">addini</span><span class="p">(</span><span class="s2">&quot;minversion&quot;</span><span class="p">,</span> <span class="s2">&quot;minimally required pytest version&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">addini</span><span class="p">(</span>
            <span class="s2">&quot;required_plugins&quot;</span><span class="p">,</span>
            <span class="s2">&quot;plugins that must be present for pytest to run&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;args&quot;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="p">[],</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_override_ini</span> <span class="o">=</span> <span class="n">ns</span><span class="o">.</span><span class="n">override_ini</span> <span class="ow">or</span> <span class="p">()</span>

    <span class="k">def</span> <span class="nf">_consider_importhook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Install the PEP 302 import hook if using assertion rewriting.</span>

<span class="sd">        Needs to parse the --assert=&lt;mode&gt; option from the commandline</span>
<span class="sd">        and find all the installed plugins to mark them for rewriting</span>
<span class="sd">        by the importhook.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ns</span><span class="p">,</span> <span class="n">unknown_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">parse_known_and_unknown_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="s2">&quot;assertmode&quot;</span><span class="p">,</span> <span class="s2">&quot;plain&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;rewrite&quot;</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">_pytest.assertion</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">hook</span> <span class="o">=</span> <span class="n">_pytest</span><span class="o">.</span><span class="n">assertion</span><span class="o">.</span><span class="n">install_importhook</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">SystemError</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;plain&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mark_plugins_for_rewrite</span><span class="p">(</span><span class="n">hook</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_warn_about_missing_assertion</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_mark_plugins_for_rewrite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hook</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Given an importhook, mark for rewrite any top-level</span>
<span class="sd">        modules or packages in the distribution package for</span>
<span class="sd">        all pytest plugins.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">rewrite_hook</span> <span class="o">=</span> <span class="n">hook</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PYTEST_DISABLE_PLUGIN_AUTOLOAD&quot;</span><span class="p">):</span>
            <span class="c1"># We don&#39;t autoload from setuptools entry points, no need to continue.</span>
            <span class="k">return</span>

        <span class="n">package_files</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="n">importlib_metadata</span><span class="o">.</span><span class="n">distributions</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">ep</span><span class="o">.</span><span class="n">group</span> <span class="o">==</span> <span class="s2">&quot;pytest11&quot;</span> <span class="k">for</span> <span class="n">ep</span> <span class="ow">in</span> <span class="n">dist</span><span class="o">.</span><span class="n">entry_points</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">dist</span><span class="o">.</span><span class="n">files</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">_iter_rewritable_modules</span><span class="p">(</span><span class="n">package_files</span><span class="p">):</span>
            <span class="n">hook</span><span class="o">.</span><span class="n">mark_rewrite</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">via</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Validate known args.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">_config_source_hint</span> <span class="o">=</span> <span class="n">via</span>  <span class="c1"># type: ignore</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">parse_known_and_unknown_args</span><span class="p">(</span>
                <span class="n">args</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">_config_source_hint</span>  <span class="c1"># type: ignore</span>

        <span class="k">return</span> <span class="n">args</span>

    <span class="k">def</span> <span class="nf">_preparse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">addopts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">addopts</span><span class="p">:</span>
            <span class="n">env_addopts</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PYTEST_ADDOPTS&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">env_addopts</span><span class="p">):</span>
                <span class="n">args</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_validate_args</span><span class="p">(</span><span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">env_addopts</span><span class="p">),</span> <span class="s2">&quot;via PYTEST_ADDOPTS&quot;</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">args</span>
                <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initini</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">addopts</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_validate_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getini</span><span class="p">(</span><span class="s2">&quot;addopts&quot;</span><span class="p">),</span> <span class="s2">&quot;via addopts config&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">args</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">known_args_namespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">(</span>
            <span class="n">args</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkversion</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_consider_importhook</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">consider_preparse</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">exclude_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PYTEST_DISABLE_PLUGIN_AUTOLOAD&quot;</span><span class="p">):</span>
            <span class="c1"># Don&#39;t autoload from setuptools entry point. Only explicitly specified</span>
            <span class="c1"># plugins are going to be loaded.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">load_setuptools_entrypoints</span><span class="p">(</span><span class="s2">&quot;pytest11&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">consider_env</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">known_args_namespace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">(</span>
            <span class="n">args</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">known_args_namespace</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_plugins</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_warn_about_skipped_plugins</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">known_args_namespace</span><span class="o">.</span><span class="n">strict</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">issue_config_time_warning</span><span class="p">(</span>
                <span class="n">_pytest</span><span class="o">.</span><span class="n">deprecated</span><span class="o">.</span><span class="n">STRICT_OPTION</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">known_args_namespace</span><span class="o">.</span><span class="n">confcutdir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">inipath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">confcutdir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inipath</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">known_args_namespace</span><span class="o">.</span><span class="n">confcutdir</span> <span class="o">=</span> <span class="n">confcutdir</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">pytest_load_initial_conftests</span><span class="p">(</span>
                <span class="n">early_config</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_parser</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">ConftestImportFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">known_args_namespace</span><span class="o">.</span><span class="n">help</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">known_args_namespace</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
                <span class="c1"># we don&#39;t want to prevent --help/--version to work</span>
                <span class="c1"># so just let is pass and print a warning at the end</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">issue_config_time_warning</span><span class="p">(</span>
                    <span class="n">PytestConfigWarning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;could not load initial conftests: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>

<div class="viewcode-block" id="Config.pytest_collection"><a class="viewcode-back" href="../../reference.html#pytest.Config.pytest_collection">[docs]</a>    <span class="nd">@hookimpl</span><span class="p">(</span><span class="n">hookwrapper</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">pytest_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Validate invalid ini keys after collection is done so we take in account</span>
<span class="sd">        options added by late-loading conftest files.&quot;&quot;&quot;</span>
        <span class="k">yield</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_config_options</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_checkversion</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">pytest</span>

        <span class="n">minver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inicfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;minversion&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">minver</span><span class="p">:</span>
            <span class="c1"># Imported lazily to improve start-up time.</span>
            <span class="kn">from</span> <span class="nn">packaging.version</span> <span class="kn">import</span> <span class="n">Version</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">minver</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">pytest</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: &#39;minversion&#39; must be a single value&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">inipath</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">Version</span><span class="p">(</span><span class="n">minver</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">Version</span><span class="p">(</span><span class="n">pytest</span><span class="o">.</span><span class="n">__version__</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">pytest</span><span class="o">.</span><span class="n">UsageError</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: &#39;minversion&#39; requires pytest-</span><span class="si">%s</span><span class="s2">, actual pytest-</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inipath</span><span class="p">,</span> <span class="n">minver</span><span class="p">,</span> <span class="n">pytest</span><span class="o">.</span><span class="n">__version__</span><span class="p">,)</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_config_options</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_unknown_ini_keys</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_warn_or_fail_if_strict</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown config option: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_plugins</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">required_plugins</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getini</span><span class="p">(</span><span class="s2">&quot;required_plugins&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">required_plugins</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Imported lazily to improve start-up time.</span>
        <span class="kn">from</span> <span class="nn">packaging.version</span> <span class="kn">import</span> <span class="n">Version</span>
        <span class="kn">from</span> <span class="nn">packaging.requirements</span> <span class="kn">import</span> <span class="n">InvalidRequirement</span><span class="p">,</span> <span class="n">Requirement</span>

        <span class="n">plugin_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">list_plugin_distinfo</span><span class="p">()</span>
        <span class="n">plugin_dist_info</span> <span class="o">=</span> <span class="p">{</span><span class="n">dist</span><span class="o">.</span><span class="n">project_name</span><span class="p">:</span> <span class="n">dist</span><span class="o">.</span><span class="n">version</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">dist</span> <span class="ow">in</span> <span class="n">plugin_info</span><span class="p">}</span>

        <span class="n">missing_plugins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">required_plugin</span> <span class="ow">in</span> <span class="n">required_plugins</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">spec</span> <span class="o">=</span> <span class="n">Requirement</span><span class="p">(</span><span class="n">required_plugin</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">InvalidRequirement</span><span class="p">:</span>
                <span class="n">missing_plugins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">required_plugin</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plugin_dist_info</span><span class="p">:</span>
                <span class="n">missing_plugins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">required_plugin</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">Version</span><span class="p">(</span><span class="n">plugin_dist_info</span><span class="p">[</span><span class="n">spec</span><span class="o">.</span><span class="n">name</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">specifier</span><span class="p">:</span>
                <span class="n">missing_plugins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">required_plugin</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">missing_plugins</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UsageError</span><span class="p">(</span>
                <span class="s2">&quot;Missing required plugins: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_plugins</span><span class="p">)),</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_warn_or_fail_if_strict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">known_args_namespace</span><span class="o">.</span><span class="n">strict_config</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UsageError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">issue_config_time_warning</span><span class="p">(</span><span class="n">PytestConfigWarning</span><span class="p">(</span><span class="n">message</span><span class="p">),</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_unknown_ini_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">parser_inicfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">_inidict</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inicfg</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parser_inicfg</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">addopts</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Parse given cmdline arguments into this config object.</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;args&quot;</span>
        <span class="p">),</span> <span class="s2">&quot;can only parse cmdline args at most once per Config object&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">pytest_addhooks</span><span class="o">.</span><span class="n">call_historic</span><span class="p">(</span>
            <span class="n">kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">pluginmanager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pluginmanager</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preparse</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">addopts</span><span class="o">=</span><span class="n">addopts</span><span class="p">)</span>
        <span class="c1"># XXX deprecated hook:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">pytest_cmdline_preparse</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">after_preparse</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># type: ignore</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">parse_setoption</span><span class="p">(</span>
                <span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">option</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">invocation_params</span><span class="o">.</span><span class="n">dir</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">rootpath</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getini</span><span class="p">(</span><span class="s2">&quot;testpaths&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invocation_params</span><span class="o">.</span><span class="n">dir</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="k">except</span> <span class="n">PrintHelp</span><span class="p">:</span>
            <span class="k">pass</span>

<div class="viewcode-block" id="Config.issue_config_time_warning"><a class="viewcode-back" href="../../reference.html#pytest.Config.issue_config_time_warning">[docs]</a>    <span class="k">def</span> <span class="nf">issue_config_time_warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warning</span><span class="p">:</span> <span class="ne">Warning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Issue and handle a warning during the &quot;configure&quot; stage.</span>

<span class="sd">        During ``pytest_configure`` we can&#39;t capture warnings using the ``catch_warnings_for_item``</span>
<span class="sd">        function because it is not possible to have hookwrappers around ``pytest_configure``.</span>

<span class="sd">        This function is mainly intended for plugins that need to issue warnings during</span>
<span class="sd">        ``pytest_configure`` (or similar stages).</span>

<span class="sd">        :param warning: The warning instance.</span>
<span class="sd">        :param stacklevel: stacklevel forwarded to warnings.warn.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">is_blocked</span><span class="p">(</span><span class="s2">&quot;warnings&quot;</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">cmdline_filters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">known_args_namespace</span><span class="o">.</span><span class="n">pythonwarnings</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">config_filters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getini</span><span class="p">(</span><span class="s2">&quot;filterwarnings&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">records</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;always&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">warning</span><span class="p">))</span>
            <span class="n">apply_warning_filters</span><span class="p">(</span><span class="n">config_filters</span><span class="p">,</span> <span class="n">cmdline_filters</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">warning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="n">stacklevel</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">records</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="n">stacklevel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_filename</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_lineno</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">pytest_warning_captured</span><span class="o">.</span><span class="n">call_historic</span><span class="p">(</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">warning_message</span><span class="o">=</span><span class="n">records</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">when</span><span class="o">=</span><span class="s2">&quot;config&quot;</span><span class="p">,</span>
                    <span class="n">item</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">pytest_warning_recorded</span><span class="o">.</span><span class="n">call_historic</span><span class="p">(</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">warning_message</span><span class="o">=</span><span class="n">records</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">when</span><span class="o">=</span><span class="s2">&quot;config&quot;</span><span class="p">,</span>
                    <span class="n">nodeid</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="Config.addinivalue_line"><a class="viewcode-back" href="../../reference.html#pytest.Config.addinivalue_line">[docs]</a>    <span class="k">def</span> <span class="nf">addinivalue_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add a line to an ini-file option. The option must have been</span>
<span class="sd">        declared but might not yet be set in which case the line becomes</span>
<span class="sd">        the first line in its value.&quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getini</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>  <span class="c1"># modifies the cached list inline</span></div>

<div class="viewcode-block" id="Config.getini"><a class="viewcode-back" href="../../reference.html#pytest.Config.getini">[docs]</a>    <span class="k">def</span> <span class="nf">getini</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return configuration value from an :ref:`ini file &lt;configfiles&gt;`.</span>

<span class="sd">        If the specified name hasn&#39;t been registered through a prior</span>
<span class="sd">        :py:func:`parser.addini &lt;_pytest.config.argparsing.Parser.addini&gt;`</span>
<span class="sd">        call (usually from a plugin), a ValueError is raised.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inicache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inicache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getini</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">val</span></div>

    <span class="k">def</span> <span class="nf">_getini</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">description</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">_inidict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unknown configuration value: </span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="n">override_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_override_ini_value</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">override_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inicfg</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">default</span>
                <span class="k">if</span> <span class="nb">type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s2">&quot;&quot;</span>
                <span class="k">return</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">override_value</span>
        <span class="c1"># Coerce the values based on types.</span>
        <span class="c1">#</span>
        <span class="c1"># Note: some coercions are only required if we are reading from .ini files, because</span>
        <span class="c1"># the file format doesn&#39;t contain type information, but when reading from toml we will</span>
        <span class="c1"># get either str or list of str values (see _parse_ini_config_from_pyproject_toml).</span>
        <span class="c1"># For example:</span>
        <span class="c1">#</span>
        <span class="c1">#   ini:</span>
        <span class="c1">#     a_line_list = &quot;tests acceptance&quot;</span>
        <span class="c1">#   in this case, we need to split the string to obtain a list of strings.</span>
        <span class="c1">#</span>
        <span class="c1">#   toml:</span>
        <span class="c1">#     a_line_list = [&quot;tests&quot;, &quot;acceptance&quot;]</span>
        <span class="c1">#   in this case, we already have a list ready to use.</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;pathlist&quot;</span><span class="p">:</span>
            <span class="c1"># TODO: This assert is probably not valid in all cases.</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">inipath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">dp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inipath</span><span class="o">.</span><span class="n">parent</span>
            <span class="n">input_values</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">value</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dp</span> <span class="o">/</span> <span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">input_values</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;args&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;linelist&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span> <span class="k">if</span> <span class="n">t</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;bool&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_strtobool</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">type</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;string&quot;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_getconftest_pathlist</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">]]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mod</span><span class="p">,</span> <span class="n">relroots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">_rget_with_confmod</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;importmode&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">modpath</span> <span class="o">=</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">dirpath</span><span class="p">()</span>
        <span class="n">values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">relroot</span> <span class="ow">in</span> <span class="n">relroots</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relroot</span><span class="p">,</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">):</span>
                <span class="n">relroot</span> <span class="o">=</span> <span class="n">relroot</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
                <span class="n">relroot</span> <span class="o">=</span> <span class="n">modpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">relroot</span><span class="p">,</span> <span class="nb">abs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relroot</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span>

    <span class="k">def</span> <span class="nf">_get_override_ini_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># override_ini is a list of &quot;ini=value&quot; options.</span>
        <span class="c1"># Always use the last item if multiple values are set for same ini-name,</span>
        <span class="c1"># e.g. -o foo=bar1 -o foo=bar2 will set foo to bar2.</span>
        <span class="k">for</span> <span class="n">ini_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_override_ini</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">user_ini_value</span> <span class="o">=</span> <span class="n">ini_config</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UsageError</span><span class="p">(</span>
                    <span class="s2">&quot;-o/--override-ini expects option=value style (got: </span><span class="si">{!r}</span><span class="s2">).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">ini_config</span>
                    <span class="p">)</span>
                <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">user_ini_value</span>
        <span class="k">return</span> <span class="n">value</span>

<div class="viewcode-block" id="Config.getoption"><a class="viewcode-back" href="../../reference.html#pytest.Config.getoption">[docs]</a>    <span class="k">def</span> <span class="nf">getoption</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">notset</span><span class="p">,</span> <span class="n">skip</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return command line option value.</span>

<span class="sd">        :param name: Name of the option.  You may also specify</span>
<span class="sd">            the literal ``--OPT`` option instead of the &quot;dest&quot; option name.</span>
<span class="sd">        :param default: Default value if no option of that name exists.</span>
<span class="sd">        :param skip: If True, raise pytest.skip if option does not exists</span>
<span class="sd">            or has a None value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opt2dest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">option</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">skip</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">val</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">notset</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">default</span>
            <span class="k">if</span> <span class="n">skip</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">pytest</span>

                <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no </span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2"> option found&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no option named </span><span class="si">{</span><span class="n">name</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span></div>

<div class="viewcode-block" id="Config.getvalue"><a class="viewcode-back" href="../../reference.html#pytest.Config.getvalue">[docs]</a>    <span class="k">def</span> <span class="nf">getvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deprecated, use getoption() instead.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Config.getvalueorskip"><a class="viewcode-back" href="../../reference.html#pytest.Config.getvalueorskip">[docs]</a>    <span class="k">def</span> <span class="nf">getvalueorskip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deprecated, use getoption(skip=True) instead.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_warn_about_missing_assertion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_assertion_supported</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;plain&quot;</span><span class="p">:</span>
                <span class="n">warning_text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;ASSERTIONS ARE NOT EXECUTED&quot;</span>
                    <span class="s2">&quot; and FAILING TESTS WILL PASS.  Are you&quot;</span>
                    <span class="s2">&quot; using python -O?&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warning_text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;assertions not in test modules or&quot;</span>
                    <span class="s2">&quot; plugins will be ignored&quot;</span>
                    <span class="s2">&quot; because assert statements are not executed &quot;</span>
                    <span class="s2">&quot;by the underlying Python interpreter &quot;</span>
                    <span class="s2">&quot;(are you using python -O?)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">issue_config_time_warning</span><span class="p">(</span>
                <span class="n">PytestConfigWarning</span><span class="p">(</span><span class="n">warning_text</span><span class="p">),</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_warn_about_skipped_plugins</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">skipped_plugins</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">issue_config_time_warning</span><span class="p">(</span>
                <span class="n">PytestConfigWarning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;skipped plugin </span><span class="si">{</span><span class="n">module_name</span><span class="si">!r}</span><span class="s2">: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_assertion_supported</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">assert</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># type: ignore[unreachable]</span>


<span class="k">def</span> <span class="nf">create_terminal_writer</span><span class="p">(</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TextIO</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TerminalWriter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Create a TerminalWriter instance configured according to the options</span>
<span class="sd">    in the config object.</span>

<span class="sd">    Every code which requires a TerminalWriter object and has access to a</span>
<span class="sd">    config object should use this function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tw</span> <span class="o">=</span> <span class="n">TerminalWriter</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">color</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
        <span class="n">tw</span><span class="o">.</span><span class="n">hasmarkup</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">color</span> <span class="o">==</span> <span class="s2">&quot;no&quot;</span><span class="p">:</span>
        <span class="n">tw</span><span class="o">.</span><span class="n">hasmarkup</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">code_highlight</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
        <span class="n">tw</span><span class="o">.</span><span class="n">code_highlight</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">code_highlight</span> <span class="o">==</span> <span class="s2">&quot;no&quot;</span><span class="p">:</span>
        <span class="n">tw</span><span class="o">.</span><span class="n">code_highlight</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">tw</span>


<span class="k">def</span> <span class="nf">_strtobool</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Convert a string representation of truth to True or False.</span>

<span class="sd">    True values are &#39;y&#39;, &#39;yes&#39;, &#39;t&#39;, &#39;true&#39;, &#39;on&#39;, and &#39;1&#39;; false values</span>
<span class="sd">    are &#39;n&#39;, &#39;no&#39;, &#39;f&#39;, &#39;false&#39;, &#39;off&#39;, and &#39;0&#39;.  Raises ValueError if</span>
<span class="sd">    &#39;val&#39; is anything else.</span>

<span class="sd">    .. note:: Copied from distutils.util.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;on&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="s2">&quot;off&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid truth value </span><span class="si">{</span><span class="n">val</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">parse_warning_filter</span><span class="p">(</span>
    <span class="n">arg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">escape</span><span class="p">:</span> <span class="nb">bool</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="ne">Warning</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Parse a warnings filter string.</span>

<span class="sd">    This is copied from warnings._setoption, but does not apply the filter,</span>
<span class="sd">    only parses it, and makes the escaping optional.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">warnings</span><span class="o">.</span><span class="n">_OptionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;too many fields (max 5): </span><span class="si">{</span><span class="n">arg</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">action_</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">category_</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">lineno_</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">]</span>
    <span class="n">action</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">warnings</span><span class="o">.</span><span class="n">_getaction</span><span class="p">(</span><span class="n">action_</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
    <span class="n">category</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="ne">Warning</span><span class="p">]</span> <span class="o">=</span> <span class="n">warnings</span><span class="o">.</span><span class="n">_getcategory</span><span class="p">(</span><span class="n">category_</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
    <span class="k">if</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">escape</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">module</span> <span class="ow">and</span> <span class="n">escape</span><span class="p">:</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">module</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;\Z&quot;</span>
    <span class="k">if</span> <span class="n">lineno_</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lineno</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lineno_</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lineno</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">OverflowError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">warnings</span><span class="o">.</span><span class="n">_OptionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid lineno </span><span class="si">{</span><span class="n">lineno_</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lineno</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">action</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">lineno</span>


<span class="k">def</span> <span class="nf">apply_warning_filters</span><span class="p">(</span>
    <span class="n">config_filters</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">cmdline_filters</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Applies pytest-configured filters to the warnings module&quot;&quot;&quot;</span>
    <span class="c1"># Filters should have this precedence: cmdline options, config.</span>
    <span class="c1"># Filters should be applied in the inverse order of precedence.</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">config_filters</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="o">*</span><span class="n">parse_warning_filter</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">escape</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">cmdline_filters</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="o">*</span><span class="n">parse_warning_filter</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">escape</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>

            <div class="clearer"></div>
          </div>
      </div>
  <span id="sidebar-top"></span>
      <div class="clearer"></div>
    </div>
  
    <div class="footer" role="contentinfo">
        &#169; Copyright 20152020, holger krekel and pytest-dev team.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.5.4.
    </div>
  <script src="../../_static/version_warning_offset.js"></script>

  </body>
</html>