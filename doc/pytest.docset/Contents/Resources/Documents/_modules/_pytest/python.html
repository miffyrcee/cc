


<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>_pytest.python &#8212; pytest documentation</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/pygments_pytest.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <script>DOCUMENTATION_OPTIONS.URL_ROOT = '../../';</script>
   
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../contents.html">pytest-6.2</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">_pytest.python</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <h1>Source code for _pytest.python</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Python test discovery, setup and run of test functions.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Generator</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterator</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Mapping</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Sequence</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Set</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Type</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">py</span>

<span class="kn">import</span> <span class="nn">_pytest</span>
<span class="kn">from</span> <span class="nn">_pytest</span> <span class="kn">import</span> <span class="n">fixtures</span>
<span class="kn">from</span> <span class="nn">_pytest</span> <span class="kn">import</span> <span class="n">nodes</span>
<span class="kn">from</span> <span class="nn">_pytest._code</span> <span class="kn">import</span> <span class="n">filter_traceback</span>
<span class="kn">from</span> <span class="nn">_pytest._code</span> <span class="kn">import</span> <span class="n">getfslineno</span>
<span class="kn">from</span> <span class="nn">_pytest._code.code</span> <span class="kn">import</span> <span class="n">ExceptionInfo</span>
<span class="kn">from</span> <span class="nn">_pytest._code.code</span> <span class="kn">import</span> <span class="n">TerminalRepr</span>
<span class="kn">from</span> <span class="nn">_pytest._io</span> <span class="kn">import</span> <span class="n">TerminalWriter</span>
<span class="kn">from</span> <span class="nn">_pytest._io.saferepr</span> <span class="kn">import</span> <span class="n">saferepr</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">ascii_escaped</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">final</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">get_default_arg_names</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">get_real_func</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">getimfunc</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">getlocation</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">is_async_function</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">is_generator</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">NOTSET</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">REGEX_TYPE</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">safe_getattr</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">safe_isclass</span>
<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">STRING_TYPES</span>
<span class="kn">from</span> <span class="nn">_pytest.config</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">_pytest.config</span> <span class="kn">import</span> <span class="n">ExitCode</span>
<span class="kn">from</span> <span class="nn">_pytest.config</span> <span class="kn">import</span> <span class="n">hookimpl</span>
<span class="kn">from</span> <span class="nn">_pytest.config.argparsing</span> <span class="kn">import</span> <span class="n">Parser</span>
<span class="kn">from</span> <span class="nn">_pytest.deprecated</span> <span class="kn">import</span> <span class="n">FSCOLLECTOR_GETHOOKPROXY_ISINITPATH</span>
<span class="kn">from</span> <span class="nn">_pytest.fixtures</span> <span class="kn">import</span> <span class="n">FuncFixtureInfo</span>
<span class="kn">from</span> <span class="nn">_pytest.main</span> <span class="kn">import</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">_pytest.mark</span> <span class="kn">import</span> <span class="n">MARK_GEN</span>
<span class="kn">from</span> <span class="nn">_pytest.mark</span> <span class="kn">import</span> <span class="n">ParameterSet</span>
<span class="kn">from</span> <span class="nn">_pytest.mark.structures</span> <span class="kn">import</span> <span class="n">get_unpacked_marks</span>
<span class="kn">from</span> <span class="nn">_pytest.mark.structures</span> <span class="kn">import</span> <span class="n">Mark</span>
<span class="kn">from</span> <span class="nn">_pytest.mark.structures</span> <span class="kn">import</span> <span class="n">MarkDecorator</span>
<span class="kn">from</span> <span class="nn">_pytest.mark.structures</span> <span class="kn">import</span> <span class="n">normalize_mark_list</span>
<span class="kn">from</span> <span class="nn">_pytest.outcomes</span> <span class="kn">import</span> <span class="n">fail</span>
<span class="kn">from</span> <span class="nn">_pytest.outcomes</span> <span class="kn">import</span> <span class="n">skip</span>
<span class="kn">from</span> <span class="nn">_pytest.pathlib</span> <span class="kn">import</span> <span class="n">import_path</span>
<span class="kn">from</span> <span class="nn">_pytest.pathlib</span> <span class="kn">import</span> <span class="n">ImportPathMismatchError</span>
<span class="kn">from</span> <span class="nn">_pytest.pathlib</span> <span class="kn">import</span> <span class="n">parts</span>
<span class="kn">from</span> <span class="nn">_pytest.pathlib</span> <span class="kn">import</span> <span class="n">visit</span>
<span class="kn">from</span> <span class="nn">_pytest.warning_types</span> <span class="kn">import</span> <span class="n">PytestCollectionWarning</span>
<span class="kn">from</span> <span class="nn">_pytest.warning_types</span> <span class="kn">import</span> <span class="n">PytestUnhandledCoroutineWarning</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">Literal</span>
    <span class="kn">from</span> <span class="nn">_pytest.fixtures</span> <span class="kn">import</span> <span class="n">_Scope</span>


<span class="k">def</span> <span class="nf">pytest_addoption</span><span class="p">(</span><span class="n">parser</span><span class="p">:</span> <span class="n">Parser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getgroup</span><span class="p">(</span><span class="s2">&quot;general&quot;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span>
        <span class="s2">&quot;--fixtures&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--funcargs&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;showfixtures&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;show available fixtures, sorted by plugin appearance &quot;</span>
        <span class="s2">&quot;(fixtures with leading &#39;_&#39; are only shown with &#39;-v&#39;)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span>
        <span class="s2">&quot;--fixtures-per-test&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;show_fixtures_per_test&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;show fixtures per test&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">addini</span><span class="p">(</span>
        <span class="s2">&quot;python_files&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;args&quot;</span><span class="p">,</span>
        <span class="c1"># NOTE: default is also used in AssertionRewritingHook.</span>
        <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;test_*.py&quot;</span><span class="p">,</span> <span class="s2">&quot;*_test.py&quot;</span><span class="p">],</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;glob-style file patterns for Python test module discovery&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">addini</span><span class="p">(</span>
        <span class="s2">&quot;python_classes&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;args&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Test&quot;</span><span class="p">],</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;prefixes or glob names for Python test class discovery&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">addini</span><span class="p">(</span>
        <span class="s2">&quot;python_functions&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;args&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">],</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;prefixes or glob names for Python test function and method discovery&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">addini</span><span class="p">(</span>
        <span class="s2">&quot;disable_test_id_escaping_and_forfeit_all_rights_to_community_support&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;bool&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;disable string escape non-ascii characters, might cause unwanted &quot;</span>
        <span class="s2">&quot;side effects(use at your own risk)&quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">pytest_cmdline_main</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">ExitCode</span><span class="p">]]:</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">showfixtures</span><span class="p">:</span>
        <span class="n">showfixtures</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">option</span><span class="o">.</span><span class="n">show_fixtures_per_test</span><span class="p">:</span>
        <span class="n">show_fixtures_per_test</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">pytest_generate_tests</span><span class="p">(</span><span class="n">metafunc</span><span class="p">:</span> <span class="s2">&quot;Metafunc&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="n">metafunc</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">iter_markers</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;parametrize&quot;</span><span class="p">):</span>
        <span class="c1"># TODO: Fix this type-ignore (overlapping kwargs).</span>
        <span class="n">metafunc</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="o">*</span><span class="n">marker</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">marker</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">_param_mark</span><span class="o">=</span><span class="n">marker</span><span class="p">)</span>  <span class="c1"># type: ignore[misc]</span>


<span class="k">def</span> <span class="nf">pytest_configure</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">config</span><span class="o">.</span><span class="n">addinivalue_line</span><span class="p">(</span>
        <span class="s2">&quot;markers&quot;</span><span class="p">,</span>
        <span class="s2">&quot;parametrize(argnames, argvalues): call a test function multiple &quot;</span>
        <span class="s2">&quot;times passing in different arguments in turn. argvalues generally &quot;</span>
        <span class="s2">&quot;needs to be a list of values if argnames specifies only one name &quot;</span>
        <span class="s2">&quot;or a list of tuples of values if argnames specifies multiple names. &quot;</span>
        <span class="s2">&quot;Example: @parametrize(&#39;arg1&#39;, [1,2]) would lead to two calls of the &quot;</span>
        <span class="s2">&quot;decorated test function, one with arg1=1 and another with arg1=2.&quot;</span>
        <span class="s2">&quot;see https://docs.pytest.org/en/stable/parametrize.html for more info &quot;</span>
        <span class="s2">&quot;and examples.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">addinivalue_line</span><span class="p">(</span>
        <span class="s2">&quot;markers&quot;</span><span class="p">,</span>
        <span class="s2">&quot;usefixtures(fixturename1, fixturename2, ...): mark tests as needing &quot;</span>
        <span class="s2">&quot;all of the specified fixtures. see &quot;</span>
        <span class="s2">&quot;https://docs.pytest.org/en/stable/fixture.html#usefixtures &quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">async_warn_and_skip</span><span class="p">(</span><span class="n">nodeid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;async def functions are not natively supported and have been skipped.</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">msg</span> <span class="o">+=</span> <span class="p">(</span>
        <span class="s2">&quot;You need to install a suitable plugin for your async framework, for example:</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;  - anyio</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;  - pytest-asyncio</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;  - pytest-tornasync</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;  - pytest-trio</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;  - pytest-twisted&quot;</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">PytestUnhandledCoroutineWarning</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nodeid</span><span class="p">)))</span>
    <span class="n">skip</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s2">&quot;async def function and no async plugin installed (see warnings)&quot;</span><span class="p">)</span>


<span class="nd">@hookimpl</span><span class="p">(</span><span class="n">trylast</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pytest_pyfunc_call</span><span class="p">(</span><span class="n">pyfuncitem</span><span class="p">:</span> <span class="s2">&quot;Function&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]:</span>
    <span class="n">testfunction</span> <span class="o">=</span> <span class="n">pyfuncitem</span><span class="o">.</span><span class="n">obj</span>
    <span class="k">if</span> <span class="n">is_async_function</span><span class="p">(</span><span class="n">testfunction</span><span class="p">):</span>
        <span class="n">async_warn_and_skip</span><span class="p">(</span><span class="n">pyfuncitem</span><span class="o">.</span><span class="n">nodeid</span><span class="p">)</span>
    <span class="n">funcargs</span> <span class="o">=</span> <span class="n">pyfuncitem</span><span class="o">.</span><span class="n">funcargs</span>
    <span class="n">testargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">arg</span><span class="p">:</span> <span class="n">funcargs</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">pyfuncitem</span><span class="o">.</span><span class="n">_fixtureinfo</span><span class="o">.</span><span class="n">argnames</span><span class="p">}</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">testfunction</span><span class="p">(</span><span class="o">**</span><span class="n">testargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;__await__&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;__aiter__&quot;</span><span class="p">):</span>
        <span class="n">async_warn_and_skip</span><span class="p">(</span><span class="n">pyfuncitem</span><span class="o">.</span><span class="n">nodeid</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">pytest_collect_file</span><span class="p">(</span>
    <span class="n">path</span><span class="p">:</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Collector</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Module&quot;</span><span class="p">]:</span>
    <span class="n">ext</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">ext</span>
    <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;.py&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parent</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">isinitpath</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path_matches_patterns</span><span class="p">(</span>
                <span class="n">path</span><span class="p">,</span> <span class="n">parent</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getini</span><span class="p">(</span><span class="s2">&quot;python_files&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;__init__.py&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="n">ihook</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">gethookproxy</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">module</span><span class="p">:</span> <span class="n">Module</span> <span class="o">=</span> <span class="n">ihook</span><span class="o">.</span><span class="n">pytest_pycollect_makemodule</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">module</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">path_matches_patterns</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">,</span> <span class="n">patterns</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Return whether path matches any of the patterns in the list of globs given.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span> <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pytest_pycollect_makemodule</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Module&quot;</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">basename</span> <span class="o">==</span> <span class="s2">&quot;__init__.py&quot;</span><span class="p">:</span>
        <span class="n">pkg</span><span class="p">:</span> <span class="n">Package</span> <span class="o">=</span> <span class="n">Package</span><span class="o">.</span><span class="n">from_parent</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">fspath</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pkg</span>
    <span class="n">mod</span><span class="p">:</span> <span class="n">Module</span> <span class="o">=</span> <span class="n">Module</span><span class="o">.</span><span class="n">from_parent</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">fspath</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mod</span>


<span class="nd">@hookimpl</span><span class="p">(</span><span class="n">trylast</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pytest_pycollect_makeitem</span><span class="p">(</span><span class="n">collector</span><span class="p">:</span> <span class="s2">&quot;PyCollector&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">):</span>
    <span class="c1"># Nothing was collected elsewhere, let&#39;s do it here.</span>
    <span class="k">if</span> <span class="n">safe_isclass</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">collector</span><span class="o">.</span><span class="n">istestclass</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Class</span><span class="o">.</span><span class="n">from_parent</span><span class="p">(</span><span class="n">collector</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">collector</span><span class="o">.</span><span class="n">istestfunction</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="c1"># mock seems to store unbound methods (issue473), normalize it.</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__func__&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
        <span class="c1"># We need to try and unwrap the function if it&#39;s a functools.partial</span>
        <span class="c1"># or a functools.wrapped.</span>
        <span class="c1"># We mustn&#39;t if it&#39;s been wrapped with mock.patch (python 2 only).</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">or</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">get_real_func</span><span class="p">(</span><span class="n">obj</span><span class="p">))):</span>
            <span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="n">getfslineno</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn_explicit</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="n">PytestCollectionWarning</span><span class="p">(</span>
                    <span class="s2">&quot;cannot collect </span><span class="si">%r</span><span class="s2"> because it is not a function.&quot;</span> <span class="o">%</span> <span class="n">name</span>
                <span class="p">),</span>
                <span class="n">category</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">filename</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span>
                <span class="n">lineno</span><span class="o">=</span><span class="n">lineno</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__test__&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">is_generator</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">Function</span><span class="o">.</span><span class="n">from_parent</span><span class="p">(</span><span class="n">collector</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;yield tests were removed in pytest 4.0 - </span><span class="si">{name}</span><span class="s2"> will be ignored&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span>
                <span class="p">)</span>
                <span class="n">res</span><span class="o">.</span><span class="n">add_marker</span><span class="p">(</span><span class="n">MARK_GEN</span><span class="o">.</span><span class="n">xfail</span><span class="p">(</span><span class="n">run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="n">reason</span><span class="p">))</span>
                <span class="n">res</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">PytestCollectionWarning</span><span class="p">(</span><span class="n">reason</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">collector</span><span class="o">.</span><span class="n">_genfunctions</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">res</span>


<span class="k">class</span> <span class="nc">PyobjMixin</span><span class="p">:</span>
    <span class="n">_ALLOW_MARKERS</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Function and attributes that the mixin needs (for type-checking only).</span>
    <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">parent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Node</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">own_markers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Mark</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">getparent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">_NodeType</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">_NodeType</span><span class="p">]:</span>
            <span class="o">...</span>

        <span class="k">def</span> <span class="nf">listchain</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Node</span><span class="p">]:</span>
            <span class="o">...</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">module</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Python module object this node was collected from (can be None).&quot;&quot;&quot;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getparent</span><span class="p">(</span><span class="n">Module</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">obj</span> <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Python class object this node was collected from (can be None).&quot;&quot;&quot;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getparent</span><span class="p">(</span><span class="n">Class</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">obj</span> <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">instance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Python instance object this node was collected from (can be None).&quot;&quot;&quot;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getparent</span><span class="p">(</span><span class="n">Instance</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">obj</span> <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">obj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Underlying Python object.&quot;&quot;&quot;</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_obj&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_obj</span> <span class="o">=</span> <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getobj</span><span class="p">()</span>
            <span class="c1"># XXX evil hack</span>
            <span class="c1"># used to avoid Instance collector marker duplication</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ALLOW_MARKERS</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">own_markers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_unpacked_marks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="nd">@obj</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_obj</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_getobj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the underlying Python object. May be overwritten by subclasses.&quot;&quot;&quot;</span>
        <span class="c1"># TODO: Improve the type of `parent` such that assert/ignore aren&#39;t needed.</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">obj</span>  <span class="c1"># type: ignore[attr-defined]</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getmodpath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stopatmodule</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">includemodule</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return Python path relative to the containing module.&quot;&quot;&quot;</span>
        <span class="n">chain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listchain</span><span class="p">()</span>
        <span class="n">chain</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Instance</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Module</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">stopatmodule</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">includemodule</span><span class="p">:</span>
                        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="k">return</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reportinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="c1"># XXX caching?</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span>
        <span class="n">compat_co_firstlineno</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;compat_co_firstlineno&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">compat_co_firstlineno</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="c1"># nose compatibility</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="vm">__module__</span><span class="p">]</span><span class="o">.</span><span class="vm">__file__</span>
            <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pyc&quot;</span><span class="p">):</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">fspath</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_path</span>
            <span class="n">lineno</span> <span class="o">=</span> <span class="n">compat_co_firstlineno</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fspath</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="n">getfslineno</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">modpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getmodpath</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lineno</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fspath</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">modpath</span>


<span class="c1"># As an optimization, these builtin attribute names are pre-ignored when</span>
<span class="c1"># iterating over an object during collection -- the pytest_pycollect_makeitem</span>
<span class="c1"># hook is not called for them.</span>
<span class="c1"># fmt: off</span>
<span class="k">class</span> <span class="nc">_EmptyClass</span><span class="p">:</span> <span class="k">pass</span>  <span class="c1"># noqa: E701</span>
<span class="n">IGNORED_ATTRIBUTES</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>  <span class="c1"># noqa: E305</span>
    <span class="nb">frozenset</span><span class="p">(),</span>
    <span class="c1"># Module.</span>
    <span class="nb">dir</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">(</span><span class="s2">&quot;empty_module&quot;</span><span class="p">)),</span>
    <span class="c1"># Some extra module attributes the above doesn&#39;t catch.</span>
    <span class="p">{</span><span class="s2">&quot;__builtins__&quot;</span><span class="p">,</span> <span class="s2">&quot;__file__&quot;</span><span class="p">,</span> <span class="s2">&quot;__cached__&quot;</span><span class="p">},</span>
    <span class="c1"># Class.</span>
    <span class="nb">dir</span><span class="p">(</span><span class="n">_EmptyClass</span><span class="p">),</span>
    <span class="c1"># Instance.</span>
    <span class="nb">dir</span><span class="p">(</span><span class="n">_EmptyClass</span><span class="p">()),</span>
<span class="p">)</span>
<span class="k">del</span> <span class="n">_EmptyClass</span>
<span class="c1"># fmt: on</span>


<span class="k">class</span> <span class="nc">PyCollector</span><span class="p">(</span><span class="n">PyobjMixin</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Collector</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">funcnamefilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_matches_prefix_or_glob_option</span><span class="p">(</span><span class="s2">&quot;python_functions&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">isnosetest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Look for the __test__ attribute, which is applied by the</span>
<span class="sd">        @nose.tools.istest decorator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We explicitly check for &quot;is True&quot; here to not mistakenly treat</span>
        <span class="c1"># classes with a custom __getattr__ returning something truthy (like a</span>
        <span class="c1"># function) as test classes.</span>
        <span class="k">return</span> <span class="n">safe_getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__test__&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">classnamefilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_matches_prefix_or_glob_option</span><span class="p">(</span><span class="s2">&quot;python_classes&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">istestfunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">funcnamefilter</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">isnosetest</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">staticmethod</span><span class="p">):</span>
                <span class="c1"># staticmethods need to be unwrapped.</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">safe_getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__func__&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">safe_getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__call__&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">fixtures</span><span class="o">.</span><span class="n">getfixturemarker</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">istestclass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">classnamefilter</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">isnosetest</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_matches_prefix_or_glob_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if the given name matches the prefix or glob-pattern defined</span>
<span class="sd">        in ini configuration.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getini</span><span class="p">(</span><span class="n">option_name</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">option</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="c1"># Check that name looks like a glob-string before calling fnmatch</span>
            <span class="c1"># because this is called for every name in each collected module,</span>
            <span class="c1"># and fnmatch is somewhat expensive to call.</span>
            <span class="k">elif</span> <span class="p">(</span><span class="s2">&quot;*&quot;</span> <span class="ow">in</span> <span class="n">option</span> <span class="ow">or</span> <span class="s2">&quot;?&quot;</span> <span class="ow">in</span> <span class="n">option</span> <span class="ow">or</span> <span class="s2">&quot;[&quot;</span> <span class="ow">in</span> <span class="n">option</span><span class="p">)</span> <span class="ow">and</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">option</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Item</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Collector</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__test__&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># NB. we avoid random getattrs and peek in the __dict__ instead</span>
        <span class="c1"># (XXX originally introduced from a PyPy need, still true?)</span>
        <span class="n">dicts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__dict__&quot;</span><span class="p">,</span> <span class="p">{})]</span>
        <span class="k">for</span> <span class="n">basecls</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">:</span>
            <span class="n">dicts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">basecls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="n">seen</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">values</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Item</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Collector</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ihook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ihook</span>
        <span class="k">for</span> <span class="n">dic</span> <span class="ow">in</span> <span class="n">dicts</span><span class="p">:</span>
            <span class="c1"># Note: seems like the dict can change during iteration -</span>
            <span class="c1"># be careful not to remove the list() without consideration.</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dic</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">IGNORED_ATTRIBUTES</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">ihook</span><span class="o">.</span><span class="n">pytest_pycollect_makeitem</span><span class="p">(</span>
                    <span class="n">collector</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">values</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">sort_key</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
            <span class="n">fspath</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">reportinfo</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fspath</span><span class="p">),</span> <span class="n">lineno</span><span class="p">)</span>

        <span class="n">values</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">sort_key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span>

    <span class="k">def</span> <span class="nf">_genfunctions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">funcobj</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="s2">&quot;Function&quot;</span><span class="p">]:</span>
        <span class="n">modulecol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getparent</span><span class="p">(</span><span class="n">Module</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">modulecol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">modulecol</span><span class="o">.</span><span class="n">obj</span>
        <span class="n">clscol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getparent</span><span class="p">(</span><span class="n">Class</span><span class="p">)</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="n">clscol</span> <span class="ow">and</span> <span class="n">clscol</span><span class="o">.</span><span class="n">obj</span> <span class="ow">or</span> <span class="kc">None</span>
        <span class="n">fm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_fixturemanager</span>

        <span class="n">definition</span> <span class="o">=</span> <span class="n">FunctionDefinition</span><span class="o">.</span><span class="n">from_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">callobj</span><span class="o">=</span><span class="n">funcobj</span><span class="p">)</span>
        <span class="n">fixtureinfo</span> <span class="o">=</span> <span class="n">definition</span><span class="o">.</span><span class="n">_fixtureinfo</span>

        <span class="n">metafunc</span> <span class="o">=</span> <span class="n">Metafunc</span><span class="p">(</span>
            <span class="n">definition</span><span class="p">,</span> <span class="n">fixtureinfo</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">cls</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="n">module</span>
        <span class="p">)</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s2">&quot;pytest_generate_tests&quot;</span><span class="p">):</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="n">pytest_generate_tests</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;pytest_generate_tests&quot;</span><span class="p">):</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="p">()</span><span class="o">.</span><span class="n">pytest_generate_tests</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ihook</span><span class="o">.</span><span class="n">pytest_generate_tests</span><span class="o">.</span><span class="n">call_extra</span><span class="p">(</span><span class="n">methods</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">metafunc</span><span class="o">=</span><span class="n">metafunc</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">metafunc</span><span class="o">.</span><span class="n">_calls</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">Function</span><span class="o">.</span><span class="n">from_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">fixtureinfo</span><span class="o">=</span><span class="n">fixtureinfo</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Add funcargs() as fixturedefs to fixtureinfo.arg2fixturedefs.</span>
            <span class="n">fixtures</span><span class="o">.</span><span class="n">add_funcarg_pseudo_fixture_def</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metafunc</span><span class="p">,</span> <span class="n">fm</span><span class="p">)</span>

            <span class="c1"># Add_funcarg_pseudo_fixture_def may have shadowed some fixtures</span>
            <span class="c1"># with direct parametrization, so make sure we update what the</span>
            <span class="c1"># function really needs.</span>
            <span class="n">fixtureinfo</span><span class="o">.</span><span class="n">prune_dependency_tree</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">callspec</span> <span class="ow">in</span> <span class="n">metafunc</span><span class="o">.</span><span class="n">_calls</span><span class="p">:</span>
                <span class="n">subname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">callspec</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">]&quot;</span>
                <span class="k">yield</span> <span class="n">Function</span><span class="o">.</span><span class="n">from_parent</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">subname</span><span class="p">,</span>
                    <span class="n">callspec</span><span class="o">=</span><span class="n">callspec</span><span class="p">,</span>
                    <span class="n">callobj</span><span class="o">=</span><span class="n">funcobj</span><span class="p">,</span>
                    <span class="n">fixtureinfo</span><span class="o">=</span><span class="n">fixtureinfo</span><span class="p">,</span>
                    <span class="n">keywords</span><span class="o">=</span><span class="p">{</span><span class="n">callspec</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
                    <span class="n">originalname</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="p">)</span>


<div class="viewcode-block" id="Module"><a class="viewcode-back" href="../../reference.html#pytest.Module">[docs]</a><span class="k">class</span> <span class="nc">Module</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">File</span><span class="p">,</span> <span class="n">PyCollector</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Collector for test classes and functions.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_getobj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_importtestmodule</span><span class="p">()</span>

<div class="viewcode-block" id="Module.collect"><a class="viewcode-back" href="../../reference.html#pytest.Module.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Item</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Collector</span><span class="p">]]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inject_setup_module_fixture</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inject_setup_function_fixture</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_fixturemanager</span><span class="o">.</span><span class="n">parsefactories</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_inject_setup_module_fixture</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Inject a hidden autouse, module scoped fixture into the collected module object</span>
<span class="sd">        that invokes setUpModule/tearDownModule if either or both are available.</span>

<span class="sd">        Using a fixture to invoke this methods ensures we play nicely and unsurprisingly with</span>
<span class="sd">        other fixtures (#517).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">setup_module</span> <span class="o">=</span> <span class="n">_get_first_non_fixture_func</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;setUpModule&quot;</span><span class="p">,</span> <span class="s2">&quot;setup_module&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">teardown_module</span> <span class="o">=</span> <span class="n">_get_first_non_fixture_func</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;tearDownModule&quot;</span><span class="p">,</span> <span class="s2">&quot;teardown_module&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">setup_module</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">teardown_module</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="nd">@fixtures</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span>
            <span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;module&quot;</span><span class="p">,</span>
            <span class="c1"># Use a unique name to speed up lookup.</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;xunit_setup_module_fixture_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">def</span> <span class="nf">xunit_setup_module_fixture</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">setup_module</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_call_with_optional_argument</span><span class="p">(</span><span class="n">setup_module</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">module</span><span class="p">)</span>
            <span class="k">yield</span>
            <span class="k">if</span> <span class="n">teardown_module</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_call_with_optional_argument</span><span class="p">(</span><span class="n">teardown_module</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">module</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">__pytest_setup_module</span> <span class="o">=</span> <span class="n">xunit_setup_module_fixture</span>

    <span class="k">def</span> <span class="nf">_inject_setup_function_fixture</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Inject a hidden autouse, function scoped fixture into the collected module object</span>
<span class="sd">        that invokes setup_function/teardown_function if either or both are available.</span>

<span class="sd">        Using a fixture to invoke this methods ensures we play nicely and unsurprisingly with</span>
<span class="sd">        other fixtures (#517).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">setup_function</span> <span class="o">=</span> <span class="n">_get_first_non_fixture_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;setup_function&quot;</span><span class="p">,))</span>
        <span class="n">teardown_function</span> <span class="o">=</span> <span class="n">_get_first_non_fixture_func</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;teardown_function&quot;</span><span class="p">,)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">setup_function</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">teardown_function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="nd">@fixtures</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span>
            <span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">,</span>
            <span class="c1"># Use a unique name to speed up lookup.</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;xunit_setup_function_fixture_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">def</span> <span class="nf">xunit_setup_function_fixture</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">instance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># in this case we are bound to an instance, so we need to let</span>
                <span class="c1"># setup_method handle this</span>
                <span class="k">yield</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">setup_function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_call_with_optional_argument</span><span class="p">(</span><span class="n">setup_function</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">function</span><span class="p">)</span>
            <span class="k">yield</span>
            <span class="k">if</span> <span class="n">teardown_function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">_call_with_optional_argument</span><span class="p">(</span><span class="n">teardown_function</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">function</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">__pytest_setup_function</span> <span class="o">=</span> <span class="n">xunit_setup_function_fixture</span>

    <span class="k">def</span> <span class="nf">_importtestmodule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># We assume we are only called once per module.</span>
        <span class="n">importmode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;--import-mode&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">import_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fspath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">importmode</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">SyntaxError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">CollectError</span><span class="p">(</span>
                <span class="n">ExceptionInfo</span><span class="o">.</span><span class="n">from_current</span><span class="p">()</span><span class="o">.</span><span class="n">getrepr</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;short&quot;</span><span class="p">)</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">except</span> <span class="n">ImportPathMismatchError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">CollectError</span><span class="p">(</span>
                <span class="s2">&quot;import file mismatch:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;imported module </span><span class="si">%r</span><span class="s2"> has this __file__ attribute:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;  </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;which is not the same as the test file we want to collect:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;  </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;HINT: remove __pycache__ / .pyc files and/or use a &quot;</span>
                <span class="s2">&quot;unique basename for your test file modules&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">exc_info</span> <span class="o">=</span> <span class="n">ExceptionInfo</span><span class="o">.</span><span class="n">from_current</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">exc_info</span><span class="o">.</span><span class="n">traceback</span> <span class="o">=</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">traceback</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filter_traceback</span><span class="p">)</span>
            <span class="n">exc_repr</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">exc_info</span><span class="o">.</span><span class="n">getrepr</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;short&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">traceback</span>
                <span class="k">else</span> <span class="n">exc_info</span><span class="o">.</span><span class="n">exconly</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">formatted_tb</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc_repr</span><span class="p">)</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">CollectError</span><span class="p">(</span>
                <span class="s2">&quot;ImportError while importing test module &#39;</span><span class="si">{fspath}</span><span class="s2">&#39;.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Hint: make sure your test modules/packages have valid Python names.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Traceback:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;</span><span class="si">{traceback}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fspath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fspath</span><span class="p">,</span> <span class="n">traceback</span><span class="o">=</span><span class="n">formatted_tb</span><span class="p">)</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">except</span> <span class="n">skip</span><span class="o">.</span><span class="n">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">allow_module_level</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">CollectError</span><span class="p">(</span>
                <span class="s2">&quot;Using pytest.skip outside of a test is not allowed. &quot;</span>
                <span class="s2">&quot;To decorate a test function, use the @pytest.mark.skip &quot;</span>
                <span class="s2">&quot;or @pytest.mark.skipif decorators instead, and to skip a &quot;</span>
                <span class="s2">&quot;module use `pytestmark = pytest.mark.{skip,skipif}.&quot;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">consider_module</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mod</span></div>


<span class="k">class</span> <span class="nc">Package</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fspath</span><span class="p">:</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">,</span>
        <span class="n">parent</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Collector</span><span class="p">,</span>
        <span class="c1"># NOTE: following args are unused:</span>
        <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">session</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nodeid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># NOTE: Could be just the following, but kept as-is for compat.</span>
        <span class="c1"># nodes.FSCollector.__init__(self, fspath, parent=parent)</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">session</span>
        <span class="n">nodes</span><span class="o">.</span><span class="n">FSCollector</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">fspath</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">nodeid</span><span class="o">=</span><span class="n">nodeid</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fspath</span><span class="o">.</span><span class="n">dirname</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Not using fixtures to call setup_module here because autouse fixtures</span>
        <span class="c1"># from packages are not called automatically (#4085).</span>
        <span class="n">setup_module</span> <span class="o">=</span> <span class="n">_get_first_non_fixture_func</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;setUpModule&quot;</span><span class="p">,</span> <span class="s2">&quot;setup_module&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">setup_module</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_call_with_optional_argument</span><span class="p">(</span><span class="n">setup_module</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">)</span>

        <span class="n">teardown_module</span> <span class="o">=</span> <span class="n">_get_first_non_fixture_func</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;tearDownModule&quot;</span><span class="p">,</span> <span class="s2">&quot;teardown_module&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">teardown_module</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">_call_with_optional_argument</span><span class="p">,</span> <span class="n">teardown_module</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addfinalizer</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">gethookproxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fspath</span><span class="p">:</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">FSCOLLECTOR_GETHOOKPROXY_ISINITPATH</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">gethookproxy</span><span class="p">(</span><span class="n">fspath</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">isinitpath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">FSCOLLECTOR_GETHOOKPROXY_ISINITPATH</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">isinitpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_recurse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">direntry</span><span class="p">:</span> <span class="s2">&quot;os.DirEntry[str]&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">direntry</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;__pycache__&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">(</span><span class="n">direntry</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="n">ihook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">gethookproxy</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">dirpath</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">ihook</span><span class="o">.</span><span class="n">pytest_ignore_collect</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">norecursepatterns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getini</span><span class="p">(</span><span class="s2">&quot;norecursedirs&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">fnmatch</span><span class="o">=</span><span class="n">pat</span><span class="p">)</span> <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">norecursepatterns</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_collectfile</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">,</span> <span class="n">handle_dupes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Collector</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">()</span>
        <span class="p">),</span> <span class="s2">&quot;</span><span class="si">{!r}</span><span class="s2"> is not a file (isdir=</span><span class="si">{!r}</span><span class="s2">, exists=</span><span class="si">{!r}</span><span class="s2">, islink=</span><span class="si">{!r}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">path</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(),</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(),</span> <span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">ihook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">gethookproxy</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">isinitpath</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ihook</span><span class="o">.</span><span class="n">pytest_ignore_collect</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">()</span>

        <span class="k">if</span> <span class="n">handle_dupes</span><span class="p">:</span>
            <span class="n">keepduplicates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;keepduplicates&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">keepduplicates</span><span class="p">:</span>
                <span class="n">duplicate_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">_duplicatepaths</span>
                <span class="k">if</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">duplicate_paths</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">duplicate_paths</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ihook</span><span class="o">.</span><span class="n">pytest_collect_file</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># type: ignore[no-any-return]</span>

    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Item</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Collector</span><span class="p">]]:</span>
        <span class="n">this_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fspath</span><span class="o">.</span><span class="n">dirpath</span><span class="p">()</span>
        <span class="n">init_module</span> <span class="o">=</span> <span class="n">this_path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;__init__.py&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">init_module</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">path_matches_patterns</span><span class="p">(</span>
            <span class="n">init_module</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getini</span><span class="p">(</span><span class="s2">&quot;python_files&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">yield</span> <span class="n">Module</span><span class="o">.</span><span class="n">from_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fspath</span><span class="o">=</span><span class="n">init_module</span><span class="p">)</span>
        <span class="n">pkg_prefixes</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">direntry</span> <span class="ow">in</span> <span class="n">visit</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">this_path</span><span class="p">),</span> <span class="n">recurse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_recurse</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">(</span><span class="n">direntry</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

            <span class="c1"># We will visit our own __init__.py file, in which case we skip it.</span>
            <span class="k">if</span> <span class="n">direntry</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">direntry</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;__init__.py&quot;</span> <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">dirpath</span><span class="p">()</span> <span class="o">==</span> <span class="n">this_path</span><span class="p">:</span>
                    <span class="k">continue</span>

            <span class="n">parts_</span> <span class="o">=</span> <span class="n">parts</span><span class="p">(</span><span class="n">direntry</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">pkg_prefix</span><span class="p">)</span> <span class="ow">in</span> <span class="n">parts_</span> <span class="ow">and</span> <span class="n">pkg_prefix</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;__init__.py&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">path</span>
                <span class="k">for</span> <span class="n">pkg_prefix</span> <span class="ow">in</span> <span class="n">pkg_prefixes</span>
            <span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">direntry</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collectfile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">direntry</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="c1"># Broken symlink or invalid/missing file.</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;__init__.py&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">pkg_prefixes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_call_with_optional_argument</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Call the given function with the given argument if func accepts one argument, otherwise</span>
<span class="sd">    calls func without arguments.&quot;&quot;&quot;</span>
    <span class="n">arg_count</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_argcount</span>
    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="n">arg_count</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">arg_count</span><span class="p">:</span>
        <span class="n">func</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">func</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_get_first_non_fixture_func</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">names</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Return the attribute from the given object to be used as a setup/teardown</span>
<span class="sd">    xunit-style function, but only if not marked as a fixture to avoid calling it twice.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="n">meth</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">meth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fixtures</span><span class="o">.</span><span class="n">getfixturemarker</span><span class="p">(</span><span class="n">meth</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">meth</span>


<div class="viewcode-block" id="Class"><a class="viewcode-back" href="../../reference.html#pytest.Class">[docs]</a><span class="k">class</span> <span class="nc">Class</span><span class="p">(</span><span class="n">PyCollector</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Collector for test methods.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Class.from_parent"><a class="viewcode-back" href="../../reference.html#pytest.Class.from_parent">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_parent</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The public constructor.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">from_parent</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span></div>

<div class="viewcode-block" id="Class.collect"><a class="viewcode-back" href="../../reference.html#pytest.Class.collect">[docs]</a>    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Item</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Collector</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">safe_getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__test__&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">hasinit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="n">PytestCollectionWarning</span><span class="p">(</span>
                    <span class="s2">&quot;cannot collect test class </span><span class="si">%r</span><span class="s2"> because it has a &quot;</span>
                    <span class="s2">&quot;__init__ constructor (from: </span><span class="si">%s</span><span class="s2">)&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">nodeid</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="n">hasnew</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="n">PytestCollectionWarning</span><span class="p">(</span>
                    <span class="s2">&quot;cannot collect test class </span><span class="si">%r</span><span class="s2"> because it has a &quot;</span>
                    <span class="s2">&quot;__new__ constructor (from: </span><span class="si">%s</span><span class="s2">)&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">nodeid</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_inject_setup_class_fixture</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inject_setup_method_fixture</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">Instance</span><span class="o">.</span><span class="n">from_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;()&quot;</span><span class="p">)]</span></div>

    <span class="k">def</span> <span class="nf">_inject_setup_class_fixture</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Inject a hidden autouse, class scoped fixture into the collected class object</span>
<span class="sd">        that invokes setup_class/teardown_class if either or both are available.</span>

<span class="sd">        Using a fixture to invoke this methods ensures we play nicely and unsurprisingly with</span>
<span class="sd">        other fixtures (#517).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">setup_class</span> <span class="o">=</span> <span class="n">_get_first_non_fixture_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;setup_class&quot;</span><span class="p">,))</span>
        <span class="n">teardown_class</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;teardown_class&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">setup_class</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">teardown_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="nd">@fixtures</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span>
            <span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">,</span>
            <span class="c1"># Use a unique name to speed up lookup.</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;xunit_setup_class_fixture_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">def</span> <span class="nf">xunit_setup_class_fixture</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">setup_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">=</span> <span class="n">getimfunc</span><span class="p">(</span><span class="n">setup_class</span><span class="p">)</span>
                <span class="n">_call_with_optional_argument</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">yield</span>
            <span class="k">if</span> <span class="n">teardown_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">=</span> <span class="n">getimfunc</span><span class="p">(</span><span class="n">teardown_class</span><span class="p">)</span>
                <span class="n">_call_with_optional_argument</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">__pytest_setup_class</span> <span class="o">=</span> <span class="n">xunit_setup_class_fixture</span>

    <span class="k">def</span> <span class="nf">_inject_setup_method_fixture</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Inject a hidden autouse, function scoped fixture into the collected class object</span>
<span class="sd">        that invokes setup_method/teardown_method if either or both are available.</span>

<span class="sd">        Using a fixture to invoke this methods ensures we play nicely and unsurprisingly with</span>
<span class="sd">        other fixtures (#517).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">setup_method</span> <span class="o">=</span> <span class="n">_get_first_non_fixture_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;setup_method&quot;</span><span class="p">,))</span>
        <span class="n">teardown_method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;teardown_method&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">setup_method</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">teardown_method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="nd">@fixtures</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span>
            <span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">,</span>
            <span class="c1"># Use a unique name to speed up lookup.</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;xunit_setup_method_fixture_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">def</span> <span class="nf">xunit_setup_method_fixture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">function</span>
            <span class="k">if</span> <span class="n">setup_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;setup_method&quot;</span><span class="p">)</span>
                <span class="n">_call_with_optional_argument</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
            <span class="k">yield</span>
            <span class="k">if</span> <span class="n">teardown_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;teardown_method&quot;</span><span class="p">)</span>
                <span class="n">_call_with_optional_argument</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">__pytest_setup_method</span> <span class="o">=</span> <span class="n">xunit_setup_method_fixture</span></div>


<span class="k">class</span> <span class="nc">Instance</span><span class="p">(</span><span class="n">PyCollector</span><span class="p">):</span>
    <span class="n">_ALLOW_MARKERS</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># hack, destroy later</span>
    <span class="c1"># Instances share the object with their parents in a way</span>
    <span class="c1"># that duplicates markers instances if not taken out</span>
    <span class="c1"># can be removed at node structure reorganization time.</span>

    <span class="k">def</span> <span class="nf">_getobj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Improve the type of `parent` such that assert/ignore aren&#39;t needed.</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">obj</span>  <span class="c1"># type: ignore[attr-defined]</span>
        <span class="k">return</span> <span class="n">obj</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Item</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Collector</span><span class="p">]]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_fixturemanager</span><span class="o">.</span><span class="n">parsefactories</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">newinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getobj</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span>


<span class="k">def</span> <span class="nf">hasinit</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">init</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__init__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">init</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">init</span> <span class="o">!=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__init__</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">hasnew</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">new</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__new__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">new</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">new</span> <span class="o">!=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="nd">@final</span>
<span class="k">class</span> <span class="nc">CallSpec2</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metafunc</span><span class="p">:</span> <span class="s2">&quot;Metafunc&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metafunc</span> <span class="o">=</span> <span class="n">metafunc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">funcargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_idlist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Used for sorting parametrized resources.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arg2scopenum</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">marks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Mark</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CallSpec2&quot;</span><span class="p">:</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">CallSpec2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metafunc</span><span class="p">)</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">funcargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funcargs</span><span class="p">)</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">marks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">marks</span><span class="p">)</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">indices</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">_arg2scopenum</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_arg2scopenum</span><span class="p">)</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">_idlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_idlist</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cs</span>

    <span class="k">def</span> <span class="nf">_checkargnotcontained</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="ow">or</span> <span class="n">arg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">funcargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;duplicate </span><span class="si">{</span><span class="n">arg</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getparam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">object</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idlist</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">setmulti2</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">valtypes</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;Literal[&#39;params&#39;, &#39;funcargs&#39;]&quot;</span><span class="p">],</span>
        <span class="n">argnames</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">valset</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">object</span><span class="p">],</span>
        <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">marks</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Mark</span><span class="p">,</span> <span class="n">MarkDecorator</span><span class="p">]],</span>
        <span class="n">scopenum</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">param_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">argnames</span><span class="p">,</span> <span class="n">valset</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_checkargnotcontained</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="n">valtype_for_arg</span> <span class="o">=</span> <span class="n">valtypes</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">valtype_for_arg</span> <span class="o">==</span> <span class="s2">&quot;params&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">elif</span> <span class="n">valtype_for_arg</span> <span class="o">==</span> <span class="s2">&quot;funcargs&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">funcargs</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
                <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Unhandled valtype for arg: </span><span class="si">{</span><span class="n">valtype_for_arg</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_index</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_arg2scopenum</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">scopenum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_idlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">marks</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">normalize_mark_list</span><span class="p">(</span><span class="n">marks</span><span class="p">))</span>


<div class="viewcode-block" id="Metafunc"><a class="viewcode-back" href="../../reference.html#pytest.Metafunc">[docs]</a><span class="nd">@final</span>
<span class="k">class</span> <span class="nc">Metafunc</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Objects passed to the :func:`pytest_generate_tests &lt;_pytest.hookspec.pytest_generate_tests&gt;` hook.</span>

<span class="sd">    They help to inspect a test function and to generate tests according to</span>
<span class="sd">    test configuration or values specified in the class or module where a</span>
<span class="sd">    test function is defined.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">definition</span><span class="p">:</span> <span class="s2">&quot;FunctionDefinition&quot;</span><span class="p">,</span>
        <span class="n">fixtureinfo</span><span class="p">:</span> <span class="n">fixtures</span><span class="o">.</span><span class="n">FuncFixtureInfo</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">,</span>
        <span class="bp">cls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">module</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1">#: Access to the underlying :class:`_pytest.python.FunctionDefinition`.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">definition</span> <span class="o">=</span> <span class="n">definition</span>

        <span class="c1">#: Access to the :class:`_pytest.config.Config` object for the test session.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>

        <span class="c1">#: The module object where the test function is defined in.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">module</span>

        <span class="c1">#: Underlying Python test function.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">definition</span><span class="o">.</span><span class="n">obj</span>

        <span class="c1">#: Set of fixture names required by the test function.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixturenames</span> <span class="o">=</span> <span class="n">fixtureinfo</span><span class="o">.</span><span class="n">names_closure</span>

        <span class="c1">#: Class object where the test function is defined in or ``None``.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cls</span> <span class="o">=</span> <span class="bp">cls</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">CallSpec2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_arg2fixturedefs</span> <span class="o">=</span> <span class="n">fixtureinfo</span><span class="o">.</span><span class="n">name2fixturedefs</span>

<div class="viewcode-block" id="Metafunc.parametrize"><a class="viewcode-back" href="../../reference.html#pytest.Metafunc.parametrize">[docs]</a>    <span class="k">def</span> <span class="nf">parametrize</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">argnames</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]],</span>
        <span class="n">argvalues</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ParameterSet</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">object</span><span class="p">],</span> <span class="nb">object</span><span class="p">]],</span>
        <span class="n">indirect</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">Union</span><span class="p">[</span>
                <span class="n">Iterable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]],</span>
                <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]],</span>
            <span class="p">]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">scope</span><span class="p">:</span> <span class="s2">&quot;Optional[_Scope]&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">_param_mark</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mark</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add new invocations to the underlying test function using the list</span>
<span class="sd">        of argvalues for the given argnames.  Parametrization is performed</span>
<span class="sd">        during the collection phase.  If you need to setup expensive resources</span>
<span class="sd">        see about setting indirect to do it rather at test setup time.</span>

<span class="sd">        :param argnames:</span>
<span class="sd">            A comma-separated string denoting one or more argument names, or</span>
<span class="sd">            a list/tuple of argument strings.</span>

<span class="sd">        :param argvalues:</span>
<span class="sd">            The list of argvalues determines how often a test is invoked with</span>
<span class="sd">            different argument values.</span>

<span class="sd">            If only one argname was specified argvalues is a list of values.</span>
<span class="sd">            If N argnames were specified, argvalues must be a list of</span>
<span class="sd">            N-tuples, where each tuple-element specifies a value for its</span>
<span class="sd">            respective argname.</span>

<span class="sd">        :param indirect:</span>
<span class="sd">            A list of arguments&#39; names (subset of argnames) or a boolean.</span>
<span class="sd">            If True the list contains all names from the argnames. Each</span>
<span class="sd">            argvalue corresponding to an argname in this list will</span>
<span class="sd">            be passed as request.param to its respective argname fixture</span>
<span class="sd">            function so that it can perform more expensive setups during the</span>
<span class="sd">            setup phase of a test rather than at collection time.</span>

<span class="sd">        :param ids:</span>
<span class="sd">            Sequence of (or generator for) ids for ``argvalues``,</span>
<span class="sd">            or a callable to return part of the id for each argvalue.</span>

<span class="sd">            With sequences (and generators like ``itertools.count()``) the</span>
<span class="sd">            returned ids should be of type ``string``, ``int``, ``float``,</span>
<span class="sd">            ``bool``, or ``None``.</span>
<span class="sd">            They are mapped to the corresponding index in ``argvalues``.</span>
<span class="sd">            ``None`` means to use the auto-generated id.</span>

<span class="sd">            If it is a callable it will be called for each entry in</span>
<span class="sd">            ``argvalues``, and the return value is used as part of the</span>
<span class="sd">            auto-generated id for the whole set (where parts are joined with</span>
<span class="sd">            dashes (&quot;-&quot;)).</span>
<span class="sd">            This is useful to provide more specific ids for certain items, e.g.</span>
<span class="sd">            dates.  Returning ``None`` will use an auto-generated id.</span>

<span class="sd">            If no ids are provided they will be generated automatically from</span>
<span class="sd">            the argvalues.</span>

<span class="sd">        :param scope:</span>
<span class="sd">            If specified it denotes the scope of the parameters.</span>
<span class="sd">            The scope is used for grouping tests by parameter instances.</span>
<span class="sd">            It will also override any fixture-function defined scope, allowing</span>
<span class="sd">            to set a dynamic scope using test context or configuration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">_pytest.fixtures</span> <span class="kn">import</span> <span class="n">scope2index</span>

        <span class="n">argnames</span><span class="p">,</span> <span class="n">parameters</span> <span class="o">=</span> <span class="n">ParameterSet</span><span class="o">.</span><span class="n">_for_parametrize</span><span class="p">(</span>
            <span class="n">argnames</span><span class="p">,</span>
            <span class="n">argvalues</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
            <span class="n">nodeid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">nodeid</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">del</span> <span class="n">argvalues</span>

        <span class="k">if</span> <span class="s2">&quot;request&quot;</span> <span class="ow">in</span> <span class="n">argnames</span><span class="p">:</span>
            <span class="n">fail</span><span class="p">(</span>
                <span class="s2">&quot;&#39;request&#39; is a reserved name and cannot be used in @pytest.mark.parametrize&quot;</span><span class="p">,</span>
                <span class="n">pytrace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">scope</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scope</span> <span class="o">=</span> <span class="n">_find_parametrized_scope</span><span class="p">(</span><span class="n">argnames</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arg2fixturedefs</span><span class="p">,</span> <span class="n">indirect</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_if_using_arg_names</span><span class="p">(</span><span class="n">argnames</span><span class="p">,</span> <span class="n">indirect</span><span class="p">)</span>

        <span class="n">arg_values_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_arg_value_types</span><span class="p">(</span><span class="n">argnames</span><span class="p">,</span> <span class="n">indirect</span><span class="p">)</span>

        <span class="c1"># Use any already (possibly) generated ids with parametrize Marks.</span>
        <span class="k">if</span> <span class="n">_param_mark</span> <span class="ow">and</span> <span class="n">_param_mark</span><span class="o">.</span><span class="n">_param_ids_from</span><span class="p">:</span>
            <span class="n">generated_ids</span> <span class="o">=</span> <span class="n">_param_mark</span><span class="o">.</span><span class="n">_param_ids_from</span><span class="o">.</span><span class="n">_param_ids_generated</span>
            <span class="k">if</span> <span class="n">generated_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="n">generated_ids</span>

        <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_arg_ids</span><span class="p">(</span>
            <span class="n">argnames</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">nodeid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">definition</span><span class="o">.</span><span class="n">nodeid</span>
        <span class="p">)</span>

        <span class="c1"># Store used (possibly generated) ids with parametrize Marks.</span>
        <span class="k">if</span> <span class="n">_param_mark</span> <span class="ow">and</span> <span class="n">_param_mark</span><span class="o">.</span><span class="n">_param_ids_from</span> <span class="ow">and</span> <span class="n">generated_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">_param_mark</span><span class="o">.</span><span class="n">_param_ids_from</span><span class="p">,</span> <span class="s2">&quot;_param_ids_generated&quot;</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span>

        <span class="n">scopenum</span> <span class="o">=</span> <span class="n">scope2index</span><span class="p">(</span>
            <span class="n">scope</span><span class="p">,</span> <span class="n">descr</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;parametrize() call in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Create the new calls: if we are parametrize() multiple times (by applying the decorator</span>
        <span class="c1"># more than once) then we accumulate those calls generating the cartesian product</span>
        <span class="c1"># of all calls.</span>
        <span class="n">newcalls</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">callspec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span> <span class="ow">or</span> <span class="p">[</span><span class="n">CallSpec2</span><span class="p">(</span><span class="bp">self</span><span class="p">)]:</span>
            <span class="k">for</span> <span class="n">param_index</span><span class="p">,</span> <span class="p">(</span><span class="n">param_id</span><span class="p">,</span> <span class="n">param_set</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)):</span>
                <span class="n">newcallspec</span> <span class="o">=</span> <span class="n">callspec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">newcallspec</span><span class="o">.</span><span class="n">setmulti2</span><span class="p">(</span>
                    <span class="n">arg_values_types</span><span class="p">,</span>
                    <span class="n">argnames</span><span class="p">,</span>
                    <span class="n">param_set</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                    <span class="n">param_id</span><span class="p">,</span>
                    <span class="n">param_set</span><span class="o">.</span><span class="n">marks</span><span class="p">,</span>
                    <span class="n">scopenum</span><span class="p">,</span>
                    <span class="n">param_index</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">newcalls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newcallspec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calls</span> <span class="o">=</span> <span class="n">newcalls</span></div>

    <span class="k">def</span> <span class="nf">_resolve_arg_ids</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">argnames</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">Union</span><span class="p">[</span>
                <span class="n">Iterable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]],</span>
                <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]],</span>
            <span class="p">]</span>
        <span class="p">],</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ParameterSet</span><span class="p">],</span>
        <span class="n">nodeid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Resolve the actual ids for the given argnames, based on the ``ids`` parameter given</span>
<span class="sd">        to ``parametrize``.</span>

<span class="sd">        :param List[str] argnames: List of argument names passed to ``parametrize()``.</span>
<span class="sd">        :param ids: The ids parameter of the parametrized call (see docs).</span>
<span class="sd">        :param List[ParameterSet] parameters: The list of parameter values, same size as ``argnames``.</span>
<span class="sd">        :param str str: The nodeid of the item that generated this parametrized call.</span>
<span class="sd">        :rtype: List[str]</span>
<span class="sd">        :returns: The list of ids for each argname given.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">idfn</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ids_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">callable</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
            <span class="n">idfn</span> <span class="o">=</span> <span class="n">ids</span>
            <span class="n">ids_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idfn</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ids_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate_ids</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">idmaker</span><span class="p">(</span><span class="n">argnames</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">idfn</span><span class="p">,</span> <span class="n">ids_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">nodeid</span><span class="o">=</span><span class="n">nodeid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_ids</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ids</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]],</span>
        <span class="n">parameters</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ParameterSet</span><span class="p">],</span>
        <span class="n">func_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">num_ids</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">iter</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;ids must be a callable or an iterable&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
            <span class="n">num_ids</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>

        <span class="c1"># num_ids == 0 is a special case: https://github.com/pytest-dev/pytest/issues/1849</span>
        <span class="k">if</span> <span class="n">num_ids</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span> <span class="ow">and</span> <span class="n">num_ids</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;In </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2"> parameter sets specified, with different number of ids: </span><span class="si">{}</span><span class="s2">&quot;</span>
            <span class="n">fail</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func_name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="p">),</span> <span class="n">num_ids</span><span class="p">),</span> <span class="n">pytrace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">new_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">id_value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">islice</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">num_ids</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">id_value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">id_value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">new_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">id_value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">id_value</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)):</span>
                <span class="n">new_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">id_value</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>  <span class="c1"># type: ignore[unreachable]</span>
                    <span class="s2">&quot;In </span><span class="si">{}</span><span class="s2">: ids must be list of string/float/int/bool, &quot;</span>
                    <span class="s2">&quot;found: </span><span class="si">{}</span><span class="s2"> (type: </span><span class="si">{!r}</span><span class="s2">) at index </span><span class="si">{}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="n">fail</span><span class="p">(</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func_name</span><span class="p">,</span> <span class="n">saferepr</span><span class="p">(</span><span class="n">id_value</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">id_value</span><span class="p">),</span> <span class="n">idx</span><span class="p">),</span>
                    <span class="n">pytrace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">new_ids</span>

    <span class="k">def</span> <span class="nf">_resolve_arg_value_types</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">argnames</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">indirect</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;Literal[&#39;params&#39;, &#39;funcargs&#39;]&quot;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Resolve if each parametrized argument must be considered a</span>
<span class="sd">        parameter to a fixture or a &quot;funcarg&quot; to the function, based on the</span>
<span class="sd">        ``indirect`` parameter of the parametrized() call.</span>

<span class="sd">        :param List[str] argnames: List of argument names passed to ``parametrize()``.</span>
<span class="sd">        :param indirect: Same as the ``indirect`` parameter of ``parametrize()``.</span>
<span class="sd">        :rtype: Dict[str, str]</span>
<span class="sd">            A dict mapping each arg name to either:</span>
<span class="sd">            * &quot;params&quot; if the argname should be the parameter of a fixture of the same name.</span>
<span class="sd">            * &quot;funcargs&quot; if the argname should be a parameter to the parametrized test function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indirect</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">valtypes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">,</span> <span class="s2">&quot;funcargs&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span>
                <span class="n">argnames</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span> <span class="k">if</span> <span class="n">indirect</span> <span class="k">else</span> <span class="s2">&quot;funcargs&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indirect</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
            <span class="n">valtypes</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">argnames</span><span class="p">,</span> <span class="s2">&quot;funcargs&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">indirect</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">argnames</span><span class="p">:</span>
                    <span class="n">fail</span><span class="p">(</span>
                        <span class="s2">&quot;In </span><span class="si">{}</span><span class="s2">: indirect fixture &#39;</span><span class="si">{}</span><span class="s2">&#39; doesn&#39;t exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">arg</span>
                        <span class="p">),</span>
                        <span class="n">pytrace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="n">valtypes</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;params&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fail</span><span class="p">(</span>
                <span class="s2">&quot;In </span><span class="si">{func}</span><span class="s2">: expected Sequence or boolean for indirect, got </span><span class="si">{type}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">indirect</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="p">),</span>
                <span class="n">pytrace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">valtypes</span>

    <span class="k">def</span> <span class="nf">_validate_if_using_arg_names</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">argnames</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">indirect</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if all argnames are being used, by default values, or directly/indirectly.</span>

<span class="sd">        :param List[str] argnames: List of argument names passed to ``parametrize()``.</span>
<span class="sd">        :param indirect: Same as the ``indirect`` parameter of ``parametrize()``.</span>
<span class="sd">        :raises ValueError: If validation fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">default_arg_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">get_default_arg_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">))</span>
        <span class="n">func_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">argnames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixturenames</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">default_arg_names</span><span class="p">:</span>
                    <span class="n">fail</span><span class="p">(</span>
                        <span class="s2">&quot;In </span><span class="si">{}</span><span class="s2">: function already takes an argument &#39;</span><span class="si">{}</span><span class="s2">&#39; with a default value&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">func_name</span><span class="p">,</span> <span class="n">arg</span>
                        <span class="p">),</span>
                        <span class="n">pytrace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indirect</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;fixture&quot;</span> <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">indirect</span> <span class="k">else</span> <span class="s2">&quot;argument&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;fixture&quot;</span> <span class="k">if</span> <span class="n">indirect</span> <span class="k">else</span> <span class="s2">&quot;argument&quot;</span>
                    <span class="n">fail</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;In </span><span class="si">{</span><span class="n">func_name</span><span class="si">}</span><span class="s2">: function uses no </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> &#39;</span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                        <span class="n">pytrace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_find_parametrized_scope</span><span class="p">(</span>
    <span class="n">argnames</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">arg2fixturedefs</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">fixtures</span><span class="o">.</span><span class="n">FixtureDef</span><span class="p">[</span><span class="nb">object</span><span class="p">]]],</span>
    <span class="n">indirect</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;fixtures._Scope&quot;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Find the most appropriate scope for a parametrized call based on its arguments.</span>

<span class="sd">    When there&#39;s at least one direct argument, always use &quot;function&quot; scope.</span>

<span class="sd">    When a test function is parametrized and all its arguments are indirect</span>
<span class="sd">    (e.g. fixtures), return the most narrow scope based on the fixtures used.</span>

<span class="sd">    Related to issue #1832, based on code posted by @Kingdread.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indirect</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">):</span>
        <span class="n">all_arguments_are_fixtures</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indirect</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">argnames</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">all_arguments_are_fixtures</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">indirect</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">all_arguments_are_fixtures</span><span class="p">:</span>
        <span class="n">fixturedefs</span> <span class="o">=</span> <span class="n">arg2fixturedefs</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">used_scopes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">fixturedef</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scope</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">fixturedef</span> <span class="ow">in</span> <span class="n">fixturedefs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">argnames</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">used_scopes</span><span class="p">:</span>
            <span class="c1"># Takes the most narrow scope from used fixtures.</span>
            <span class="k">for</span> <span class="n">scope</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">fixtures</span><span class="o">.</span><span class="n">scopes</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">scope</span> <span class="ow">in</span> <span class="n">used_scopes</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">scope</span>

    <span class="k">return</span> <span class="s2">&quot;function&quot;</span>


<span class="k">def</span> <span class="nf">_ascii_escaped_by_config</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">],</span> <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Config</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">escape_option</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">escape_option</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getini</span><span class="p">(</span>
            <span class="s2">&quot;disable_test_id_escaping_and_forfeit_all_rights_to_community_support&quot;</span>
        <span class="p">)</span>
    <span class="c1"># TODO: If escaping is turned off and the user passes bytes,</span>
    <span class="c1">#       will return a bytes. For now we ignore this but the</span>
    <span class="c1">#       code *probably* doesn&#39;t handle this case.</span>
    <span class="k">return</span> <span class="n">val</span> <span class="k">if</span> <span class="n">escape_option</span> <span class="k">else</span> <span class="n">ascii_escaped</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>  <span class="c1"># type: ignore</span>


<span class="k">def</span> <span class="nf">_idval</span><span class="p">(</span>
    <span class="n">val</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span>
    <span class="n">argname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">idfn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]]],</span>
    <span class="n">nodeid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Config</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">idfn</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">generated_id</span> <span class="o">=</span> <span class="n">idfn</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">generated_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">generated_id</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nodeid</span><span class="si">}</span><span class="s2">: &quot;</span> <span class="k">if</span> <span class="n">nodeid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;error raised while trying to determine id of parameter &#39;</span><span class="si">{}</span><span class="s2">&#39; at position </span><span class="si">{}</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">argname</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
    <span class="k">elif</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">hook_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">pytest_make_parametrize_id</span><span class="p">(</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">argname</span><span class="o">=</span><span class="n">argname</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">hook_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hook_id</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">STRING_TYPES</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_ascii_escaped_by_config</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">REGEX_TYPE</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ascii_escaped</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">pattern</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">val</span> <span class="ow">is</span> <span class="n">NOTSET</span><span class="p">:</span>
        <span class="c1"># Fallback to default. Note that NOTSET is an enum.Enum.</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># Name of a class, function, module, etc.</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">name</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">argname</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_idvalset</span><span class="p">(</span>
    <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">parameterset</span><span class="p">:</span> <span class="n">ParameterSet</span><span class="p">,</span>
    <span class="n">argnames</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">idfn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]]],</span>
    <span class="n">ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]],</span>
    <span class="n">nodeid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Config</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">parameterset</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">parameterset</span><span class="o">.</span><span class="n">id</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="k">else</span> <span class="n">ids</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">this_id</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">_idval</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">argname</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">idfn</span><span class="p">,</span> <span class="n">nodeid</span><span class="o">=</span><span class="n">nodeid</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">val</span><span class="p">,</span> <span class="n">argname</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">parameterset</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">argnames</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">this_id</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_ascii_escaped_by_config</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">idmaker</span><span class="p">(</span>
    <span class="n">argnames</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">parametersets</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">ParameterSet</span><span class="p">],</span>
    <span class="n">idfn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ids</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Config</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">nodeid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">resolved_ids</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">_idvalset</span><span class="p">(</span>
            <span class="n">valindex</span><span class="p">,</span> <span class="n">parameterset</span><span class="p">,</span> <span class="n">argnames</span><span class="p">,</span> <span class="n">idfn</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">nodeid</span><span class="o">=</span><span class="n">nodeid</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">valindex</span><span class="p">,</span> <span class="n">parameterset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parametersets</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># All IDs must be unique!</span>
    <span class="n">unique_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">resolved_ids</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_ids</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">resolved_ids</span><span class="p">):</span>

        <span class="c1"># Record the number of occurrences of each test ID.</span>
        <span class="n">test_id_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">resolved_ids</span><span class="p">)</span>

        <span class="c1"># Map the test ID to its next suffix.</span>
        <span class="n">test_id_suffixes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Suffix non-unique IDs to make them unique.</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">test_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">resolved_ids</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">test_id_counts</span><span class="p">[</span><span class="n">test_id</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">resolved_ids</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_id</span><span class="p">,</span> <span class="n">test_id_suffixes</span><span class="p">[</span><span class="n">test_id</span><span class="p">])</span>
                <span class="n">test_id_suffixes</span><span class="p">[</span><span class="n">test_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">resolved_ids</span>


<span class="k">def</span> <span class="nf">show_fixtures_per_test</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">_pytest.main</span> <span class="kn">import</span> <span class="n">wrap_session</span>

    <span class="k">return</span> <span class="n">wrap_session</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">_show_fixtures_per_test</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_show_fixtures_per_test</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">_pytest.config</span>

    <span class="n">session</span><span class="o">.</span><span class="n">perform_collect</span><span class="p">()</span>
    <span class="n">curdir</span> <span class="o">=</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">()</span>
    <span class="n">tw</span> <span class="o">=</span> <span class="n">_pytest</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">create_terminal_writer</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_best_relpath</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="n">getlocation</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">curdir</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">curdir</span><span class="o">.</span><span class="n">bestrelpath</span><span class="p">(</span><span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">(</span><span class="n">loc</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">write_fixture</span><span class="p">(</span><span class="n">fixture_def</span><span class="p">:</span> <span class="n">fixtures</span><span class="o">.</span><span class="n">FixtureDef</span><span class="p">[</span><span class="nb">object</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">argname</span> <span class="o">=</span> <span class="n">fixture_def</span><span class="o">.</span><span class="n">argname</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">argname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bestrel</span> <span class="o">=</span> <span class="n">get_best_relpath</span><span class="p">(</span><span class="n">fixture_def</span><span class="o">.</span><span class="n">func</span><span class="p">)</span>
            <span class="n">funcargspec</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">argname</span><span class="si">}</span><span class="s2"> -- </span><span class="si">{</span><span class="n">bestrel</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">funcargspec</span> <span class="o">=</span> <span class="n">argname</span>
        <span class="n">tw</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">funcargspec</span><span class="p">,</span> <span class="n">green</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">fixture_doc</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="n">fixture_def</span><span class="o">.</span><span class="n">func</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fixture_doc</span><span class="p">:</span>
            <span class="n">write_docstring</span><span class="p">(</span><span class="n">tw</span><span class="p">,</span> <span class="n">fixture_doc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tw</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="s2">&quot;    no docstring available&quot;</span><span class="p">,</span> <span class="n">red</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write_item</span><span class="p">(</span><span class="n">item</span><span class="p">:</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Item</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Not all items have _fixtureinfo attribute.</span>
        <span class="n">info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FuncFixtureInfo</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s2">&quot;_fixtureinfo&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">info</span><span class="o">.</span><span class="n">name2fixturedefs</span><span class="p">:</span>
            <span class="c1"># This test item does not use any fixtures.</span>
            <span class="k">return</span>
        <span class="n">tw</span><span class="o">.</span><span class="n">line</span><span class="p">()</span>
        <span class="n">tw</span><span class="o">.</span><span class="n">sep</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;fixtures used by </span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># TODO: Fix this type ignore.</span>
        <span class="n">tw</span><span class="o">.</span><span class="n">sep</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">get_best_relpath</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">function</span><span class="p">)))</span>  <span class="c1"># type: ignore[attr-defined]</span>
        <span class="c1"># dict key not used in loop but needed for sorting.</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">fixturedefs</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">name2fixturedefs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">assert</span> <span class="n">fixturedefs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fixturedefs</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># Last item is expected to be the one used by the test item.</span>
            <span class="n">write_fixture</span><span class="p">(</span><span class="n">fixturedefs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">session_item</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
        <span class="n">write_item</span><span class="p">(</span><span class="n">session_item</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">showfixtures</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">ExitCode</span><span class="p">]:</span>
    <span class="kn">from</span> <span class="nn">_pytest.main</span> <span class="kn">import</span> <span class="n">wrap_session</span>

    <span class="k">return</span> <span class="n">wrap_session</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">_showfixtures_main</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_showfixtures_main</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">_pytest.config</span>

    <span class="n">session</span><span class="o">.</span><span class="n">perform_collect</span><span class="p">()</span>
    <span class="n">curdir</span> <span class="o">=</span> <span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">()</span>
    <span class="n">tw</span> <span class="o">=</span> <span class="n">_pytest</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">create_terminal_writer</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">)</span>

    <span class="n">fm</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">_fixturemanager</span>

    <span class="n">available</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">seen</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">argname</span><span class="p">,</span> <span class="n">fixturedefs</span> <span class="ow">in</span> <span class="n">fm</span><span class="o">.</span><span class="n">_arg2fixturedefs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">assert</span> <span class="n">fixturedefs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fixturedefs</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">fixturedef</span> <span class="ow">in</span> <span class="n">fixturedefs</span><span class="p">:</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">getlocation</span><span class="p">(</span><span class="n">fixturedef</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">curdir</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">fixturedef</span><span class="o">.</span><span class="n">argname</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">fixturedef</span><span class="o">.</span><span class="n">argname</span><span class="p">,</span> <span class="n">loc</span><span class="p">))</span>
            <span class="n">available</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">fixturedef</span><span class="o">.</span><span class="n">baseid</span><span class="p">),</span>
                    <span class="n">fixturedef</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
                    <span class="n">curdir</span><span class="o">.</span><span class="n">bestrelpath</span><span class="p">(</span><span class="n">py</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">local</span><span class="p">(</span><span class="n">loc</span><span class="p">)),</span>
                    <span class="n">fixturedef</span><span class="o">.</span><span class="n">argname</span><span class="p">,</span>
                    <span class="n">fixturedef</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="n">available</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">currentmodule</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">baseid</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">bestrel</span><span class="p">,</span> <span class="n">argname</span><span class="p">,</span> <span class="n">fixturedef</span> <span class="ow">in</span> <span class="n">available</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">currentmodule</span> <span class="o">!=</span> <span class="n">module</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">module</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_pytest.&quot;</span><span class="p">):</span>
                <span class="n">tw</span><span class="o">.</span><span class="n">line</span><span class="p">()</span>
                <span class="n">tw</span><span class="o">.</span><span class="n">sep</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;fixtures defined from </span><span class="si">{</span><span class="n">module</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">currentmodule</span> <span class="o">=</span> <span class="n">module</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">argname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;_&quot;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">tw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">argname</span><span class="p">,</span> <span class="n">green</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fixturedef</span><span class="o">.</span><span class="n">scope</span> <span class="o">!=</span> <span class="s2">&quot;function&quot;</span><span class="p">:</span>
            <span class="n">tw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; [</span><span class="si">%s</span><span class="s2"> scope]&quot;</span> <span class="o">%</span> <span class="n">fixturedef</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="n">cyan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; -- </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">bestrel</span><span class="p">,</span> <span class="n">yellow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">tw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="n">getlocation</span><span class="p">(</span><span class="n">fixturedef</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">curdir</span><span class="p">))</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="n">fixturedef</span><span class="o">.</span><span class="n">func</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">doc</span><span class="p">:</span>
            <span class="n">write_docstring</span><span class="p">(</span><span class="n">tw</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tw</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">loc</span><span class="si">}</span><span class="s2">: no docstring available&quot;</span><span class="p">,</span> <span class="n">red</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">tw</span><span class="o">.</span><span class="n">line</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">write_docstring</span><span class="p">(</span><span class="n">tw</span><span class="p">:</span> <span class="n">TerminalWriter</span><span class="p">,</span> <span class="n">doc</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">indent</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;    &quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
        <span class="n">tw</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="n">line</span><span class="p">)</span>


<div class="viewcode-block" id="Function"><a class="viewcode-back" href="../../reference.html#pytest.Function">[docs]</a><span class="k">class</span> <span class="nc">Function</span><span class="p">(</span><span class="n">PyobjMixin</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Item</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An Item responsible for setting up and executing a Python test function.</span>

<span class="sd">    param name:</span>
<span class="sd">        The full function name, including any decorations like those</span>
<span class="sd">        added by parametrization (``my_func[my_param]``).</span>
<span class="sd">    param parent:</span>
<span class="sd">        The parent Node.</span>
<span class="sd">    param config:</span>
<span class="sd">        The pytest Config object.</span>
<span class="sd">    param callspec:</span>
<span class="sd">        If given, this is function has been parametrized and the callspec contains</span>
<span class="sd">        meta information about the parametrization.</span>
<span class="sd">    param callobj:</span>
<span class="sd">        If given, the object which will be called when the Function is invoked,</span>
<span class="sd">        otherwise the callobj will be obtained from ``parent`` using ``originalname``.</span>
<span class="sd">    param keywords:</span>
<span class="sd">        Keywords bound to the function object for &quot;-k&quot; matching.</span>
<span class="sd">    param session:</span>
<span class="sd">        The pytest Session object.</span>
<span class="sd">    param fixtureinfo:</span>
<span class="sd">        Fixture information already resolved at this fixture node..</span>
<span class="sd">    param originalname:</span>
<span class="sd">        The attribute name to use for accessing the underlying function object.</span>
<span class="sd">        Defaults to ``name``. Set this if name is different from the original name,</span>
<span class="sd">        for example when it contains decorations like those added by parametrization</span>
<span class="sd">        (``my_func[my_param]``).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Disable since functions handle it themselves.</span>
    <span class="n">_ALLOW_MARKERS</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">parent</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Config</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">callspec</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CallSpec2</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">callobj</span><span class="o">=</span><span class="n">NOTSET</span><span class="p">,</span>
        <span class="n">keywords</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Session</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fixtureinfo</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FuncFixtureInfo</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">originalname</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">callobj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">NOTSET</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">callobj</span>

        <span class="c1">#: Original function name, without any decorations (for example</span>
        <span class="c1">#: parametrization adds a ``&quot;[...]&quot;`` suffix to function names), used to access</span>
        <span class="c1">#: the underlying function object from ``parent`` (in case ``callobj`` is not given</span>
        <span class="c1">#: explicitly).</span>
        <span class="c1">#:</span>
        <span class="c1">#: .. versionadded:: 3.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">originalname</span> <span class="o">=</span> <span class="n">originalname</span> <span class="ow">or</span> <span class="n">name</span>

        <span class="c1"># Note: when FunctionDefinition is introduced, we should change ``originalname``</span>
        <span class="c1"># to a readonly property that returns FunctionDefinition.name.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">own_markers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_unpacked_marks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">callspec</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callspec</span> <span class="o">=</span> <span class="n">callspec</span>
            <span class="c1"># this is total hostile and a mess</span>
            <span class="c1"># keywords are broken by design by now</span>
            <span class="c1"># this will be redeemed later</span>
            <span class="k">for</span> <span class="n">mark</span> <span class="ow">in</span> <span class="n">callspec</span><span class="o">.</span><span class="n">marks</span><span class="p">:</span>
                <span class="c1"># feel free to cry, this was broken for years before</span>
                <span class="c1"># and keywords cant fix it per design</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">[</span><span class="n">mark</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mark</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">own_markers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">normalize_mark_list</span><span class="p">(</span><span class="n">callspec</span><span class="o">.</span><span class="n">marks</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">keywords</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">keywords</span><span class="p">)</span>

        <span class="c1"># todo: this is a hell of a hack</span>
        <span class="c1"># https://github.com/pytest-dev/pytest/issues/4569</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="n">mark</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">mark</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_markers</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">mark</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">fixtureinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fixtureinfo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_fixturemanager</span><span class="o">.</span><span class="n">getfixtureinfo</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="n">funcargs</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fixtureinfo</span><span class="p">:</span> <span class="n">FuncFixtureInfo</span> <span class="o">=</span> <span class="n">fixtureinfo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixturenames</span> <span class="o">=</span> <span class="n">fixtureinfo</span><span class="o">.</span><span class="n">names_closure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initrequest</span><span class="p">()</span>

<div class="viewcode-block" id="Function.from_parent"><a class="viewcode-back" href="../../reference.html#pytest.Function.from_parent">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_parent</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>  <span class="c1"># todo: determine sound type limitations</span>
        <span class="sd">&quot;&quot;&quot;The public constructor.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">from_parent</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_initrequest</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">funcargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="o">=</span> <span class="n">fixtures</span><span class="o">.</span><span class="n">FixtureRequest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_ispytest</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Underlying python &#39;function&#39; object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">getimfunc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getobj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">originalname</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_pyfuncitem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;(compatonly) for code expecting pytest-2.2 style request objects.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="Function.runtest"><a class="viewcode-back" href="../../reference.html#pytest.Function.runtest">[docs]</a>    <span class="k">def</span> <span class="nf">runtest</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Execute the underlying test function.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ihook</span><span class="o">.</span><span class="n">pytest_pyfunc_call</span><span class="p">(</span><span class="n">pyfuncitem</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">Instance</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">newinstance</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getobj</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">_fillfixtures</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_prunetraceback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">excinfo</span><span class="p">:</span> <span class="n">ExceptionInfo</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_obj&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;fulltrace&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">_pytest</span><span class="o">.</span><span class="n">_code</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">from_function</span><span class="p">(</span><span class="n">get_real_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="p">))</span>
            <span class="n">path</span><span class="p">,</span> <span class="n">firstlineno</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">code</span><span class="o">.</span><span class="n">firstlineno</span>
            <span class="n">traceback</span> <span class="o">=</span> <span class="n">excinfo</span><span class="o">.</span><span class="n">traceback</span>
            <span class="n">ntraceback</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">firstlineno</span><span class="o">=</span><span class="n">firstlineno</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ntraceback</span> <span class="o">==</span> <span class="n">traceback</span><span class="p">:</span>
                <span class="n">ntraceback</span> <span class="o">=</span> <span class="n">ntraceback</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ntraceback</span> <span class="o">==</span> <span class="n">traceback</span><span class="p">:</span>
                    <span class="n">ntraceback</span> <span class="o">=</span> <span class="n">ntraceback</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filter_traceback</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ntraceback</span><span class="p">:</span>
                        <span class="n">ntraceback</span> <span class="o">=</span> <span class="n">traceback</span>

            <span class="n">excinfo</span><span class="o">.</span><span class="n">traceback</span> <span class="o">=</span> <span class="n">ntraceback</span><span class="o">.</span><span class="n">filter</span><span class="p">()</span>
            <span class="c1"># issue364: mark all but first and last frames to</span>
            <span class="c1"># only show a single-line message for each frame.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;tbstyle&quot;</span><span class="p">,</span> <span class="s2">&quot;auto&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">excinfo</span><span class="o">.</span><span class="n">traceback</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">excinfo</span><span class="o">.</span><span class="n">traceback</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">entry</span><span class="o">.</span><span class="n">set_repr_style</span><span class="p">(</span><span class="s2">&quot;short&quot;</span><span class="p">)</span>

    <span class="c1"># TODO: Type ignored -- breaks Liskov Substitution.</span>
<div class="viewcode-block" id="Function.repr_failure"><a class="viewcode-back" href="../../reference.html#pytest.Function.repr_failure">[docs]</a>    <span class="k">def</span> <span class="nf">repr_failure</span><span class="p">(</span>  <span class="c1"># type: ignore[override]</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">excinfo</span><span class="p">:</span> <span class="n">ExceptionInfo</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TerminalRepr</span><span class="p">]:</span>
        <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getoption</span><span class="p">(</span><span class="s2">&quot;tbstyle&quot;</span><span class="p">,</span> <span class="s2">&quot;auto&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
            <span class="n">style</span> <span class="o">=</span> <span class="s2">&quot;long&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repr_failure_py</span><span class="p">(</span><span class="n">excinfo</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="FunctionDefinition"><a class="viewcode-back" href="../../reference.html#pytest.FunctionDefinition">[docs]</a><span class="k">class</span> <span class="nc">FunctionDefinition</span><span class="p">(</span><span class="n">Function</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class is a step gap solution until we evolve to have actual function definition nodes</span>
<span class="sd">    and manage to get rid of ``metafunc``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FunctionDefinition.runtest"><a class="viewcode-back" href="../../reference.html#pytest.FunctionDefinition.runtest">[docs]</a>    <span class="k">def</span> <span class="nf">runtest</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;function definitions are not supposed to be run as tests&quot;</span><span class="p">)</span></div>

    <span class="n">setup</span> <span class="o">=</span> <span class="n">runtest</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
      </div>
  <span id="sidebar-top"></span>
      <div class="clearer"></div>
    </div>
  
    <div class="footer" role="contentinfo">
        &#169; Copyright 20152020, holger krekel and pytest-dev team.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.5.4.
    </div>
  <script src="../../_static/version_warning_offset.js"></script>

  </body>
</html>