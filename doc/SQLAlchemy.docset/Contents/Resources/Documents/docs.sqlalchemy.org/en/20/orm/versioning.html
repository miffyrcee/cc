<html><!-- Mirrored from docs.sqlalchemy.org/en/20/orm/versioning.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 06 Jul 2023 08:05:55 GMT --><!-- Added by HTTrack --><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><!-- /Added by HTTrack -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>
        
        
    
    Configuring a Version Counter
 </title>

    

    

    <link href="../../../../fonts.googleapis.com/cssa2b2.css?family=Lato:400,700|Roboto+Slab:400,700" rel="stylesheet" type="text/css">

    
        <!-- begin iterate through SQLA css_files -->
            <link rel="stylesheet" href="../_static/pygments.css" type="text/css">
        <!-- end iterate through SQLA css_files -->

        <!-- begin iterate through sphinx environment local css_files -->
            <link rel="stylesheet" href="../_static/pygments.css" type="text/css">
            <link rel="stylesheet" href="../_static/default.css" type="text/css">
            <link rel="stylesheet" href="../_static/copybutton.css" type="text/css">
            <link rel="stylesheet" href="../_static/docs.css" type="text/css">
            <link rel="stylesheet" href="../_static/changelog.css" type="text/css">
            <link rel="stylesheet" href="../_static/sphinx_paramlinks.css" type="text/css">
        <!-- end iterate through sphinx environment local css_files -->

        <link rel="stylesheet" type="text/css" media="all" href="../../../../www.sqlalchemy.org/css/bootstrap.min.css">
	    <link rel="stylesheet" type="text/css" media="all" href="../../../../www.sqlalchemy.org/css/site.css">
        <link rel="stylesheet" type="text/css" media="all" href="../../../../www.sqlalchemy.org/css/sidebar_extra.css">
        <link rel="stylesheet" type="text/css" media="print" href="../../../../www.sqlalchemy.org/css/print.css">

        <!-- begin iterate through sphinx environment remote css_files -->
        <!-- end iterate through sphinx environment remote css_files -->
    

    

    

    


    
        <link rel="canonical" href="http://docs.sqlalchemy.org/en/latest/orm/versioning.html">

    <script type="text/javascript">
        var doc_version = "latest";
        var doc_slug = "sqlalchemy";
        var static_root = "../_static"

        // copied from:
        // https://github.com/rtfd/readthedocs.org/commit/edbbb4c753454cf20c128d4eb2fef60d740debaa#diff-2f70e8d9361202bfe3f378d2ff2c510bR8
        var READTHEDOCS_DATA = {
            project: "sqlalchemy",
            version: "latest",
            page: "orm/versioning",
            theme: ""
          };


    </script>
    <!-- end RTD <head> via SQLAlchemy adapter -->

    

    <!-- begin layout.mako headers -->

    <link rel="index" title="Index" href="../genindex.html">
    <link rel="search" title="Search" href="../search.html">
        <link rel="copyright" title="Copyright" href="../copyright.html">
    <link rel="top" title="SQLAlchemy 2.0 Documentation" href="../index-2.html">
        <link rel="up" title="ORM Mapped Class Configuration" href="mapper_config.html">
        <link rel="next" title="Class Mapping API" href="mapping_api.html">
        <link rel="prev" title="Non-Traditional Mappings" href="nonstandard_mappings.html">
    <!-- end layout.mako headers -->




    

    <!-- sqlalchemy.org docs base head -->
    
<link rel="shortcut icon" href="../../../../www.sqlalchemy.org/favicon.ico" type="image/x-icon">
<link href="../../../../fonts.googleapis.com/css118a.css?family=Source+Sans+Pro:400,600,400italic" rel="stylesheet" type="text/css">

<script type="text/javascript">
var site_base='//www.sqlalchemy.org';
var docs_base='//docs.sqlalchemy.org';
</script>


    <!-- end sqlalchemy.org docs base head -->

</head>

<body>

<div id="wrap" class="container-xxl wrap px-0">





<nav class="navbar navbar-light logo">
    <div class="container-fluid">
        <a class="navbar-brand" href="http://www.sqlalchemy.org/">
            <img src="../../../../www.sqlalchemy.org/img/sqla_logo.png" width="240" alt="SQLAlchemy">
        </a>
        <div class="navbar-brand align-self-end dbtoolkit">
            <img src="../../../../www.sqlalchemy.org/img/dbtoolkit6.gif" width="180" height="12" alt="The Database Toolkit for Python">
        </div>
    </div>
</nav>
<nav class="navbar navbar-expand-md navbar-dark bg-sa-green py-0 navigation">
    <div class="container-fluid">
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavigation" aria-controls="navbarNavigation" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <span class="navbar-brand d-md-block d-md-none" href="#">The Database Toolkit for Python</span>
        <div class="collapse navbar-collapse" id="navbarNavigation">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link " href="http://www.sqlalchemy.org/">home</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle " href="#" id="feature-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        features
                    </a>
                    <ul class="dropdown-menu dropdown-menu-dark bg-sa-green" aria-labelledby="feature-dropdown">
                        <li><a class="dropdown-item" href="http://www.sqlalchemy.org/philosophy.html">Philosophy Statement</a></li>
                        <li><a class="dropdown-item" href="http://www.sqlalchemy.org/features.html">Feature Overview</a></li>
                        <li><a class="dropdown-item" href="http://www.sqlalchemy.org/quotes.html">Testimonials</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a class="nav-link " href="http://www.sqlalchemy.org/blog/">news</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle active" aria-current="page" href="#" id="docs-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        documentation
                    </a>
                    <ul class="dropdown-menu dropdown-menu-dark bg-sa-green" aria-labelledby="docs-dropdown">
                        <li><a class="dropdown-item" href="http://docs.sqlalchemy.org/">Current Documentation (version 2.0)</a></li>

                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="http://www.sqlalchemy.org/library.html#reference">Documentation by Version</a></li>
                        
        <li>
            <a class="dropdown-item" href="../index.html">
                <span class="ps-2">Version 2.0</span>
            </a>
        </li>
        <li>
            <a class="dropdown-item" href="http://docs.sqlalchemy.org/en/14/">
                <span class="ps-2">Version 1.4</span>
            </a>
        </li>
        <li>
            <a class="dropdown-item" href="http://docs.sqlalchemy.org/en/13/">
                <span class="ps-2">Version 1.3</span>
            </a>
        </li>

                        <li><hr class="dropdown-divider"></li>

                        <li><a class="dropdown-item" href="http://www.sqlalchemy.org/library.html#talks">Talks and Tutorials</a></li>
                        <li><a class="dropdown-item" href="http://www.sqlalchemy.org/library.html">Published content overview</a></li>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle " href="#" id="community-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        community
                    </a>
                    <ul class="dropdown-menu dropdown-menu-dark bg-sa-green" aria-labelledby="community-dropdown">
                        <li><a class="dropdown-item" href="http://www.sqlalchemy.org/support.html">Get Support</a></li>
                        <li><a class="dropdown-item" href="http://www.sqlalchemy.org/participate.html">Participate</a></li>
                        <li><a class="dropdown-item" href="http://www.sqlalchemy.org/develop.html">Develop</a></li>
                        <li><a class="dropdown-item" href="http://www.sqlalchemy.org/codeofconduct.html">Code of Conduct</a></li>
                        <li><a class="dropdown-item" href="https://github.com/sqlalchemy/sqlalchemy">Github</a></li>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle " href="#" id="download-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        download
                    </a>
                    <ul class="dropdown-menu dropdown-menu-dark bg-sa-green" aria-labelledby="download-dropdown">
                        <li><a class="dropdown-item" href="http://www.sqlalchemy.org/download.html">Download</a>
                        






    </li><li><a class="dropdown-item" href="http://www.sqlalchemy.org/download.html#current">Current Release Series (2.0)</a></li>

    <li><a class="dropdown-item" href="http://www.sqlalchemy.org/download.html#maintenance">Maintenance Release (1.4)</a></li>

    <li><a class="dropdown-item" href="http://www.sqlalchemy.org/download.html#development">Development Access</a></li>
    <li><a class="dropdown-item" href="http://www.sqlalchemy.org/download.html#license">License</a></li>
    <li><a class="dropdown-item" href="http://www.sqlalchemy.org/download.html#versions">Version Numbering</a></li>
    <li><a class="dropdown-item" href="http://www.sqlalchemy.org/download.html#relstatus">Release Status</a></li>

                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>


<div id="main-body" class="docs main-body row m-0">

<main id="docs" class="docs">


















<div id="docs-container">





<div id="docs-top-navigation-container" class="body-background">
<div id="docs-header">
    <div id="docs-version-header">
        Release: <span class="version-num">2.0.18</span>

            <span id="sidebar-current">current release</span>

        | Release Date: July 5, 2023

    </div>

    <h1><a href="../index-2.html">SQLAlchemy 2.0 Documentation</a></h1>

</div>
</div>

<div id="docs-body-container">

    <div id="fixed-sidebar" class="">



        <div id="docs-sidebar-popout">
            <h3><a href="../index-2.html">SQLAlchemy 2.0 Documentation</a></h3>
                <p id="sidebar-current">current release</p>
            <p id="sidebar-topnav">
                <a href="../index-2.html">Home</a>
                | <a href="http://docs.sqlalchemy.org/20/sqlalchemy_20.zip">Download this Documentation</a>
            </p>

            <div id="sidebar-search">
                <form class="search" action="https://docs.sqlalchemy.org/en/20/search.html" method="get">
                  <label>
                  Search terms:
                  <input type="text" placeholder="search..." name="q" size="12">
                  </label>
                  <input type="hidden" name="check_keywords" value="yes">
                  <input type="hidden" name="area" value="default">
                </form>
            </div>

        </div>

        <div id="docs-sidebar">

        <div id="sidebar-banner">
            
        
<script async="" type="text/javascript" id="_carbonads_js"></script>
<script async="" type="text/javascript" id="_eaads_js" src="../../../../media.ethicalads.io/media/client/ethicalads.min.js"></script>

<div data-ea-publisher="sqlalchemyorg" data-ea-type="image" class="adaptive flat horizontal"></div>

<script type="text/javascript">

var ea = "../../../../media.ethicalads.io/media/client/ethicalads.min.js";
var carbon = "../../../../cdn.carbonads.com/carbon8b90.js?serve=CKYILK7Y&amp;placement=sqlalchemyorg";

if (Math.floor(Math.random() * 10) < 8) {
    ea_script = document.getElementById("_eaads_js");
    ea_script.setAttribute('src', ea);
}
else {
    carbon_script = document.getElementById("_carbonads_js");
    carbon_script.setAttribute('src', carbon);
}

</script>

    
        </div>

        <div id="docs-sidebar-inner">

        
        <h3>
            <a href="index.html" title="SQLAlchemy ORM">SQLAlchemy ORM</a>
        </h3>

        <ul>
<li><span class="link-container"><a class="reference external" href="quickstart.html">ORM Quick Start</a></span></li>
<li><span class="link-container"><a class="reference external" href="mapper_config.html">ORM Mapped Class Configuration</a></span><ul>
<li><span class="link-container"><a class="reference external" href="mapping_styles.html">ORM Mapped Class Overview</a></span></li>
<li><span class="link-container"><a class="reference external" href="declarative_mapping.html">Mapping Classes with Declarative</a></span></li>
<li><span class="link-container"><a class="reference external" href="dataclasses.html">Integration with dataclasses and attrs</a></span></li>
<li><span class="link-container"><a class="reference external" href="mapped_sql_expr.html">SQL Expressions as Mapped Attributes</a></span></li>
<li><span class="link-container"><a class="reference external" href="mapped_attributes.html">Changing Attribute Behavior</a></span></li>
<li><span class="link-container"><a class="reference external" href="composites.html">Composite Column Types</a></span></li>
<li><span class="link-container"><a class="reference external" href="inheritance.html">Mapping Class Inheritance Hierarchies</a></span></li>
<li><span class="link-container"><a class="reference external" href="nonstandard_mappings.html">Non-Traditional Mappings</a></span></li>
<li class="selected"><span class="link-container"><strong>Configuring a Version Counter</strong><a class="paramlink headerlink reference internal" href="#">¶</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#simple-version-counting">Simple Version Counting</a></span></li>
<li><span class="link-container"><a class="reference external" href="#custom-version-counters-types">Custom Version Counters / Types</a></span></li>
<li><span class="link-container"><a class="reference external" href="#server-side-version-counters">Server Side Version Counters</a></span></li>
<li><span class="link-container"><a class="reference external" href="#programmatic-or-conditional-version-counters">Programmatic or Conditional Version Counters</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="mapping_api.html">Class Mapping API</a></span></li>
<li><span class="link-container"><a class="reference external" href="scalar_mapping.html">Mapping SQL Expressions</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="relationships.html">Relationship Configuration</a></span></li>
<li><span class="link-container"><a class="reference external" href="queryguide/index.html">ORM Querying Guide</a></span></li>
<li><span class="link-container"><a class="reference external" href="session.html">Using the Session</a></span></li>
<li><span class="link-container"><a class="reference external" href="extending.html">Events and Internals</a></span></li>
<li><span class="link-container"><a class="reference external" href="extensions/index.html">ORM Extensions</a></span></li>
<li><span class="link-container"><a class="reference external" href="examples.html">ORM Examples</a></span></li>
</ul>


        <h4>Project Versions</h4>
        <ul class="version-listing">
            <li><a href="../index-2.html">2.0.18</a></li>
        </ul>

        </div>

        </div>

    </div>

    <div id="narrow-index-nav">
        <form class="search" action="https://docs.sqlalchemy.org/en/20/search.html" method="get">
            <label>
                Search terms:
            <input type="text" placeholder="search..." name="q" size="12">
            </label>
            <input type="submit" value="Search">
            <input type="hidden" name="check_keywords" value="yes">
            <input type="hidden" name="area" value="default">
        </form>

        <p>
        <a href="../index-2.html">Home</a>
        | <a href="http://docs.sqlalchemy.org/20/sqlalchemy_20.zip">Download this Documentation</a>
        </p>

    </div>


        <div id="docs-narrow-top-navigation">
            <ul>
                <li><b>Previous:</b>
                <a href="nonstandard_mappings.html" title="previous chapter">Non-Traditional Mappings</a></li>
                <li><b>Next:</b>
                <a href="mapping_api.html" title="next chapter">Class Mapping API</a></li>

            <li><b>Up:</b> <a href="../index-2.html">Home</a></li>
                    <ul><li><a href="index.html" title="SQLAlchemy ORM">SQLAlchemy ORM</a></li>
                    <ul><li><a href="mapper_config.html" title="ORM Mapped Class Configuration">ORM Mapped Class Configuration</a></li>
                </ul>
                </ul>



            <li><b>On this page:</b></li>
            <ul>
<li><a class="reference internal" href="#configuring-a-version-counter">Configuring a Version Counter</a><ul>
<li><a class="reference internal" href="#simple-version-counting">Simple Version Counting</a></li>
<li><a class="reference internal" href="#custom-version-counters-types">Custom Version Counters / Types</a></li>
<li><a class="reference internal" href="#server-side-version-counters">Server Side Version Counters</a></li>
<li><a class="reference internal" href="#programmatic-or-conditional-version-counters">Programmatic or Conditional Version Counters</a></li>
</ul>
</li>
</ul>


            </ul>

        </div>



    <div id="docs-body" role="main" class=" orm-versioning">
        
<section id="configuring-a-version-counter">
<span id="mapper-version-counter"></span><h1>Configuring a Version Counter<a class="headerlink" href="#configuring-a-version-counter" title="Permalink to this heading">¶</a></h1>
<p>The <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.Mapper" title="sqlalchemy.orm.Mapper"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapper</span></code></a> supports management of a <a class="reference internal" href="../glossary.html#term-version-id-column"><span class="xref std std-term">version id column</span></a>, which
is a single table column that increments or otherwise updates its value
each time an <code class="docutils literal notranslate"><span class="pre">UPDATE</span></code> to the mapped table occurs.  This value is checked each
time the ORM emits an <code class="docutils literal notranslate"><span class="pre">UPDATE</span></code> or <code class="docutils literal notranslate"><span class="pre">DELETE</span></code> against the row to ensure that
the value held in memory matches the database value.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Because the versioning feature relies upon comparison of the <strong>in memory</strong>
record of an object, the feature only applies to the <a class="reference internal" href="session_api.html#sqlalchemy.orm.Session.flush" title="sqlalchemy.orm.Session.flush"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.flush()</span></code></a>
process, where the ORM flushes individual in-memory rows to the database.
It does <strong>not</strong> take effect when performing
a multirow UPDATE or DELETE using <a class="reference internal" href="queryguide/query.html#sqlalchemy.orm.Query.update" title="sqlalchemy.orm.Query.update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.update()</span></code></a> or <a class="reference internal" href="queryguide/query.html#sqlalchemy.orm.Query.delete" title="sqlalchemy.orm.Query.delete"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.delete()</span></code></a>
methods, as these methods only emit an UPDATE or DELETE statement but otherwise
do not have direct access to the contents of those rows being affected.</p>
</div>
<p>The purpose of this feature is to detect when two concurrent transactions
are modifying the same row at roughly the same time, or alternatively to provide
a guard against the usage of a “stale” row in a system that might be re-using
data from a previous transaction without refreshing (e.g. if one sets <code class="docutils literal notranslate"><span class="pre">expire_on_commit=False</span></code>
with a <a class="reference internal" href="session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a>, it is possible to re-use the data from a previous
transaction).</p>
<aside class="topic">
<p class="topic-title">Concurrent transaction updates</p>
<p>When detecting concurrent updates within transactions, it is typically the
case that the database’s transaction isolation level is below the level of
<a class="reference internal" href="../glossary.html#term-repeatable-read"><span class="xref std std-term">repeatable read</span></a>; otherwise, the transaction will not be exposed
to a new row value created by a concurrent update which conflicts with
the locally updated value.  In this case, the SQLAlchemy versioning
feature will typically not be useful for in-transaction conflict detection,
though it still can be used for cross-transaction staleness detection.</p>
<p>The database that enforces repeatable reads will typically either have locked the
target row against a concurrent update, or is employing some form
of multi version concurrency control such that it will emit an error
when the transaction is committed.  SQLAlchemy’s version_id_col is an alternative
which allows version tracking to occur for specific tables within a transaction
that otherwise might not have this isolation level set.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference external" href="https://www.postgresql.org/docs/current/static/transaction-iso.html#XACT-REPEATABLE-READ">Repeatable Read Isolation Level</a> - PostgreSQL’s implementation of repeatable read, including a description of the error condition.</p>
</div>
</aside>
<section id="simple-version-counting">
<h2>Simple Version Counting<a class="headerlink" href="#simple-version-counting" title="Permalink to this heading">¶</a></h2>
<p>The most straightforward way to track versions is to add an integer column
to the mapped table, then establish it as the <code class="docutils literal notranslate"><span class="pre">version_id_col</span></code> within the
mapper options:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">"user"</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">version_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"version_id_col"</span><span class="p">:</span> <span class="n">version_id</span><span class="p">}</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is <strong>strongly recommended</strong> that the <code class="docutils literal notranslate"><span class="pre">version_id</span></code> column
be made NOT NULL.  The versioning feature <strong>does not support</strong> a NULL
value in the versioning column.</p>
</div>
<p>Above, the <code class="docutils literal notranslate"><span class="pre">User</span></code> mapping tracks integer versions using the column
<code class="docutils literal notranslate"><span class="pre">version_id</span></code>.   When an object of type <code class="docutils literal notranslate"><span class="pre">User</span></code> is first flushed, the
<code class="docutils literal notranslate"><span class="pre">version_id</span></code> column will be given a value of “1”.   Then, an UPDATE
of the table later on will always be emitted in a manner similar to the
following:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">UPDATE</span><span class="w"> </span><span class="k">user</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">version_id</span><span class="o">=</span><span class="p">:</span><span class="n">version_id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="p">:</span><span class="n">name</span>
<span class="k">WHERE</span><span class="w"> </span><span class="k">user</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">:</span><span class="n">user_id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">user</span><span class="p">.</span><span class="n">version_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">:</span><span class="n">user_version_id</span>
<span class="c1">-- {"name": "new name", "version_id": 2, "user_id": 1, "user_version_id": 1}</span></pre></div>
</div>
<p>The above UPDATE statement is updating the row that not only matches
<code class="docutils literal notranslate"><span class="pre">user.id</span> <span class="pre">=</span> <span class="pre">1</span></code>, it also is requiring that <code class="docutils literal notranslate"><span class="pre">user.version_id</span> <span class="pre">=</span> <span class="pre">1</span></code>, where “1”
is the last version identifier we’ve been known to use on this object.
If a transaction elsewhere has modified the row independently, this version id
will no longer match, and the UPDATE statement will report that no rows matched;
this is the condition that SQLAlchemy tests, that exactly one row matched our
UPDATE (or DELETE) statement.  If zero rows match, that indicates our version
of the data is stale, and a <a class="reference internal" href="exceptions.html#sqlalchemy.orm.exc.StaleDataError" title="sqlalchemy.orm.exc.StaleDataError"><code class="xref py py-exc docutils literal notranslate"><span class="pre">StaleDataError</span></code></a> is raised.</p>
</section>
<section id="custom-version-counters-types">
<a class="dashAnchor" name="//apple_ref/Section/Custom%20Version%20Counters%20%2F%20Types"></a><span id="custom-version-counter"></span><h2>Custom Version Counters / Types<a class="headerlink" href="#custom-version-counters-types" title="Permalink to this heading">¶</a></h2>
<p>Other kinds of values or counters can be used for versioning.  Common types include
dates and GUIDs.   When using an alternate type or counter scheme, SQLAlchemy
provides a hook for this scheme using the <code class="docutils literal notranslate"><span class="pre">version_id_generator</span></code> argument,
which accepts a version generation callable.  This callable is passed the value of the current
known version, and is expected to return the subsequent version.</p>
<p>For example, if we wanted to track the versioning of our <code class="docutils literal notranslate"><span class="pre">User</span></code> class
using a randomly generated GUID, we could do this (note that some backends
support a native GUID type, but we illustrate here using a simple string):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">uuid</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">"user"</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">version_uuid</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">"version_id_col"</span><span class="p">:</span> <span class="n">version_uuid</span><span class="p">,</span>
        <span class="s2">"version_id_generator"</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">version</span><span class="p">:</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">,</span>
    <span class="p">}</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>The persistence engine will call upon <code class="docutils literal notranslate"><span class="pre">uuid.uuid4()</span></code> each time a
<code class="docutils literal notranslate"><span class="pre">User</span></code> object is subject to an INSERT or an UPDATE.  In this case, our
version generation function can disregard the incoming value of <code class="docutils literal notranslate"><span class="pre">version</span></code>,
as the <code class="docutils literal notranslate"><span class="pre">uuid4()</span></code> function
generates identifiers without any prerequisite value.  If we were using
a sequential versioning scheme such as numeric or a special character system,
we could make use of the given <code class="docutils literal notranslate"><span class="pre">version</span></code> in order to help determine the
subsequent value.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../core/custom_types.html#custom-guid-type"><span class="std std-ref">Backend-agnostic GUID Type</span></a></p>
</div>
</section>
<section id="server-side-version-counters">
<a class="dashAnchor" name="//apple_ref/Section/Server%20Side%20Version%20Counters"></a><span id="server-side-version-counter"></span><h2>Server Side Version Counters<a class="headerlink" href="#server-side-version-counters" title="Permalink to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">version_id_generator</span></code> can also be configured to rely upon a value
that is generated by the database.  In this case, the database would need
some means of generating new identifiers when a row is subject to an INSERT
as well as with an UPDATE.   For the UPDATE case, typically an update trigger
is needed, unless the database in question supports some other native
version identifier.  The PostgreSQL database in particular supports a system
column called <a class="reference external" href="https://www.postgresql.org/docs/current/static/ddl-system-columns.html">xmin</a>
which provides UPDATE versioning.  We can make use
of the PostgreSQL <code class="docutils literal notranslate"><span class="pre">xmin</span></code> column to version our <code class="docutils literal notranslate"><span class="pre">User</span></code>
class as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">FetchedValue</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">"user"</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">xmin</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="s2">"xmin"</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">server_default</span><span class="o">=</span><span class="n">FetchedValue</span><span class="p">())</span>

    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"version_id_col"</span><span class="p">:</span> <span class="n">xmin</span><span class="p">,</span> <span class="s2">"version_id_generator"</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>With the above mapping, the ORM will rely upon the <code class="docutils literal notranslate"><span class="pre">xmin</span></code> column for
automatically providing the new value of the version id counter.</p>
<aside class="topic">
<p class="topic-title">creating tables that refer to system columns</p>
<p>In the above scenario, as <code class="docutils literal notranslate"><span class="pre">xmin</span></code> is a system column provided by PostgreSQL,
we use the <code class="docutils literal notranslate"><span class="pre">system=True</span></code> argument to mark it as a system-provided
column, omitted from the <code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">TABLE</span></code> statement.   The datatype of this
column is an internal PostgreSQL type called <code class="docutils literal notranslate"><span class="pre">xid</span></code> which acts mostly
like a string, so we use the <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.String" title="sqlalchemy.types.String"><code class="xref py py-class docutils literal notranslate"><span class="pre">String</span></code></a> datatype.</p>
</aside>
<p>The ORM typically does not actively fetch the values of database-generated
values when it emits an INSERT or UPDATE, instead leaving these columns as
“expired” and to be fetched when they are next accessed, unless the <code class="docutils literal notranslate"><span class="pre">eager_defaults</span></code>
<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.Mapper" title="sqlalchemy.orm.Mapper"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapper</span></code></a> flag is set.  However, when a
server side version column is used, the ORM needs to actively fetch the newly
generated value.  This is so that the version counter is set up <em>before</em>
any concurrent transaction may update it again.   This fetching is also
best done simultaneously within the INSERT or UPDATE statement using <a class="reference internal" href="../glossary.html#term-RETURNING"><span class="xref std std-term">RETURNING</span></a>,
otherwise if emitting a SELECT statement afterwards, there is still a potential
race condition where the version counter may change before it can be fetched.</p>
<p>When the target database supports RETURNING, an INSERT statement for our <code class="docutils literal notranslate"><span class="pre">User</span></code> class will look
like this:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="ss">"user"</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">RETURNING</span><span class="w"> </span><span class="ss">"user"</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="ss">"user"</span><span class="p">.</span><span class="n">xmin</span>
<span class="c1">-- {'name': 'ed'}</span></pre></div>
</div>
<p>Where above, the ORM can acquire any newly generated primary key values along
with server-generated version identifiers in one statement.   When the backend
does not support RETURNING, an additional SELECT must be emitted for <strong>every</strong>
INSERT and UPDATE, which is much less efficient, and also introduces the possibility of
missed version counters:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="ss">"user"</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="n">s</span><span class="p">)</span>
<span class="c1">-- {'name': 'ed'}</span>

<span class="k">SELECT</span><span class="w"> </span><span class="ss">"user"</span><span class="p">.</span><span class="n">version_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">user_version_id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="ss">"user"</span><span class="w"> </span><span class="k">where</span>
<span class="ss">"user"</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">:</span><span class="n">param_1</span>
<span class="c1">-- {"param_1": 1}</span></pre></div>
</div>
<p>It is <em>strongly recommended</em> that server side version counters only be used
when absolutely necessary and only on backends that support <a class="reference internal" href="../glossary.html#term-RETURNING"><span class="xref std std-term">RETURNING</span></a>,
currently PostgreSQL, Oracle, MariaDB 10.5, SQLite 3.35, and SQL Server.</p>
</section>
<section id="programmatic-or-conditional-version-counters">
<h2>Programmatic or Conditional Version Counters<a class="headerlink" href="#programmatic-or-conditional-version-counters" title="Permalink to this heading">¶</a></h2>
<p>When <code class="docutils literal notranslate"><span class="pre">version_id_generator</span></code> is set to False, we can also programmatically
(and conditionally) set the version identifier on our object in the same way
we assign any other mapped attribute.  Such as if we used our UUID example, but
set <code class="docutils literal notranslate"><span class="pre">version_id_generator</span></code> to <code class="docutils literal notranslate"><span class="pre">False</span></code>, we can set the version identifier
at our choosing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">uuid</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">"user"</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">version_uuid</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"version_id_col"</span><span class="p">:</span> <span class="n">version_uuid</span><span class="p">,</span> <span class="s2">"version_id_generator"</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>


<span class="n">u1</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"u1"</span><span class="p">,</span> <span class="n">version_uuid</span><span class="o">=</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

<span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span>

<span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="n">u1</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"u2"</span>
<span class="n">u1</span><span class="o">.</span><span class="n">version_uuid</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>

<span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>We can update our <code class="docutils literal notranslate"><span class="pre">User</span></code> object without incrementing the version counter
as well; the value of the counter will remain unchanged, and the UPDATE
statement will still check against the previous value.  This may be useful
for schemes where only certain classes of UPDATE are sensitive to concurrency
issues:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># will leave version_uuid unchanged</span>
<span class="n">u1</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"u3"</span>
<span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></pre></div>
</div>
</section>
</section>

    </div>

</div>

<div id="docs-bottom-navigation" class="docs-navigation-links, ">
        Previous:
        <a href="nonstandard_mappings.html" title="previous chapter">Non-Traditional Mappings</a>
        Next:
        <a href="mapping_api.html" title="next chapter">Class Mapping API</a>

    <div id="docs-copyright">
        © <a href="../copyright.html">Copyright</a> 2007-2023, the SQLAlchemy authors and contributors.


    <p><b>flambé!</b> the dragon and <b><i>The Alchemist</i></b> image designs created and generously donated by <a href="https://github.com/vmalloc">Rotem Yaari</a>.</p>

        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 7.0.1.

    Documentation last generated: Wed 05 Jul 2023 03:34:09 PM 

    </div>
</div>

</div>




</main></div>

</div> <!-- end #main-body -->


    

    

<div id="footer" class="footer">
    <div class="snd-ad">
    </div>
    <div class="pypowered">
        <a href="http://www.python.org/" title="The Python Language Site">
            <img src="../../../../www.sqlalchemy.org/img/python-logo.gif" width="88" height="30" alt="Python" class="pypowered">
        </a>
    </div>

    <div class="copyright">
        <p>Website content copyright © by SQLAlchemy authors and contributors.
            SQLAlchemy and its documentation are licensed under the MIT license.</p>
        <p>SQLAlchemy is a trademark of Michael Bayer.  mike(&amp;)zzzcomputing.com
        All rights reserved. </p>
        <p>Website generation by
        <a href="https://github.com/sqlalchemyorg/zeekofile/">zeekofile</a>, with
        huge thanks to the <a href="https://github.com/EnigmaCurry/blogofile">Blogofile</a>
        project.</p>

        <a rel="me" href="https://fosstodon.org/@zzzeek">Mastodon</a>

    </div>

    <br clear="all">

</div>



     <!-- End original user content -->

    




 <!-- end #wrap -->


    

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
          URL_ROOT:    '../',
          VERSION:     '2.0.18',
          COLLAPSE_MODINDEX: false,
          FILE_SUFFIX: '.html'
      };
    </script>

    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>

    <!-- begin iterate through sphinx environment script_files -->
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script type="text/javascript" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/sphinx_highlight.js"></script>
        <script type="text/javascript" src="../_static/clipboard.min.js"></script>
        <script type="text/javascript" src="../_static/copybutton.js"></script>
    <!-- end iterate through sphinx environment script_files -->

    <script type="text/javascript" src="../_static/init.js"></script>




<script type="text/javascript" src="../../../../www.sqlalchemy.org/js/bootstrap.bundle.min.js"></script>
<script type="text/javascript" src="../../../../www.sqlalchemy.org/js/doc_versions.js"></script>

<!-- Google tag (gtag.js) -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-KWWK46V0YX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KWWK46V0YX');
</script>




<!-- Mirrored from docs.sqlalchemy.org/en/20/orm/versioning.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 06 Jul 2023 08:05:55 GMT -->


</body></html>