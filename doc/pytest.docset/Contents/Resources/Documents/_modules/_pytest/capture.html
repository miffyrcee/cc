


<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>_pytest.capture &#8212; pytest documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/pygments_pytest.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.png"/>
    <link rel="search" title="Search" href="../../search.html" />
  <script>DOCUMENTATION_OPTIONS.URL_ROOT = '';</script>
   
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a></li>
        <li class="nav-item nav-item-0"><a href="../../contents.html">pytest-7.3</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">_pytest.capture</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <h1>Source code for _pytest.capture</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Per-test stdout/stderr capturing mechanism.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">UnsupportedOperation</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">TemporaryFile</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">TracebackType</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">AnyStr</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">BinaryIO</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Generator</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Generic</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterator</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NamedTuple</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TextIO</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Type</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>

<span class="kn">from</span> <span class="nn">_pytest.compat</span> <span class="kn">import</span> <span class="n">final</span>
<span class="kn">from</span> <span class="nn">_pytest.config</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">_pytest.config</span> <span class="kn">import</span> <span class="n">hookimpl</span>
<span class="kn">from</span> <span class="nn">_pytest.config.argparsing</span> <span class="kn">import</span> <span class="n">Parser</span>
<span class="kn">from</span> <span class="nn">_pytest.deprecated</span> <span class="kn">import</span> <span class="n">check_ispytest</span>
<span class="kn">from</span> <span class="nn">_pytest.fixtures</span> <span class="kn">import</span> <span class="n">fixture</span>
<span class="kn">from</span> <span class="nn">_pytest.fixtures</span> <span class="kn">import</span> <span class="n">SubRequest</span>
<span class="kn">from</span> <span class="nn">_pytest.nodes</span> <span class="kn">import</span> <span class="n">Collector</span>
<span class="kn">from</span> <span class="nn">_pytest.nodes</span> <span class="kn">import</span> <span class="n">File</span>
<span class="kn">from</span> <span class="nn">_pytest.nodes</span> <span class="kn">import</span> <span class="n">Item</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">Final</span>
    <span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">Literal</span>

    <span class="n">_CaptureMethod</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;fd&quot;</span><span class="p">,</span> <span class="s2">&quot;sys&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="s2">&quot;tee-sys&quot;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">pytest_addoption</span><span class="p">(</span><span class="n">parser</span><span class="p">:</span> <span class="n">Parser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">getgroup</span><span class="p">(</span><span class="s2">&quot;general&quot;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">_addoption</span><span class="p">(</span>
        <span class="s2">&quot;--capture&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;fd&quot;</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;method&quot;</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;fd&quot;</span><span class="p">,</span> <span class="s2">&quot;sys&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="s2">&quot;tee-sys&quot;</span><span class="p">],</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Per-test capturing method: one of fd|sys|no|tee-sys&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">_addoption</span><span class="p">(</span>
        <span class="s2">&quot;-s&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_const&quot;</span><span class="p">,</span>
        <span class="n">const</span><span class="o">=</span><span class="s2">&quot;no&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;capture&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Shortcut for --capture=no&quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_colorama_workaround</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure colorama is imported so that it attaches to the correct stdio</span>
<span class="sd">    handles on Windows.</span>

<span class="sd">    colorama uses the terminal on import time. So if something does the</span>
<span class="sd">    first import of colorama while I/O capture is active, colorama will</span>
<span class="sd">    fail in various ways.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;win32&quot;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">colorama</span>  <span class="c1"># noqa: F401</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">pass</span>


<span class="k">def</span> <span class="nf">_windowsconsoleio_workaround</span><span class="p">(</span><span class="n">stream</span><span class="p">:</span> <span class="n">TextIO</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Workaround for Windows Unicode console handling.</span>

<span class="sd">    Python 3.6 implemented Unicode console handling for Windows. This works</span>
<span class="sd">    by reading/writing to the raw console handle using</span>
<span class="sd">    ``{Read,Write}ConsoleW``.</span>

<span class="sd">    The problem is that we are going to ``dup2`` over the stdio file</span>
<span class="sd">    descriptors when doing ``FDCapture`` and this will ``CloseHandle`` the</span>
<span class="sd">    handles used by Python to write to the console. Though there is still some</span>
<span class="sd">    weirdness and the console handle seems to only be closed randomly and not</span>
<span class="sd">    on the first call to ``CloseHandle``, or maybe it gets reopened with the</span>
<span class="sd">    same handle value when we suspend capturing.</span>

<span class="sd">    The workaround in this case will reopen stdio with a different fd which</span>
<span class="sd">    also means a different handle by replicating the logic in</span>
<span class="sd">    &quot;Py_lifecycle.c:initstdio/create_stdio&quot;.</span>

<span class="sd">    :param stream:</span>
<span class="sd">        In practice ``sys.stdout`` or ``sys.stderr``, but given</span>
<span class="sd">        here as parameter for unittesting purposes.</span>

<span class="sd">    See https://github.com/pytest-dev/py/issues/103.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;win32&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s2">&quot;pypy_version_info&quot;</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="c1"># Bail out if ``stream`` doesn&#39;t seem like a proper ``io`` stream (#2666).</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s2">&quot;buffer&quot;</span><span class="p">):</span>  <span class="c1"># type: ignore[unreachable]</span>
        <span class="k">return</span>

    <span class="n">buffered</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">stream</span><span class="o">.</span><span class="n">buffer</span><span class="p">,</span> <span class="s2">&quot;raw&quot;</span><span class="p">)</span>
    <span class="n">raw_stdout</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">raw</span> <span class="k">if</span> <span class="n">buffered</span> <span class="k">else</span> <span class="n">stream</span><span class="o">.</span><span class="n">buffer</span>  <span class="c1"># type: ignore[attr-defined]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_stdout</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">_WindowsConsoleIO</span><span class="p">):</span>  <span class="c1"># type: ignore[attr-defined]</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_reopen_stdio</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">buffered</span> <span class="ow">and</span> <span class="n">mode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;w&quot;</span><span class="p">:</span>
            <span class="n">buffering</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">buffering</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">return</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">fileno</span><span class="p">()),</span> <span class="n">mode</span><span class="p">,</span> <span class="n">buffering</span><span class="p">),</span>
            <span class="n">f</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span>
            <span class="n">f</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span>
            <span class="n">f</span><span class="o">.</span><span class="n">newlines</span><span class="p">,</span>
            <span class="n">f</span><span class="o">.</span><span class="n">line_buffering</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span> <span class="o">=</span> <span class="n">_reopen_stdio</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">_reopen_stdio</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">_reopen_stdio</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span>


<span class="nd">@hookimpl</span><span class="p">(</span><span class="n">hookwrapper</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pytest_load_initial_conftests</span><span class="p">(</span><span class="n">early_config</span><span class="p">:</span> <span class="n">Config</span><span class="p">):</span>
    <span class="n">ns</span> <span class="o">=</span> <span class="n">early_config</span><span class="o">.</span><span class="n">known_args_namespace</span>
    <span class="k">if</span> <span class="n">ns</span><span class="o">.</span><span class="n">capture</span> <span class="o">==</span> <span class="s2">&quot;fd&quot;</span><span class="p">:</span>
        <span class="n">_windowsconsoleio_workaround</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
    <span class="n">_colorama_workaround</span><span class="p">()</span>
    <span class="n">pluginmanager</span> <span class="o">=</span> <span class="n">early_config</span><span class="o">.</span><span class="n">pluginmanager</span>
    <span class="n">capman</span> <span class="o">=</span> <span class="n">CaptureManager</span><span class="p">(</span><span class="n">ns</span><span class="o">.</span><span class="n">capture</span><span class="p">)</span>
    <span class="n">pluginmanager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">capman</span><span class="p">,</span> <span class="s2">&quot;capturemanager&quot;</span><span class="p">)</span>

    <span class="c1"># Make sure that capturemanager is properly reset at final shutdown.</span>
    <span class="n">early_config</span><span class="o">.</span><span class="n">add_cleanup</span><span class="p">(</span><span class="n">capman</span><span class="o">.</span><span class="n">stop_global_capturing</span><span class="p">)</span>

    <span class="c1"># Finally trigger conftest loading but while capturing (issue #93).</span>
    <span class="n">capman</span><span class="o">.</span><span class="n">start_global_capturing</span><span class="p">()</span>
    <span class="n">outcome</span> <span class="o">=</span> <span class="k">yield</span>
    <span class="n">capman</span><span class="o">.</span><span class="n">suspend_global_capture</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">outcome</span><span class="o">.</span><span class="n">excinfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">capman</span><span class="o">.</span><span class="n">read_global_capture</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>


<span class="c1"># IO Helpers.</span>


<span class="k">class</span> <span class="nc">EncodedFile</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">):</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># Ensure that file.name is a string. Workaround for a Python bug</span>
        <span class="c1"># fixed in &gt;=3.7.4: https://bugs.python.org/issue36015</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># TextIOWrapper doesn&#39;t expose a mode, but at least some of our</span>
        <span class="c1"># tests check it.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CaptureIO</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(),</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">write_through</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TeeCaptureIO</span><span class="p">(</span><span class="n">CaptureIO</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">TextIO</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_other</span> <span class="o">=</span> <span class="n">other</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_other</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DontReadFromInput</span><span class="p">(</span><span class="n">TextIO</span><span class="p">):</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">encoding</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sys</span><span class="o">.</span><span class="n">__stdin__</span><span class="o">.</span><span class="n">encoding</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
            <span class="s2">&quot;pytest: reading from stdin while output is captured!  Consider using `-s`.&quot;</span>
        <span class="p">)</span>

    <span class="n">readline</span> <span class="o">=</span> <span class="n">read</span>

    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">readlines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
            <span class="s2">&quot;pytest: reading from stdin while output is captured!  Consider using `-s`.&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">fileno</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UnsupportedOperation</span><span class="p">(</span><span class="s2">&quot;redirected stdin is pseudofile, has no fileno()&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UnsupportedOperation</span><span class="p">(</span><span class="s2">&quot;redirected stdin is pseudofile, has no flush()&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">isatty</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">readable</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">seek</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">whence</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UnsupportedOperation</span><span class="p">(</span><span class="s2">&quot;redirected stdin is pseudofile, has no seek(int)&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">seekable</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">tell</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UnsupportedOperation</span><span class="p">(</span><span class="s2">&quot;redirected stdin is pseudofile, has no tell()&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">truncate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UnsupportedOperation</span><span class="p">(</span><span class="s2">&quot;cannont truncate stdin&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UnsupportedOperation</span><span class="p">(</span><span class="s2">&quot;cannot write to stdin&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">writelines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UnsupportedOperation</span><span class="p">(</span><span class="s2">&quot;Cannot write to stdin&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">writable</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DontReadFromInput&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">]],</span>
        <span class="n">value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">],</span>
        <span class="n">traceback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TracebackType</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BinaryIO</span><span class="p">:</span>
        <span class="c1"># The str/bytes doesn&#39;t actually matter in this type, so OK to fake.</span>
        <span class="k">return</span> <span class="bp">self</span>  <span class="c1"># type: ignore[return-value]</span>


<span class="c1"># Capture classes.</span>


<span class="k">class</span> <span class="nc">CaptureBase</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]):</span>
    <span class="n">EMPTY_BUFFER</span><span class="p">:</span> <span class="n">AnyStr</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">done</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">suspend</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">resume</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">writeorg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">AnyStr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">snap</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AnyStr</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>


<span class="n">patchsysdict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;stdin&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;stdout&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;stderr&quot;</span><span class="p">}</span>


<span class="k">class</span> <span class="nc">NoCapture</span><span class="p">(</span><span class="n">CaptureBase</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
    <span class="n">EMPTY_BUFFER</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">done</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">suspend</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">resume</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">snap</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">writeorg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">SysCaptureBase</span><span class="p">(</span><span class="n">CaptureBase</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">tmpfile</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TextIO</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">tee</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">patchsysdict</span><span class="p">[</span><span class="n">fd</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_old</span><span class="p">:</span> <span class="n">TextIO</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">if</span> <span class="n">tmpfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;stdin&quot;</span><span class="p">:</span>
                <span class="n">tmpfile</span> <span class="o">=</span> <span class="n">DontReadFromInput</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tmpfile</span> <span class="o">=</span> <span class="n">CaptureIO</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">tee</span> <span class="k">else</span> <span class="n">TeeCaptureIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_old</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpfile</span> <span class="o">=</span> <span class="n">tmpfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="s2">&quot;initialized&quot;</span>

    <span class="k">def</span> <span class="nf">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">class_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> _old=</span><span class="si">{}</span><span class="s2"> _state=</span><span class="si">{!r}</span><span class="s2"> tmpfile=</span><span class="si">{!r}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">class_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_old&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_old</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&lt;UNSET&gt;&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmpfile</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> _old=</span><span class="si">{}</span><span class="s2"> _state=</span><span class="si">{!r}</span><span class="s2"> tmpfile=</span><span class="si">{!r}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_old&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_old</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&lt;UNSET&gt;&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmpfile</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_assert_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">states</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="ow">in</span> <span class="n">states</span>
        <span class="p">),</span> <span class="s2">&quot;cannot </span><span class="si">{}</span><span class="s2"> in state </span><span class="si">{!r}</span><span class="s2">: expected one of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">op</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_state</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;initialized&quot;</span><span class="p">,))</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="s2">&quot;started&quot;</span>

    <span class="k">def</span> <span class="nf">done</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_state</span><span class="p">(</span><span class="s2">&quot;done&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;initialized&quot;</span><span class="p">,</span> <span class="s2">&quot;started&quot;</span><span class="p">,</span> <span class="s2">&quot;suspended&quot;</span><span class="p">,</span> <span class="s2">&quot;done&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="s2">&quot;done&quot;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_old</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_old</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="s2">&quot;done&quot;</span>

    <span class="k">def</span> <span class="nf">suspend</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_state</span><span class="p">(</span><span class="s2">&quot;suspend&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;started&quot;</span><span class="p">,</span> <span class="s2">&quot;suspended&quot;</span><span class="p">))</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_old</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="s2">&quot;suspended&quot;</span>

    <span class="k">def</span> <span class="nf">resume</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_state</span><span class="p">(</span><span class="s2">&quot;resume&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;started&quot;</span><span class="p">,</span> <span class="s2">&quot;suspended&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="s2">&quot;started&quot;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="s2">&quot;started&quot;</span>


<span class="k">class</span> <span class="nc">SysCaptureBinary</span><span class="p">(</span><span class="n">SysCaptureBase</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]):</span>
    <span class="n">EMPTY_BUFFER</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">snap</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_state</span><span class="p">(</span><span class="s2">&quot;snap&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;started&quot;</span><span class="p">,</span> <span class="s2">&quot;suspended&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpfile</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpfile</span><span class="o">.</span><span class="n">truncate</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">writeorg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_state</span><span class="p">(</span><span class="s2">&quot;writeorg&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;started&quot;</span><span class="p">,</span> <span class="s2">&quot;suspended&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_old</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_old</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_old</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">SysCapture</span><span class="p">(</span><span class="n">SysCaptureBase</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
    <span class="n">EMPTY_BUFFER</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">snap</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_state</span><span class="p">(</span><span class="s2">&quot;snap&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;started&quot;</span><span class="p">,</span> <span class="s2">&quot;suspended&quot;</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmpfile</span><span class="p">,</span> <span class="n">CaptureIO</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpfile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpfile</span><span class="o">.</span><span class="n">truncate</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">writeorg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_state</span><span class="p">(</span><span class="s2">&quot;writeorg&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;started&quot;</span><span class="p">,</span> <span class="s2">&quot;suspended&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_old</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_old</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">FDCaptureBase</span><span class="p">(</span><span class="n">CaptureBase</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targetfd</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targetfd</span> <span class="o">=</span> <span class="n">targetfd</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">fstat</span><span class="p">(</span><span class="n">targetfd</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="c1"># FD capturing is conceptually simple -- create a temporary file,</span>
            <span class="c1"># redirect the FD to it, redirect back when done. But when the</span>
            <span class="c1"># target FD is invalid it throws a wrench into this lovely scheme.</span>
            <span class="c1">#</span>
            <span class="c1"># Tests themselves shouldn&#39;t care if the FD is valid, FD capturing</span>
            <span class="c1"># should work regardless of external circumstances. So falling back</span>
            <span class="c1"># to just sys capturing is not a good option.</span>
            <span class="c1">#</span>
            <span class="c1"># Further complications are the need to support suspend() and the</span>
            <span class="c1"># possibility of FD reuse (e.g. the tmpfile getting the very same</span>
            <span class="c1"># target FD). The following approach is robust, I believe.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">targetfd_invalid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_RDWR</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targetfd_invalid</span><span class="p">,</span> <span class="n">targetfd</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">targetfd_invalid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targetfd_save</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="n">targetfd</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">targetfd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmpfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">syscapture</span><span class="p">:</span> <span class="n">CaptureBase</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">SysCapture</span><span class="p">(</span><span class="n">targetfd</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmpfile</span> <span class="o">=</span> <span class="n">EncodedFile</span><span class="p">(</span>
                <span class="n">TemporaryFile</span><span class="p">(</span><span class="n">buffering</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
                <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">,</span>
                <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">write_through</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">targetfd</span> <span class="ow">in</span> <span class="n">patchsysdict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">syscapture</span> <span class="o">=</span> <span class="n">SysCapture</span><span class="p">(</span><span class="n">targetfd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpfile</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">syscapture</span> <span class="o">=</span> <span class="n">NoCapture</span><span class="p">(</span><span class="n">targetfd</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="s2">&quot;initialized&quot;</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> oldfd=</span><span class="si">{}</span><span class="s2"> _state=</span><span class="si">{!r}</span><span class="s2"> tmpfile=</span><span class="si">{!r}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">targetfd</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">targetfd_save</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmpfile</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_assert_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">states</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="ow">in</span> <span class="n">states</span>
        <span class="p">),</span> <span class="s2">&quot;cannot </span><span class="si">{}</span><span class="s2"> in state </span><span class="si">{!r}</span><span class="s2">: expected one of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">op</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start capturing on targetfd using memorized tmpfile.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_state</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;initialized&quot;</span><span class="p">,))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmpfile</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetfd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">syscapture</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="s2">&quot;started&quot;</span>

    <span class="k">def</span> <span class="nf">done</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop capturing, restore streams, return original capture file,</span>
<span class="sd">        seeked to position zero.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_state</span><span class="p">(</span><span class="s2">&quot;done&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;initialized&quot;</span><span class="p">,</span> <span class="s2">&quot;started&quot;</span><span class="p">,</span> <span class="s2">&quot;suspended&quot;</span><span class="p">,</span> <span class="s2">&quot;done&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="s2">&quot;done&quot;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targetfd_save</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetfd</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targetfd_save</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetfd_invalid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetfd_invalid</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetfd</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targetfd</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targetfd_invalid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">syscapture</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="s2">&quot;done&quot;</span>

    <span class="k">def</span> <span class="nf">suspend</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_state</span><span class="p">(</span><span class="s2">&quot;suspend&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;started&quot;</span><span class="p">,</span> <span class="s2">&quot;suspended&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="s2">&quot;suspended&quot;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">syscapture</span><span class="o">.</span><span class="n">suspend</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targetfd_save</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetfd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="s2">&quot;suspended&quot;</span>

    <span class="k">def</span> <span class="nf">resume</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_state</span><span class="p">(</span><span class="s2">&quot;resume&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;started&quot;</span><span class="p">,</span> <span class="s2">&quot;suspended&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="s2">&quot;started&quot;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">syscapture</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmpfile</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetfd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="s2">&quot;started&quot;</span>


<span class="k">class</span> <span class="nc">FDCaptureBinary</span><span class="p">(</span><span class="n">FDCaptureBase</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Capture IO to/from a given OS-level file descriptor.</span>

<span class="sd">    snap() produces `bytes`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">EMPTY_BUFFER</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">snap</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_state</span><span class="p">(</span><span class="s2">&quot;snap&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;started&quot;</span><span class="p">,</span> <span class="s2">&quot;suspended&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpfile</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpfile</span><span class="o">.</span><span class="n">truncate</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">writeorg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write to original file descriptor.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_state</span><span class="p">(</span><span class="s2">&quot;writeorg&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;started&quot;</span><span class="p">,</span> <span class="s2">&quot;suspended&quot;</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targetfd_save</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FDCapture</span><span class="p">(</span><span class="n">FDCaptureBase</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Capture IO to/from a given OS-level file descriptor.</span>

<span class="sd">    snap() produces text.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">EMPTY_BUFFER</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">snap</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_state</span><span class="p">(</span><span class="s2">&quot;snap&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;started&quot;</span><span class="p">,</span> <span class="s2">&quot;suspended&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmpfile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpfile</span><span class="o">.</span><span class="n">truncate</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">writeorg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write to original file descriptor.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_assert_state</span><span class="p">(</span><span class="s2">&quot;writeorg&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;started&quot;</span><span class="p">,</span> <span class="s2">&quot;suspended&quot;</span><span class="p">))</span>
        <span class="c1"># XXX use encoding of original stream</span>
        <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targetfd_save</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>


<span class="c1"># MultiCapture</span>


<span class="c1"># Generic NamedTuple only supported since Python 3.11.</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span> <span class="ow">or</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>

    <span class="nd">@final</span>
    <span class="k">class</span> <span class="nc">CaptureResult</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The result of :method:`CaptureFixture.readouterr`.&quot;&quot;&quot;</span>

        <span class="n">out</span><span class="p">:</span> <span class="n">AnyStr</span>
        <span class="n">err</span><span class="p">:</span> <span class="n">AnyStr</span>

<span class="k">else</span><span class="p">:</span>

    <span class="k">class</span> <span class="nc">CaptureResult</span><span class="p">(</span>
        <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;CaptureResult&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="s2">&quot;err&quot;</span><span class="p">]),</span> <span class="n">Generic</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The result of :method:`CaptureFixture.readouterr`.&quot;&quot;&quot;</span>

        <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>


<span class="k">class</span> <span class="nc">MultiCapture</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]):</span>
    <span class="n">_state</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_in_suspended</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">in_</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CaptureBase</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]],</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CaptureBase</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]],</span>
        <span class="n">err</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CaptureBase</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CaptureBase</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]]</span> <span class="o">=</span> <span class="n">in_</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CaptureBase</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]]</span> <span class="o">=</span> <span class="n">out</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CaptureBase</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]]</span> <span class="o">=</span> <span class="n">err</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;MultiCapture out=</span><span class="si">{!r}</span><span class="s2"> err=</span><span class="si">{!r}</span><span class="s2"> in_=</span><span class="si">{!r}</span><span class="s2"> _state=</span><span class="si">{!r}</span><span class="s2"> _in_suspended=</span><span class="si">{!r}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_in_suspended</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">start_capturing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="s2">&quot;started&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">pop_outerr_to_orig</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">,</span> <span class="n">AnyStr</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pop current snapshot out/err capture and flush to orig streams.&quot;&quot;&quot;</span>
        <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readouterr</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">writeorg</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="o">.</span><span class="n">writeorg</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">err</span>

    <span class="k">def</span> <span class="nf">suspend_capturing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="s2">&quot;suspended&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">suspend</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="o">.</span><span class="n">suspend</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">in_</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_</span><span class="o">.</span><span class="n">suspend</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_in_suspended</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">resume_capturing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="s2">&quot;started&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_in_suspended</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_in_suspended</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">stop_capturing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop capturing and reset capturing streams.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="s2">&quot;stopped&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;was already stopped&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="s2">&quot;stopped&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">is_started</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether actively capturing -- not suspended or stopped.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="s2">&quot;started&quot;</span>

    <span class="k">def</span> <span class="nf">readouterr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CaptureResult</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">snap</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span><span class="o">.</span><span class="n">snap</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">err</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># TODO: This type error is real, need to fix.</span>
        <span class="k">return</span> <span class="n">CaptureResult</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>


<span class="k">def</span> <span class="nf">_get_multicapture</span><span class="p">(</span><span class="n">method</span><span class="p">:</span> <span class="s2">&quot;_CaptureMethod&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MultiCapture</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;fd&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">MultiCapture</span><span class="p">(</span><span class="n">in_</span><span class="o">=</span><span class="n">FDCapture</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">out</span><span class="o">=</span><span class="n">FDCapture</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">err</span><span class="o">=</span><span class="n">FDCapture</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;sys&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">MultiCapture</span><span class="p">(</span><span class="n">in_</span><span class="o">=</span><span class="n">SysCapture</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">out</span><span class="o">=</span><span class="n">SysCapture</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">err</span><span class="o">=</span><span class="n">SysCapture</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;no&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">MultiCapture</span><span class="p">(</span><span class="n">in_</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;tee-sys&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">MultiCapture</span><span class="p">(</span>
            <span class="n">in_</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">SysCapture</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">err</span><span class="o">=</span><span class="n">SysCapture</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">tee</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unknown capturing method: </span><span class="si">{</span><span class="n">method</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="c1"># CaptureManager and CaptureFixture</span>


<span class="k">class</span> <span class="nc">CaptureManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The capture plugin.</span>

<span class="sd">    Manages that the appropriate capture method is enabled/disabled during</span>
<span class="sd">    collection and each test phase (setup, call, teardown). After each of</span>
<span class="sd">    those points, the captured output is obtained and attached to the</span>
<span class="sd">    collection/runtest report.</span>

<span class="sd">    There are two levels of capture:</span>

<span class="sd">    * global: enabled by default and can be suppressed by the ``-s``</span>
<span class="sd">      option. This is always enabled/disabled during collection and each test</span>
<span class="sd">      phase.</span>

<span class="sd">    * fixture: when a test function or one of its fixture depend on the</span>
<span class="sd">      ``capsys`` or ``capfd`` fixtures. In this case special handling is</span>
<span class="sd">      needed to ensure the fixtures take precedence over the global capture.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="s2">&quot;_CaptureMethod&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_method</span><span class="p">:</span> <span class="n">Final</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_global_capturing</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MultiCapture</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_capture_fixture</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CaptureFixture</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;CaptureManager _method=</span><span class="si">{!r}</span><span class="s2"> _global_capturing=</span><span class="si">{!r}</span><span class="s2"> _capture_fixture=</span><span class="si">{!r}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_global_capturing</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capture_fixture</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_capturing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_globally_capturing</span><span class="p">():</span>
            <span class="k">return</span> <span class="s2">&quot;global&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capture_fixture</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;fixture </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capture_fixture</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">fixturename</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Global capturing control</span>

    <span class="k">def</span> <span class="nf">is_globally_capturing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="o">!=</span> <span class="s2">&quot;no&quot;</span>

    <span class="k">def</span> <span class="nf">start_global_capturing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_global_capturing</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_global_capturing</span> <span class="o">=</span> <span class="n">_get_multicapture</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_method</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_global_capturing</span><span class="o">.</span><span class="n">start_capturing</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">stop_global_capturing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_global_capturing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_global_capturing</span><span class="o">.</span><span class="n">pop_outerr_to_orig</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_global_capturing</span><span class="o">.</span><span class="n">stop_capturing</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_global_capturing</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">resume_global_capture</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># During teardown of the python process, and on rare occasions, capture</span>
        <span class="c1"># attributes can be `None` while trying to resume global capture.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_global_capturing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_global_capturing</span><span class="o">.</span><span class="n">resume_capturing</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">suspend_global_capture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_global_capturing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_global_capturing</span><span class="o">.</span><span class="n">suspend_capturing</span><span class="p">(</span><span class="n">in_</span><span class="o">=</span><span class="n">in_</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">suspend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Need to undo local capsys-et-al if it exists before disabling global capture.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suspend_fixture</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suspend_global_capture</span><span class="p">(</span><span class="n">in_</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">resume</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resume_global_capture</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resume_fixture</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">read_global_capture</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CaptureResult</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_global_capturing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_global_capturing</span><span class="o">.</span><span class="n">readouterr</span><span class="p">()</span>

    <span class="c1"># Fixture Control</span>

    <span class="k">def</span> <span class="nf">set_fixture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capture_fixture</span><span class="p">:</span> <span class="s2">&quot;CaptureFixture[Any]&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capture_fixture</span><span class="p">:</span>
            <span class="n">current_fixture</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capture_fixture</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">fixturename</span>
            <span class="n">requested_fixture</span> <span class="o">=</span> <span class="n">capture_fixture</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">fixturename</span>
            <span class="n">capture_fixture</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">raiseerror</span><span class="p">(</span>
                <span class="s2">&quot;cannot use </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2"> at the same time&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">requested_fixture</span><span class="p">,</span> <span class="n">current_fixture</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_capture_fixture</span> <span class="o">=</span> <span class="n">capture_fixture</span>

    <span class="k">def</span> <span class="nf">unset_fixture</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_capture_fixture</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">activate_fixture</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;If the current item is using ``capsys`` or ``capfd``, activate</span>
<span class="sd">        them so they take precedence over the global capture.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capture_fixture</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_capture_fixture</span><span class="o">.</span><span class="n">_start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">deactivate_fixture</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deactivate the ``capsys`` or ``capfd`` fixture of this item, if any.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capture_fixture</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_capture_fixture</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">suspend_fixture</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capture_fixture</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_capture_fixture</span><span class="o">.</span><span class="n">_suspend</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">resume_fixture</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capture_fixture</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_capture_fixture</span><span class="o">.</span><span class="n">_resume</span><span class="p">()</span>

    <span class="c1"># Helper context managers</span>

    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">global_and_fixture_disabled</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Context manager to temporarily disable global and current fixture capturing.&quot;&quot;&quot;</span>
        <span class="n">do_fixture</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capture_fixture</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capture_fixture</span><span class="o">.</span><span class="n">_is_started</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">do_fixture</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">suspend_fixture</span><span class="p">()</span>
        <span class="n">do_global</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_global_capturing</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_global_capturing</span><span class="o">.</span><span class="n">is_started</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">do_global</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">suspend_global_capture</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">do_global</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resume_global_capture</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">do_fixture</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resume_fixture</span><span class="p">()</span>

    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">item_capture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">when</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Item</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resume_global_capture</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activate_fixture</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deactivate_fixture</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">suspend_global_capture</span><span class="p">(</span><span class="n">in_</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_global_capture</span><span class="p">()</span>
        <span class="n">item</span><span class="o">.</span><span class="n">add_report_section</span><span class="p">(</span><span class="n">when</span><span class="p">,</span> <span class="s2">&quot;stdout&quot;</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
        <span class="n">item</span><span class="o">.</span><span class="n">add_report_section</span><span class="p">(</span><span class="n">when</span><span class="p">,</span> <span class="s2">&quot;stderr&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>

    <span class="c1"># Hooks</span>

    <span class="nd">@hookimpl</span><span class="p">(</span><span class="n">hookwrapper</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">pytest_make_collect_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collector</span><span class="p">:</span> <span class="n">Collector</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">collector</span><span class="p">,</span> <span class="n">File</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resume_global_capture</span><span class="p">()</span>
            <span class="n">outcome</span> <span class="o">=</span> <span class="k">yield</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">suspend_global_capture</span><span class="p">()</span>
            <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_global_capture</span><span class="p">()</span>
            <span class="n">rep</span> <span class="o">=</span> <span class="n">outcome</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">out</span><span class="p">:</span>
                <span class="n">rep</span><span class="o">.</span><span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;Captured stdout&quot;</span><span class="p">,</span> <span class="n">out</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">rep</span><span class="o">.</span><span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;Captured stderr&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span>

    <span class="nd">@hookimpl</span><span class="p">(</span><span class="n">hookwrapper</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">pytest_runtest_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Item</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_capture</span><span class="p">(</span><span class="s2">&quot;setup&quot;</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
            <span class="k">yield</span>

    <span class="nd">@hookimpl</span><span class="p">(</span><span class="n">hookwrapper</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">pytest_runtest_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Item</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_capture</span><span class="p">(</span><span class="s2">&quot;call&quot;</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
            <span class="k">yield</span>

    <span class="nd">@hookimpl</span><span class="p">(</span><span class="n">hookwrapper</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">pytest_runtest_teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Item</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_capture</span><span class="p">(</span><span class="s2">&quot;teardown&quot;</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
            <span class="k">yield</span>

    <span class="nd">@hookimpl</span><span class="p">(</span><span class="n">tryfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">pytest_keyboard_interrupt</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_global_capturing</span><span class="p">()</span>

    <span class="nd">@hookimpl</span><span class="p">(</span><span class="n">tryfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">pytest_internalerror</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_global_capturing</span><span class="p">()</span>


<div class="viewcode-block" id="CaptureFixture"><a class="viewcode-back" href="../../reference/reference.html#_pytest.capture.CaptureFixture">[docs]</a><span class="k">class</span> <span class="nc">CaptureFixture</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Object returned by the :fixture:`capsys`, :fixture:`capsysbinary`,</span>
<span class="sd">    :fixture:`capfd` and :fixture:`capfdbinary` fixtures.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">captureclass</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">CaptureBase</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]],</span>
        <span class="n">request</span><span class="p">:</span> <span class="n">SubRequest</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">_ispytest</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">check_ispytest</span><span class="p">(</span><span class="n">_ispytest</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">captureclass</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">CaptureBase</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]]</span> <span class="o">=</span> <span class="n">captureclass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_capture</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MultiCapture</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_captured_out</span><span class="p">:</span> <span class="n">AnyStr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">captureclass</span><span class="o">.</span><span class="n">EMPTY_BUFFER</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_captured_err</span><span class="p">:</span> <span class="n">AnyStr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">captureclass</span><span class="o">.</span><span class="n">EMPTY_BUFFER</span>

    <span class="k">def</span> <span class="nf">_start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capture</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_capture</span> <span class="o">=</span> <span class="n">MultiCapture</span><span class="p">(</span>
                <span class="n">in_</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">captureclass</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">err</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">captureclass</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_capture</span><span class="o">.</span><span class="n">start_capturing</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capture</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capture</span><span class="o">.</span><span class="n">pop_outerr_to_orig</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_captured_out</span> <span class="o">+=</span> <span class="n">out</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_captured_err</span> <span class="o">+=</span> <span class="n">err</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_capture</span><span class="o">.</span><span class="n">stop_capturing</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_capture</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="CaptureFixture.readouterr"><a class="viewcode-back" href="../../reference/reference.html#_pytest.capture.CaptureFixture.readouterr">[docs]</a>    <span class="k">def</span> <span class="nf">readouterr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CaptureResult</span><span class="p">[</span><span class="n">AnyStr</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read and return the captured output so far, resetting the internal</span>
<span class="sd">        buffer.</span>

<span class="sd">        :returns:</span>
<span class="sd">            The captured content as a namedtuple with ``out`` and ``err``</span>
<span class="sd">            string attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">captured_out</span><span class="p">,</span> <span class="n">captured_err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_captured_out</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_captured_err</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capture</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capture</span><span class="o">.</span><span class="n">readouterr</span><span class="p">()</span>
            <span class="n">captured_out</span> <span class="o">+=</span> <span class="n">out</span>
            <span class="n">captured_err</span> <span class="o">+=</span> <span class="n">err</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_captured_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">captureclass</span><span class="o">.</span><span class="n">EMPTY_BUFFER</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_captured_err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">captureclass</span><span class="o">.</span><span class="n">EMPTY_BUFFER</span>
        <span class="k">return</span> <span class="n">CaptureResult</span><span class="p">(</span><span class="n">captured_out</span><span class="p">,</span> <span class="n">captured_err</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_suspend</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Suspend this fixture&#39;s own capturing temporarily.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capture</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_capture</span><span class="o">.</span><span class="n">suspend_capturing</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_resume</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resume this fixture&#39;s own capturing temporarily.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capture</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_capture</span><span class="o">.</span><span class="n">resume_capturing</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_is_started</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether actively capturing -- not disabled or closed.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capture</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capture</span><span class="o">.</span><span class="n">is_started</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="CaptureFixture.disabled"><a class="viewcode-back" href="../../reference/reference.html#_pytest.capture.CaptureFixture.disabled">[docs]</a>    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">disabled</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Temporarily disable capturing while inside the ``with`` block.&quot;&quot;&quot;</span>
        <span class="n">capmanager</span><span class="p">:</span> <span class="n">CaptureManager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">getplugin</span><span class="p">(</span>
            <span class="s2">&quot;capturemanager&quot;</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="n">capmanager</span><span class="o">.</span><span class="n">global_and_fixture_disabled</span><span class="p">():</span>
            <span class="k">yield</span></div></div>


<span class="c1"># The fixtures.</span>


<div class="viewcode-block" id="capsys"><a class="viewcode-back" href="../../reference/reference.html#_pytest.capture.capsys">[docs]</a><span class="nd">@fixture</span>
<span class="k">def</span> <span class="nf">capsys</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">SubRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">CaptureFixture</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Enable text capturing of writes to ``sys.stdout`` and ``sys.stderr``.</span>

<span class="sd">    The captured output is made available via ``capsys.readouterr()`` method</span>
<span class="sd">    calls, which return a ``(out, err)`` namedtuple.</span>
<span class="sd">    ``out`` and ``err`` will be ``text`` objects.</span>

<span class="sd">    Returns an instance of :class:`CaptureFixture[str] &lt;pytest.CaptureFixture&gt;`.</span>

<span class="sd">    Example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        def test_output(capsys):</span>
<span class="sd">            print(&quot;hello&quot;)</span>
<span class="sd">            captured = capsys.readouterr()</span>
<span class="sd">            assert captured.out == &quot;hello\n&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">capman</span><span class="p">:</span> <span class="n">CaptureManager</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">getplugin</span><span class="p">(</span><span class="s2">&quot;capturemanager&quot;</span><span class="p">)</span>
    <span class="n">capture_fixture</span> <span class="o">=</span> <span class="n">CaptureFixture</span><span class="p">(</span><span class="n">SysCapture</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">_ispytest</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">capman</span><span class="o">.</span><span class="n">set_fixture</span><span class="p">(</span><span class="n">capture_fixture</span><span class="p">)</span>
    <span class="n">capture_fixture</span><span class="o">.</span><span class="n">_start</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">capture_fixture</span>
    <span class="n">capture_fixture</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">capman</span><span class="o">.</span><span class="n">unset_fixture</span><span class="p">()</span></div>


<div class="viewcode-block" id="capsysbinary"><a class="viewcode-back" href="../../reference/reference.html#_pytest.capture.capsysbinary">[docs]</a><span class="nd">@fixture</span>
<span class="k">def</span> <span class="nf">capsysbinary</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">SubRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">CaptureFixture</span><span class="p">[</span><span class="nb">bytes</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Enable bytes capturing of writes to ``sys.stdout`` and ``sys.stderr``.</span>

<span class="sd">    The captured output is made available via ``capsysbinary.readouterr()``</span>
<span class="sd">    method calls, which return a ``(out, err)`` namedtuple.</span>
<span class="sd">    ``out`` and ``err`` will be ``bytes`` objects.</span>

<span class="sd">    Returns an instance of :class:`CaptureFixture[bytes] &lt;pytest.CaptureFixture&gt;`.</span>

<span class="sd">    Example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        def test_output(capsysbinary):</span>
<span class="sd">            print(&quot;hello&quot;)</span>
<span class="sd">            captured = capsysbinary.readouterr()</span>
<span class="sd">            assert captured.out == b&quot;hello\n&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">capman</span><span class="p">:</span> <span class="n">CaptureManager</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">getplugin</span><span class="p">(</span><span class="s2">&quot;capturemanager&quot;</span><span class="p">)</span>
    <span class="n">capture_fixture</span> <span class="o">=</span> <span class="n">CaptureFixture</span><span class="p">(</span><span class="n">SysCaptureBinary</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">_ispytest</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">capman</span><span class="o">.</span><span class="n">set_fixture</span><span class="p">(</span><span class="n">capture_fixture</span><span class="p">)</span>
    <span class="n">capture_fixture</span><span class="o">.</span><span class="n">_start</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">capture_fixture</span>
    <span class="n">capture_fixture</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">capman</span><span class="o">.</span><span class="n">unset_fixture</span><span class="p">()</span></div>


<div class="viewcode-block" id="capfd"><a class="viewcode-back" href="../../reference/reference.html#_pytest.capture.capfd">[docs]</a><span class="nd">@fixture</span>
<span class="k">def</span> <span class="nf">capfd</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">SubRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">CaptureFixture</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Enable text capturing of writes to file descriptors ``1`` and ``2``.</span>

<span class="sd">    The captured output is made available via ``capfd.readouterr()`` method</span>
<span class="sd">    calls, which return a ``(out, err)`` namedtuple.</span>
<span class="sd">    ``out`` and ``err`` will be ``text`` objects.</span>

<span class="sd">    Returns an instance of :class:`CaptureFixture[str] &lt;pytest.CaptureFixture&gt;`.</span>

<span class="sd">    Example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        def test_system_echo(capfd):</span>
<span class="sd">            os.system(&#39;echo &quot;hello&quot;&#39;)</span>
<span class="sd">            captured = capfd.readouterr()</span>
<span class="sd">            assert captured.out == &quot;hello\n&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">capman</span><span class="p">:</span> <span class="n">CaptureManager</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">getplugin</span><span class="p">(</span><span class="s2">&quot;capturemanager&quot;</span><span class="p">)</span>
    <span class="n">capture_fixture</span> <span class="o">=</span> <span class="n">CaptureFixture</span><span class="p">(</span><span class="n">FDCapture</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">_ispytest</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">capman</span><span class="o">.</span><span class="n">set_fixture</span><span class="p">(</span><span class="n">capture_fixture</span><span class="p">)</span>
    <span class="n">capture_fixture</span><span class="o">.</span><span class="n">_start</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">capture_fixture</span>
    <span class="n">capture_fixture</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">capman</span><span class="o">.</span><span class="n">unset_fixture</span><span class="p">()</span></div>


<div class="viewcode-block" id="capfdbinary"><a class="viewcode-back" href="../../reference/reference.html#_pytest.capture.capfdbinary">[docs]</a><span class="nd">@fixture</span>
<span class="k">def</span> <span class="nf">capfdbinary</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">SubRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">CaptureFixture</span><span class="p">[</span><span class="nb">bytes</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Enable bytes capturing of writes to file descriptors ``1`` and ``2``.</span>

<span class="sd">    The captured output is made available via ``capfd.readouterr()`` method</span>
<span class="sd">    calls, which return a ``(out, err)`` namedtuple.</span>
<span class="sd">    ``out`` and ``err`` will be ``byte`` objects.</span>

<span class="sd">    Returns an instance of :class:`CaptureFixture[bytes] &lt;pytest.CaptureFixture&gt;`.</span>

<span class="sd">    Example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        def test_system_echo(capfdbinary):</span>
<span class="sd">            os.system(&#39;echo &quot;hello&quot;&#39;)</span>
<span class="sd">            captured = capfdbinary.readouterr()</span>
<span class="sd">            assert captured.out == b&quot;hello\n&quot;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">capman</span><span class="p">:</span> <span class="n">CaptureManager</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pluginmanager</span><span class="o">.</span><span class="n">getplugin</span><span class="p">(</span><span class="s2">&quot;capturemanager&quot;</span><span class="p">)</span>
    <span class="n">capture_fixture</span> <span class="o">=</span> <span class="n">CaptureFixture</span><span class="p">(</span><span class="n">FDCaptureBinary</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">_ispytest</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">capman</span><span class="o">.</span><span class="n">set_fixture</span><span class="p">(</span><span class="n">capture_fixture</span><span class="p">)</span>
    <span class="n">capture_fixture</span><span class="o">.</span><span class="n">_start</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">capture_fixture</span>
    <span class="n">capture_fixture</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">capman</span><span class="o">.</span><span class="n">unset_fixture</span><span class="p">()</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
      </div>
  <span id="sidebar-top"></span>
      <div class="clearer"></div>
    </div>
  
    <div class="footer" role="contentinfo">
        &#169; Copyright 2015, holger krekel and pytest-dev team.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
    </div>
  <script src="../../_static/version_warning_offset.js"></script>

  </body>
</html>