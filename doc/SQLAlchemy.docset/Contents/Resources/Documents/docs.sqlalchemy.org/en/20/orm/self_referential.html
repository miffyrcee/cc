<html><!-- Mirrored from docs.sqlalchemy.org/en/20/orm/self_referential.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 06 Jul 2023 08:05:55 GMT --><!-- Added by HTTrack --><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><!-- /Added by HTTrack -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>
        
        
    
    Adjacency List Relationships
 </title>

    

    

    <link href="../../../../fonts.googleapis.com/cssa2b2.css?family=Lato:400,700|Roboto+Slab:400,700" rel="stylesheet" type="text/css">

    
        <!-- begin iterate through SQLA css_files -->
            <link rel="stylesheet" href="../_static/pygments.css" type="text/css">
        <!-- end iterate through SQLA css_files -->

        <!-- begin iterate through sphinx environment local css_files -->
            <link rel="stylesheet" href="../_static/pygments.css" type="text/css">
            <link rel="stylesheet" href="../_static/default.css" type="text/css">
            <link rel="stylesheet" href="../_static/copybutton.css" type="text/css">
            <link rel="stylesheet" href="../_static/docs.css" type="text/css">
            <link rel="stylesheet" href="../_static/changelog.css" type="text/css">
            <link rel="stylesheet" href="../_static/sphinx_paramlinks.css" type="text/css">
        <!-- end iterate through sphinx environment local css_files -->

        <link rel="stylesheet" type="text/css" media="all" href="../../../../www.sqlalchemy.org/css/bootstrap.min.css">
	    <link rel="stylesheet" type="text/css" media="all" href="../../../../www.sqlalchemy.org/css/site.css">
        <link rel="stylesheet" type="text/css" media="all" href="../../../../www.sqlalchemy.org/css/sidebar_extra.css">
        <link rel="stylesheet" type="text/css" media="print" href="../../../../www.sqlalchemy.org/css/print.css">

        <!-- begin iterate through sphinx environment remote css_files -->
        <!-- end iterate through sphinx environment remote css_files -->
    

    

    

    


    
        <link rel="canonical" href="http://docs.sqlalchemy.org/en/latest/orm/self_referential.html">

    <script type="text/javascript">
        var doc_version = "latest";
        var doc_slug = "sqlalchemy";
        var static_root = "../_static"

        // copied from:
        // https://github.com/rtfd/readthedocs.org/commit/edbbb4c753454cf20c128d4eb2fef60d740debaa#diff-2f70e8d9361202bfe3f378d2ff2c510bR8
        var READTHEDOCS_DATA = {
            project: "sqlalchemy",
            version: "latest",
            page: "orm/self_referential",
            theme: ""
          };


    </script>
    <!-- end RTD <head> via SQLAlchemy adapter -->

    

    <!-- begin layout.mako headers -->

    <link rel="index" title="Index" href="../genindex.html">
    <link rel="search" title="Search" href="../search.html">
        <link rel="copyright" title="Copyright" href="../copyright.html">
    <link rel="top" title="SQLAlchemy 2.0 Documentation" href="../index-2.html">
        <link rel="up" title="Relationship Configuration" href="relationships.html">
        <link rel="next" title="Configuring how Relationship Joins" href="join_conditions.html">
        <link rel="prev" title="Basic Relationship Patterns" href="basic_relationships.html">
    <!-- end layout.mako headers -->




    

    <!-- sqlalchemy.org docs base head -->
    
<link rel="shortcut icon" href="../../../../www.sqlalchemy.org/favicon.ico" type="image/x-icon">
<link href="../../../../fonts.googleapis.com/css118a.css?family=Source+Sans+Pro:400,600,400italic" rel="stylesheet" type="text/css">

<script type="text/javascript">
var site_base='//www.sqlalchemy.org';
var docs_base='//docs.sqlalchemy.org';
</script>


    <!-- end sqlalchemy.org docs base head -->

</head>

<body>

<div id="wrap" class="container-xxl wrap px-0">





<nav class="navbar navbar-light logo">
    <div class="container-fluid">
        <a class="navbar-brand" href="http://www.sqlalchemy.org/">
            <img src="../../../../www.sqlalchemy.org/img/sqla_logo.png" width="240" alt="SQLAlchemy">
        </a>
        <div class="navbar-brand align-self-end dbtoolkit">
            <img src="../../../../www.sqlalchemy.org/img/dbtoolkit6.gif" width="180" height="12" alt="The Database Toolkit for Python">
        </div>
    </div>
</nav>
<nav class="navbar navbar-expand-md navbar-dark bg-sa-green py-0 navigation">
    <div class="container-fluid">
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavigation" aria-controls="navbarNavigation" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <span class="navbar-brand d-md-block d-md-none" href="#">The Database Toolkit for Python</span>
        <div class="collapse navbar-collapse" id="navbarNavigation">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link " href="http://www.sqlalchemy.org/">home</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle " href="#" id="feature-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        features
                    </a>
                    <ul class="dropdown-menu dropdown-menu-dark bg-sa-green" aria-labelledby="feature-dropdown">
                        <li><a class="dropdown-item" href="http://www.sqlalchemy.org/philosophy.html">Philosophy Statement</a></li>
                        <li><a class="dropdown-item" href="http://www.sqlalchemy.org/features.html">Feature Overview</a></li>
                        <li><a class="dropdown-item" href="http://www.sqlalchemy.org/quotes.html">Testimonials</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a class="nav-link " href="http://www.sqlalchemy.org/blog/">news</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle active" aria-current="page" href="#" id="docs-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        documentation
                    </a>
                    <ul class="dropdown-menu dropdown-menu-dark bg-sa-green" aria-labelledby="docs-dropdown">
                        <li><a class="dropdown-item" href="http://docs.sqlalchemy.org/">Current Documentation (version 2.0)</a></li>

                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="http://www.sqlalchemy.org/library.html#reference">Documentation by Version</a></li>
                        
        <li>
            <a class="dropdown-item" href="../index.html">
                <span class="ps-2">Version 2.0</span>
            </a>
        </li>
        <li>
            <a class="dropdown-item" href="http://docs.sqlalchemy.org/en/14/">
                <span class="ps-2">Version 1.4</span>
            </a>
        </li>
        <li>
            <a class="dropdown-item" href="http://docs.sqlalchemy.org/en/13/">
                <span class="ps-2">Version 1.3</span>
            </a>
        </li>

                        <li><hr class="dropdown-divider"></li>

                        <li><a class="dropdown-item" href="http://www.sqlalchemy.org/library.html#talks">Talks and Tutorials</a></li>
                        <li><a class="dropdown-item" href="http://www.sqlalchemy.org/library.html">Published content overview</a></li>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle " href="#" id="community-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        community
                    </a>
                    <ul class="dropdown-menu dropdown-menu-dark bg-sa-green" aria-labelledby="community-dropdown">
                        <li><a class="dropdown-item" href="http://www.sqlalchemy.org/support.html">Get Support</a></li>
                        <li><a class="dropdown-item" href="http://www.sqlalchemy.org/participate.html">Participate</a></li>
                        <li><a class="dropdown-item" href="http://www.sqlalchemy.org/develop.html">Develop</a></li>
                        <li><a class="dropdown-item" href="http://www.sqlalchemy.org/codeofconduct.html">Code of Conduct</a></li>
                        <li><a class="dropdown-item" href="https://github.com/sqlalchemy/sqlalchemy">Github</a></li>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle " href="#" id="download-dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        download
                    </a>
                    <ul class="dropdown-menu dropdown-menu-dark bg-sa-green" aria-labelledby="download-dropdown">
                        <li><a class="dropdown-item" href="http://www.sqlalchemy.org/download.html">Download</a>
                        






    </li><li><a class="dropdown-item" href="http://www.sqlalchemy.org/download.html#current">Current Release Series (2.0)</a></li>

    <li><a class="dropdown-item" href="http://www.sqlalchemy.org/download.html#maintenance">Maintenance Release (1.4)</a></li>

    <li><a class="dropdown-item" href="http://www.sqlalchemy.org/download.html#development">Development Access</a></li>
    <li><a class="dropdown-item" href="http://www.sqlalchemy.org/download.html#license">License</a></li>
    <li><a class="dropdown-item" href="http://www.sqlalchemy.org/download.html#versions">Version Numbering</a></li>
    <li><a class="dropdown-item" href="http://www.sqlalchemy.org/download.html#relstatus">Release Status</a></li>

                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>


<div id="main-body" class="docs main-body row m-0">

<main id="docs" class="docs">


















<div id="docs-container">





<div id="docs-top-navigation-container" class="body-background">
<div id="docs-header">
    <div id="docs-version-header">
        Release: <span class="version-num">2.0.18</span>

            <span id="sidebar-current">current release</span>

        | Release Date: July 5, 2023

    </div>

    <h1><a href="../index-2.html">SQLAlchemy 2.0 Documentation</a></h1>

</div>
</div>

<div id="docs-body-container">

    <div id="fixed-sidebar" class="">



        <div id="docs-sidebar-popout">
            <h3><a href="../index-2.html">SQLAlchemy 2.0 Documentation</a></h3>
                <p id="sidebar-current">current release</p>
            <p id="sidebar-topnav">
                <a href="../index-2.html">Home</a>
                | <a href="http://docs.sqlalchemy.org/20/sqlalchemy_20.zip">Download this Documentation</a>
            </p>

            <div id="sidebar-search">
                <form class="search" action="https://docs.sqlalchemy.org/en/20/search.html" method="get">
                  <label>
                  Search terms:
                  <input type="text" placeholder="search..." name="q" size="12">
                  </label>
                  <input type="hidden" name="check_keywords" value="yes">
                  <input type="hidden" name="area" value="default">
                </form>
            </div>

        </div>

        <div id="docs-sidebar">

        <div id="sidebar-banner">
            
        
<script async="" type="text/javascript" id="_carbonads_js" src="../../../../cdn.carbonads.com/carbon8b90.js?serve=CKYILK7Y&amp;amp;placement=sqlalchemyorg"></script>
<script async="" type="text/javascript" id="_eaads_js" src="../../../../media.ethicalads.io/media/client/ethicalads.min.js"></script>

<div data-ea-publisher="sqlalchemyorg" data-ea-type="image" class="adaptive flat horizontal"></div>

<script type="text/javascript">

var ea = "../../../../media.ethicalads.io/media/client/ethicalads.min.js";
var carbon = "../../../../cdn.carbonads.com/carbon8b90.js?serve=CKYILK7Y&amp;placement=sqlalchemyorg";

if (Math.floor(Math.random() * 10) < 8) {
    ea_script = document.getElementById("_eaads_js");
    ea_script.setAttribute('src', ea);
}
else {
    carbon_script = document.getElementById("_carbonads_js");
    carbon_script.setAttribute('src', carbon);
}

</script>

    
        </div>

        <div id="docs-sidebar-inner">

        
        <h3>
            <a href="index.html" title="SQLAlchemy ORM">SQLAlchemy ORM</a>
        </h3>

        <ul>
<li><span class="link-container"><a class="reference external" href="quickstart.html">ORM Quick Start</a></span></li>
<li><span class="link-container"><a class="reference external" href="mapper_config.html">ORM Mapped Class Configuration</a></span></li>
<li><span class="link-container"><a class="reference external" href="relationships.html">Relationship Configuration</a></span><ul>
<li><span class="link-container"><a class="reference external" href="basic_relationships.html">Basic Relationship Patterns</a></span></li>
<li class="selected"><span class="link-container"><strong>Adjacency List Relationships</strong><a class="paramlink headerlink reference internal" href="#">¶</a></span><ul>
<li><span class="link-container"><a class="reference external" href="#composite-adjacency-lists">Composite Adjacency Lists</a></span></li>
<li><span class="link-container"><a class="reference external" href="#self-referential-query-strategies">Self-Referential Query Strategies</a></span></li>
<li><span class="link-container"><a class="reference external" href="#configuring-self-referential-eager-loading">Configuring Self-Referential Eager Loading</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="join_conditions.html">Configuring how Relationship Joins</a></span></li>
<li><span class="link-container"><a class="reference external" href="large_collections.html">Working with Large Collections</a></span></li>
<li><span class="link-container"><a class="reference external" href="collection_api.html">Collection Customization and API Details</a></span></li>
<li><span class="link-container"><a class="reference external" href="relationship_persistence.html">Special Relationship Persistence Patterns</a></span></li>
<li><span class="link-container"><a class="reference external" href="backref.html">Using the legacy ‘backref’ relationship parameter</a></span></li>
<li><span class="link-container"><a class="reference external" href="relationship_api.html">Relationships API</a></span></li>
</ul>
</li>
<li><span class="link-container"><a class="reference external" href="queryguide/index.html">ORM Querying Guide</a></span></li>
<li><span class="link-container"><a class="reference external" href="session.html">Using the Session</a></span></li>
<li><span class="link-container"><a class="reference external" href="extending.html">Events and Internals</a></span></li>
<li><span class="link-container"><a class="reference external" href="extensions/index.html">ORM Extensions</a></span></li>
<li><span class="link-container"><a class="reference external" href="examples.html">ORM Examples</a></span></li>
</ul>


        <h4>Project Versions</h4>
        <ul class="version-listing">
            <li><a href="../index-2.html">2.0.18</a></li>
        </ul>

        </div>

        </div>

    </div>

    <div id="narrow-index-nav">
        <form class="search" action="https://docs.sqlalchemy.org/en/20/search.html" method="get">
            <label>
                Search terms:
            <input type="text" placeholder="search..." name="q" size="12">
            </label>
            <input type="submit" value="Search">
            <input type="hidden" name="check_keywords" value="yes">
            <input type="hidden" name="area" value="default">
        </form>

        <p>
        <a href="../index-2.html">Home</a>
        | <a href="http://docs.sqlalchemy.org/20/sqlalchemy_20.zip">Download this Documentation</a>
        </p>

    </div>


        <div id="docs-narrow-top-navigation">
            <ul>
                <li><b>Previous:</b>
                <a href="basic_relationships.html" title="previous chapter">Basic Relationship Patterns</a></li>
                <li><b>Next:</b>
                <a href="join_conditions.html" title="next chapter">Configuring how Relationship Joins</a></li>

            <li><b>Up:</b> <a href="../index-2.html">Home</a></li>
                    <ul><li><a href="index.html" title="SQLAlchemy ORM">SQLAlchemy ORM</a></li>
                    <ul><li><a href="relationships.html" title="Relationship Configuration">Relationship Configuration</a></li>
                </ul>
                </ul>



            <li><b>On this page:</b></li>
            <ul>
<li><a class="reference internal" href="#adjacency-list-relationships">Adjacency List Relationships</a><ul>
<li><a class="reference internal" href="#composite-adjacency-lists">Composite Adjacency Lists</a></li>
<li><a class="reference internal" href="#self-referential-query-strategies">Self-Referential Query Strategies</a></li>
<li><a class="reference internal" href="#configuring-self-referential-eager-loading">Configuring Self-Referential Eager Loading</a></li>
</ul>
</li>
</ul>


            </ul>

        </div>



    <div id="docs-body" role="main" class=" orm-self_referential">
        
<section id="adjacency-list-relationships">
<span id="self-referential"></span><h1>Adjacency List Relationships<a class="headerlink" href="#adjacency-list-relationships" title="Permalink to this heading">¶</a></h1>
<p>The <strong>adjacency list</strong> pattern is a common relational pattern whereby a table
contains a foreign key reference to itself, in other words is a
<strong>self referential relationship</strong>. This is the most common
way to represent hierarchical data in flat tables.  Other methods
include <strong>nested sets</strong>, sometimes called “modified preorder”,
as well as <strong>materialized path</strong>.  Despite the appeal that modified preorder
has when evaluated for its fluency within SQL queries, the adjacency list model is
probably the most appropriate pattern for the large majority of hierarchical
storage needs, for reasons of concurrency, reduced complexity, and that
modified preorder has little advantage over an application which can fully
load subtrees into the application space.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>This section details the single-table version of a self-referential
relationship. For a self-referential relationship that uses a second table
as an association table, see the section
<a class="reference internal" href="join_conditions.html#self-referential-many-to-many"><span class="std std-ref">Self-Referential Many-to-Many Relationship</span></a>.</p>
</div>
<p>In this example, we’ll work with a single mapped
class called <code class="docutils literal notranslate"><span class="pre">Node</span></code>, representing a tree structure:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Node</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">"node"</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">parent_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">"node.id"</span><span class="p">))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
    <span class="n">children</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">"Node"</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>With this structure, a graph such as the following:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>root --+---&gt; child1
       +---&gt; child2 --+--&gt; subchild1
       |              +--&gt; subchild2
       +---&gt; child3</pre></div>
</div>
<p>Would be represented with data such as:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>id       parent_id     data
---      -------       ----
1        NULL          root
2        1             child1
3        1             child2
4        3             subchild1
5        3             subchild2
6        1             child3</pre></div>
</div>
<p>The <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> configuration here works in the
same way as a “normal” one-to-many relationship, with the
exception that the “direction”, i.e. whether the relationship
is one-to-many or many-to-one, is assumed by default to
be one-to-many.   To establish the relationship as many-to-one,
an extra directive is added known as <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.remote_side" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.remote_side</span></code></a>, which
is a <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> or collection of <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> objects
that indicate those which should be considered to be “remote”:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Node</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">"node"</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">parent_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">"node.id"</span><span class="p">))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">"Node"</span><span class="p">,</span> <span class="n">remote_side</span><span class="o">=</span><span class="p">[</span><span class="n">id</span><span class="p">])</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Where above, the <code class="docutils literal notranslate"><span class="pre">id</span></code> column is applied as the <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.remote_side" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.remote_side</span></code></a>
of the <code class="docutils literal notranslate"><span class="pre">parent</span></code> <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a>, thus establishing
<code class="docutils literal notranslate"><span class="pre">parent_id</span></code> as the “local” side, and the relationship
then behaves as a many-to-one.</p>
<p>As always, both directions can be combined into a bidirectional
relationship using two <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> constructs linked by
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.back_populates" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.back_populates</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Node</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">"node"</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">parent_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">"node.id"</span><span class="p">))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
    <span class="n">children</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">"Node"</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">"parent"</span><span class="p">)</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">"Node"</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">"children"</span><span class="p">,</span> <span class="n">remote_side</span><span class="o">=</span><span class="p">[</span><span class="n">id</span><span class="p">])</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="examples.html#examples-adjacencylist"><span class="std std-ref">Adjacency List</span></a> - working example, updated for SQLAlchemy 2.0</p>
</div>
<section id="composite-adjacency-lists">
<h2>Composite Adjacency Lists<a class="headerlink" href="#composite-adjacency-lists" title="Permalink to this heading">¶</a></h2>
<p>A sub-category of the adjacency list relationship is the rare
case where a particular column is present on both the “local” and
“remote” side of the join condition.  An example is the <code class="docutils literal notranslate"><span class="pre">Folder</span></code>
class below; using a composite primary key, the <code class="docutils literal notranslate"><span class="pre">account_id</span></code>
column refers to itself, to indicate sub folders which are within
the same account as that of the parent; while <code class="docutils literal notranslate"><span class="pre">folder_id</span></code> refers
to a specific folder within that account:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Folder</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">"folder"</span>
    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ForeignKeyConstraint</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">"account_id"</span><span class="p">,</span> <span class="s2">"parent_id"</span><span class="p">],</span> <span class="p">[</span><span class="s2">"folder.account_id"</span><span class="p">,</span> <span class="s2">"folder.folder_id"</span><span class="p">]</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">account_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">folder_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">parent_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>

    <span class="n">parent_folder</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">"Folder"</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">"child_folders"</span><span class="p">,</span> <span class="n">remote_side</span><span class="o">=</span><span class="p">[</span><span class="n">account_id</span><span class="p">,</span> <span class="n">folder_id</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">child_folders</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">"Folder"</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">"parent_folder"</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Above, we pass <code class="docutils literal notranslate"><span class="pre">account_id</span></code> into the <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.remote_side" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.remote_side</span></code></a> list.
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> recognizes that the <code class="docutils literal notranslate"><span class="pre">account_id</span></code> column here
is on both sides, and aligns the “remote” column along with the
<code class="docutils literal notranslate"><span class="pre">folder_id</span></code> column, which it recognizes as uniquely present on
the “remote” side.</p>
</section>
<section id="self-referential-query-strategies">
<a class="dashAnchor" name="//apple_ref/Section/Self-Referential%20Query%20Strategies"></a><span id="self-referential-query"></span><h2>Self-Referential Query Strategies<a class="headerlink" href="#self-referential-query-strategies" title="Permalink to this heading">¶</a></h2>
<p>Querying of self-referential structures works like any other query:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># get all nodes named 'child2'</span>
<span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">Node</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Node</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">"child2"</span><span class="p">))</span></pre></div>
</div>
<p>However extra care is needed when attempting to join along
the foreign key from one level of the tree to the next.  In SQL,
a join from a table to itself requires that at least one side of the
expression be “aliased” so that it can be unambiguously referred to.</p>
<p>Recall from <a class="reference internal" href="queryguide/select.html#orm-queryguide-orm-aliases"><span class="std std-ref">Selecting ORM Aliases</span></a> in the ORM tutorial that the
<a class="reference internal" href="queryguide/api.html#sqlalchemy.orm.aliased" title="sqlalchemy.orm.aliased"><code class="xref py py-func docutils literal notranslate"><span class="pre">aliased()</span></code></a> construct is normally used to provide an “alias” of
an ORM entity.  Joining from <code class="docutils literal notranslate"><span class="pre">Node</span></code> to itself using this technique
looks like:</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">aliased</span>

<span class="n">nodealias</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">Node</span><span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span>
    <span class="n">select</span><span class="p">(</span><span class="n">Node</span><span class="p">)</span>
    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Node</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">"subchild1"</span><span class="p">)</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Node</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">of_type</span><span class="p">(</span><span class="n">nodealias</span><span class="p">))</span>
    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">nodealias</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="s2">"child2"</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<div class="show_sql"><span class="k">SELECT</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">node_id</span><span class="p">,</span>
<span class="w">        </span><span class="n">node</span><span class="p">.</span><span class="n">parent_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">node_parent_id</span><span class="p">,</span>
<span class="w">        </span><span class="n">node</span><span class="p">.</span><span class="k">data</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">node_data</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">node_1</span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">parent_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node_1</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="k">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="w">    </span><span class="k">AND</span><span class="w"> </span><span class="n">node_1</span><span class="p">.</span><span class="k">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="p">[</span><span class="s1">'subchild1'</span><span class="p">,</span><span class="w"> </span><span class="s1">'child2'</span><span class="p">]</span>
</div></pre></div>
</div>
</section>
<section id="configuring-self-referential-eager-loading">
<a class="dashAnchor" name="//apple_ref/Section/Configuring%20Self-Referential%20Eager%20Loading"></a><span id="self-referential-eager-loading"></span><h2>Configuring Self-Referential Eager Loading<a class="headerlink" href="#configuring-self-referential-eager-loading" title="Permalink to this heading">¶</a></h2>
<p>Eager loading of relationships occurs using joins or outerjoins from parent to
child table during a normal query operation, such that the parent and its
immediate child collection or reference can be populated from a single SQL
statement, or a second statement for all immediate child collections.
SQLAlchemy’s joined and subquery eager loading use aliased tables in all cases
when joining to related items, so are compatible with self-referential
joining. However, to use eager loading with a self-referential relationship,
SQLAlchemy needs to be told how many levels deep it should join and/or query;
otherwise the eager load will not take place at all. This depth setting is
configured via <code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationships.join_depth</span></code>:</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Node</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">"node"</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">parent_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">"node.id"</span><span class="p">))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
    <span class="n">children</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">"Node"</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s2">"joined"</span><span class="p">,</span> <span class="n">join_depth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>


<span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">Node</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<div class="show_sql"><span class="k">SELECT</span><span class="w"> </span><span class="n">node_1</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">node_1_id</span><span class="p">,</span>
<span class="w">        </span><span class="n">node_1</span><span class="p">.</span><span class="n">parent_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">node_1_parent_id</span><span class="p">,</span>
<span class="w">        </span><span class="n">node_1</span><span class="p">.</span><span class="k">data</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">node_1_data</span><span class="p">,</span>
<span class="w">        </span><span class="n">node_2</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">node_2_id</span><span class="p">,</span>
<span class="w">        </span><span class="n">node_2</span><span class="p">.</span><span class="n">parent_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">node_2_parent_id</span><span class="p">,</span>
<span class="w">        </span><span class="n">node_2</span><span class="p">.</span><span class="k">data</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">node_2_data</span><span class="p">,</span>
<span class="w">        </span><span class="n">node</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">node_id</span><span class="p">,</span>
<span class="w">        </span><span class="n">node</span><span class="p">.</span><span class="n">parent_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">node_parent_id</span><span class="p">,</span>
<span class="w">        </span><span class="n">node</span><span class="p">.</span><span class="k">data</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">node_data</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">node</span>
<span class="w">    </span><span class="k">LEFT</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">node_2</span>
<span class="w">        </span><span class="k">ON</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node_2</span><span class="p">.</span><span class="n">parent_id</span>
<span class="w">    </span><span class="k">LEFT</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">node_1</span>
<span class="w">        </span><span class="k">ON</span><span class="w"> </span><span class="n">node_2</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node_1</span><span class="p">.</span><span class="n">parent_id</span>
<span class="p">[]</span>
</div></pre><div class="code-non-annotations-key"></div></div>
</div>
</section>
</section>

    </div>

</div>

<div id="docs-bottom-navigation" class="docs-navigation-links, ">
        Previous:
        <a href="basic_relationships.html" title="previous chapter">Basic Relationship Patterns</a>
        Next:
        <a href="join_conditions.html" title="next chapter">Configuring how Relationship Joins</a>

    <div id="docs-copyright">
        © <a href="../copyright.html">Copyright</a> 2007-2023, the SQLAlchemy authors and contributors.


    <p><b>flambé!</b> the dragon and <b><i>The Alchemist</i></b> image designs created and generously donated by <a href="https://github.com/vmalloc">Rotem Yaari</a>.</p>

        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 7.0.1.

    Documentation last generated: Wed 05 Jul 2023 03:34:06 PM 

    </div>
</div>

</div>




</main></div>

</div> <!-- end #main-body -->


    

    

<div id="footer" class="footer">
    <div class="snd-ad">
    </div>
    <div class="pypowered">
        <a href="http://www.python.org/" title="The Python Language Site">
            <img src="../../../../www.sqlalchemy.org/img/python-logo.gif" width="88" height="30" alt="Python" class="pypowered">
        </a>
    </div>

    <div class="copyright">
        <p>Website content copyright © by SQLAlchemy authors and contributors.
            SQLAlchemy and its documentation are licensed under the MIT license.</p>
        <p>SQLAlchemy is a trademark of Michael Bayer.  mike(&amp;)zzzcomputing.com
        All rights reserved. </p>
        <p>Website generation by
        <a href="https://github.com/sqlalchemyorg/zeekofile/">zeekofile</a>, with
        huge thanks to the <a href="https://github.com/EnigmaCurry/blogofile">Blogofile</a>
        project.</p>

        <a rel="me" href="https://fosstodon.org/@zzzeek">Mastodon</a>

    </div>

    <br clear="all">

</div>



     <!-- End original user content -->

    




 <!-- end #wrap -->


    

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
          URL_ROOT:    '../',
          VERSION:     '2.0.18',
          COLLAPSE_MODINDEX: false,
          FILE_SUFFIX: '.html'
      };
    </script>

    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>

    <!-- begin iterate through sphinx environment script_files -->
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script type="text/javascript" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/sphinx_highlight.js"></script>
        <script type="text/javascript" src="../_static/clipboard.min.js"></script>
        <script type="text/javascript" src="../_static/copybutton.js"></script>
    <!-- end iterate through sphinx environment script_files -->

    <script type="text/javascript" src="../_static/init.js"></script>




<script type="text/javascript" src="../../../../www.sqlalchemy.org/js/bootstrap.bundle.min.js"></script>
<script type="text/javascript" src="../../../../www.sqlalchemy.org/js/doc_versions.js"></script>

<!-- Google tag (gtag.js) -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-KWWK46V0YX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KWWK46V0YX');
</script>




<!-- Mirrored from docs.sqlalchemy.org/en/20/orm/self_referential.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 06 Jul 2023 08:05:55 GMT -->


</body></html>