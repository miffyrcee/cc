<html><!-- Online page at https://en.cppreference.com/w/MediaWiki:Gadget-standard_revisions.js --><head><meta charset="utf-8"><title>MediaWiki:Gadget-standard revisions.js</title><link rel="stylesheet" href="./css_1.css" type="text/css"><link rel="stylesheet" href="./css_2.css" type="text/css"><link rel="stylesheet" href="./css_3.css" type="text/css"><link rel="stylesheet" href="./css_4.css" type="text/css"><link rel="stylesheet" href="./css_5.css" type="text/css"><link rel="stylesheet" href="./css_20.css" type="text/css"><link rel="stylesheet" href="./css_8.css" type="text/css"><link rel="stylesheet" href="./css_9.css" type="text/css"><link rel="stylesheet" href="./css_10.css" type="text/css"><link rel="stylesheet" href="./css_11.css" type="text/css"><script type="text/javascript" src="./js_1.js"></script><script type="text/javascript" src="./js_2.js"></script><script type="text/javascript" src="./js_5977.js"></script><script type="text/javascript" src="./js_4.js"></script><script type="text/javascript" src="./js_5.js"></script><script type="text/javascript" src="./js_6.js"></script><script type="text/javascript" src="./js_7.js"></script><script type="text/javascript" src="./js_8.js"></script><script type="text/javascript" src="./js_9.js"></script><script type="text/javascript" src="./js_10.js"></script><script type="text/javascript" src="./js_11.js"></script><script type="text/javascript" src="./js_12.js"></script><script type="text/javascript" src="./js_13.js"></script><script type="text/javascript" src="./js_14.js"></script><script type="text/javascript" src="./js_15.js"></script><style>.t-example-live-link {display:none !important} .t-sidebar-body {display:none}\nbody{min-width:0}\ndiv.mw-geshi{width:95%}\ndiv#content {width:auto !important} div#content{background-image:none; margin-left:0px;} .t-lines {background:inherit !important} pre, div.mw-geshi {width: 100% !important} body {background:white !important} div#content {width:100% !important} pre, div.mw-geshi {width:auto !important} .t-example-live-link, #mw-head, #cpp-footer-base {display:none !important} .t-navbar-menu > div {position:relative !important}</style></head><body class="mediawiki ltr sitedir-ltr ns-8 ns-subject page-MediaWiki_Gadget-standard_revisions_js skin-cppreference2 action-view">
        <!-- header -->
        <div id="mw-head" class="noprint">
            <div id="cpp-head-first-base">
                <div id="cpp-head-first">
                    <h5><a href="https://en.cppreference.com/">
                        cppreference.com                        </a></h5>
                    <div id="cpp-head-search">
                        
<!-- 0 -->
<div id="p-search">
<form action="https://duckduckgo.com/" method="get">
  <input type="hidden" name="sites" value="cppreference.com">
  <input type="search" name="q">
  <input type="submit" value="Search">
</form>
</div>

<!-- /0 -->
                    </div>
                    <div id="cpp-head-personal">
                        
<!-- 0 -->
<div id="p-personal" class="">
<span id="pt-createaccount"><a href="https://en.cppreference.com/mwiki/index.php?title=Special:UserLogin&amp;returnto=MediaWiki%3AGadget-standard+revisions.js&amp;type=signup">Create account</a></span>	<div class="menu">
        <ul>
<li id="pt-login"><a href="https://en.cppreference.com/mwiki/index.php?title=Special:UserLogin&amp;returnto=MediaWiki%3AGadget-standard+revisions.js" title="You are encouraged to log in; however, it is not mandatory [ctrl-option-o]" accesskey="o">Log in</a></li>        </ul>
    </div>
</div>

<!-- /0 -->
                    </div>

                </div>
            </div>
            <div id="cpp-head-second-base">
                <div id="cpp-head-second">
                    <div id="cpp-head-tools-left">
                        
<!-- 0 -->
<div id="p-namespaces" class="vectorTabs">
	<h5>Namespaces</h5>
	<ul>
					<li id="ca-nstab-mediawiki" class="selected"><span><a href="./MediaWiki:Gadget-standard_revisions.js.html" title="View the system message [ctrl-option-c]" accesskey="c">Message</a></span></li>
					<li id="ca-talk"><span><a href="./MediaWiki_talk:Gadget-standard_revisions.js.html" title="Discussion about the content page [ctrl-option-t]" accesskey="t">Discussion</a></span></li>
			</ul>
</div>

<!-- /0 -->

<!-- 1 -->
<div id="p-variants" class="vectorMenu emptyPortlet">
		<h5><span>Variants</span><a href="#"></a></h5>
	<div class="menu">
		<ul>
					</ul>
	</div>
</div>

<!-- /1 -->
                    </div>
                    <div id="cpp-head-tools-right">
                        
<!-- 0 -->
<div id="p-views" class="vectorTabs">
	<h5>Views</h5>
	<ul>
					<li id="ca-view" class="selected"><span><a href="./MediaWiki:Gadget-standard_revisions.js.html">View</a></span></li>
					<li id="ca-viewsource"><span><a href="https://en.cppreference.com/mwiki/index.php?title=MediaWiki:Gadget-standard_revisions.js&amp;action=edit" title="This page is protected.
You can view its source [ctrl-option-e]" accesskey="e">View source</a></span></li>
					<li id="ca-history" class="collapsible"><span><a href="https://en.cppreference.com/mwiki/index.php?title=MediaWiki:Gadget-standard_revisions.js&amp;action=history" title="Past revisions of this page [ctrl-option-h]" accesskey="h">History</a></span></li>
			</ul>
</div>

<!-- /0 -->

<!-- 1 -->
<div id="p-cactions" class="vectorMenu emptyPortlet">
	<h5><span>Actions</span><a href="#"></a></h5>
	<div class="menu">
		<ul>
					</ul>
	</div>
</div>

<!-- /1 -->
                    </div>
                </div>
            </div>
        </div>
        <!-- /header -->
        <!-- content -->
<style type="text/css">
#carbonads {
  display: block;
  overflow: hidden;
  position: absolute;
  text-align: center;
  left: -170px;
  max-width: 150px;
  border-radius: 4px;
  border: solid 1px hsla(0, 0%, 0%, .1);
  background-color: hsl(0, 0%, 98%);
  font-size: 12px;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu,
  Cantarell, "Helvetica Neue", Helvetica, Arial, sans-serif;
  line-height: 1.5;
}

#carbonads a {
  color: inherit;
  text-decoration: none;
}

#carbonads a:hover {
  color: inherit;
}

#carbonads span {
  position: relative;
  display: block;
  overflow: hidden;
}

.carbon-img {
  display: block;
  margin-bottom: 8px;
  max-width: 150px;
  line-height: 1;
}

.carbon-img img {
  display: block;
  margin: 0 auto;
  max-width: 150px !important;
  width: 150px;
  height: auto;
}

.carbon-text {
  display: block;
  padding: 0 1em 8px;
}

.carbon-poweredby {
  display: block;
  padding: 8px 12px;
  background: repeating-linear-gradient(-45deg, transparent, transparent 5px, hsla(0, 0%, 0%, .025) 5px, hsla(0, 0%, 0%, .025) 10px) hsla(203, 11%, 95%, .4);
  text-transform: uppercase;
  letter-spacing: .5px;
  font-weight: 600;
  font-size: 9px;
  line-height: 1;
}
html { font-variant-ligatures: no-common-ligatures; }
</style>
        <div id="cpp-content-base">
            <div id="content">
                <a id="top"></a>
                <div id="mw-js-message" style="display:none;"></div>
                                <!-- firstHeading -->
<script async="" type="text/javascript" src="../../cdn.carbonads.com/carbon.js" id="_carbonads_js"></script>
                <h1 id="firstHeading" class="firstHeading">MediaWiki:Gadget-standard revisions.js</h1>
                <!-- /firstHeading -->
                <!-- bodyContent -->
                <div id="bodyContent">
                                        <!-- tagline -->
                    <div id="siteSub">From cppreference.com</div>
                    <!-- /tagline -->
                                        <!-- subtitle -->
                    <div id="contentSub"></div>
                    <!-- /subtitle -->
                                                            <!-- bodycontent -->
                    <div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><div id="mw-clearyourcache" lang="en" dir="ltr" class="mw-content-ltr">
<p><b>Note:</b> After saving, you may have to bypass your browser's cache to see the changes.
</p>
<ul><li> <b>Firefox / Safari:</b> Hold <i>Shift</i> while clicking <i>Reload</i>, or press either <i>Ctrl-F5</i> or <i>Ctrl-R</i> (<i>⌘-R</i> on a Mac)
</li><li> <b>Google Chrome:</b> Press <i>Ctrl-Shift-R</i> (<i>⌘-Shift-R</i> on a Mac)
</li><li> <b>Internet Explorer:</b> Hold <i>Ctrl</i> while clicking <i>Refresh</i>, or press <i>Ctrl-F5</i>
</li><li> <b>Opera:</b> Clear the cache in <i>Tools → Preferences</i>
</li></ul>
</div>
<div dir="ltr"><pre class="javascript source-javascript">&nbsp;
<span class="coMULTI">/*
    Copyright (C) 2013-2017  Povilas Kanapickas &lt;povilas@radix.lt&gt;
&nbsp;
    This file is part of cppreference.com
&nbsp;
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 2 of the License, or
    (at your option) any later version.
&nbsp;
    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.
&nbsp;
    You should have received a copy of the GNU General Public License
    along with this program.  If not, see http://www.gnu.org/licenses/.
*/</span>
&nbsp;
$<span class="br0">(</span><span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
&nbsp;
    <span class="kw2">var</span> debug <span class="sy0">=</span> <span class="kw2">false</span><span class="sy0">;</span>
&nbsp;
    <span class="co1">// Add console.log() if not present</span>
    <span class="kw1">if</span> <span class="br0">(</span><span class="sy0">!</span>window.<span class="me1">console</span><span class="br0">)</span>
        window.<span class="me1">console</span> <span class="sy0">=</span> <span class="br0">{</span><span class="br0">}</span><span class="sy0">;</span>
    <span class="kw1">if</span> <span class="br0">(</span><span class="sy0">!</span>window.<span class="me1">console</span>.<span class="me1">log</span><span class="br0">)</span>
        window.<span class="me1">console</span>.<span class="me1">log</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span> <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="co1">// Returns true if the given arrays have the same length and equal elements</span>
    <span class="co1">// at specific positions, false otherwise</span>
    <span class="kw2">function</span> array_equal<span class="br0">(</span>a<span class="sy0">,</span> b<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw2">var</span> i <span class="sy0">=</span> a.<span class="me1">length</span><span class="sy0">;</span>
        <span class="kw1">if</span> <span class="br0">(</span>i <span class="sy0">!==</span> b.<span class="me1">length</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">return</span> <span class="kw2">false</span><span class="sy0">;</span>
        <span class="br0">}</span>
        <span class="kw1">while</span> <span class="br0">(</span>i<span class="sy0">--</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">if</span> <span class="br0">(</span>a<span class="br0">[</span>i<span class="br0">]</span> <span class="sy0">!==</span> b<span class="br0">[</span>i<span class="br0">]</span><span class="br0">)</span> <span class="br0">{</span>
                <span class="kw1">return</span> <span class="kw2">false</span><span class="sy0">;</span>
            <span class="br0">}</span>
        <span class="br0">}</span>
        <span class="kw1">return</span> <span class="kw2">true</span><span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="co1">// Given an array of numbers, sorts them, removes non-unique elements and</span>
    <span class="co1">// returns the resulting array. The argument array is not modified.</span>
    <span class="kw2">function</span> array_sort_unique<span class="br0">(</span>a<span class="br0">)</span> <span class="br0">{</span>
        a <span class="sy0">=</span> a.<span class="me1">sort</span><span class="br0">(</span><span class="kw2">function</span><span class="br0">(</span>x<span class="sy0">,</span> y<span class="br0">)</span> <span class="br0">{</span> <span class="kw1">return</span> x <span class="sy0">-</span> y<span class="sy0">;</span> <span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="kw2">var</span> c <span class="sy0">=</span> a<span class="br0">[</span><span class="nu0">0</span><span class="br0">]</span><span class="sy0">;</span>
        <span class="kw2">var</span> res <span class="sy0">=</span> <span class="br0">[</span>c<span class="br0">]</span><span class="sy0">;</span>
        <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> i <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> a.<span class="me1">length</span><span class="sy0">;</span> i<span class="sy0">++</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">if</span> <span class="br0">(</span>a<span class="br0">[</span>i<span class="br0">]</span> <span class="sy0">!==</span> c<span class="br0">)</span> <span class="br0">{</span>
                res.<span class="me1">push</span><span class="br0">(</span>a<span class="br0">[</span>i<span class="br0">]</span><span class="br0">)</span><span class="sy0">;</span>
                c <span class="sy0">=</span> a<span class="br0">[</span>i<span class="br0">]</span><span class="sy0">;</span>
            <span class="br0">}</span>
        <span class="br0">}</span>
        <span class="kw1">return</span> res<span class="sy0">;</span>
    <span class="br0">}</span>
&nbsp;
    <span class="co1">/// Exit if we are not in view mode</span>
    <span class="kw1">if</span> <span class="br0">(</span>mw.<span class="me1">config</span>.<span class="me1">get</span><span class="br0">(</span><span class="st0">'wgAction'</span><span class="br0">)</span> <span class="sy0">!=</span> <span class="st0">'view'</span><span class="br0">)</span> <span class="br0">{</span>
        <span class="kw1">return</span><span class="sy0">;</span>
    <span class="br0">}</span>
    <span class="kw1">if</span> <span class="br0">(</span>mw.<span class="me1">config</span>.<span class="me1">get</span><span class="br0">(</span><span class="st0">'wgNamespaceNumber'</span><span class="br0">)</span> <span class="sy0">!=</span> <span class="nu0">0</span><span class="br0">)</span> <span class="br0">{</span>
        <span class="kw1">return</span><span class="sy0">;</span>
    <span class="br0">}</span>
&nbsp;
    <span class="co1">/// Are we dealing with C or C++?</span>
    <span class="kw2">var</span> is_cxx <span class="sy0">=</span> <span class="br0">(</span>mw.<span class="me1">config</span>.<span class="me1">get</span><span class="br0">(</span><span class="st0">'wgTitle'</span><span class="br0">)</span>.<span class="me1">indexOf</span><span class="br0">(</span><span class="st0">'c/'</span><span class="br0">)</span> <span class="sy0">!=</span> <span class="nu0">0</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
    <span class="co1">// Standard revision identification 'enums'. Throughout the plugin it is</span>
    <span class="co1">// assumed that the values are integers starting at zero and thus they can</span>
    <span class="co1">// be used as an index in regular arrays.</span>
    <span class="kw2">var</span> Rev_c <span class="sy0">=</span> <span class="br0">{</span> DIFF<span class="sy0">:</span> <span class="nu0">0</span><span class="sy0">,</span> FIRST<span class="sy0">:</span> <span class="nu0">1</span><span class="sy0">,</span> C89<span class="sy0">:</span> <span class="nu0">1</span><span class="sy0">,</span> C99<span class="sy0">:</span> <span class="nu0">2</span><span class="sy0">,</span> C11<span class="sy0">:</span> <span class="nu0">3</span><span class="sy0">,</span> C17<span class="sy0">:</span> <span class="nu0">4</span><span class="sy0">,</span> C23<span class="sy0">:</span> <span class="nu0">5</span><span class="sy0">,</span> LAST<span class="sy0">:</span> <span class="nu0">6</span> <span class="br0">}</span><span class="sy0">;</span>
    <span class="kw2">var</span> Rev_cxx <span class="sy0">=</span> <span class="br0">{</span> DIFF<span class="sy0">:</span> <span class="nu0">0</span><span class="sy0">,</span> FIRST<span class="sy0">:</span> <span class="nu0">1</span><span class="sy0">,</span> CXX98<span class="sy0">:</span> <span class="nu0">1</span><span class="sy0">,</span> CXX11<span class="sy0">:</span> <span class="nu0">2</span><span class="sy0">,</span> CXX14<span class="sy0">:</span> <span class="nu0">3</span><span class="sy0">,</span> CXX17<span class="sy0">:</span> <span class="nu0">4</span><span class="sy0">,</span> CXX20<span class="sy0">:</span> <span class="nu0">5</span><span class="sy0">,</span> CXX23<span class="sy0">:</span> <span class="nu0">6</span><span class="sy0">,</span> LAST<span class="sy0">:</span> <span class="nu0">7</span> <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="kw2">var</span> Rev<span class="sy0">;</span>
&nbsp;
    <span class="kw1">if</span> <span class="br0">(</span>is_cxx<span class="br0">)</span> <span class="br0">{</span>
        Rev <span class="sy0">=</span> Rev_cxx<span class="sy0">;</span>
    <span class="br0">}</span> <span class="kw1">else</span> <span class="br0">{</span>
        Rev <span class="sy0">=</span> Rev_c<span class="sy0">;</span>
    <span class="br0">}</span>
&nbsp;
    <span class="co1">/// Standard revision description strings</span>
    <span class="kw2">var</span> desc_c <span class="sy0">=</span> <span class="br0">[</span>
        <span class="br0">{</span> rev<span class="sy0">:</span> Rev.<span class="me1">DIFF</span><span class="sy0">,</span> title<span class="sy0">:</span> <span class="st0">'Diff'</span> <span class="br0">}</span><span class="sy0">,</span>
        <span class="br0">{</span> rev<span class="sy0">:</span> Rev.<span class="me1">C89</span><span class="sy0">,</span> title<span class="sy0">:</span> <span class="st0">'C89'</span> <span class="br0">}</span><span class="sy0">,</span>
        <span class="br0">{</span> rev<span class="sy0">:</span> Rev.<span class="me1">C99</span><span class="sy0">,</span> title<span class="sy0">:</span> <span class="st0">'C99'</span> <span class="br0">}</span><span class="sy0">,</span>
        <span class="br0">{</span> rev<span class="sy0">:</span> Rev.<span class="me1">C11</span><span class="sy0">,</span> title<span class="sy0">:</span> <span class="st0">'C11'</span> <span class="br0">}</span><span class="sy0">,</span>
        <span class="br0">{</span> rev<span class="sy0">:</span> Rev.<span class="me1">C17</span><span class="sy0">,</span> title<span class="sy0">:</span> <span class="st0">'C17'</span> <span class="br0">}</span><span class="sy0">,</span>
        <span class="br0">{</span> rev<span class="sy0">:</span> Rev.<span class="me1">C23</span><span class="sy0">,</span> title<span class="sy0">:</span> <span class="st0">'C23'</span> <span class="br0">}</span><span class="sy0">,</span>
    <span class="br0">]</span><span class="sy0">;</span>
&nbsp;
    <span class="kw2">var</span> desc_cxx <span class="sy0">=</span> <span class="br0">[</span>
        <span class="br0">{</span> rev<span class="sy0">:</span> Rev.<span class="me1">DIFF</span><span class="sy0">,</span> title<span class="sy0">:</span> <span class="st0">'Diff'</span> <span class="br0">}</span><span class="sy0">,</span>
        <span class="br0">{</span> rev<span class="sy0">:</span> Rev.<span class="me1">CXX98</span><span class="sy0">,</span> title<span class="sy0">:</span> <span class="st0">'C++98/03'</span> <span class="br0">}</span><span class="sy0">,</span>
        <span class="br0">{</span> rev<span class="sy0">:</span> Rev.<span class="me1">CXX11</span><span class="sy0">,</span> title<span class="sy0">:</span> <span class="st0">'C++11'</span> <span class="br0">}</span><span class="sy0">,</span>
        <span class="br0">{</span> rev<span class="sy0">:</span> Rev.<span class="me1">CXX14</span><span class="sy0">,</span> title<span class="sy0">:</span> <span class="st0">'C++14'</span> <span class="br0">}</span><span class="sy0">,</span>
        <span class="br0">{</span> rev<span class="sy0">:</span> Rev.<span class="me1">CXX17</span><span class="sy0">,</span> title<span class="sy0">:</span> <span class="st0">'C++17'</span> <span class="br0">}</span><span class="sy0">,</span>
        <span class="br0">{</span> rev<span class="sy0">:</span> Rev.<span class="me1">CXX20</span><span class="sy0">,</span> title<span class="sy0">:</span> <span class="st0">'C++20'</span> <span class="br0">}</span><span class="sy0">,</span>
        <span class="br0">{</span> rev<span class="sy0">:</span> Rev.<span class="me1">CXX23</span><span class="sy0">,</span> title<span class="sy0">:</span> <span class="st0">'C++23'</span> <span class="br0">}</span><span class="sy0">,</span>
    <span class="br0">]</span><span class="sy0">;</span>
&nbsp;
    <span class="kw2">var</span> desc<span class="sy0">;</span>
&nbsp;
    <span class="kw1">if</span> <span class="br0">(</span>is_cxx<span class="br0">)</span> <span class="br0">{</span>   <span class="co1">// select either C or C++ version</span>
        desc <span class="sy0">=</span> desc_cxx<span class="sy0">;</span>
    <span class="br0">}</span> <span class="kw1">else</span> <span class="br0">{</span>
        desc <span class="sy0">=</span> desc_c<span class="sy0">;</span>
    <span class="br0">}</span>
&nbsp;
    <span class="coMULTI">/** A 'mark identifier' is an object that specifies a half-open range of
        standards. It contains the following fields:
         'since' - a bool value identifying which half of the range is open.
         'rev' - the revision of the standard. Rev.DIFF is not an accepted
            value.
    */</span>
&nbsp;
    <span class="coMULTI">/*  Given a mark identifier and a revision, returns true if the range
        specified by the mark identifier includes the revision in question
    */</span>
    <span class="kw2">function</span> should_be_shown<span class="br0">(</span>rev<span class="sy0">,</span> mark<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw1">if</span> <span class="br0">(</span>rev <span class="sy0">===</span> Rev.<span class="me1">DIFF</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">return</span> <span class="kw2">true</span><span class="sy0">;</span>
        <span class="br0">}</span>
        <span class="kw1">if</span> <span class="br0">(</span>mark.<span class="me1">since</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">return</span> <span class="br0">(</span>rev <span class="sy0">&gt;=</span> mark.<span class="me1">rev</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="br0">}</span> <span class="kw1">else</span> <span class="br0">{</span>
            <span class="kw1">return</span> <span class="br0">(</span>rev <span class="sy0">&lt;</span> mark.<span class="me1">rev</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="br0">}</span>
    <span class="br0">}</span>
&nbsp;
    <span class="coMULTI">/*  Returns a mark identifier for a jQuery object. This function only
        supports elements that may contain at most one mark css tag.
    */</span>
    <span class="kw2">function</span> get_mark_cxx<span class="br0">(</span>el<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw1">if</span> <span class="br0">(</span>el.<span class="me1">hasClass</span><span class="br0">(</span><span class="st0">'t-since-cxx11'</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">return</span> <span class="br0">{</span> since<span class="sy0">:</span> <span class="kw2">true</span><span class="sy0">,</span> rev<span class="sy0">:</span> Rev.<span class="me1">CXX11</span> <span class="br0">}</span><span class="sy0">;</span>
        <span class="br0">}</span>
        <span class="kw1">if</span> <span class="br0">(</span>el.<span class="me1">hasClass</span><span class="br0">(</span><span class="st0">'t-since-cxx14'</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">return</span> <span class="br0">{</span> since<span class="sy0">:</span> <span class="kw2">true</span><span class="sy0">,</span> rev<span class="sy0">:</span> Rev.<span class="me1">CXX14</span> <span class="br0">}</span><span class="sy0">;</span>
        <span class="br0">}</span>
        <span class="kw1">if</span> <span class="br0">(</span>el.<span class="me1">hasClass</span><span class="br0">(</span><span class="st0">'t-since-cxx17'</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">return</span> <span class="br0">{</span> since<span class="sy0">:</span> <span class="kw2">true</span><span class="sy0">,</span> rev<span class="sy0">:</span> Rev.<span class="me1">CXX17</span> <span class="br0">}</span><span class="sy0">;</span>
        <span class="br0">}</span>
        <span class="kw1">if</span> <span class="br0">(</span>el.<span class="me1">hasClass</span><span class="br0">(</span><span class="st0">'t-since-cxx20'</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">return</span> <span class="br0">{</span> since<span class="sy0">:</span> <span class="kw2">true</span><span class="sy0">,</span> rev<span class="sy0">:</span> Rev.<span class="me1">CXX20</span> <span class="br0">}</span><span class="sy0">;</span>
        <span class="br0">}</span>
        <span class="kw1">if</span> <span class="br0">(</span>el.<span class="me1">hasClass</span><span class="br0">(</span><span class="st0">'t-since-cxx23'</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">return</span> <span class="br0">{</span> since<span class="sy0">:</span> <span class="kw2">true</span><span class="sy0">,</span> rev<span class="sy0">:</span> Rev.<span class="me1">CXX23</span> <span class="br0">}</span><span class="sy0">;</span>
        <span class="br0">}</span>
        <span class="kw1">if</span> <span class="br0">(</span>el.<span class="me1">hasClass</span><span class="br0">(</span><span class="st0">'t-until-cxx11'</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">return</span> <span class="br0">{</span> since<span class="sy0">:</span> <span class="kw2">false</span><span class="sy0">,</span> rev<span class="sy0">:</span> Rev.<span class="me1">CXX11</span> <span class="br0">}</span><span class="sy0">;</span>
        <span class="br0">}</span>
        <span class="kw1">if</span> <span class="br0">(</span>el.<span class="me1">hasClass</span><span class="br0">(</span><span class="st0">'t-until-cxx14'</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">return</span> <span class="br0">{</span> since<span class="sy0">:</span> <span class="kw2">false</span><span class="sy0">,</span> rev<span class="sy0">:</span> Rev.<span class="me1">CXX14</span> <span class="br0">}</span><span class="sy0">;</span>
        <span class="br0">}</span>
        <span class="kw1">if</span> <span class="br0">(</span>el.<span class="me1">hasClass</span><span class="br0">(</span><span class="st0">'t-until-cxx17'</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">return</span> <span class="br0">{</span> since<span class="sy0">:</span> <span class="kw2">false</span><span class="sy0">,</span> rev<span class="sy0">:</span> Rev.<span class="me1">CXX17</span> <span class="br0">}</span><span class="sy0">;</span>
        <span class="br0">}</span>
        <span class="kw1">if</span> <span class="br0">(</span>el.<span class="me1">hasClass</span><span class="br0">(</span><span class="st0">'t-until-cxx20'</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">return</span> <span class="br0">{</span> since<span class="sy0">:</span> <span class="kw2">false</span><span class="sy0">,</span> rev<span class="sy0">:</span> Rev.<span class="me1">CXX20</span> <span class="br0">}</span><span class="sy0">;</span>
        <span class="br0">}</span>
        <span class="kw1">if</span> <span class="br0">(</span>el.<span class="me1">hasClass</span><span class="br0">(</span><span class="st0">'t-until-cxx23'</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">return</span> <span class="br0">{</span> since<span class="sy0">:</span> <span class="kw2">false</span><span class="sy0">,</span> rev<span class="sy0">:</span> Rev.<span class="me1">CXX23</span> <span class="br0">}</span><span class="sy0">;</span>
        <span class="br0">}</span>
        <span class="kw1">return</span> <span class="br0">{</span> since<span class="sy0">:</span> <span class="kw2">true</span><span class="sy0">,</span> rev<span class="sy0">:</span> Rev.<span class="me1">CXX98</span> <span class="br0">}</span><span class="sy0">;</span>
    <span class="br0">}</span>
&nbsp;
    <span class="kw2">function</span> get_mark_c<span class="br0">(</span>el<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw1">if</span> <span class="br0">(</span>el.<span class="me1">hasClass</span><span class="br0">(</span><span class="st0">'t-since-c99'</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">return</span> <span class="br0">{</span> since<span class="sy0">:</span> <span class="kw2">true</span><span class="sy0">,</span> rev<span class="sy0">:</span> Rev.<span class="me1">C99</span> <span class="br0">}</span><span class="sy0">;</span>
        <span class="br0">}</span>
        <span class="kw1">if</span> <span class="br0">(</span>el.<span class="me1">hasClass</span><span class="br0">(</span><span class="st0">'t-since-c11'</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">return</span> <span class="br0">{</span> since<span class="sy0">:</span> <span class="kw2">true</span><span class="sy0">,</span> rev<span class="sy0">:</span> Rev.<span class="me1">C11</span> <span class="br0">}</span><span class="sy0">;</span>
        <span class="br0">}</span>
        <span class="kw1">if</span> <span class="br0">(</span>el.<span class="me1">hasClass</span><span class="br0">(</span><span class="st0">'t-since-c17'</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">return</span> <span class="br0">{</span> since<span class="sy0">:</span> <span class="kw2">true</span><span class="sy0">,</span> rev<span class="sy0">:</span> Rev.<span class="me1">C17</span> <span class="br0">}</span><span class="sy0">;</span>
        <span class="br0">}</span>
        <span class="kw1">if</span> <span class="br0">(</span>el.<span class="me1">hasClass</span><span class="br0">(</span><span class="st0">'t-since-c23'</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">return</span> <span class="br0">{</span> since<span class="sy0">:</span> <span class="kw2">true</span><span class="sy0">,</span> rev<span class="sy0">:</span> Rev.<span class="me1">C23</span> <span class="br0">}</span><span class="sy0">;</span>
        <span class="br0">}</span>
        <span class="kw1">if</span> <span class="br0">(</span>el.<span class="me1">hasClass</span><span class="br0">(</span><span class="st0">'t-until-c99'</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">return</span> <span class="br0">{</span> since<span class="sy0">:</span> <span class="kw2">false</span><span class="sy0">,</span> rev<span class="sy0">:</span> Rev.<span class="me1">C99</span> <span class="br0">}</span><span class="sy0">;</span>
        <span class="br0">}</span>
        <span class="kw1">if</span> <span class="br0">(</span>el.<span class="me1">hasClass</span><span class="br0">(</span><span class="st0">'t-until-c11'</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">return</span> <span class="br0">{</span> since<span class="sy0">:</span> <span class="kw2">false</span><span class="sy0">,</span> rev<span class="sy0">:</span> Rev.<span class="me1">C11</span> <span class="br0">}</span><span class="sy0">;</span>
        <span class="br0">}</span>
        <span class="kw1">if</span> <span class="br0">(</span>el.<span class="me1">hasClass</span><span class="br0">(</span><span class="st0">'t-until-c17'</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">return</span> <span class="br0">{</span> since<span class="sy0">:</span> <span class="kw2">false</span><span class="sy0">,</span> rev<span class="sy0">:</span> Rev.<span class="me1">C17</span> <span class="br0">}</span><span class="sy0">;</span>
        <span class="br0">}</span>
        <span class="kw1">if</span> <span class="br0">(</span>el.<span class="me1">hasClass</span><span class="br0">(</span><span class="st0">'t-until-c23'</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">return</span> <span class="br0">{</span> since<span class="sy0">:</span> <span class="kw2">false</span><span class="sy0">,</span> rev<span class="sy0">:</span> Rev.<span class="me1">C23</span> <span class="br0">}</span><span class="sy0">;</span>
        <span class="br0">}</span>
        <span class="kw1">return</span> <span class="br0">{</span> since<span class="sy0">:</span> <span class="kw2">true</span><span class="sy0">,</span> rev<span class="sy0">:</span> Rev.<span class="me1">C89</span> <span class="br0">}</span><span class="sy0">;</span>
    <span class="br0">}</span>
&nbsp;
    <span class="coMULTI">/*  This class stores information about what revisions a certain object
        should be shown on. A number of convenience functions are provided.
    */</span>
    <span class="kw2">var</span> VisibilityMap <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>revs<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw1">this</span>.<span class="me1">map</span> <span class="sy0">=</span> <span class="br0">[</span><span class="br0">]</span><span class="sy0">;</span>
&nbsp;
        <span class="co1">// initialize the map to "not shown"</span>
        <span class="kw2">var</span> i<span class="sy0">;</span>
        <span class="kw1">for</span> <span class="br0">(</span>i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> Rev.<span class="me1">LAST</span><span class="sy0">;</span> i<span class="sy0">++</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">this</span>.<span class="me1">map</span>.<span class="me1">push</span><span class="br0">(</span><span class="kw2">false</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="br0">}</span>
&nbsp;
        <span class="kw1">if</span> <span class="br0">(</span><span class="kw1">typeof</span><span class="br0">(</span>revs<span class="br0">)</span> <span class="sy0">!==</span> <span class="st0">'undefined'</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">for</span> <span class="br0">(</span>i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> revs.<span class="me1">length</span><span class="sy0">;</span> i<span class="sy0">++</span><span class="br0">)</span> <span class="br0">{</span>
                <span class="kw1">this</span>.<span class="me1">map</span><span class="br0">[</span>revs<span class="br0">[</span>i<span class="br0">]</span><span class="br0">]</span> <span class="sy0">=</span> <span class="kw2">true</span><span class="sy0">;</span>
            <span class="br0">}</span>
        <span class="br0">}</span>
    <span class="br0">}</span>
&nbsp;
    <span class="co1">// Checks the visibility on the given revision.</span>
    VisibilityMap.<span class="me1">prototype</span>.<span class="me1">is_visible_on</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>rev<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw1">return</span> <span class="kw1">this</span>.<span class="me1">map</span><span class="br0">[</span>rev<span class="br0">]</span><span class="sy0">;</span>
    <span class="br0">}</span>
&nbsp;
    <span class="co1">// Checks whether all revisions are hidden in this visibility map</span>
    VisibilityMap.<span class="me1">prototype</span>.<span class="me1">is_visible_on_none</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
        <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> Rev.<span class="me1">LAST</span><span class="sy0">;</span> i<span class="sy0">++</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">if</span> <span class="br0">(</span><span class="kw1">this</span>.<span class="me1">map</span><span class="br0">[</span>i<span class="br0">]</span> <span class="sy0">===</span> <span class="kw2">true</span><span class="br0">)</span> <span class="br0">{</span>
                <span class="kw1">return</span> <span class="kw2">false</span><span class="sy0">;</span>
            <span class="br0">}</span>
        <span class="br0">}</span>
        <span class="kw1">return</span> <span class="kw2">true</span><span class="sy0">;</span>
    <span class="br0">}</span>
&nbsp;
    <span class="co1">// Checks whether all revisions are shown in this visibility map</span>
    VisibilityMap.<span class="me1">prototype</span>.<span class="me1">is_visible_on_all</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
        <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> Rev.<span class="me1">LAST</span><span class="sy0">;</span> i<span class="sy0">++</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">if</span> <span class="br0">(</span><span class="kw1">this</span>.<span class="me1">map</span><span class="br0">[</span>i<span class="br0">]</span> <span class="sy0">===</span> <span class="kw2">false</span><span class="br0">)</span> <span class="br0">{</span>
                <span class="kw1">return</span> <span class="kw2">false</span><span class="sy0">;</span>
            <span class="br0">}</span>
        <span class="br0">}</span>
        <span class="kw1">return</span> <span class="kw2">true</span><span class="sy0">;</span>
    <span class="br0">}</span>
&nbsp;
    <span class="co1">// Sets the visibility on the given revision to true.</span>
    VisibilityMap.<span class="me1">prototype</span>.<span class="me1">add</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>rev<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw1">this</span>.<span class="me1">map</span><span class="br0">[</span>rev<span class="br0">]</span> <span class="sy0">=</span> <span class="kw2">true</span><span class="sy0">;</span>
    <span class="br0">}</span>
&nbsp;
    <span class="co1">// Sets the visibility on the given revision to true.</span>
    VisibilityMap.<span class="me1">prototype</span>.<span class="me1">remove</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>rev<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw1">this</span>.<span class="me1">map</span><span class="br0">[</span>rev<span class="br0">]</span> <span class="sy0">=</span> <span class="kw2">false</span><span class="sy0">;</span>
    <span class="br0">}</span>
&nbsp;
&nbsp;
    <span class="coMULTI">/*  Fills the visibility map with the given value. After the operation
        map.is_visible_on(rev) == value for all valid revisions.
    */</span>
    VisibilityMap.<span class="me1">prototype</span>.<span class="me1">fill</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>value<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> <span class="kw1">this</span>.<span class="me1">map</span>.<span class="me1">length</span><span class="sy0">;</span> i<span class="sy0">++</span><span class="br0">)</span>
            <span class="kw1">this</span>.<span class="me1">map</span><span class="br0">[</span>i<span class="br0">]</span> <span class="sy0">=</span> value<span class="sy0">;</span>
    <span class="br0">}</span>
&nbsp;
    <span class="kw2">var</span> visibility_fill <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>value<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw2">var</span> ret <span class="sy0">=</span> <span class="kw2">new</span> VisibilityMap<span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
        ret.<span class="me1">fill</span><span class="br0">(</span>value<span class="br0">)</span><span class="sy0">;</span>
        <span class="kw1">return</span> ret<span class="sy0">;</span>
    <span class="br0">}</span>
&nbsp;
    <span class="co1">// Clones the visibility map</span>
    VisibilityMap.<span class="me1">prototype</span>.<span class="me1">clone</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
        <span class="kw2">var</span> ret <span class="sy0">=</span> <span class="kw2">new</span> VisibilityMap<span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
        ret.<span class="me1">map</span> <span class="sy0">=</span> <span class="kw1">this</span>.<span class="me1">map</span>.<span class="me1">slice</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="kw1">return</span> ret<span class="sy0">;</span>
    <span class="br0">}</span>
&nbsp;
    <span class="co1">// Checks whether two visibility maps are equal</span>
    VisibilityMap.<span class="me1">prototype</span>.<span class="me1">equal</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>other<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw1">return</span> array_equal<span class="br0">(</span><span class="kw1">this</span>.<span class="me1">map</span><span class="sy0">,</span> other.<span class="me1">map</span><span class="br0">)</span><span class="sy0">;</span>
    <span class="br0">}</span>
&nbsp;
    <span class="coMULTI">/*  Combines the map with another visibility map. The resulting map
        indicates visibility on particular revision if both argument maps
        indicated so. Returns this.
    */</span>
    VisibilityMap.<span class="me1">prototype</span>.<span class="me1">combine_and</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>map<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> Rev.<span class="me1">LAST</span><span class="sy0">;</span> i<span class="sy0">++</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">this</span>.<span class="me1">map</span><span class="br0">[</span>i<span class="br0">]</span> <span class="sy0">=</span> <span class="kw1">this</span>.<span class="me1">map</span><span class="br0">[</span>i<span class="br0">]</span> <span class="sy0">&amp;&amp;</span> map.<span class="me1">map</span><span class="br0">[</span>i<span class="br0">]</span><span class="sy0">;</span>
        <span class="br0">}</span>
    <span class="br0">}</span>
&nbsp;
    <span class="coMULTI">/*  Combines the map with another visibility map. The resulting map
        indicates visibility on particular revision if either argument maps
        indicated so.
    */</span>
    VisibilityMap.<span class="me1">prototype</span>.<span class="me1">combine_or</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>map<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> Rev.<span class="me1">LAST</span><span class="sy0">;</span> i<span class="sy0">++</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">this</span>.<span class="me1">map</span><span class="br0">[</span>i<span class="br0">]</span> <span class="sy0">=</span> <span class="kw1">this</span>.<span class="me1">map</span><span class="br0">[</span>i<span class="br0">]</span> <span class="sy0">||</span> map.<span class="me1">map</span><span class="br0">[</span>i<span class="br0">]</span><span class="sy0">;</span>
        <span class="br0">}</span>
    <span class="br0">}</span>
&nbsp;
    <span class="co1">// Prints the contents to a string</span>
    VisibilityMap.<span class="me1">prototype</span>.<span class="me1">debug_to_string</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
        <span class="kw2">var</span> out <span class="sy0">=</span> <span class="st0">'{ '</span><span class="sy0">;</span>
        <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> <span class="kw1">this</span>.<span class="me1">map</span>.<span class="me1">length</span><span class="sy0">;</span> i<span class="sy0">++</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">if</span> <span class="br0">(</span><span class="kw1">this</span>.<span class="me1">map</span><span class="br0">[</span>i<span class="br0">]</span><span class="br0">)</span> <span class="br0">{</span>
                out <span class="sy0">+=</span> <span class="st0">'T'</span><span class="sy0">;</span>
            <span class="br0">}</span> <span class="kw1">else</span> <span class="br0">{</span>
                out <span class="sy0">+=</span> <span class="st0">'F'</span><span class="sy0">;</span>
            <span class="br0">}</span>
        <span class="br0">}</span>
        out <span class="sy0">+=</span> <span class="st0">' }'</span><span class="sy0">;</span>
        <span class="kw1">return</span> out<span class="sy0">;</span>
    <span class="br0">}</span>
&nbsp;
    <span class="coMULTI">/*  Given an jQuery object, inspects mark css classes and returns a
        visibility map corresponding to these css classes. Rev.DIFF is not
        included into the returned visibility map.
    */</span>
    <span class="kw2">function</span> get_visibility_map_cxx<span class="br0">(</span>el<span class="br0">)</span> <span class="br0">{</span>
        <span class="co1">// DIFF: 0, CXX98: 1, CXX11: 2, CXX14: 3, CXX17: 4, CXX20: 5, CXX23: 6</span>
        <span class="kw2">var</span> classes_cxx <span class="sy0">=</span> <span class="br0">[</span>
            <span class="br0">{</span> rev<span class="sy0">:</span> Rev.<span class="me1">CXX11</span><span class="sy0">,</span> since<span class="sy0">:</span> <span class="st0">'t-since-cxx11'</span><span class="sy0">,</span> until<span class="sy0">:</span> <span class="st0">'t-until-cxx11'</span> <span class="br0">}</span><span class="sy0">,</span>
            <span class="br0">{</span> rev<span class="sy0">:</span> Rev.<span class="me1">CXX14</span><span class="sy0">,</span> since<span class="sy0">:</span> <span class="st0">'t-since-cxx14'</span><span class="sy0">,</span> until<span class="sy0">:</span> <span class="st0">'t-until-cxx14'</span> <span class="br0">}</span><span class="sy0">,</span>
            <span class="br0">{</span> rev<span class="sy0">:</span> Rev.<span class="me1">CXX17</span><span class="sy0">,</span> since<span class="sy0">:</span> <span class="st0">'t-since-cxx17'</span><span class="sy0">,</span> until<span class="sy0">:</span> <span class="st0">'t-until-cxx17'</span> <span class="br0">}</span><span class="sy0">,</span>
            <span class="br0">{</span> rev<span class="sy0">:</span> Rev.<span class="me1">CXX20</span><span class="sy0">,</span> since<span class="sy0">:</span> <span class="st0">'t-since-cxx20'</span><span class="sy0">,</span> until<span class="sy0">:</span> <span class="st0">'t-until-cxx20'</span> <span class="br0">}</span><span class="sy0">,</span>
            <span class="br0">{</span> rev<span class="sy0">:</span> Rev.<span class="me1">CXX23</span><span class="sy0">,</span> since<span class="sy0">:</span> <span class="st0">'t-since-cxx23'</span><span class="sy0">,</span> until<span class="sy0">:</span> <span class="st0">'t-until-cxx23'</span> <span class="br0">}</span><span class="sy0">,</span>
        <span class="br0">]</span><span class="sy0">;</span>
        <span class="kw2">var</span> map <span class="sy0">=</span> <span class="kw2">new</span> VisibilityMap<span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> classes_cxx.<span class="me1">length</span><span class="sy0">;</span> i<span class="sy0">++</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">if</span> <span class="br0">(</span>el.<span class="me1">hasClass</span><span class="br0">(</span>classes_cxx<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">since</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
                <span class="kw1">break</span><span class="sy0">;</span>
            <span class="br0">}</span>
        <span class="br0">}</span>
        <span class="kw1">if</span> <span class="br0">(</span>i <span class="sy0">===</span> classes_cxx.<span class="me1">length</span><span class="br0">)</span> <span class="br0">{</span>
            map.<span class="me1">add</span><span class="br0">(</span>Rev.<span class="me1">CXX98</span><span class="br0">)</span><span class="sy0">;</span>
            i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>
        <span class="br0">}</span>
        <span class="kw1">for</span> <span class="br0">(</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> classes_cxx.<span class="me1">length</span><span class="sy0">;</span> i<span class="sy0">++</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">if</span> <span class="br0">(</span>el.<span class="me1">hasClass</span><span class="br0">(</span>classes_cxx<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">until</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
                <span class="kw1">break</span><span class="sy0">;</span>
            <span class="br0">}</span>
            map.<span class="me1">add</span><span class="br0">(</span>classes_cxx<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">rev</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="br0">}</span>
        <span class="kw1">return</span> map<span class="sy0">;</span>
    <span class="br0">}</span>
&nbsp;
    <span class="coMULTI">/*  This function is a modified copy of the previous one, adopted for "C".
     *  Space Mission. 2021/10/20.
    */</span>
    <span class="kw2">function</span> get_visibility_map_c<span class="br0">(</span>el<span class="br0">)</span> <span class="br0">{</span>
        <span class="co1">// DIFF: 0, C89: 1, C99: 2, C11: 3, C17: 4, C23: 5</span>
        <span class="kw2">var</span> classes_c <span class="sy0">=</span> <span class="br0">[</span>
            <span class="br0">{</span> rev<span class="sy0">:</span> Rev.<span class="me1">C89</span><span class="sy0">,</span> since<span class="sy0">:</span> <span class="st0">'t-since-c89'</span><span class="sy0">,</span> until<span class="sy0">:</span> <span class="st0">'t-until-c89'</span> <span class="br0">}</span><span class="sy0">,</span>
            <span class="br0">{</span> rev<span class="sy0">:</span> Rev.<span class="me1">C99</span><span class="sy0">,</span> since<span class="sy0">:</span> <span class="st0">'t-since-c99'</span><span class="sy0">,</span> until<span class="sy0">:</span> <span class="st0">'t-until-c99'</span> <span class="br0">}</span><span class="sy0">,</span>
            <span class="br0">{</span> rev<span class="sy0">:</span> Rev.<span class="me1">C11</span><span class="sy0">,</span> since<span class="sy0">:</span> <span class="st0">'t-since-c11'</span><span class="sy0">,</span> until<span class="sy0">:</span> <span class="st0">'t-until-c11'</span> <span class="br0">}</span><span class="sy0">,</span>
            <span class="br0">{</span> rev<span class="sy0">:</span> Rev.<span class="me1">C17</span><span class="sy0">,</span> since<span class="sy0">:</span> <span class="st0">'t-since-c17'</span><span class="sy0">,</span> until<span class="sy0">:</span> <span class="st0">'t-until-c17'</span> <span class="br0">}</span><span class="sy0">,</span>
            <span class="br0">{</span> rev<span class="sy0">:</span> Rev.<span class="me1">C23</span><span class="sy0">,</span> since<span class="sy0">:</span> <span class="st0">'t-since-c23'</span><span class="sy0">,</span> until<span class="sy0">:</span> <span class="st0">'t-until-c23'</span> <span class="br0">}</span><span class="sy0">,</span>
        <span class="br0">]</span><span class="sy0">;</span>
        <span class="kw2">var</span> map <span class="sy0">=</span> <span class="kw2">new</span> VisibilityMap<span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> classes_c.<span class="me1">length</span><span class="sy0">;</span> i<span class="sy0">++</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">if</span> <span class="br0">(</span>el.<span class="me1">hasClass</span><span class="br0">(</span>classes_c<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">since</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
                <span class="kw1">break</span><span class="sy0">;</span>
            <span class="br0">}</span>
        <span class="br0">}</span>
        <span class="kw1">if</span> <span class="br0">(</span>i <span class="sy0">===</span> classes_c.<span class="me1">length</span><span class="br0">)</span> <span class="br0">{</span>
            map.<span class="me1">add</span><span class="br0">(</span>Rev.<span class="me1">C89</span><span class="br0">)</span><span class="sy0">;</span>
            i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>
        <span class="br0">}</span>
        <span class="kw1">for</span> <span class="br0">(</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> classes_c.<span class="me1">length</span><span class="sy0">;</span> i<span class="sy0">++</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">if</span> <span class="br0">(</span>el.<span class="me1">hasClass</span><span class="br0">(</span>classes_c<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">until</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
                <span class="kw1">break</span><span class="sy0">;</span>
            <span class="br0">}</span>
            map.<span class="me1">add</span><span class="br0">(</span>classes_c<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">rev</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="br0">}</span>
        <span class="kw1">return</span> map<span class="sy0">;</span>
    <span class="br0">}</span>
&nbsp;
    <span class="kw2">var</span> get_mark<span class="sy0">,</span> get_visibility_map<span class="sy0">;</span>
&nbsp;
    <span class="kw1">if</span> <span class="br0">(</span>is_cxx<span class="br0">)</span> <span class="br0">{</span>   <span class="co1">// select either C or C++ version</span>
        get_mark <span class="sy0">=</span> get_mark_cxx<span class="sy0">;</span>
        get_visibility_map <span class="sy0">=</span> get_visibility_map_cxx<span class="sy0">;</span>
    <span class="br0">}</span> <span class="kw1">else</span> <span class="br0">{</span>
        get_mark <span class="sy0">=</span> get_mark_c<span class="sy0">;</span>
        get_visibility_map <span class="sy0">=</span> get_visibility_map_c<span class="sy0">;</span>
    <span class="br0">}</span>
&nbsp;
    <span class="coMULTI">/** This class keeps track of objects that need to be shown or hidden for
        specific standard revision.
    */</span>
    <span class="kw2">var</span> ObjectTracker <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
&nbsp;
        <span class="kw1">this</span>.<span class="me1">all_objects</span> <span class="sy0">=</span> <span class="br0">[</span><span class="br0">]</span><span class="sy0">;</span>
        <span class="co1">// jQuery screws up restoring correct display property</span>
        <span class="kw1">this</span>.<span class="me1">all_display</span> <span class="sy0">=</span> <span class="br0">[</span><span class="br0">]</span><span class="sy0">;</span>
&nbsp;
        <span class="kw1">this</span>.<span class="me1">diff_ids</span> <span class="sy0">=</span> <span class="br0">[</span><span class="br0">]</span><span class="sy0">;</span>
        <span class="kw1">this</span>.<span class="me1">curr_rev</span> <span class="sy0">=</span> Rev.<span class="me1">DIFF</span><span class="sy0">;</span>
&nbsp;
        <span class="co1">// Maps revisions to object indexes within this.all_objects.</span>
        <span class="kw1">this</span>.<span class="me1">rev2id_map</span> <span class="sy0">=</span> <span class="br0">[</span><span class="br0">]</span><span class="sy0">;</span>
        <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> Rev.<span class="me1">LAST</span><span class="sy0">;</span> <span class="sy0">++</span>i<span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">this</span>.<span class="me1">rev2id_map</span><span class="br0">[</span>i<span class="br0">]</span> <span class="sy0">=</span> <span class="br0">[</span><span class="br0">]</span><span class="sy0">;</span>
        <span class="br0">}</span>
    <span class="br0">}</span>
&nbsp;
    <span class="coMULTI">/** Adds a jQuery object @a obj that should be shown only on specific
        revisions identified by @a revs. @a orig_obj is used to compute the
        display property that should be set to the object when the visibility
        is restored.
    */</span>
    ObjectTracker.<span class="me1">prototype</span>.<span class="me1">add_object</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>obj<span class="sy0">,</span> orig_obj<span class="sy0">,</span> visibility_map<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw2">var</span> id <span class="sy0">=</span> <span class="kw1">this</span>.<span class="me1">all_objects</span>.<span class="me1">length</span><span class="sy0">;</span>
        <span class="kw1">this</span>.<span class="me1">all_objects</span><span class="br0">[</span>id<span class="br0">]</span> <span class="sy0">=</span> obj<span class="sy0">;</span>
        <span class="kw1">this</span>.<span class="me1">all_display</span><span class="br0">[</span>id<span class="br0">]</span> <span class="sy0">=</span> orig_obj.<span class="me1">css</span><span class="br0">(</span><span class="st0">'display'</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
        <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> rev <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> rev <span class="sy0">&lt;</span> Rev.<span class="me1">LAST</span><span class="sy0">;</span> rev<span class="sy0">++</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">if</span> <span class="br0">(</span>visibility_map.<span class="me1">is_visible_on</span><span class="br0">(</span>rev<span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
                <span class="kw1">this</span>.<span class="me1">rev2id_map</span><span class="br0">[</span>rev<span class="br0">]</span>.<span class="me1">push</span><span class="br0">(</span>id<span class="br0">)</span><span class="sy0">;</span>
            <span class="br0">}</span>
        <span class="br0">}</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="co1">// Same as add_object except that obj is used to compute the display</span>
    <span class="co1">// property. The object must be already attached to DOM.</span>
    ObjectTracker.<span class="me1">prototype</span>.<span class="me1">add_diff_object</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>obj<span class="sy0">,</span> visibility_map<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw1">this</span>.<span class="me1">add_object</span><span class="br0">(</span>obj<span class="sy0">,</span> obj<span class="sy0">,</span> visibility_map<span class="br0">)</span><span class="sy0">;</span>
    <span class="br0">}</span>
&nbsp;
    <span class="coMULTI">/*  Changes the visibility of objects to what it should be at the given
        revision rev.
    */</span>
    ObjectTracker.<span class="me1">prototype</span>.<span class="me1">to_rev</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>rev<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw1">if</span> <span class="br0">(</span>rev <span class="sy0">===</span> <span class="kw1">this</span>.<span class="me1">curr_rev</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">return</span><span class="sy0">;</span>
        <span class="br0">}</span>
        <span class="kw2">var</span> visible_before <span class="sy0">=</span> <span class="kw1">this</span>.<span class="me1">rev2id_map</span><span class="br0">[</span><span class="kw1">this</span>.<span class="me1">curr_rev</span><span class="br0">]</span><span class="sy0">;</span>
        <span class="kw2">var</span> visible_after <span class="sy0">=</span> <span class="kw1">this</span>.<span class="me1">rev2id_map</span><span class="br0">[</span>rev<span class="br0">]</span><span class="sy0">;</span>
&nbsp;
        <span class="kw2">var</span> i<span class="sy0">,</span> curr<span class="sy0">;</span>
        <span class="kw1">for</span> <span class="br0">(</span>i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> visible_before.<span class="me1">length</span><span class="sy0">;</span> <span class="sy0">++</span>i<span class="br0">)</span> <span class="br0">{</span>
            curr <span class="sy0">=</span> visible_before<span class="br0">[</span>i<span class="br0">]</span><span class="sy0">;</span>
            <span class="kw1">if</span> <span class="br0">(</span>$.<span class="me1">inArray</span><span class="br0">(</span>curr<span class="sy0">,</span> visible_after<span class="br0">)</span> <span class="sy0">===</span> <span class="sy0">-</span><span class="nu0">1</span><span class="br0">)</span> <span class="br0">{</span>
                <span class="kw1">this</span>.<span class="me1">all_objects</span><span class="br0">[</span>curr<span class="br0">]</span>.<span class="me1">css</span><span class="br0">(</span><span class="st0">'display'</span><span class="sy0">,</span> <span class="st0">'none'</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="br0">}</span>
        <span class="br0">}</span>
        <span class="kw1">for</span> <span class="br0">(</span>i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> visible_after.<span class="me1">length</span><span class="sy0">;</span> <span class="sy0">++</span>i<span class="br0">)</span> <span class="br0">{</span>
            curr <span class="sy0">=</span> visible_after<span class="br0">[</span>i<span class="br0">]</span><span class="sy0">;</span>
            <span class="kw1">if</span> <span class="br0">(</span>$.<span class="me1">inArray</span><span class="br0">(</span>curr<span class="sy0">,</span> visible_before<span class="br0">)</span> <span class="sy0">===</span> <span class="sy0">-</span><span class="nu0">1</span><span class="br0">)</span> <span class="br0">{</span>
                <span class="kw1">this</span>.<span class="me1">all_objects</span><span class="br0">[</span>curr<span class="br0">]</span>.<span class="me1">css</span><span class="br0">(</span><span class="st0">'display'</span><span class="sy0">,</span> <span class="kw1">this</span>.<span class="me1">all_display</span><span class="br0">[</span>curr<span class="br0">]</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="br0">}</span>
        <span class="br0">}</span>
        <span class="kw1">this</span>.<span class="me1">curr_rev</span> <span class="sy0">=</span> rev<span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="coMULTI">/*  This class tracks object visibility throughout the section hierarchy.
        For example, when section contents are not visible on a certain
        revision, then related visual objects such as section title are hidden
        too.
&nbsp;
        In the context of this class, visual objects can be of one of the
        following four kinds: primary, secondary, unknown and container. A
        visual object is a certain DOM node in the tree. Section boundaries
        and hierarchy has no relation to the DOM hierarchy.
&nbsp;
            Primary
&nbsp;
        Primary objects define the visibility of the whole section the objects
        are in. If all primary and unknown objects are not visible, the whole
        section is hidden. The reason why unknown objects affect the visibility
        of sections is that we want to be conservative and if we can't
        determine the kind of an object, better treat it as primary.
&nbsp;
        Primary objects do not contain other objects.
&nbsp;
            Secondary
&nbsp;
        Secondary objects don't affect the visibility of sections. Secondary
        objects do not contain other objects.
&nbsp;
            Container
&nbsp;
        Container objects contain other visual objects and add some visual
        "effect" such as padding, so that in order to hide the presence
        of the contained objects completely, the container must be hidden too.
&nbsp;
            Unknown
&nbsp;
        Unknown objects are those objects for which any other kind was not
        defined. They are treated the same way as primary objects.
&nbsp;
        Unknown objects do not contain other objects.
&nbsp;
&nbsp;
        When all primary and unknown elements within a section are not visible
        in certain revision, then all secondary elements are hidden too. The
        process is repeated throughout entire section hierarchy.
&nbsp;
        The section hierarchy tree is built by specifying hierarchy level via
        set_level() and adding elements via add_*() functions. Hierarchy levels
        are identified by ascending integer numbers. Container objects are set
        independently via enter_container() and exit_container() functions -
        these functions effectively form a parallel hierarchy.
    */</span>
    <span class="kw2">var</span> SectionContentsTracker <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
        <span class="kw1">this</span>.<span class="me1">root_section</span> <span class="sy0">=</span> <span class="kw2">new</span> SectionNode<span class="br0">(</span><span class="kw2">null</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="kw1">this</span>.<span class="me1">root_container</span> <span class="sy0">=</span> <span class="kw2">new</span> ContainerNode<span class="br0">(</span><span class="kw2">null</span><span class="sy0">,</span> <span class="kw2">null</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="kw1">this</span>.<span class="me1">curr_section</span> <span class="sy0">=</span> <span class="kw1">this</span>.<span class="me1">root_section</span><span class="sy0">;</span>
        <span class="kw1">this</span>.<span class="me1">curr_container</span> <span class="sy0">=</span> <span class="kw1">this</span>.<span class="me1">root_container</span><span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="kw2">var</span> ObjectType <span class="sy0">=</span> <span class="br0">{</span>
        PRIMARY <span class="sy0">:</span> <span class="nu0">0</span><span class="sy0">,</span>
        SECONDARY <span class="sy0">:</span> <span class="nu0">1</span><span class="sy0">,</span>
        UNKNOWN <span class="sy0">:</span> <span class="nu0">2</span><span class="sy0">,</span>
        SECTION <span class="sy0">:</span> <span class="nu0">3</span><span class="sy0">,</span>
        CONTAINER <span class="sy0">:</span> <span class="nu0">4</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="co1">// internal classes for SectionContentsTracker</span>
    <span class="kw2">var</span> ObjectNode <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>parent_section<span class="sy0">,</span> parent_container<span class="sy0">,</span> type<span class="sy0">,</span> obj<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw1">this</span>.<span class="me1">parent_section</span> <span class="sy0">=</span> parent_section<span class="sy0">;</span>
        <span class="kw1">this</span>.<span class="me1">parent_container</span> <span class="sy0">=</span> parent_container<span class="sy0">;</span>
        <span class="kw1">this</span>.<span class="me1">level</span> <span class="sy0">=</span> parent_section.<span class="me1">level</span> <span class="sy0">+</span> <span class="nu0">1</span><span class="sy0">;</span>
        <span class="kw1">this</span>.<span class="me1">children</span> <span class="sy0">=</span> <span class="kw2">null</span><span class="sy0">;</span>
        <span class="kw1">this</span>.<span class="me1">obj</span> <span class="sy0">=</span> obj<span class="sy0">;</span>
        <span class="kw1">this</span>.<span class="me1">type</span> <span class="sy0">=</span> type<span class="sy0">;</span>
        <span class="kw1">this</span>.<span class="me1">visible</span> <span class="sy0">=</span> <span class="kw2">null</span><span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="co1">// Creates a section node given a parent node. For root section parent</span>
    <span class="co1">// should be null. The level of the created section is determined</span>
    <span class="co1">// automatically from the level of the parent section.</span>
    <span class="kw2">var</span> SectionNode <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>parent<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw1">this</span>.<span class="me1">parent_section</span> <span class="sy0">=</span> parent<span class="sy0">;</span>
        <span class="kw1">if</span> <span class="br0">(</span>parent <span class="sy0">===</span> <span class="kw2">null</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">this</span>.<span class="me1">level</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>
        <span class="br0">}</span> <span class="kw1">else</span> <span class="br0">{</span>
            <span class="kw1">this</span>.<span class="me1">level</span> <span class="sy0">=</span> <span class="kw1">this</span>.<span class="me1">parent_section</span>.<span class="me1">level</span> <span class="sy0">+</span> <span class="nu0">1</span><span class="sy0">;</span>
        <span class="br0">}</span>
        <span class="kw1">this</span>.<span class="me1">children</span> <span class="sy0">=</span> <span class="br0">[</span><span class="br0">]</span><span class="sy0">;</span>
        <span class="kw1">this</span>.<span class="me1">obj</span> <span class="sy0">=</span> <span class="kw2">null</span><span class="sy0">;</span>
        <span class="kw1">this</span>.<span class="me1">type</span> <span class="sy0">=</span> ObjectType.<span class="me1">SECTION</span><span class="sy0">;</span>
        <span class="kw1">this</span>.<span class="me1">visible</span> <span class="sy0">=</span> <span class="kw2">null</span><span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="co1">// Creates a container node given a parent container and the jQuery object</span>
    <span class="co1">// representing the object. For root container parent should be null.</span>
    <span class="kw2">var</span> ContainerNode <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>parent<span class="sy0">,</span> obj<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw1">this</span>.<span class="me1">parent_container</span> <span class="sy0">=</span> parent<span class="sy0">;</span>
        <span class="kw1">this</span>.<span class="me1">children</span> <span class="sy0">=</span> <span class="br0">[</span><span class="br0">]</span><span class="sy0">;</span>
        <span class="kw1">this</span>.<span class="me1">obj</span> <span class="sy0">=</span> obj<span class="sy0">;</span>
        <span class="kw1">this</span>.<span class="me1">type</span> <span class="sy0">=</span> ObjectType.<span class="me1">CONTAINER</span><span class="sy0">;</span>
        <span class="kw1">this</span>.<span class="me1">visible</span> <span class="sy0">=</span> <span class="kw2">null</span><span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="coMULTI">/*  Walks the internal section hierarchy tree to the specified level. If
        level is higher than current level, then new section nodes are created as
        descendants of the current section node. If the current level is the
        same, a new node is created.
&nbsp;
        Sections are portions of the html tree delimited by the heading
        elements (&lt;h1&gt;, &lt;h2&gt;, etc.)
    */</span>
    SectionContentsTracker.<span class="me1">prototype</span>.<span class="me1">set_level</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>level<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw1">if</span> <span class="br0">(</span>level <span class="sy0">&lt;</span> <span class="nu0">0</span><span class="br0">)</span> <span class="br0">{</span>
            console.<span class="me1">log</span><span class="br0">(</span><span class="st0">"Level must be positive"</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="kw1">return</span><span class="sy0">;</span>
        <span class="br0">}</span>
&nbsp;
        <span class="kw1">while</span> <span class="br0">(</span><span class="kw1">this</span>.<span class="me1">curr_section</span>.<span class="me1">level</span> <span class="sy0">&gt;=</span> level <span class="sy0">&amp;&amp;</span> <span class="kw1">this</span>.<span class="me1">curr_section</span>.<span class="me1">level</span> <span class="sy0">&gt;</span> <span class="nu0">0</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">this</span>.<span class="me1">curr_section</span> <span class="sy0">=</span> <span class="kw1">this</span>.<span class="me1">curr_section</span>.<span class="me1">parent_section</span><span class="sy0">;</span>
        <span class="br0">}</span>
        <span class="kw1">while</span> <span class="br0">(</span><span class="kw1">this</span>.<span class="me1">curr_section</span>.<span class="me1">level</span> <span class="sy0">&lt;</span> level<span class="br0">)</span> <span class="br0">{</span>
            <span class="kw2">var</span> new_section <span class="sy0">=</span> <span class="kw2">new</span> SectionNode<span class="br0">(</span><span class="kw1">this</span>.<span class="me1">curr_section</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="kw1">this</span>.<span class="me1">curr_section</span>.<span class="me1">children</span>.<span class="me1">push</span><span class="br0">(</span>new_section<span class="br0">)</span><span class="sy0">;</span>
            <span class="kw1">this</span>.<span class="me1">curr_section</span> <span class="sy0">=</span> new_section<span class="sy0">;</span>
        <span class="br0">}</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="coMULTI">/*  Adds an jQuery object to the current section and container. type is the
        kind of the object and visible is the visibility map. Don't use this
        method, use add_primary, add_secondary and add_unknown instead
    */</span>
    SectionContentsTracker.<span class="me1">prototype</span>.<span class="me1">add_object</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>obj<span class="sy0">,</span> type<span class="sy0">,</span> visible<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw2">var</span> new_node <span class="sy0">=</span> <span class="kw2">new</span> ObjectNode<span class="br0">(</span><span class="kw1">this</span>.<span class="me1">curr_section</span><span class="sy0">,</span> <span class="kw1">this</span>.<span class="me1">curr_container</span><span class="sy0">,</span> type<span class="sy0">,</span> obj<span class="br0">)</span><span class="sy0">;</span>
        new_node.<span class="me1">visible</span> <span class="sy0">=</span> visible<span class="sy0">;</span>
        <span class="kw1">this</span>.<span class="me1">curr_section</span>.<span class="me1">children</span>.<span class="me1">push</span><span class="br0">(</span>new_node<span class="br0">)</span><span class="sy0">;</span>
        <span class="kw1">this</span>.<span class="me1">curr_container</span>.<span class="me1">children</span>.<span class="me1">push</span><span class="br0">(</span>new_node<span class="br0">)</span><span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="co1">// Adds a primary object to the current section and container with the</span>
    <span class="co1">// given visibility map.</span>
    SectionContentsTracker.<span class="me1">prototype</span>.<span class="me1">add_primary</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>obj<span class="sy0">,</span> visible<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw1">this</span>.<span class="me1">add_object</span><span class="br0">(</span>obj<span class="sy0">,</span> ObjectType.<span class="me1">PRIMARY</span><span class="sy0">,</span> visible<span class="br0">)</span><span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="co1">// Adds a secondary object to the current section and container</span>
    SectionContentsTracker.<span class="me1">prototype</span>.<span class="me1">add_secondary</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>obj<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw1">this</span>.<span class="me1">add_object</span><span class="br0">(</span>obj<span class="sy0">,</span> ObjectType.<span class="me1">SECONDARY</span><span class="sy0">,</span> <span class="kw2">null</span><span class="br0">)</span><span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="co1">// Adds an unknown object to the current section and container</span>
    SectionContentsTracker.<span class="me1">prototype</span>.<span class="me1">add_unknown</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>obj<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw1">this</span>.<span class="me1">add_object</span><span class="br0">(</span>obj<span class="sy0">,</span> ObjectType.<span class="me1">UNKNOWN</span><span class="sy0">,</span> visibility_fill<span class="br0">(</span><span class="kw2">true</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="co1">// Interprets a given object as a container and "enters" it. From this call</span>
    <span class="co1">// until call to exit_container, all added objects are added as descendants</span>
    <span class="co1">// of this container. Multiple containers may be nested.</span>
    SectionContentsTracker.<span class="me1">prototype</span>.<span class="me1">enter_container</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>obj<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw2">var</span> new_node <span class="sy0">=</span> <span class="kw2">new</span> ContainerNode<span class="br0">(</span><span class="kw1">this</span>.<span class="me1">curr_container</span><span class="sy0">,</span> obj<span class="br0">)</span><span class="sy0">;</span>
        <span class="kw1">this</span>.<span class="me1">curr_container</span>.<span class="me1">children</span>.<span class="me1">push</span><span class="br0">(</span>new_node<span class="br0">)</span><span class="sy0">;</span>
        <span class="kw1">this</span>.<span class="me1">curr_container</span> <span class="sy0">=</span> new_node<span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    SectionContentsTracker.<span class="me1">prototype</span>.<span class="me1">exit_container</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
        <span class="kw1">this</span>.<span class="me1">curr_container</span> <span class="sy0">=</span> <span class="kw1">this</span>.<span class="me1">curr_container</span>.<span class="me1">parent_container</span><span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="co1">// Recursively evaluates visibility of a section object</span>
    SectionContentsTracker.<span class="me1">prototype</span>.<span class="me1">eval_section_visibility</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>obj<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw2">var</span> visible <span class="sy0">=</span> <span class="kw2">new</span> VisibilityMap<span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="kw2">var</span> i<span class="sy0">,</span> child<span class="sy0">;</span>
        <span class="kw1">for</span> <span class="br0">(</span>i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> obj.<span class="me1">children</span>.<span class="me1">length</span><span class="sy0">;</span> i<span class="sy0">++</span><span class="br0">)</span> <span class="br0">{</span>
            child <span class="sy0">=</span> obj.<span class="me1">children</span><span class="br0">[</span>i<span class="br0">]</span><span class="sy0">;</span>
            <span class="kw1">switch</span> <span class="br0">(</span>child.<span class="me1">type</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">case</span> ObjectType.<span class="me1">PRIMARY</span><span class="sy0">:</span>
            <span class="kw1">case</span> ObjectType.<span class="me1">UNKNOWN</span><span class="sy0">:</span>
                visible.<span class="me1">combine_or</span><span class="br0">(</span>child.<span class="me1">visible</span><span class="br0">)</span><span class="sy0">;</span>
                <span class="kw1">break</span><span class="sy0">;</span>
            <span class="kw1">case</span> ObjectType.<span class="me1">SECONDARY</span><span class="sy0">:</span> <span class="co1">// ignoring secondary objects</span>
                <span class="kw1">break</span><span class="sy0">;</span>
            <span class="kw1">case</span> ObjectType.<span class="me1">SECTION</span><span class="sy0">:</span>
                visible.<span class="me1">combine_or</span><span class="br0">(</span><span class="kw1">this</span>.<span class="me1">eval_section_visibility</span><span class="br0">(</span>child<span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
                <span class="kw1">break</span><span class="sy0">;</span>
            <span class="br0">}</span>
        <span class="br0">}</span>
&nbsp;
        <span class="kw1">for</span> <span class="br0">(</span>i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> obj.<span class="me1">children</span>.<span class="me1">length</span><span class="sy0">;</span> i<span class="sy0">++</span><span class="br0">)</span> <span class="br0">{</span>
            child <span class="sy0">=</span> obj.<span class="me1">children</span><span class="br0">[</span>i<span class="br0">]</span><span class="sy0">;</span>
            <span class="kw1">if</span> <span class="br0">(</span>child.<span class="me1">type</span> <span class="sy0">===</span> ObjectType.<span class="me1">SECONDARY</span><span class="br0">)</span> <span class="br0">{</span>
                child.<span class="me1">visible</span> <span class="sy0">=</span> visible<span class="sy0">;</span>
            <span class="br0">}</span>
        <span class="br0">}</span>
&nbsp;
        obj.<span class="me1">visible</span> <span class="sy0">=</span> visible<span class="sy0">;</span>
        <span class="kw1">return</span> visible<span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="co1">// Recursively evaluates visibility of container objects. Assumes that</span>
    <span class="co1">// visibility of secondary objects is already set</span>
    SectionContentsTracker.<span class="me1">prototype</span>.<span class="me1">eval_container_visibility</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>obj<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw2">var</span> visible <span class="sy0">=</span> <span class="kw2">new</span> VisibilityMap<span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> obj.<span class="me1">children</span>.<span class="me1">length</span><span class="sy0">;</span> i<span class="sy0">++</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw2">var</span> child <span class="sy0">=</span> obj.<span class="me1">children</span><span class="br0">[</span>i<span class="br0">]</span><span class="sy0">;</span>
            <span class="kw1">if</span> <span class="br0">(</span>child.<span class="me1">type</span> <span class="sy0">===</span> ObjectType.<span class="me1">CONTAINER</span><span class="br0">)</span> <span class="br0">{</span>
                visible.<span class="me1">combine_or</span><span class="br0">(</span><span class="kw1">this</span>.<span class="me1">eval_container_visibility</span><span class="br0">(</span>child<span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="br0">}</span> <span class="kw1">else</span> <span class="br0">{</span>
                visible.<span class="me1">combine_or</span><span class="br0">(</span>child.<span class="me1">visible</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="br0">}</span>
        <span class="br0">}</span>
        obj.<span class="me1">visible</span> <span class="sy0">=</span> visible<span class="sy0">;</span>
        <span class="kw1">return</span> visible<span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="coMULTI">/*  Checks if the object needs to be hidden in any revisions identified in
        mask and if yes, performs the hide operation. visible_mask is a
        visibility map. Returns the visibility of the object ANDed with the mask.
    */</span>
    SectionContentsTracker.<span class="me1">prototype</span>.<span class="me1">perform_hide_obj</span> <span class="sy0">=</span>  <span class="kw2">function</span><span class="br0">(</span>obj<span class="sy0">,</span> tracker<span class="sy0">,</span> visible_mask<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw2">var</span> wanted_visible <span class="sy0">=</span> obj.<span class="me1">visible</span>.<span class="me1">clone</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
        wanted_visible.<span class="me1">combine_and</span><span class="br0">(</span>visible_mask<span class="br0">)</span><span class="sy0">;</span>
        <span class="kw1">if</span> <span class="br0">(</span><span class="sy0">!</span>wanted_visible.<span class="me1">equal</span><span class="br0">(</span>visible_mask<span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
            tracker.<span class="me1">add_diff_object</span><span class="br0">(</span>obj.<span class="me1">obj</span><span class="sy0">,</span> wanted_visible<span class="br0">)</span><span class="sy0">;</span>
            <span class="kw1">return</span> wanted_visible<span class="sy0">;</span>
        <span class="br0">}</span>
        <span class="kw1">return</span> visible_mask<span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="co1">// Recursively evaluates the contents of a container and hides container</span>
    <span class="co1">// and secondary elements if needed. visible_mask identifies which</span>
    <span class="co1">// revisions the object may be visible in certain revision (it may not be</span>
    <span class="co1">// visible in case parent container is not visible).</span>
    SectionContentsTracker.<span class="me1">prototype</span>.<span class="me1">perform_hide</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>obj<span class="sy0">,</span> tracker<span class="sy0">,</span> visible_mask<span class="br0">)</span> <span class="br0">{</span>
        <span class="co1">// handle visibility of the container</span>
        <span class="kw1">if</span> <span class="br0">(</span>obj <span class="sy0">!==</span> <span class="kw1">this</span>.<span class="me1">root_container</span><span class="br0">)</span> <span class="br0">{</span>
            visible_mask <span class="sy0">=</span> <span class="kw1">this</span>.<span class="me1">perform_hide_obj</span><span class="br0">(</span>obj<span class="sy0">,</span> tracker<span class="sy0">,</span> visible_mask<span class="br0">)</span><span class="sy0">;</span>
        <span class="br0">}</span>
&nbsp;
        <span class="co1">// handle visibility of contents</span>
        <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> obj.<span class="me1">children</span>.<span class="me1">length</span><span class="sy0">;</span> <span class="sy0">++</span>i<span class="br0">)</span> <span class="br0">{</span>
            <span class="kw2">var</span> child <span class="sy0">=</span> obj.<span class="me1">children</span><span class="br0">[</span>i<span class="br0">]</span><span class="sy0">;</span>
            <span class="kw1">switch</span> <span class="br0">(</span>child.<span class="me1">type</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">case</span> ObjectType.<span class="me1">CONTAINER</span><span class="sy0">:</span>
                <span class="kw1">this</span>.<span class="me1">perform_hide</span><span class="br0">(</span>child<span class="sy0">,</span> tracker<span class="sy0">,</span> visible_mask<span class="br0">)</span><span class="sy0">;</span>
                <span class="kw1">break</span><span class="sy0">;</span>
            <span class="kw1">case</span> ObjectType.<span class="me1">SECONDARY</span><span class="sy0">:</span>
                <span class="kw1">this</span>.<span class="me1">perform_hide_obj</span><span class="br0">(</span>child<span class="sy0">,</span> tracker<span class="sy0">,</span> visible_mask<span class="br0">)</span><span class="sy0">;</span>
                <span class="kw1">break</span><span class="sy0">;</span>
            <span class="br0">}</span>
        <span class="br0">}</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    SectionContentsTracker.<span class="me1">prototype</span>.<span class="me1">run</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>tracker<span class="br0">)</span> <span class="br0">{</span>
        <span class="co1">// evaluate visibility of sections and containers</span>
        <span class="kw1">this</span>.<span class="me1">eval_section_visibility</span><span class="br0">(</span><span class="kw1">this</span>.<span class="me1">root_section</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="kw1">this</span>.<span class="me1">eval_container_visibility</span><span class="br0">(</span><span class="kw1">this</span>.<span class="me1">root_container</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
        <span class="kw1">this</span>.<span class="me1">perform_hide</span><span class="br0">(</span><span class="kw1">this</span>.<span class="me1">root_container</span><span class="sy0">,</span> tracker<span class="sy0">,</span> visibility_fill<span class="br0">(</span><span class="kw2">true</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="coMULTI">/*  Used to aggregate a set of objects that need to be versioned. The set
        may be created from objects only in certain part of the DOM tree, this
        allows to perform independent versioning execution in different parts
        of the page.
&nbsp;
        This is used for example to support inclusions of Template:member. It
        almost always contains a separate set declaration and description lists
        whose numbering needs to be versioned separately.
    */</span>
    <span class="kw2">var</span> Scope <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>root<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw1">this</span>.<span class="me1">root</span> <span class="sy0">=</span> root<span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="coMULTI">/** Creates a new scope and initializes it with the objects gathered from
        the given jQuery object. Returns the new scope.
    */</span>
    Scope.<span class="me1">create_root</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>obj<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw2">var</span> scope <span class="sy0">=</span> <span class="kw2">new</span> Scope<span class="br0">(</span>obj<span class="br0">)</span><span class="sy0">;</span>
        scope.<span class="me1">nv</span> <span class="sy0">=</span> scope.<span class="me1">root</span>.<span class="me1">find</span><span class="br0">(</span><span class="st0">'.t-navbar'</span><span class="br0">)</span><span class="sy0">;</span>
        scope.<span class="me1">dcl_tables</span> <span class="sy0">=</span> scope.<span class="me1">root</span>.<span class="me1">find</span><span class="br0">(</span><span class="st0">'.t-dcl-begin'</span><span class="br0">)</span><span class="sy0">;</span>
        scope.<span class="me1">dcl_rev_tables</span> <span class="sy0">=</span> scope.<span class="me1">dcl_tables</span>.<span class="me1">filter</span><span class="br0">(</span><span class="st0">'.t-dcl-rev-begin'</span><span class="br0">)</span><span class="sy0">;</span>
        scope.<span class="me1">dsc_tables</span> <span class="sy0">=</span> scope.<span class="me1">root</span>.<span class="me1">find</span><span class="br0">(</span><span class="st0">'.t-dsc-begin'</span><span class="br0">)</span><span class="sy0">;</span>
        scope.<span class="me1">rev_tables</span> <span class="sy0">=</span> scope.<span class="me1">root</span>.<span class="me1">find</span><span class="br0">(</span><span class="st0">'.t-rev-begin'</span><span class="br0">)</span><span class="sy0">;</span>
        scope.<span class="me1">rev_inl_tables</span> <span class="sy0">=</span> scope.<span class="me1">root</span>.<span class="me1">find</span><span class="br0">(</span><span class="st0">'.t-rev-inl'</span><span class="br0">)</span><span class="sy0">;</span>
        scope.<span class="me1">list_items</span> <span class="sy0">=</span> scope.<span class="me1">root</span>.<span class="me1">find</span><span class="br0">(</span><span class="st0">'.t-li1'</span><span class="br0">)</span><span class="sy0">;</span>
        scope.<span class="me1">list_items</span>.<span class="me1">add</span><span class="br0">(</span>scope.<span class="me1">root</span>.<span class="me1">find</span><span class="br0">(</span><span class="st0">'.t-li2'</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
        scope.<span class="me1">list_items</span>.<span class="me1">add</span><span class="br0">(</span>scope.<span class="me1">root</span>.<span class="me1">find</span><span class="br0">(</span><span class="st0">'.t-li3'</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="kw1">return</span> scope<span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="coMULTI">/** Given two scopes: parent scope and child scope, moves the elements
        contained within jQuery object in parent_scope[prop] to
        child_scope[prop] whenever they have child_scope.root as parent.
    */</span>
    Scope.<span class="me1">split_scope</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>parent_scope<span class="sy0">,</span> child_scope<span class="sy0">,</span> prop<span class="br0">)</span> <span class="br0">{</span>
&nbsp;
        <span class="co1">// get elements to move</span>
        <span class="kw2">var</span> to_move <span class="sy0">=</span> parent_scope<span class="br0">[</span>prop<span class="br0">]</span>.<span class="me1">filter</span><span class="br0">(</span><span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">return</span> $.<span class="me1">contains</span><span class="br0">(</span>child_scope.<span class="me1">root</span><span class="br0">[</span><span class="nu0">0</span><span class="br0">]</span><span class="sy0">,</span> <span class="kw1">this</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
        <span class="co1">// remove elements from parent and add to child</span>
        parent_scope<span class="br0">[</span>prop<span class="br0">]</span> <span class="sy0">=</span> parent_scope<span class="br0">[</span>prop<span class="br0">]</span>.<span class="me1">not</span><span class="br0">(</span>to_move<span class="br0">)</span><span class="sy0">;</span>
        child_scope<span class="br0">[</span>prop<span class="br0">]</span> <span class="sy0">=</span> to_move<span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="coMULTI">/** Creates a new scope and initializes it with the objects from the given
        parent scope that also have the given jQuery object obj as parent. The
        filtered objects are removed from the parent scope. The function returns
        the new scope.
    */</span>
    Scope.<span class="me1">create_child</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>parent<span class="sy0">,</span> obj<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw2">var</span> scope <span class="sy0">=</span> <span class="kw2">new</span> Scope<span class="br0">(</span>obj<span class="br0">)</span><span class="sy0">;</span>
        Scope.<span class="me1">split_scope</span><span class="br0">(</span>parent<span class="sy0">,</span> scope<span class="sy0">,</span> <span class="st0">'nv'</span><span class="br0">)</span><span class="sy0">;</span>
        Scope.<span class="me1">split_scope</span><span class="br0">(</span>parent<span class="sy0">,</span> scope<span class="sy0">,</span> <span class="st0">'dcl_tables'</span><span class="br0">)</span><span class="sy0">;</span>
        Scope.<span class="me1">split_scope</span><span class="br0">(</span>parent<span class="sy0">,</span> scope<span class="sy0">,</span> <span class="st0">'dcl_rev_tables'</span><span class="br0">)</span><span class="sy0">;</span>
        Scope.<span class="me1">split_scope</span><span class="br0">(</span>parent<span class="sy0">,</span> scope<span class="sy0">,</span> <span class="st0">'dsc_tables'</span><span class="br0">)</span><span class="sy0">;</span>
        Scope.<span class="me1">split_scope</span><span class="br0">(</span>parent<span class="sy0">,</span> scope<span class="sy0">,</span> <span class="st0">'rev_tables'</span><span class="br0">)</span><span class="sy0">;</span>
        Scope.<span class="me1">split_scope</span><span class="br0">(</span>parent<span class="sy0">,</span> scope<span class="sy0">,</span> <span class="st0">'rev_inl_tables'</span><span class="br0">)</span><span class="sy0">;</span>
        Scope.<span class="me1">split_scope</span><span class="br0">(</span>parent<span class="sy0">,</span> scope<span class="sy0">,</span> <span class="st0">'list_items'</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="kw1">return</span> scope<span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="kw2">var</span> StandardRevisionPlugin <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
        <span class="kw1">this</span>.<span class="me1">curr_rev</span> <span class="sy0">=</span> Rev.<span class="me1">DIFF</span><span class="sy0">;</span>
&nbsp;
        <span class="kw1">this</span>.<span class="me1">tracker</span> <span class="sy0">=</span> <span class="kw2">new</span> ObjectTracker<span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="kw1">this</span>.<span class="me1">is_prepared</span> <span class="sy0">=</span> <span class="kw2">false</span><span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="coMULTI">/*  Prepares the navbar for versioning using object tracker. As the navbar
        contains many items and we might want to reflow the columns in the
        future, instead of committing each item to the object tracker we make
        as many copies of the original navbar as there needed, customize each
        copy in-place and commit the results to the object tracker. This gives
        us both performance and flexibility benefits.
    */</span>
    StandardRevisionPlugin.<span class="me1">prototype</span>.<span class="me1">prepare_navbar</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>scope<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw2">var</span> nv <span class="sy0">=</span> scope.<span class="me1">nv</span> <span class="co1">// main navbar</span>
        <span class="kw1">if</span> <span class="br0">(</span>nv.<span class="me1">length</span> <span class="sy0">===</span> <span class="nu0">0</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">return</span><span class="sy0">;</span> <span class="co1">// no navbar</span>
        <span class="br0">}</span>
&nbsp;
        <span class="kw1">this</span>.<span class="me1">tracker</span>.<span class="me1">add_diff_object</span><span class="br0">(</span>nv<span class="sy0">,</span> <span class="kw2">new</span> VisibilityMap<span class="br0">(</span><span class="br0">[</span>Rev.<span class="me1">DIFF</span><span class="br0">]</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
        <span class="kw2">var</span> self <span class="sy0">=</span> <span class="kw1">this</span><span class="sy0">;</span>
&nbsp;
        <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> rev <span class="sy0">=</span> Rev.<span class="me1">FIRST</span><span class="sy0">;</span> rev <span class="sy0">&lt;</span> Rev.<span class="me1">LAST</span><span class="sy0">;</span> <span class="sy0">++</span>rev<span class="br0">)</span> <span class="br0">{</span>
            <span class="co1">// Create new navbar and insert it to the tracker</span>
            <span class="kw2">var</span> rev_nv <span class="sy0">=</span> nv.<span class="me1">clone</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">hide</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">insertAfter</span><span class="br0">(</span>nv<span class="br0">)</span><span class="sy0">;</span>
            <span class="kw1">this</span>.<span class="me1">tracker</span>.<span class="me1">add_object</span><span class="br0">(</span>rev_nv<span class="sy0">,</span> nv<span class="sy0">,</span> <span class="kw2">new</span> VisibilityMap<span class="br0">(</span><span class="br0">[</span>rev<span class="br0">]</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
            <span class="co1">// Get interesting elements</span>
            <span class="kw2">var</span> nv_tables <span class="sy0">=</span> rev_nv.<span class="me1">find</span><span class="br0">(</span><span class="st0">'.t-nv-begin'</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="kw2">var</span> nv_tables_tb <span class="sy0">=</span> nv_tables.<span class="me1">children</span><span class="br0">(</span><span class="st0">'tbody'</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
            <span class="kw2">var</span> el_h1 <span class="sy0">=</span> nv_tables_tb.<span class="me1">children</span><span class="br0">(</span><span class="st0">'.t-nv-h1'</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="kw2">var</span> el_h2 <span class="sy0">=</span> nv_tables_tb.<span class="me1">children</span><span class="br0">(</span><span class="st0">'.t-nv-h2'</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="kw2">var</span> el_col_tables <span class="sy0">=</span> nv_tables_tb.<span class="me1">children</span><span class="br0">(</span><span class="st0">'.t-nv-col-table'</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="kw2">var</span> el_nv <span class="sy0">=</span> nv_tables_tb.<span class="me1">children</span><span class="br0">(</span><span class="st0">'.t-nv'</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
            <span class="co1">// Remove entries from the link tables that should not be visible</span>
            <span class="co1">// for the revision in question</span>
            el_nv.<span class="me1">each</span><span class="br0">(</span><span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span><span class="br0">{</span>
&nbsp;
                <span class="co1">// Get the link table</span>
                <span class="kw2">var</span> link_tds <span class="sy0">=</span> $<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span>.<span class="me1">find</span><span class="br0">(</span><span class="st0">'.t-nv-ln-table div'</span><span class="br0">)</span><span class="sy0">;</span>
                <span class="kw2">var</span> marks<span class="sy0">;</span>
&nbsp;
                <span class="kw1">if</span> <span class="br0">(</span>link_tds.<span class="me1">length</span> <span class="sy0">===</span> <span class="nu0">0</span><span class="br0">)</span> <span class="br0">{</span>
                    <span class="co1">// bare nv template used. Check if we don't have a mark</span>
                    <span class="co1">// template by chance</span>
                    marks <span class="sy0">=</span> $<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span>.<span class="me1">find</span><span class="br0">(</span><span class="st0">'.t-mark-rev'</span><span class="br0">)</span><span class="sy0">;</span>
                    <span class="kw1">if</span> <span class="br0">(</span>marks.<span class="me1">length</span> <span class="sy0">&gt;</span> <span class="nu0">0</span><span class="br0">)</span> <span class="br0">{</span>
                        <span class="kw2">var</span> mark <span class="sy0">=</span> get_mark<span class="br0">(</span>marks.<span class="me1">first</span><span class="br0">(</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
                        <span class="kw1">if</span> <span class="br0">(</span><span class="sy0">!</span>should_be_shown<span class="br0">(</span>rev<span class="sy0">,</span> mark<span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
                            $<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span>.<span class="me1">remove</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
                        <span class="br0">}</span> <span class="kw1">else</span> <span class="br0">{</span>
                            marks.<span class="me1">remove</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span> <span class="co1">// do not show marks in any case</span>
                        <span class="br0">}</span>
                    <span class="br0">}</span>
                    <span class="kw1">return</span><span class="sy0">;</span>
                <span class="br0">}</span>
&nbsp;
                <span class="kw1">if</span> <span class="br0">(</span>link_tds.<span class="me1">length</span> <span class="sy0">===</span> <span class="nu0">1</span><span class="br0">)</span> <span class="br0">{</span>
                    <span class="co1">// The earliest standard (always visible)</span>
                    <span class="kw1">return</span><span class="sy0">;</span>
                <span class="br0">}</span>
                <span class="kw2">var</span> titles <span class="sy0">=</span> link_tds.<span class="me1">first</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">children</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">children</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">first</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">children</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
                marks <span class="sy0">=</span> link_tds.<span class="me1">last</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">children</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">first</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">children</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
                <span class="co1">// Delete the lines</span>
                <span class="kw1">if</span> <span class="br0">(</span>self.<span class="me1">delete_lines</span><span class="br0">(</span>titles<span class="sy0">,</span> marks<span class="sy0">,</span> rev<span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
                    $<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span>.<span class="me1">remove</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
                <span class="br0">}</span>
            <span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
            <span class="co1">// Remove all empty column tables</span>
            el_col_tables.<span class="me1">each</span><span class="br0">(</span><span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
                <span class="kw1">if</span> <span class="br0">(</span>$<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span>.<span class="me1">find</span><span class="br0">(</span><span class="st0">'.t-nv'</span><span class="br0">)</span>.<span class="me1">length</span> <span class="sy0">===</span> <span class="nu0">0</span><span class="br0">)</span> <span class="br0">{</span>
                    $<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span>.<span class="me1">remove</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
                <span class="br0">}</span>
            <span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
            <span class="co1">// Look for any headings that do not have items after them</span>
            el_h2.<span class="me1">each</span><span class="br0">(</span><span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
                <span class="kw1">if</span> <span class="br0">(</span>$<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span>.<span class="me1">next</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">length</span> <span class="sy0">===</span> <span class="nu0">0</span> <span class="sy0">||</span>
                    $<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span>.<span class="me1">next</span><span class="br0">(</span><span class="br0">)</span>.<span class="kw1">is</span><span class="br0">(</span><span class="st0">'.t-nv-h2, .t-nv-h1'</span><span class="br0">)</span>
                <span class="br0">)</span> <span class="br0">{</span>
                    $<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span>.<span class="me1">remove</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
                <span class="br0">}</span>
            <span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
            el_h1.<span class="me1">each</span><span class="br0">(</span><span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
                <span class="kw1">if</span> <span class="br0">(</span>$<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span>.<span class="me1">next</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">length</span> <span class="sy0">===</span> <span class="nu0">0</span> <span class="sy0">||</span>
                    $<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span>.<span class="me1">next</span><span class="br0">(</span><span class="br0">)</span>.<span class="kw1">is</span><span class="br0">(</span><span class="st0">'.t-nv-h1'</span><span class="br0">)</span>
                <span class="br0">)</span> <span class="br0">{</span>
                    $<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span>.<span class="me1">remove</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
                <span class="br0">}</span>
            <span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
            <span class="co1">// TODO: perhaps it's worth to reflow the remaining columns</span>
        <span class="br0">}</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="coMULTI">/*  Handles inclusions of Template:rev_begin, Template:rev and
        Template:rev_end.
&nbsp;
        We don't copy the contents of this templates around. We just add the
        rows to the element tracker and show and hide them as needed. To hide
        the frame on non-diff revisions, we have special treatment in
        on_selection_change. Note, that in order for this to work, the revision
        marks must not be touched.
    */</span>
    StandardRevisionPlugin.<span class="me1">prototype</span>.<span class="me1">prepare_all_revs</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>scope<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw2">var</span> rev_elems <span class="sy0">=</span> scope.<span class="me1">rev_tables</span>.<span class="me1">children</span><span class="br0">(</span><span class="st0">'tbody'</span><span class="br0">)</span>.<span class="me1">children</span><span class="br0">(</span><span class="st0">'.t-rev'</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="kw2">var</span> self <span class="sy0">=</span> <span class="kw1">this</span><span class="sy0">;</span>
        rev_elems.<span class="me1">each</span><span class="br0">(</span><span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw2">var</span> visible <span class="sy0">=</span> get_visibility_map<span class="br0">(</span>$<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
            visible.<span class="me1">add</span><span class="br0">(</span>Rev.<span class="me1">DIFF</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
            self.<span class="me1">tracker</span>.<span class="me1">add_diff_object</span><span class="br0">(</span>$<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span><span class="sy0">,</span> visible<span class="br0">)</span><span class="sy0">;</span>
        <span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="coMULTI">/** Handles inclusions of Template:rev_inl
    */</span>
    StandardRevisionPlugin.<span class="me1">prototype</span>.<span class="me1">prepare_all_inl_revs</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>scope<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw2">var</span> self <span class="sy0">=</span> <span class="kw1">this</span><span class="sy0">;</span>
        scope.<span class="me1">rev_inl_tables</span>.<span class="me1">each</span><span class="br0">(</span><span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
            self.<span class="me1">tracker</span>.<span class="me1">add_diff_object</span><span class="br0">(</span>$<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span><span class="sy0">,</span> <span class="kw2">new</span> VisibilityMap<span class="br0">(</span><span class="br0">[</span>Rev.<span class="me1">DIFF</span><span class="br0">]</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
            <span class="kw2">var</span> visible <span class="sy0">=</span> get_visibility_map<span class="br0">(</span>$<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="kw2">var</span> copy <span class="sy0">=</span> $<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span>.<span class="me1">children</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">first</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">clone</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">hide</span><span class="br0">(</span><span class="br0">)</span>
                              .<span class="me1">insertAfter</span><span class="br0">(</span>$<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
            self.<span class="me1">tracker</span>.<span class="me1">add_object</span><span class="br0">(</span>copy<span class="sy0">,</span> $<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span><span class="sy0">,</span> visible<span class="br0">)</span><span class="sy0">;</span>
        <span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="coMULTI">/*  Handles the description lists and their contents - inclusions of
        Template:dsc_* ('t-dsc-*' CSS classes)
&nbsp;
        Prepares items in dsc lists
    */</span>
    StandardRevisionPlugin.<span class="me1">prototype</span>.<span class="me1">prepare_all_dscs</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>scope<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw2">var</span> self <span class="sy0">=</span> <span class="kw1">this</span><span class="sy0">;</span>
        scope.<span class="me1">dsc_tables</span>.<span class="me1">each</span><span class="br0">(</span><span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
            self.<span class="me1">prepare_dsc_table</span><span class="br0">(</span>$<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="co1">// Returns true if the given jQuery object defines a secondary visual object</span>
    StandardRevisionPlugin.<span class="me1">prototype</span>.<span class="me1">is_secondary</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>el<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw1">if</span> <span class="br0">(</span>el.<span class="kw1">is</span><span class="br0">(</span><span class="st0">'h2'</span><span class="br0">)</span> <span class="sy0">||</span>
            el.<span class="kw1">is</span><span class="br0">(</span><span class="st0">'h3'</span><span class="br0">)</span> <span class="sy0">||</span>
            el.<span class="kw1">is</span><span class="br0">(</span><span class="st0">'h5'</span><span class="br0">)</span> <span class="sy0">||</span>
            el.<span class="kw1">is</span><span class="br0">(</span><span class="st0">'p'</span><span class="br0">)</span> <span class="sy0">||</span>
            <span class="br0">(</span>el.<span class="kw1">is</span><span class="br0">(</span><span class="st0">'tr'</span><span class="br0">)</span> <span class="sy0">&amp;&amp;</span> el.<span class="me1">has</span><span class="br0">(</span><span class="st0">'td &gt; h5'</span><span class="br0">)</span>.<span class="me1">length</span><span class="br0">)</span> <span class="sy0">||</span>
            el.<span class="kw1">is</span><span class="br0">(</span><span class="st0">'.t-dsc-header'</span><span class="br0">)</span><span class="br0">)</span>
        <span class="br0">{</span>
            <span class="kw1">return</span> <span class="kw2">true</span><span class="sy0">;</span>
        <span class="br0">}</span>
        <span class="kw1">return</span> <span class="kw2">false</span><span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="coMULTI">/*  If the given jQuery object refers to a heading element, then returns
        the section level for that heading. More "important" heading elements
        have lower section levels, the lowest being 0. If the given jQuery
        object does not refer to a heading, then the function returns -1.
    */</span>
    StandardRevisionPlugin.<span class="me1">prototype</span>.<span class="me1">get_heading_level</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>el<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw1">if</span> <span class="br0">(</span>el.<span class="kw1">is</span><span class="br0">(</span><span class="st0">'h2'</span><span class="br0">)</span><span class="br0">)</span>
            <span class="kw1">return</span> <span class="nu0">0</span><span class="sy0">;</span>
        <span class="kw1">if</span> <span class="br0">(</span>el.<span class="kw1">is</span><span class="br0">(</span><span class="st0">'h3'</span><span class="br0">)</span><span class="br0">)</span>
            <span class="kw1">return</span> <span class="nu0">1</span><span class="sy0">;</span>
        <span class="kw1">if</span> <span class="br0">(</span>el.<span class="kw1">is</span><span class="br0">(</span><span class="st0">'h5'</span><span class="br0">)</span><span class="br0">)</span>
            <span class="kw1">return</span> <span class="nu0">2</span><span class="sy0">;</span>
        <span class="kw1">if</span> <span class="br0">(</span>el.<span class="kw1">is</span><span class="br0">(</span><span class="st0">'tr'</span><span class="br0">)</span> <span class="sy0">&amp;&amp;</span> el.<span class="me1">has</span><span class="br0">(</span><span class="st0">'td &gt; h5'</span><span class="br0">)</span>.<span class="me1">length</span><span class="br0">)</span>
            <span class="kw1">return</span> <span class="nu0">2</span><span class="sy0">;</span>
        <span class="kw1">if</span> <span class="br0">(</span>el.<span class="kw1">is</span><span class="br0">(</span><span class="st0">'.t-dsc-header'</span><span class="br0">)</span><span class="br0">)</span>
            <span class="kw1">return</span> <span class="nu0">3</span><span class="sy0">;</span>
        <span class="kw1">return</span> <span class="sy0">-</span><span class="nu0">1</span><span class="sy0">;</span>
    <span class="br0">}</span>
&nbsp;
    <span class="coMULTI">/*  If jQuery object el has a known section level, then we enter that
        section level by exiting section nodes or creating new section nodes
        and entering them as needed.
    */</span>
    StandardRevisionPlugin.<span class="me1">prototype</span>.<span class="me1">set_level_if_needed</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>section_tracker<span class="sy0">,</span> el<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw2">var</span> level <span class="sy0">=</span> <span class="kw1">this</span>.<span class="me1">get_heading_level</span><span class="br0">(</span>el<span class="br0">)</span><span class="sy0">;</span>
        <span class="kw1">if</span> <span class="br0">(</span>level <span class="sy0">&gt;=</span> <span class="nu0">0</span><span class="br0">)</span> <span class="br0">{</span>
            section_tracker.<span class="me1">set_level</span><span class="br0">(</span>level<span class="br0">)</span><span class="sy0">;</span>
        <span class="br0">}</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="co1">// Handles a description list</span>
    StandardRevisionPlugin.<span class="me1">prototype</span>.<span class="me1">prepare_dsc_table</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>el<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw2">var</span> section_tracker <span class="sy0">=</span> <span class="kw2">new</span> SectionContentsTracker<span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
        <span class="kw2">var</span> start_el <span class="sy0">=</span> el<span class="sy0">;</span>
        <span class="kw1">while</span> <span class="br0">(</span><span class="kw2">true</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw2">var</span> prev <span class="sy0">=</span> start_el.<span class="me1">prev</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="kw1">if</span> <span class="br0">(</span>prev.<span class="me1">length</span> <span class="sy0">===</span> <span class="nu0">0</span> <span class="sy0">||</span> <span class="sy0">!</span><span class="kw1">this</span>.<span class="me1">is_secondary</span><span class="br0">(</span>prev<span class="br0">)</span><span class="br0">)</span>
                <span class="kw1">break</span><span class="sy0">;</span>
            start_el <span class="sy0">=</span> prev<span class="sy0">;</span>
        <span class="br0">}</span>
&nbsp;
        <span class="kw1">while</span> <span class="br0">(</span>start_el<span class="br0">[</span><span class="nu0">0</span><span class="br0">]</span> <span class="sy0">!==</span> el<span class="br0">[</span><span class="nu0">0</span><span class="br0">]</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">this</span>.<span class="me1">set_level_if_needed</span><span class="br0">(</span>section_tracker<span class="sy0">,</span> start_el<span class="br0">)</span><span class="sy0">;</span>
            section_tracker.<span class="me1">add_secondary</span><span class="br0">(</span>start_el<span class="br0">)</span><span class="sy0">;</span>
            start_el <span class="sy0">=</span> start_el.<span class="me1">next</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="br0">}</span>
&nbsp;
        section_tracker.<span class="me1">enter_container</span><span class="br0">(</span>el<span class="br0">)</span><span class="sy0">;</span>
&nbsp;
        <span class="kw2">var</span> rows <span class="sy0">=</span> el.<span class="me1">children</span><span class="br0">(</span><span class="st0">'tbody'</span><span class="br0">)</span>.<span class="me1">children</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="kw2">var</span> self <span class="sy0">=</span> <span class="kw1">this</span><span class="sy0">;</span>
        rows.<span class="me1">each</span><span class="br0">(</span><span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw2">var</span> el <span class="sy0">=</span> $<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="kw1">if</span> <span class="br0">(</span>el.<span class="kw1">is</span><span class="br0">(</span><span class="st0">'.t-dsc'</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
                section_tracker.<span class="me1">add_primary</span><span class="br0">(</span>el<span class="sy0">,</span> self.<span class="me1">prepare_dsc</span><span class="br0">(</span>el<span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="br0">}</span> <span class="kw1">else</span> <span class="br0">{</span>
                self.<span class="me1">set_level_if_needed</span><span class="br0">(</span>section_tracker<span class="sy0">,</span> el<span class="br0">)</span><span class="sy0">;</span>
                <span class="kw1">if</span> <span class="br0">(</span>self.<span class="me1">is_secondary</span><span class="br0">(</span>el<span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
                    section_tracker.<span class="me1">add_secondary</span><span class="br0">(</span>el<span class="br0">)</span><span class="sy0">;</span>
                <span class="br0">}</span> <span class="kw1">else</span> <span class="br0">{</span>
                    section_tracker.<span class="me1">add_unknown</span><span class="br0">(</span>el<span class="br0">)</span><span class="sy0">;</span>
                <span class="br0">}</span>
            <span class="br0">}</span>
        <span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span>
        section_tracker.<span class="me1">exit_container</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
        section_tracker.<span class="me1">run</span><span class="br0">(</span><span class="kw1">this</span>.<span class="me1">tracker</span><span class="br0">)</span><span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="coMULTI">/*  Handles one description list item (inclusion of Template:dsc_*,
        't-dsc-*' CSS classes).
&nbsp;
        Returns a visibility map for that item.
    */</span>
    StandardRevisionPlugin.<span class="me1">prototype</span>.<span class="me1">prepare_dsc</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>el<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw2">var</span> self <span class="sy0">=</span> <span class="kw1">this</span><span class="sy0">;</span>
&nbsp;
        <span class="coMULTI">/*  Handles the case one of the specialized wrapper templates is
            used. This case is special in that the description may contain
            several names, each with standard tag attached.
        */</span>
        <span class="kw2">function</span> process_dsc_specialized<span class="br0">(</span>el<span class="sy0">,</span> member<span class="br0">)</span> <span class="br0">{</span>
            <span class="kw2">var</span> lines <span class="sy0">=</span> member.<span class="me1">find</span><span class="br0">(</span><span class="st0">'.t-lines'</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="kw1">if</span> <span class="br0">(</span>lines.<span class="me1">length</span> <span class="sy0">!==</span> <span class="nu0">2</span><span class="br0">)</span> <span class="br0">{</span>
                <span class="kw1">return</span> visibility_fill<span class="br0">(</span><span class="kw2">true</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="br0">}</span>
            <span class="kw2">var</span> marks <span class="sy0">=</span> lines.<span class="me1">last</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
            <span class="kw2">var</span> rev_map <span class="sy0">=</span> self.<span class="me1">get_revision_map</span><span class="br0">(</span>marks.<span class="me1">children</span><span class="br0">(</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
            self.<span class="me1">tracker</span>.<span class="me1">add_diff_object</span><span class="br0">(</span>el<span class="sy0">,</span> rev_map<span class="br0">[</span>Rev.<span class="me1">DIFF</span><span class="br0">]</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
            <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> rev <span class="sy0">=</span> Rev.<span class="me1">FIRST</span><span class="sy0">;</span> rev <span class="sy0">&lt;</span> Rev.<span class="me1">LAST</span><span class="sy0">;</span> <span class="sy0">++</span>rev<span class="br0">)</span> <span class="br0">{</span>
                <span class="kw1">if</span> <span class="br0">(</span>rev_map<span class="br0">[</span>rev<span class="br0">]</span>.<span class="me1">is_visible_on_none</span><span class="br0">(</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
                    <span class="kw1">continue</span><span class="sy0">;</span>
                <span class="br0">}</span>
&nbsp;
                <span class="kw2">var</span> copy <span class="sy0">=</span> el.<span class="me1">clone</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">hide</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
                self.<span class="me1">tracker</span>.<span class="me1">add_object</span><span class="br0">(</span>copy<span class="sy0">,</span> el<span class="sy0">,</span> rev_map<span class="br0">[</span>rev<span class="br0">]</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
                member <span class="sy0">=</span> copy.<span class="me1">children</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">children</span><span class="br0">(</span><span class="st0">'.t-dsc-member-div'</span><span class="br0">)</span><span class="sy0">;</span>
                lines <span class="sy0">=</span> member.<span class="me1">find</span><span class="br0">(</span><span class="st0">'.t-lines'</span><span class="br0">)</span><span class="sy0">;</span>
                <span class="kw2">var</span> titles <span class="sy0">=</span> lines.<span class="me1">first</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">children</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
                marks <span class="sy0">=</span> lines.<span class="me1">last</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">children</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
                self.<span class="me1">delete_lines</span><span class="br0">(</span>titles<span class="sy0">,</span> marks<span class="sy0">,</span> rev<span class="br0">)</span><span class="sy0">;</span>
                copy.<span class="me1">insertAfter</span><span class="br0">(</span>el<span class="br0">)</span><span class="sy0">;</span>
            <span class="br0">}</span>
            <span class="kw1">return</span> self.<span class="me1">revision_map_to_visibility</span><span class="br0">(</span>rev_map<span class="br0">)</span><span class="sy0">;</span>
        <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
        <span class="co1">// Handles the generic dsc template case</span>
        <span class="kw2">function</span> process_dsc_generic<span class="br0">(</span>el<span class="br0">)</span> <span class="br0">{</span>
            <span class="kw2">var</span> td <span class="sy0">=</span> el.<span class="me1">children</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">first</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="kw1">if</span> <span class="br0">(</span>td.<span class="me1">find</span><span class="br0">(</span><span class="st0">'.t-mark-rev'</span><span class="br0">)</span>.<span class="me1">length</span> <span class="sy0">===</span> <span class="nu0">0</span><span class="br0">)</span> <span class="br0">{</span>
                <span class="kw1">return</span> visibility_fill<span class="br0">(</span><span class="kw2">true</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="br0">}</span>
            <span class="kw2">var</span> rev_map <span class="sy0">=</span> self.<span class="me1">get_revision_map</span><span class="br0">(</span>td<span class="br0">)</span><span class="sy0">;</span>
            self.<span class="me1">tracker</span>.<span class="me1">add_diff_object</span><span class="br0">(</span>el<span class="sy0">,</span> rev_map<span class="br0">[</span>Rev.<span class="me1">DIFF</span><span class="br0">]</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
            <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> rev <span class="sy0">=</span> Rev.<span class="me1">FIRST</span><span class="sy0">;</span> rev <span class="sy0">&lt;</span> Rev.<span class="me1">LAST</span><span class="sy0">;</span> <span class="sy0">++</span>rev<span class="br0">)</span> <span class="br0">{</span>
                <span class="kw1">if</span> <span class="br0">(</span>rev_map<span class="br0">[</span>rev<span class="br0">]</span>.<span class="me1">is_visible_on_none</span><span class="br0">(</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
                    <span class="kw1">continue</span><span class="sy0">;</span>
                <span class="br0">}</span>
&nbsp;
                <span class="kw2">var</span> copy <span class="sy0">=</span> el.<span class="me1">clone</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">hide</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
                self.<span class="me1">tracker</span>.<span class="me1">add_object</span><span class="br0">(</span>copy<span class="sy0">,</span> el<span class="sy0">,</span> rev_map<span class="br0">[</span>rev<span class="br0">]</span><span class="br0">)</span><span class="sy0">;</span>
                <span class="co1">// remove marks, but only in the first column</span>
                copy.<span class="me1">children</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">first</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">find</span><span class="br0">(</span><span class="st0">'.t-mark-rev'</span><span class="br0">)</span>.<span class="me1">remove</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
                copy.<span class="me1">insertAfter</span><span class="br0">(</span>el<span class="br0">)</span><span class="sy0">;</span>
            <span class="br0">}</span>
            <span class="kw1">return</span> self.<span class="me1">revision_map_to_visibility</span><span class="br0">(</span>rev_map<span class="br0">)</span><span class="sy0">;</span>
        <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
        <span class="kw2">var</span> member <span class="sy0">=</span> el.<span class="me1">children</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">children</span><span class="br0">(</span><span class="st0">'.t-dsc-member-div'</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="kw1">if</span> <span class="br0">(</span>member.<span class="me1">length</span> <span class="sy0">!==</span> <span class="nu0">0</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">return</span> process_dsc_specialized<span class="br0">(</span>el<span class="sy0">,</span> member<span class="br0">)</span><span class="sy0">;</span>
        <span class="br0">}</span> <span class="kw1">else</span> <span class="br0">{</span>
            <span class="kw1">return</span> process_dsc_generic<span class="br0">(</span>el<span class="br0">)</span><span class="sy0">;</span>
        <span class="br0">}</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="coMULTI">/** Handles declaration tables and their contents. These are implemented
        by including Template:dcl_* templates ('t-dcl-*' CSS classes)
&nbsp;
        Returns "numbering map", which defines how the list items are
        renumbered (or deleted) for each revision. The numbering map is a an
        two-dimensional array - the first index identifies the revision,
        the second -- original number. The value obtained this way
        identifies whether the entry should be hidden and if not, what
        version number should be displayed on the specific revision. Hidden
        entry is identified by -1.
&nbsp;
        array[revision][orig_num] -&gt; target_num or -1
    */</span>
    StandardRevisionPlugin.<span class="me1">prototype</span>.<span class="me1">prepare_all_dcls</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>dcl_table<span class="br0">)</span> <span class="br0">{</span>
&nbsp;
        <span class="kw2">var</span> tracker <span class="sy0">=</span> <span class="kw1">this</span>.<span class="me1">tracker</span><span class="sy0">;</span>
&nbsp;
        <span class="co1">// get abstract description of the contents</span>
        defs <span class="sy0">=</span> <span class="br0">[</span><span class="br0">]</span><span class="sy0">;</span>
&nbsp;
        <span class="coMULTI">/*
            &lt;Simple dcl&gt; :== {
                type: 'i',
                obj: &lt;jQuery object&gt;
                revs: &lt;visibility map&gt;,
&nbsp;
                // -1 if not defined
                num: 'orig_num'
            }
&nbsp;
            &lt;Rev-list dcl&gt; :== {
                type: 'r',
                obj: &lt;jQuery object&gt;,
                revs: &lt;visibility map&gt;',
                num: 'orig_num',     // -1 if not defined
                aux: &lt;jQuery object&gt;, // potentially empty
&nbsp;
                // The list of indexes of entries in defs array identifying
                // children dcls
                children: [ &lt;child id&gt;, ... ]
            }
&nbsp;
            defs: [ &lt;either Simple dcl or rev-list dcl&gt;, ... ]
&nbsp;
            If rev-list dcl has 'revs' defined, then those override revs for
            all children dcls.
&nbsp;
            If rev-list dcl has 'num' defined, then 'num' for all children
            dcls is -1.
        */</span>
        <span class="kw2">var</span> num_regex <span class="sy0">=</span> <span class="co2">/\s*\((\d+)\)\s*/</span><span class="sy0">;</span>
        <span class="kw2">function</span> process_tr<span class="br0">(</span>el<span class="sy0">,</span> is_num_overridden<span class="sy0">,</span> is_rev_overridden<span class="sy0">,</span>
                            overridden_revs<span class="br0">)</span> <span class="br0">{</span>
            <span class="kw2">var</span> new_def <span class="sy0">=</span> <span class="br0">{</span>
                type<span class="sy0">:</span> <span class="st0">'s'</span><span class="sy0">,</span>
                obj<span class="sy0">:</span> el<span class="sy0">,</span>
                num<span class="sy0">:</span> <span class="sy0">-</span><span class="nu0">1</span><span class="sy0">,</span>
                revs<span class="sy0">:</span> visibility_fill<span class="br0">(</span><span class="kw2">true</span><span class="br0">)</span>
            <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
            <span class="co1">// get version num</span>
            <span class="kw1">if</span> <span class="br0">(</span><span class="sy0">!</span>is_num_overridden<span class="br0">)</span> <span class="br0">{</span>
                <span class="kw2">var</span> num_text <span class="sy0">=</span> el.<span class="me1">children</span><span class="br0">(</span><span class="st0">'td'</span><span class="br0">)</span>.<span class="me1">eq</span><span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>.<span class="me1">text</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
                <span class="kw2">var</span> match <span class="sy0">=</span> num_text.<span class="me1">match</span><span class="br0">(</span>num_regex<span class="br0">)</span><span class="sy0">;</span>
                <span class="kw1">if</span> <span class="br0">(</span>match <span class="sy0">!==</span> <span class="kw2">null</span><span class="br0">)</span> <span class="br0">{</span>
                    new_def.<span class="me1">num</span> <span class="sy0">=</span> parseInt<span class="br0">(</span>match<span class="br0">[</span><span class="nu0">1</span><span class="br0">]</span><span class="br0">)</span><span class="sy0">;</span>
                <span class="br0">}</span>
            <span class="br0">}</span>
&nbsp;
            <span class="co1">// get revision info</span>
            <span class="kw1">if</span> <span class="br0">(</span><span class="sy0">!</span>is_rev_overridden<span class="br0">)</span> <span class="br0">{</span>
                <span class="kw2">var</span> notes_td <span class="sy0">=</span> el.<span class="me1">children</span><span class="br0">(</span><span class="st0">'td'</span><span class="br0">)</span>.<span class="me1">eq</span><span class="br0">(</span><span class="nu0">2</span><span class="br0">)</span><span class="sy0">;</span>
                <span class="kw1">if</span> <span class="br0">(</span>notes_td.<span class="me1">find</span><span class="br0">(</span><span class="st0">'.t-mark-rev'</span><span class="br0">)</span>.<span class="me1">length</span> <span class="sy0">&gt;</span> <span class="nu0">0</span><span class="br0">)</span> <span class="br0">{</span>
                    new_def.<span class="me1">revs</span> <span class="sy0">=</span> get_visibility_map<span class="br0">(</span>el<span class="br0">)</span><span class="sy0">;</span>
                <span class="br0">}</span>
            <span class="br0">}</span> <span class="kw1">else</span> <span class="br0">{</span>
                new_def.<span class="me1">revs</span> <span class="sy0">=</span> overridden_revs<span class="sy0">;</span>
            <span class="br0">}</span>
&nbsp;
            <span class="kw1">return</span> defs.<span class="me1">push</span><span class="br0">(</span>new_def<span class="br0">)</span> <span class="sy0">-</span> <span class="nu0">1</span><span class="sy0">;</span>
        <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
        <span class="kw2">function</span> process_rev_tbody<span class="br0">(</span>el<span class="br0">)</span> <span class="br0">{</span>
            <span class="kw2">var</span> new_def <span class="sy0">=</span> <span class="br0">{</span>
                type<span class="sy0">:</span> <span class="st0">'r'</span><span class="sy0">,</span>
                obj<span class="sy0">:</span> el<span class="sy0">,</span>
                num<span class="sy0">:</span> <span class="sy0">-</span><span class="nu0">1</span><span class="sy0">,</span>
                revs<span class="sy0">:</span> visibility_fill<span class="br0">(</span><span class="kw2">true</span><span class="br0">)</span><span class="sy0">,</span>
                children<span class="sy0">:</span> <span class="br0">[</span><span class="br0">]</span>
            <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
            <span class="co1">// potentially empty</span>
            <span class="kw2">var</span> aux_tr <span class="sy0">=</span> el.<span class="me1">children</span><span class="br0">(</span><span class="st0">'.t-dcl-rev-aux'</span><span class="br0">)</span>.<span class="me1">first</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
            new_def.<span class="me1">aux</span> <span class="sy0">=</span> aux_tr<span class="sy0">;</span>
&nbsp;
            <span class="co1">// get version num</span>
            <span class="kw2">var</span> has_num <span class="sy0">=</span> <span class="kw2">false</span><span class="sy0">;</span>
            <span class="kw1">if</span> <span class="br0">(</span>el.<span class="me1">hasClass</span><span class="br0">(</span><span class="st0">'t-dcl-rev-num'</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
                <span class="kw2">var</span> num_text <span class="sy0">=</span> aux_tr.<span class="me1">children</span><span class="br0">(</span><span class="st0">'td'</span><span class="br0">)</span>.<span class="me1">eq</span><span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>.<span class="me1">text</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
                <span class="kw2">var</span> match <span class="sy0">=</span> num_text.<span class="me1">match</span><span class="br0">(</span>num_regex<span class="br0">)</span><span class="sy0">;</span>
                <span class="kw1">if</span> <span class="br0">(</span>match <span class="sy0">!==</span> <span class="kw2">null</span><span class="br0">)</span> <span class="br0">{</span>
                    new_def.<span class="me1">num</span> <span class="sy0">=</span> parseInt<span class="br0">(</span>match<span class="br0">[</span><span class="nu0">1</span><span class="br0">]</span><span class="br0">)</span><span class="sy0">;</span>
                    has_num <span class="sy0">=</span> <span class="kw2">true</span><span class="sy0">;</span>
                <span class="br0">}</span>
            <span class="br0">}</span>
&nbsp;
            <span class="co1">// get revision info</span>
            <span class="kw2">var</span> has_revs <span class="sy0">=</span> <span class="kw2">false</span><span class="sy0">;</span>
            <span class="kw1">if</span> <span class="br0">(</span>el.<span class="me1">hasClass</span><span class="br0">(</span><span class="st0">'t-dcl-rev-notes'</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
                <span class="kw2">var</span> mark_revs <span class="sy0">=</span> aux_tr.<span class="me1">children</span><span class="br0">(</span><span class="st0">'td'</span><span class="br0">)</span>.<span class="me1">eq</span><span class="br0">(</span><span class="nu0">2</span><span class="br0">)</span>.<span class="me1">find</span><span class="br0">(</span><span class="st0">'.t-mark-rev'</span><span class="br0">)</span><span class="sy0">;</span>
                <span class="kw1">if</span> <span class="br0">(</span>mark_revs.<span class="me1">length</span> <span class="sy0">&gt;</span> <span class="nu0">0</span><span class="br0">)</span> <span class="br0">{</span>
                    new_def.<span class="me1">revs</span> <span class="sy0">=</span> get_visibility_map<span class="br0">(</span>el<span class="br0">)</span><span class="sy0">;</span>
                    has_revs <span class="sy0">=</span> <span class="kw2">true</span><span class="sy0">;</span>
                <span class="br0">}</span>
            <span class="br0">}</span>
&nbsp;
            <span class="co1">// process the member dcls</span>
            el.<span class="me1">children</span><span class="br0">(</span><span class="st0">'.t-dcl'</span><span class="br0">)</span>.<span class="me1">each</span><span class="br0">(</span><span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
                <span class="kw2">var</span> new_id <span class="sy0">=</span> process_tr<span class="br0">(</span>$<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span><span class="sy0">,</span> has_num<span class="sy0">,</span> has_revs<span class="sy0">,</span>
                                        new_def.<span class="me1">revs</span>.<span class="me1">clone</span><span class="br0">(</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
                new_def.<span class="me1">children</span>.<span class="me1">push</span><span class="br0">(</span>new_id<span class="br0">)</span><span class="sy0">;</span>
            <span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
            defs.<span class="me1">push</span><span class="br0">(</span>new_def<span class="br0">)</span><span class="sy0">;</span>
        <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
        $<span class="br0">(</span>dcl_table<span class="br0">)</span>.<span class="me1">children</span><span class="br0">(</span><span class="st0">'tbody'</span><span class="br0">)</span>.<span class="me1">each</span><span class="br0">(</span><span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">if</span> <span class="br0">(</span>$<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span>.<span class="me1">hasClass</span><span class="br0">(</span><span class="st0">'t-dcl-rev'</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
                process_rev_tbody<span class="br0">(</span>$<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="br0">}</span> <span class="kw1">else</span> <span class="br0">{</span>
                $<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span>.<span class="me1">children</span><span class="br0">(</span><span class="st0">'.t-dcl'</span><span class="br0">)</span>.<span class="me1">each</span><span class="br0">(</span><span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
                    process_tr<span class="br0">(</span>$<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span><span class="sy0">,</span> <span class="kw2">false</span><span class="sy0">,</span> <span class="kw2">false</span><span class="sy0">,</span> <span class="br0">[</span><span class="br0">]</span><span class="br0">)</span><span class="sy0">;</span>
                <span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="br0">}</span>
        <span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
        <span class="co1">// Prints defs to a string</span>
        <span class="kw2">function</span> debug_print_defs<span class="br0">(</span>defs<span class="br0">)</span> <span class="br0">{</span>
            <span class="kw2">var</span> out <span class="sy0">=</span> <span class="st0">''</span><span class="sy0">;</span>
            <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> defs.<span class="me1">length</span><span class="sy0">;</span> i<span class="sy0">++</span><span class="br0">)</span> <span class="br0">{</span>
                out <span class="sy0">+=</span> <span class="st0">' { i:'</span> <span class="sy0">+</span> i <span class="sy0">+</span> <span class="st0">' type:'</span> <span class="sy0">+</span> defs<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">type</span> <span class="sy0">+</span> <span class="st0">' num:'</span> <span class="sy0">+</span> defs<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">num</span><span class="sy0">;</span>
                out <span class="sy0">+=</span> <span class="st0">' visible:'</span> <span class="sy0">+</span> defs<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">revs</span>.<span class="me1">debug_to_string</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
                <span class="kw1">if</span> <span class="br0">(</span>defs<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">type</span> <span class="sy0">===</span> <span class="st0">'r'</span><span class="br0">)</span> <span class="br0">{</span>
                    out <span class="sy0">+=</span> <span class="st0">' { '</span><span class="sy0">;</span>
                    <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> j <span class="sy0">=</span> <span class="nu0">0</span> <span class="sy0">;</span> j <span class="sy0">&lt;</span> defs<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">children</span>.<span class="me1">length</span><span class="sy0">;</span> <span class="sy0">++</span>j<span class="br0">)</span> <span class="br0">{</span>
                        out <span class="sy0">+=</span> defs<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">children</span><span class="br0">[</span>j<span class="br0">]</span> <span class="sy0">+</span> <span class="st0">' '</span><span class="sy0">;</span>
                    <span class="br0">}</span>
                    out <span class="sy0">+=</span> <span class="st0">'}'</span><span class="sy0">;</span>
                <span class="br0">}</span>
                out <span class="sy0">+=</span> <span class="st0">' }<span class="es0">\n</span>'</span><span class="sy0">;</span>
            <span class="br0">}</span>
            <span class="kw1">return</span> out<span class="sy0">;</span>
        <span class="br0">}</span>
&nbsp;
        <span class="coMULTI">/* Get the mapping between revisions and function version numbers.
           The function returns an array:
&nbsp;
           array[revision][source version number] -&gt; version number to display
        */</span>
        <span class="kw2">function</span> get_num_map<span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw2">var</span> num_map <span class="sy0">=</span> <span class="br0">[</span><span class="br0">]</span><span class="sy0">;</span>
&nbsp;
            <span class="co1">// We need the maximum visible num to initialize the result array</span>
            <span class="co1">// properly</span>
            <span class="kw2">var</span> max_num <span class="sy0">=</span> <span class="sy0">-</span><span class="nu0">1</span><span class="sy0">;</span>
            <span class="kw2">var</span> i<span class="sy0">;</span>
            <span class="kw1">for</span> <span class="br0">(</span>i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> defs.<span class="me1">length</span><span class="sy0">;</span> <span class="sy0">++</span>i<span class="br0">)</span> <span class="br0">{</span>
                <span class="kw1">if</span> <span class="br0">(</span>defs<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">num</span> <span class="sy0">&gt;</span> max_num<span class="br0">)</span> <span class="br0">{</span>
                    max_num <span class="sy0">=</span> defs<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">num</span><span class="sy0">;</span>
                <span class="br0">}</span>
            <span class="br0">}</span>
&nbsp;
            <span class="kw1">if</span> <span class="br0">(</span>max_num <span class="sy0">&gt;</span> <span class="sy0">-</span><span class="nu0">1</span><span class="br0">)</span> <span class="br0">{</span>
&nbsp;
                <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> rev <span class="sy0">=</span> Rev.<span class="me1">FIRST</span><span class="sy0">;</span> rev <span class="sy0">!==</span> Rev.<span class="me1">LAST</span><span class="sy0">;</span> <span class="sy0">++</span>rev<span class="br0">)</span> <span class="br0">{</span>
&nbsp;
                    <span class="kw2">var</span> visible_nums <span class="sy0">=</span> <span class="br0">[</span><span class="br0">]</span><span class="sy0">;</span>
&nbsp;
                    <span class="kw1">for</span> <span class="br0">(</span>i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> defs.<span class="me1">length</span><span class="sy0">;</span> <span class="sy0">++</span>i<span class="br0">)</span> <span class="br0">{</span>
                        <span class="kw1">if</span> <span class="br0">(</span>defs<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">revs</span>.<span class="me1">is_visible_on</span><span class="br0">(</span>rev<span class="br0">)</span> <span class="sy0">&amp;&amp;</span>
                            defs<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">num</span> <span class="sy0">!==</span> <span class="sy0">-</span><span class="nu0">1</span><span class="br0">)</span> <span class="br0">{</span>
                            visible_nums.<span class="me1">push</span><span class="br0">(</span>defs<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">num</span><span class="br0">)</span><span class="sy0">;</span>
                        <span class="br0">}</span>
                    <span class="br0">}</span>
&nbsp;
                    visible_nums <span class="sy0">=</span> array_sort_unique<span class="br0">(</span>visible_nums<span class="br0">)</span><span class="sy0">;</span>
&nbsp;
                    <span class="kw2">var</span> curr_map <span class="sy0">=</span> <span class="br0">[</span><span class="sy0">-</span><span class="nu0">1</span><span class="br0">]</span><span class="sy0">;</span>
                    <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> num <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">;</span> num <span class="sy0">&lt;=</span> max_num<span class="sy0">;</span> <span class="sy0">++</span>num<span class="br0">)</span> <span class="br0">{</span>
                        curr_map<span class="br0">[</span>num<span class="br0">]</span> <span class="sy0">=</span> <span class="sy0">-</span><span class="nu0">1</span><span class="sy0">;</span>
                    <span class="br0">}</span>
&nbsp;
                    <span class="kw2">var</span> curr_num <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">;</span>
                    <span class="kw1">for</span> <span class="br0">(</span>i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> visible_nums.<span class="me1">length</span><span class="sy0">;</span> <span class="sy0">++</span>i<span class="br0">)</span> <span class="br0">{</span>
                        curr_map<span class="br0">[</span>visible_nums<span class="br0">[</span>i<span class="br0">]</span><span class="br0">]</span> <span class="sy0">=</span> curr_num<span class="sy0">;</span>
                        curr_num<span class="sy0">++;</span>
                    <span class="br0">}</span>
                    num_map<span class="br0">[</span>rev<span class="br0">]</span> <span class="sy0">=</span> curr_map<span class="sy0">;</span>
                <span class="br0">}</span>
            <span class="br0">}</span>
            <span class="kw1">return</span> num_map<span class="sy0">;</span>
        <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
        <span class="co1">// Prints num_map to a string</span>
        <span class="kw2">function</span> debug_print_num_map<span class="br0">(</span>num_map<span class="br0">)</span> <span class="br0">{</span>
            <span class="kw2">var</span> out <span class="sy0">=</span> <span class="st0">''</span><span class="sy0">;</span>
            <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> rev <span class="sy0">=</span> Rev.<span class="me1">FIRST</span><span class="sy0">;</span> rev <span class="sy0">!==</span> Rev.<span class="me1">LAST</span><span class="sy0">;</span> <span class="sy0">++</span>rev<span class="br0">)</span> <span class="br0">{</span>
                out <span class="sy0">+=</span> <span class="st0">'['</span> <span class="sy0">+</span> desc<span class="br0">[</span>rev<span class="br0">]</span>.<span class="me1">title</span> <span class="sy0">+</span> <span class="st0">']: { '</span><span class="sy0">;</span>
                out <span class="sy0">+=</span>  num_map<span class="br0">[</span>rev<span class="br0">]</span> <span class="sy0">+</span> <span class="st0">' }<span class="es0">\n</span>'</span><span class="sy0">;</span>
            <span class="br0">}</span>
            <span class="kw1">return</span> out<span class="sy0">;</span>
        <span class="br0">}</span>
&nbsp;
        <span class="kw2">var</span> num_map <span class="sy0">=</span> get_num_map<span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
        <span class="kw1">if</span> <span class="br0">(</span>debug<span class="br0">)</span> <span class="br0">{</span>
            <span class="kw3">alert</span><span class="br0">(</span>debug_print_defs<span class="br0">(</span>defs<span class="br0">)</span> <span class="sy0">+</span> <span class="st0">'<span class="es0">\n</span><span class="es0">\n</span>'</span> <span class="sy0">+</span>
                  debug_print_num_map<span class="br0">(</span>num_map<span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="br0">}</span>
&nbsp;
        <span class="co1">// Analyze the abstract description again and modify the DOM</span>
        <span class="kw2">function</span> clear_rev_marks<span class="br0">(</span>tr<span class="br0">)</span> <span class="br0">{</span>
            marks <span class="sy0">=</span> tr.<span class="me1">children</span><span class="br0">(</span><span class="st0">'td'</span><span class="br0">)</span>.<span class="me1">eq</span><span class="br0">(</span><span class="nu0">2</span><span class="br0">)</span>.<span class="me1">find</span><span class="br0">(</span><span class="st0">'.t-mark-rev'</span><span class="br0">)</span><span class="sy0">;</span>
            marks.<span class="me1">each</span><span class="br0">(</span><span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
                <span class="co1">// remove only one &lt;br&gt;</span>
                $<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span>.<span class="me1">prev</span><span class="br0">(</span><span class="st0">'br'</span><span class="br0">)</span>.<span class="me1">add</span><span class="br0">(</span>$<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span>.<span class="me1">next</span><span class="br0">(</span><span class="st0">'br'</span><span class="br0">)</span><span class="br0">)</span>.<span class="me1">first</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">remove</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
                $<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span>.<span class="me1">remove</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
        <span class="kw2">function</span> set_number<span class="br0">(</span>tr<span class="sy0">,</span> num<span class="br0">)</span> <span class="br0">{</span>
            tr.<span class="me1">children</span><span class="br0">(</span><span class="st0">'td'</span><span class="br0">)</span>.<span class="me1">eq</span><span class="br0">(</span><span class="nu0">1</span><span class="br0">)</span>.<span class="me1">text</span><span class="br0">(</span><span class="st0">'('</span><span class="sy0">+</span>num.<span class="me1">toString</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">+</span><span class="st0">')'</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
        <span class="kw2">function</span> get_tr_nums<span class="br0">(</span>num<span class="br0">)</span> <span class="br0">{</span>
            <span class="kw2">var</span> nums <span class="sy0">=</span> <span class="br0">[</span><span class="br0">]</span><span class="sy0">;</span>
            <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> rev <span class="sy0">=</span> Rev.<span class="me1">FIRST</span><span class="sy0">;</span> rev <span class="sy0">!==</span> Rev.<span class="me1">LAST</span><span class="sy0">;</span> <span class="sy0">++</span>rev<span class="br0">)</span> <span class="br0">{</span>
                nums<span class="br0">[</span>rev<span class="br0">]</span> <span class="sy0">=</span> num_map<span class="br0">[</span>rev<span class="br0">]</span><span class="br0">[</span>num<span class="br0">]</span><span class="sy0">;</span>
            <span class="br0">}</span>
            <span class="kw1">return</span> nums<span class="sy0">;</span>
        <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
        <span class="coMULTI">/*  Returns a visibility map that identifies whether any children of
            rev-list identified by def are shown on particular revision.
        */</span>
        <span class="kw2">function</span> any_children_visible_on_rev<span class="br0">(</span>def<span class="br0">)</span> <span class="br0">{</span>
            <span class="kw2">var</span> ret <span class="sy0">=</span> <span class="kw2">new</span> VisibilityMap<span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
            <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> i <span class="sy0">!==</span> def.<span class="me1">children</span>.<span class="me1">length</span><span class="sy0">;</span> <span class="sy0">++</span>i<span class="br0">)</span> <span class="br0">{</span>
                ret.<span class="me1">combine_or</span><span class="br0">(</span>defs<span class="br0">[</span>def.<span class="me1">children</span><span class="br0">[</span>i<span class="br0">]</span><span class="br0">]</span>.<span class="me1">revs</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="br0">}</span>
            ret.<span class="me1">remove</span><span class="br0">(</span>Rev.<span class="me1">DIFF</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="kw1">return</span> ret<span class="sy0">;</span>
        <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
        <span class="coMULTI">/** Returns information about the required copies of the base
            element.
        */</span>
        <span class="kw2">function</span> get_copy_info<span class="br0">(</span>visible<span class="sy0">,</span> nums<span class="br0">)</span> <span class="br0">{</span>
            <span class="kw2">var</span> res <span class="sy0">=</span> <span class="br0">[</span><span class="br0">]</span><span class="sy0">;</span>
&nbsp;
            <span class="kw2">var</span> base_rev<span class="sy0">;</span>   <span class="co1">// Don't create a new element if it would</span>
            <span class="kw2">var</span> new_num<span class="sy0">;</span>    <span class="co1">// be identical to previous one</span>
            <span class="kw2">var</span> new_visible<span class="sy0">;</span>
            <span class="kw2">var</span> is_first <span class="sy0">=</span> <span class="kw2">true</span><span class="sy0">;</span>
&nbsp;
            <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> rev <span class="sy0">=</span> Rev.<span class="me1">FIRST</span><span class="sy0">;</span> rev <span class="sy0">!==</span> Rev.<span class="me1">LAST</span><span class="sy0">;</span> <span class="sy0">++</span>rev<span class="br0">)</span> <span class="br0">{</span>
                <span class="kw1">if</span> <span class="br0">(</span><span class="sy0">!</span>visible.<span class="me1">is_visible_on</span><span class="br0">(</span>rev<span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
                    <span class="kw1">continue</span><span class="sy0">;</span>
                <span class="br0">}</span>
                <span class="kw1">if</span> <span class="br0">(</span><span class="sy0">!</span>is_first <span class="sy0">&amp;&amp;</span> new_num <span class="sy0">===</span> nums<span class="br0">[</span>rev<span class="br0">]</span><span class="br0">)</span> <span class="br0">{</span>
                    <span class="co1">// Identical element already exists</span>
                    new_visible.<span class="me1">add</span><span class="br0">(</span>rev<span class="br0">)</span><span class="sy0">;</span>
                    <span class="kw1">continue</span><span class="sy0">;</span>
                <span class="br0">}</span>
&nbsp;
                <span class="kw1">if</span> <span class="br0">(</span><span class="sy0">!</span>is_first<span class="br0">)</span> <span class="br0">{</span>
                    res.<span class="me1">push</span><span class="br0">(</span><span class="br0">{</span> base_rev<span class="sy0">:</span> base_rev<span class="sy0">,</span> revs<span class="sy0">:</span> new_visible<span class="sy0">,</span>
                               num<span class="sy0">:</span> new_num <span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span>
                <span class="br0">}</span>
&nbsp;
                base_rev <span class="sy0">=</span> rev<span class="sy0">;</span>
                new_num <span class="sy0">=</span> nums<span class="br0">[</span>rev<span class="br0">]</span><span class="sy0">;</span>
                new_visible <span class="sy0">=</span> <span class="kw2">new</span> VisibilityMap<span class="br0">(</span><span class="br0">[</span>rev<span class="br0">]</span><span class="br0">)</span><span class="sy0">;</span>
                is_first <span class="sy0">=</span> <span class="kw2">false</span><span class="sy0">;</span>
            <span class="br0">}</span>
            <span class="kw1">if</span> <span class="br0">(</span><span class="sy0">!</span>is_first<span class="br0">)</span> <span class="br0">{</span>
                res.<span class="me1">push</span><span class="br0">(</span><span class="br0">{</span> base_rev<span class="sy0">:</span> base_rev<span class="sy0">,</span> revs<span class="sy0">:</span> new_visible<span class="sy0">,</span>
                           num<span class="sy0">:</span> new_num <span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="br0">}</span>
            <span class="kw1">return</span> res<span class="sy0">;</span>
        <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
        <span class="kw2">function</span> finalize_tr<span class="br0">(</span>def<span class="br0">)</span> <span class="br0">{</span>
            <span class="kw2">var</span> new_el<span class="sy0">;</span>
            <span class="kw1">if</span> <span class="br0">(</span>def.<span class="me1">num</span> <span class="sy0">===</span> <span class="sy0">-</span><span class="nu0">1</span><span class="br0">)</span> <span class="br0">{</span>
                <span class="kw1">if</span> <span class="br0">(</span>def.<span class="me1">revs</span>.<span class="me1">is_visible_on</span><span class="br0">(</span>Rev.<span class="me1">DIFF</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
                    <span class="co1">// no num and no rev-marks -- shown always</span>
                    tracker.<span class="me1">add_diff_object</span><span class="br0">(</span>def.<span class="me1">obj</span><span class="sy0">,</span> def.<span class="me1">revs</span><span class="br0">)</span><span class="sy0">;</span>
                <span class="br0">}</span> <span class="kw1">else</span> <span class="br0">{</span>
                    <span class="co1">// no num -- two versions: one with rev-marks and</span>
                    <span class="co1">// one without</span>
                    new_el <span class="sy0">=</span> def.<span class="me1">obj</span>.<span class="me1">clone</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">hide</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">insertAfter</span><span class="br0">(</span>def.<span class="me1">obj</span><span class="br0">)</span><span class="sy0">;</span>
                    clear_rev_marks<span class="br0">(</span>new_el<span class="br0">)</span><span class="sy0">;</span>
                    tracker.<span class="me1">add_diff_object</span><span class="br0">(</span>def.<span class="me1">obj</span><span class="sy0">,</span> <span class="kw2">new</span> VisibilityMap<span class="br0">(</span><span class="br0">[</span>Rev.<span class="me1">DIFF</span><span class="br0">]</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
                    tracker.<span class="me1">add_object</span><span class="br0">(</span>new_el<span class="sy0">,</span> def.<span class="me1">obj</span><span class="sy0">,</span> def.<span class="me1">revs</span><span class="br0">)</span><span class="sy0">;</span>
                <span class="br0">}</span>
            <span class="br0">}</span> <span class="kw1">else</span> <span class="br0">{</span>
                <span class="co1">// need to handle numbering</span>
                <span class="kw2">var</span> nums <span class="sy0">=</span> get_tr_nums<span class="br0">(</span>def.<span class="me1">num</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
                tracker.<span class="me1">add_diff_object</span><span class="br0">(</span>def.<span class="me1">obj</span><span class="sy0">,</span> <span class="kw2">new</span> VisibilityMap<span class="br0">(</span><span class="br0">[</span>Rev.<span class="me1">DIFF</span><span class="br0">]</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
                <span class="kw2">var</span> copy_info <span class="sy0">=</span> get_copy_info<span class="br0">(</span>def.<span class="me1">revs</span><span class="sy0">,</span> nums<span class="br0">)</span><span class="sy0">;</span>
&nbsp;
                <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> copy_info.<span class="me1">length</span><span class="sy0">;</span> i<span class="sy0">++</span><span class="br0">)</span> <span class="br0">{</span>
                    new_el <span class="sy0">=</span> def.<span class="me1">obj</span>.<span class="me1">clone</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">hide</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">insertAfter</span><span class="br0">(</span>def.<span class="me1">obj</span><span class="br0">)</span><span class="sy0">;</span>
                    clear_rev_marks<span class="br0">(</span>new_el<span class="br0">)</span><span class="sy0">;</span>
                    set_number<span class="br0">(</span>new_el<span class="sy0">,</span> copy_info<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">num</span><span class="br0">)</span><span class="sy0">;</span>
                    tracker.<span class="me1">add_object</span><span class="br0">(</span>new_el<span class="sy0">,</span> def.<span class="me1">obj</span><span class="sy0">,</span> copy_info<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">revs</span><span class="br0">)</span><span class="sy0">;</span>
                <span class="br0">}</span>
            <span class="br0">}</span>
        <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
        <span class="coMULTI">/*  Roughly the same as finalize_tr, but while all modifications are
            applied to the t-dcl-rev-aux element, we hide entire tbody
            section when it has no contents or defs[i].revs.is_visible_on(rev)
            is false
        */</span>
        <span class="kw2">function</span> finalize_rev_tbody<span class="br0">(</span>def<span class="br0">)</span> <span class="br0">{</span>
            <span class="co1">// The rev-list tbody does not ever change - we only need to</span>
            <span class="co1">// hide it sometimes</span>
            <span class="kw2">var</span> tbody_visible <span class="sy0">=</span> def.<span class="me1">revs</span>.<span class="me1">clone</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
            tbody_visible.<span class="me1">combine_and</span><span class="br0">(</span>any_children_visible_on_rev<span class="br0">(</span>def<span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
            tbody_visible.<span class="me1">add</span><span class="br0">(</span>Rev.<span class="me1">DIFF</span><span class="br0">)</span><span class="sy0">;</span>
            tracker.<span class="me1">add_diff_object</span><span class="br0">(</span>def.<span class="me1">obj</span><span class="sy0">,</span> tbody_visible<span class="br0">)</span><span class="sy0">;</span>
            <span class="kw2">var</span> new_el<span class="sy0">;</span>
&nbsp;
            <span class="kw1">if</span> <span class="br0">(</span>def.<span class="me1">num</span> <span class="sy0">===</span> <span class="sy0">-</span><span class="nu0">1</span><span class="br0">)</span> <span class="br0">{</span>
                <span class="kw1">if</span> <span class="br0">(</span>def.<span class="me1">revs</span>.<span class="me1">is_visible_on</span><span class="br0">(</span>Rev.<span class="me1">DIFF</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
                    <span class="co1">// No num and no rev-marks -- no further modifications</span>
                    <span class="co1">// needed.</span>
&nbsp;
                <span class="br0">}</span> <span class="kw1">else</span> <span class="br0">{</span>
                    <span class="co1">// No num -- two versions: one with rev-marks and</span>
                    <span class="co1">// one without</span>
                    new_el <span class="sy0">=</span> def.<span class="me1">aux</span>.<span class="me1">clone</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">hide</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">insertAfter</span><span class="br0">(</span>def.<span class="me1">aux</span><span class="br0">)</span><span class="sy0">;</span>
                    clear_rev_marks<span class="br0">(</span>new_el<span class="br0">)</span><span class="sy0">;</span>
                    tracker.<span class="me1">add_diff_object</span><span class="br0">(</span>def.<span class="me1">aux</span><span class="sy0">,</span> <span class="kw2">new</span> VisibilityMap<span class="br0">(</span><span class="br0">[</span>Rev.<span class="me1">DIFF</span><span class="br0">]</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
                    <span class="kw2">var</span> aux_visible <span class="sy0">=</span> tbody_visible<span class="sy0">;</span> <span class="co1">// no need to clone</span>
                    aux_visible.<span class="me1">remove</span><span class="br0">(</span>Rev.<span class="me1">DIFF</span><span class="br0">)</span><span class="sy0">;</span>
                    tracker.<span class="me1">add_object</span><span class="br0">(</span>new_el<span class="sy0">,</span> def.<span class="me1">aux</span><span class="sy0">,</span> aux_visible<span class="br0">)</span><span class="sy0">;</span>
                <span class="br0">}</span>
            <span class="br0">}</span> <span class="kw1">else</span> <span class="br0">{</span>
                <span class="co1">// need to handle numbering</span>
                <span class="kw2">var</span> nums <span class="sy0">=</span> get_tr_nums<span class="br0">(</span>def.<span class="me1">num</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
                tracker.<span class="me1">add_diff_object</span><span class="br0">(</span>def.<span class="me1">aux</span><span class="sy0">,</span> <span class="kw2">new</span> VisibilityMap<span class="br0">(</span><span class="br0">[</span>Rev.<span class="me1">DIFF</span><span class="br0">]</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
                <span class="kw2">var</span> copy_info <span class="sy0">=</span> get_copy_info<span class="br0">(</span>def.<span class="me1">revs</span><span class="sy0">,</span> nums<span class="br0">)</span><span class="sy0">;</span>
&nbsp;
                <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> copy_info.<span class="me1">length</span><span class="sy0">;</span> i<span class="sy0">++</span><span class="br0">)</span> <span class="br0">{</span>
                    new_el <span class="sy0">=</span> def.<span class="me1">aux</span>.<span class="me1">clone</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">hide</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">insertAfter</span><span class="br0">(</span>def.<span class="me1">aux</span><span class="br0">)</span><span class="sy0">;</span>
                    clear_rev_marks<span class="br0">(</span>new_el<span class="br0">)</span><span class="sy0">;</span>
                    set_number<span class="br0">(</span>new_el<span class="sy0">,</span> copy_info<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">num</span><span class="br0">)</span><span class="sy0">;</span>
                    tracker.<span class="me1">add_object</span><span class="br0">(</span>new_el<span class="sy0">,</span> def.<span class="me1">aux</span><span class="sy0">,</span> copy_info<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">revs</span><span class="br0">)</span><span class="sy0">;</span>
                <span class="br0">}</span>
            <span class="br0">}</span>
        <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
&nbsp;
        <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> defs.<span class="me1">length</span><span class="sy0">;</span> <span class="sy0">++</span>i<span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">if</span> <span class="br0">(</span>defs<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">type</span> <span class="sy0">===</span> <span class="st0">'s'</span><span class="br0">)</span> <span class="br0">{</span>
                finalize_tr<span class="br0">(</span>defs<span class="br0">[</span>i<span class="br0">]</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="br0">}</span> <span class="kw1">else</span> <span class="br0">{</span>
                finalize_rev_tbody<span class="br0">(</span>defs<span class="br0">[</span>i<span class="br0">]</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="br0">}</span>
        <span class="br0">}</span>
&nbsp;
        <span class="kw1">return</span> num_map<span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="coMULTI">/** Renumbers and hides the list items according to the given @a num_map
    */</span>
    StandardRevisionPlugin.<span class="me1">prototype</span>.<span class="me1">prepare_all_li</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>scope<span class="sy0">,</span> num_map<span class="br0">)</span> <span class="br0">{</span>
        <span class="co1">// FIXME: currently we process only the first t-li element out of</span>
        <span class="co1">// each block of elements assigned a single num.</span>
        <span class="kw2">var</span> descs <span class="sy0">=</span> <span class="br0">[</span><span class="br0">]</span><span class="sy0">;</span>
        <span class="coMULTI">/*
           { obj: &lt;jQuery object&gt;,
             obj_num: &lt;jQuery object&gt;
             num: [&lt;num&gt;, &lt;num&gt;, ...],
           }
        */</span>
        <span class="kw2">var</span> num_regex <span class="sy0">=</span> <span class="co2">/^\s*(\d+)\s*$/</span><span class="sy0">;</span>
        <span class="kw2">var</span> range_regex <span class="sy0">=</span> <span class="co2">/^\s*(\d+)-(\d+)\s*$/</span><span class="sy0">;</span>
        scope.<span class="me1">list_items</span>.<span class="me1">each</span><span class="br0">(</span><span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw2">var</span> el_num <span class="sy0">=</span> $<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span>.<span class="me1">children</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">first</span><span class="br0">(</span><span class="st0">'.t-li'</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="kw1">if</span> <span class="br0">(</span>el_num.<span class="me1">length</span> <span class="sy0">===</span> <span class="nu0">0</span><span class="br0">)</span> <span class="br0">{</span>
                <span class="kw1">return</span><span class="sy0">;</span>
            <span class="br0">}</span>
&nbsp;
            <span class="kw2">var</span> nums <span class="sy0">=</span> <span class="br0">[</span><span class="br0">]</span><span class="sy0">;</span>
            <span class="kw2">var</span> items <span class="sy0">=</span> el_num.<span class="me1">text</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">replace</span><span class="br0">(</span><span class="st0">')'</span><span class="sy0">,</span><span class="st0">''</span><span class="br0">)</span>.<span class="me1">split</span><span class="br0">(</span><span class="st0">','</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> items.<span class="me1">length</span><span class="sy0">;</span> <span class="sy0">++</span>i<span class="br0">)</span> <span class="br0">{</span>
                <span class="kw2">var</span> match <span class="sy0">=</span> items<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">match</span><span class="br0">(</span>num_regex<span class="br0">)</span><span class="sy0">;</span>
                <span class="kw1">if</span> <span class="br0">(</span>match <span class="sy0">!==</span> <span class="kw2">null</span><span class="br0">)</span> <span class="br0">{</span>
                    nums.<span class="me1">push</span><span class="br0">(</span>parseInt<span class="br0">(</span>match<span class="br0">[</span><span class="nu0">1</span><span class="br0">]</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
                    <span class="kw1">continue</span><span class="sy0">;</span>
                <span class="br0">}</span>
                match <span class="sy0">=</span> items<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">match</span><span class="br0">(</span>range_regex<span class="br0">)</span><span class="sy0">;</span>
                <span class="kw1">if</span> <span class="br0">(</span>match <span class="sy0">!==</span> <span class="kw2">null</span><span class="br0">)</span> <span class="br0">{</span>
                    <span class="kw2">var</span> first <span class="sy0">=</span> parseInt<span class="br0">(</span>match<span class="br0">[</span><span class="nu0">1</span><span class="br0">]</span><span class="br0">)</span><span class="sy0">;</span>
                    <span class="kw2">var</span> last <span class="sy0">=</span> parseInt<span class="br0">(</span>match<span class="br0">[</span><span class="nu0">2</span><span class="br0">]</span><span class="br0">)</span><span class="sy0">;</span>
                    <span class="kw1">if</span> <span class="br0">(</span>first <span class="sy0">&gt;</span> last<span class="br0">)</span> <span class="br0">{</span>
                        <span class="kw1">continue</span><span class="sy0">;</span>
                    <span class="br0">}</span>
                    <span class="kw1">for</span> <span class="br0">(</span><span class="sy0">;</span> first <span class="sy0">&lt;=</span> last<span class="sy0">;</span> <span class="sy0">++</span>first<span class="br0">)</span> <span class="br0">{</span>
                        nums.<span class="me1">push</span><span class="br0">(</span>first<span class="br0">)</span><span class="sy0">;</span>
                    <span class="br0">}</span>
                    <span class="kw1">continue</span><span class="sy0">;</span>
                <span class="br0">}</span>
            <span class="br0">}</span>
&nbsp;
            <span class="kw1">if</span> <span class="br0">(</span>nums.<span class="me1">length</span> <span class="sy0">!=</span> <span class="nu0">0</span><span class="br0">)</span> <span class="br0">{</span>
                descs.<span class="me1">push</span><span class="br0">(</span><span class="br0">{</span> obj<span class="sy0">:</span> $<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span><span class="sy0">,</span> nums<span class="sy0">:</span> nums<span class="sy0">,</span> obj_num<span class="sy0">:</span> el_num <span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="br0">}</span>
        <span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
&nbsp;
        <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> descs.<span class="me1">length</span><span class="sy0">;</span> <span class="sy0">++</span>i<span class="br0">)</span> <span class="br0">{</span>
            <span class="kw2">var</span> nums <span class="sy0">=</span> descs<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">nums</span><span class="sy0">;</span>
&nbsp;
            <span class="co1">// get the description of what numbers to display for which</span>
            <span class="co1">// revision</span>
&nbsp;
            <span class="kw2">var</span> visible <span class="sy0">=</span> visibility_fill<span class="br0">(</span><span class="kw2">true</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
            <span class="kw2">var</span> disp_desc <span class="sy0">=</span> <span class="br0">[</span><span class="br0">]</span><span class="sy0">;</span>
            <span class="kw2">var</span> prev_nums <span class="sy0">=</span> nums<span class="sy0">;</span>
            <span class="kw2">var</span> prev_revs <span class="sy0">=</span> <span class="br0">[</span> Rev.<span class="me1">DIFF</span> <span class="br0">]</span><span class="sy0">;</span>
&nbsp;
            <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> rev <span class="sy0">=</span> Rev.<span class="me1">FIRST</span><span class="sy0">;</span> rev <span class="sy0">!==</span> Rev.<span class="me1">LAST</span><span class="sy0">;</span> <span class="sy0">++</span>rev<span class="br0">)</span> <span class="br0">{</span>
                <span class="kw2">var</span> target_nums <span class="sy0">=</span> <span class="br0">[</span><span class="br0">]</span><span class="sy0">;</span>
                <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> j <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> j <span class="sy0">&lt;</span> nums.<span class="me1">length</span><span class="sy0">;</span> <span class="sy0">++</span>j<span class="br0">)</span> <span class="br0">{</span>
                    <span class="kw1">if</span> <span class="br0">(</span>nums<span class="br0">[</span>j<span class="br0">]</span> <span class="sy0">&lt;</span> num_map<span class="br0">[</span>rev<span class="br0">]</span>.<span class="me1">length</span><span class="br0">)</span> <span class="br0">{</span>
                        <span class="kw2">var</span> target_num <span class="sy0">=</span> num_map<span class="br0">[</span>rev<span class="br0">]</span><span class="br0">[</span>nums<span class="br0">[</span>j<span class="br0">]</span><span class="br0">]</span><span class="sy0">;</span>
                        <span class="kw1">if</span> <span class="br0">(</span>target_num <span class="sy0">!==</span> <span class="sy0">-</span><span class="nu0">1</span><span class="br0">)</span> <span class="br0">{</span>
                            target_nums.<span class="me1">push</span><span class="br0">(</span>target_num<span class="br0">)</span><span class="sy0">;</span>
                        <span class="br0">}</span>
                    <span class="br0">}</span>
                <span class="br0">}</span>
&nbsp;
                <span class="kw1">if</span> <span class="br0">(</span>target_nums.<span class="me1">length</span> <span class="sy0">===</span> <span class="nu0">0</span><span class="br0">)</span> <span class="br0">{</span>
                    <span class="co1">// will hide entire t-liX element</span>
                    visible.<span class="me1">remove</span><span class="br0">(</span>rev<span class="br0">)</span><span class="sy0">;</span>
                    <span class="kw1">continue</span><span class="sy0">;</span>
                <span class="br0">}</span>
&nbsp;
                <span class="kw1">if</span> <span class="br0">(</span>array_equal<span class="br0">(</span>target_nums<span class="sy0">,</span> prev_nums<span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
                    prev_revs.<span class="me1">push</span><span class="br0">(</span>rev<span class="br0">)</span><span class="sy0">;</span>
                <span class="br0">}</span> <span class="kw1">else</span> <span class="br0">{</span>
                    disp_desc.<span class="me1">push</span><span class="br0">(</span><span class="br0">{</span> revs<span class="sy0">:</span> prev_revs<span class="sy0">,</span> nums<span class="sy0">:</span> prev_nums <span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span>
                    prev_revs <span class="sy0">=</span> <span class="br0">[</span>rev<span class="br0">]</span><span class="sy0">;</span>
                    prev_nums <span class="sy0">=</span> target_nums<span class="sy0">;</span>
                <span class="br0">}</span>
            <span class="br0">}</span>
            disp_desc.<span class="me1">push</span><span class="br0">(</span><span class="br0">{</span> revs<span class="sy0">:</span> prev_revs<span class="sy0">,</span> nums<span class="sy0">:</span> prev_nums <span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="co1">// hide entire t-liX element if needed</span>
            <span class="kw1">if</span> <span class="br0">(</span><span class="sy0">!</span>visible.<span class="me1">is_visible_on_all</span><span class="br0">(</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
                <span class="kw1">this</span>.<span class="me1">tracker</span>.<span class="me1">add_diff_object</span><span class="br0">(</span>descs<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">obj</span><span class="sy0">,</span> visible<span class="br0">)</span><span class="sy0">;</span>
            <span class="br0">}</span>
&nbsp;
            <span class="co1">// Add t-li elements with different text if needed</span>
            <span class="co1">// the first item always includes Rev.DIFF in .revs</span>
            <span class="kw1">if</span> <span class="br0">(</span>disp_desc.<span class="me1">length</span> <span class="sy0">&gt;</span> <span class="nu0">1</span><span class="br0">)</span> <span class="br0">{</span>
                <span class="kw1">this</span>.<span class="me1">tracker</span>.<span class="me1">add_diff_object</span><span class="br0">(</span>descs<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">obj_num</span><span class="sy0">,</span> <span class="kw2">new</span> VisibilityMap<span class="br0">(</span>disp_desc<span class="br0">[</span><span class="nu0">0</span><span class="br0">]</span>.<span class="me1">revs</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
                <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> j <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">;</span> j <span class="sy0">&lt;</span> disp_desc.<span class="me1">length</span><span class="sy0">;</span> <span class="sy0">++</span>j<span class="br0">)</span> <span class="br0">{</span>
                    <span class="kw2">var</span> new_el <span class="sy0">=</span> descs<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">obj_num</span>.<span class="me1">clone</span><span class="br0">(</span><span class="br0">)</span>.<span class="me1">hide</span><span class="br0">(</span><span class="br0">)</span>
                                        .<span class="me1">insertAfter</span><span class="br0">(</span>descs<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">obj_num</span><span class="br0">)</span><span class="sy0">;</span>
                    <span class="kw2">var</span> text <span class="sy0">=</span> disp_desc<span class="br0">[</span>j<span class="br0">]</span>.<span class="me1">nums</span><span class="br0">[</span><span class="nu0">0</span><span class="br0">]</span>.<span class="me1">toString</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
                    <span class="kw2">var</span> text <span class="sy0">=</span> <span class="st0">''</span><span class="sy0">;</span>
                    <span class="kw2">var</span> is_first <span class="sy0">=</span> <span class="kw2">true</span><span class="sy0">;</span>
                    <span class="kw2">var</span> range_begin <span class="sy0">=</span> disp_desc<span class="br0">[</span>j<span class="br0">]</span>.<span class="me1">nums</span><span class="br0">[</span><span class="nu0">0</span><span class="br0">]</span><span class="sy0">;</span>
                    <span class="kw2">var</span> range_end <span class="sy0">=</span> disp_desc<span class="br0">[</span>j<span class="br0">]</span>.<span class="me1">nums</span><span class="br0">[</span><span class="nu0">0</span><span class="br0">]</span><span class="sy0">;</span>
                    <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> k <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">;</span> k <span class="sy0">&lt;</span> disp_desc<span class="br0">[</span>j<span class="br0">]</span>.<span class="me1">nums</span>.<span class="me1">length</span><span class="sy0">;</span> <span class="sy0">++</span>k<span class="br0">)</span> <span class="br0">{</span>
                        <span class="kw1">if</span><span class="br0">(</span>disp_desc<span class="br0">[</span>j<span class="br0">]</span>.<span class="me1">nums</span><span class="br0">[</span>k<span class="br0">]</span> <span class="sy0">==</span> range_end <span class="sy0">+</span> <span class="nu0">1</span><span class="br0">)</span> <span class="br0">{</span>
                                range_end <span class="sy0">=</span> range_end <span class="sy0">+</span> <span class="nu0">1</span><span class="sy0">;</span>
                        <span class="br0">}</span>
                        <span class="kw1">else</span> <span class="br0">{</span>
                                <span class="kw1">if</span><span class="br0">(</span><span class="sy0">!</span>is_first<span class="br0">)</span> text <span class="sy0">=</span> text <span class="sy0">+</span> <span class="st0">','</span><span class="sy0">;</span>
                                is_first <span class="sy0">=</span> <span class="kw2">false</span><span class="sy0">;</span>
                                <span class="kw1">if</span><span class="br0">(</span>range_end <span class="sy0">==</span> range_begin<span class="br0">)</span><span class="br0">{</span>
                                        text <span class="sy0">=</span> text <span class="sy0">+</span> range_begin.<span class="me1">toString</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
                                <span class="br0">}</span>
                                <span class="kw1">else</span> <span class="br0">{</span>
                                        text <span class="sy0">=</span> text <span class="sy0">+</span> range_begin.<span class="me1">toString</span><span class="br0">(</span><span class="br0">)</span> <span class="sy0">+</span> <span class="st0">'-'</span> <span class="sy0">+</span> range_end.<span class="me1">toString</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
                                <span class="br0">}</span>
                                range_begin <span class="sy0">=</span> range_end <span class="sy0">=</span> disp_desc<span class="br0">[</span>j<span class="br0">]</span>.<span class="me1">nums</span><span class="br0">[</span>k<span class="br0">]</span><span class="sy0">;</span>
                        <span class="br0">}</span>
                    <span class="br0">}</span>
                    <span class="co1">// process last element</span>
                    <span class="kw1">if</span><span class="br0">(</span><span class="sy0">!</span>is_first<span class="br0">)</span> text <span class="sy0">=</span> text <span class="sy0">+</span> <span class="st0">','</span><span class="sy0">;</span>
                    <span class="kw1">if</span><span class="br0">(</span>range_end <span class="sy0">==</span> range_begin<span class="br0">)</span><span class="br0">{</span>
                        text <span class="sy0">=</span> text <span class="sy0">+</span> range_begin.<span class="me1">toString</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
                    <span class="br0">}</span>
                    <span class="kw1">else</span> <span class="br0">{</span>
                        text <span class="sy0">=</span> text <span class="sy0">+</span> range_begin.<span class="me1">toString</span><span class="br0">(</span><span class="br0">)</span> <span class="sy0">+</span> <span class="st0">'-'</span> <span class="sy0">+</span> range_end.<span class="me1">toString</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
                    <span class="br0">}</span>
                    new_el.<span class="me1">text</span><span class="br0">(</span>text <span class="sy0">+</span> <span class="st0">')'</span><span class="br0">)</span><span class="sy0">;</span>
                    <span class="kw1">this</span>.<span class="me1">tracker</span>.<span class="me1">add_object</span><span class="br0">(</span>new_el<span class="sy0">,</span> descs<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">obj_num</span><span class="sy0">,</span> <span class="kw2">new</span> VisibilityMap<span class="br0">(</span>disp_desc<span class="br0">[</span>j<span class="br0">]</span>.<span class="me1">revs</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
                <span class="br0">}</span>
            <span class="br0">}</span>
        <span class="br0">}</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="co1">// An utility function that calls fun on all known scopes</span>
    StandardRevisionPlugin.<span class="me1">prototype</span>.<span class="me1">for_all_scopes</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>fun<span class="br0">)</span> <span class="br0">{</span>
        fun.<span class="me1">call</span><span class="br0">(</span><span class="kw1">this</span>.<span class="me1">root_scope</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> <span class="kw1">this</span>.<span class="me1">child_scopes</span>.<span class="me1">length</span><span class="sy0">;</span> <span class="sy0">++</span>i<span class="br0">)</span> <span class="br0">{</span>
            fun.<span class="me1">call</span><span class="br0">(</span><span class="kw1">this</span>.<span class="me1">child_scopes</span><span class="br0">[</span>i<span class="br0">]</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="br0">}</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="coMULTI">/*  An utility function that gathers information about visible objects and
        pushes it to various internal trackers. New DOM objects may be created
        and others deleted, but the visual appearance should not change.
    */</span>
    StandardRevisionPlugin.<span class="me1">prototype</span>.<span class="me1">prepare</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
        <span class="kw1">if</span> <span class="br0">(</span><span class="kw1">this</span>.<span class="me1">is_prepared</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">return</span><span class="sy0">;</span>
        <span class="br0">}</span>
&nbsp;
        <span class="co1">// initialize scopes</span>
        <span class="kw1">this</span>.<span class="me1">root_scope</span> <span class="sy0">=</span> Scope.<span class="me1">create_root</span><span class="br0">(</span>$<span class="br0">(</span><span class="st0">'#mw-content-text'</span><span class="br0">)</span>.<span class="me1">first</span><span class="br0">(</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="kw1">this</span>.<span class="me1">child_scopes</span> <span class="sy0">=</span> <span class="br0">[</span><span class="br0">]</span><span class="sy0">;</span>
&nbsp;
        <span class="kw2">var</span> self <span class="sy0">=</span> <span class="kw1">this</span><span class="sy0">;</span>
        <span class="kw1">this</span>.<span class="me1">root_scope</span>.<span class="me1">root</span>.<span class="me1">find</span><span class="br0">(</span><span class="st0">'.t-member'</span><span class="br0">)</span>.<span class="me1">each</span><span class="br0">(</span><span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
            self.<span class="me1">child_scopes</span>.<span class="me1">push</span><span class="br0">(</span>Scope.<span class="me1">create_child</span><span class="br0">(</span>self.<span class="me1">root_scope</span><span class="sy0">,</span> $<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
        <span class="co1">// prepare scopes</span>
        <span class="kw1">this</span>.<span class="me1">for_all_scopes</span><span class="br0">(</span><span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
&nbsp;
            <span class="kw2">var</span> scope <span class="sy0">=</span> <span class="kw1">this</span><span class="sy0">;</span>
            self.<span class="me1">prepare_navbar</span><span class="br0">(</span>scope<span class="br0">)</span><span class="sy0">;</span>
            self.<span class="me1">prepare_all_revs</span><span class="br0">(</span>scope<span class="br0">)</span><span class="sy0">;</span>
            self.<span class="me1">prepare_all_inl_revs</span><span class="br0">(</span>scope<span class="br0">)</span><span class="sy0">;</span>
            self.<span class="me1">prepare_all_dscs</span><span class="br0">(</span>scope<span class="br0">)</span><span class="sy0">;</span>
&nbsp;
            <span class="kw1">if</span> <span class="br0">(</span>scope.<span class="me1">dcl_tables</span>.<span class="me1">length</span> <span class="sy0">&gt;</span> <span class="nu0">0</span><span class="br0">)</span> <span class="br0">{</span>
                <span class="kw2">var</span> num_map <span class="sy0">=</span> self.<span class="me1">prepare_all_dcls</span><span class="br0">(</span>scope.<span class="me1">dcl_tables</span>.<span class="me1">first</span><span class="br0">(</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
                self.<span class="me1">prepare_all_li</span><span class="br0">(</span>scope<span class="sy0">,</span> num_map<span class="br0">)</span><span class="sy0">;</span>
            <span class="br0">}</span>
&nbsp;
        <span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
        <span class="kw1">this</span>.<span class="me1">is_prepared</span> <span class="sy0">=</span> <span class="kw2">true</span><span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="coMULTI">/** Utility function. Takes an jQuery object containing an array of
        elements that may or may not contain revision marker.
        Returns an a list of revisions for which a the node should be copied
        and for which revisions each of the copy would be shown. The result
        is an associative array: key identifies the revision to build the
        DOM for; the value is visibility map.
    */</span>
    StandardRevisionPlugin.<span class="me1">prototype</span>.<span class="me1">get_revision_map</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>lines<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw2">var</span> res <span class="sy0">=</span> <span class="br0">[</span><span class="br0">]</span><span class="sy0">;</span>
        res<span class="br0">[</span>Rev.<span class="me1">DIFF</span><span class="br0">]</span> <span class="sy0">=</span> <span class="kw2">new</span> VisibilityMap<span class="br0">(</span><span class="br0">[</span>Rev.<span class="me1">DIFF</span><span class="br0">]</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
        <span class="kw2">var</span> visible_by_line <span class="sy0">=</span> <span class="br0">[</span><span class="br0">]</span><span class="sy0">;</span>
&nbsp;
        <span class="co1">// create separate elements when diff has rev marks</span>
        <span class="kw2">var</span> is_diff_clean <span class="sy0">=</span> <span class="kw2">true</span><span class="sy0">;</span>
&nbsp;
        lines.<span class="me1">each</span><span class="br0">(</span><span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw2">var</span> rev_mark <span class="sy0">=</span> $<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span>.<span class="me1">find</span><span class="br0">(</span><span class="st0">'.t-mark-rev'</span><span class="br0">)</span>.<span class="me1">first</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
            visible_by_line.<span class="me1">push</span><span class="br0">(</span>get_visibility_map<span class="br0">(</span>rev_mark<span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="kw1">if</span> <span class="br0">(</span>rev_mark.<span class="me1">length</span> <span class="sy0">&gt;</span> <span class="nu0">0</span><span class="br0">)</span> <span class="br0">{</span>
                is_diff_clean <span class="sy0">=</span> <span class="kw2">false</span><span class="sy0">;</span>
            <span class="br0">}</span>
        <span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
        <span class="co1">// Track the lines shown in the previous revision. If the same lines</span>
        <span class="co1">// are shown in the current revision, simply display the element</span>
        <span class="co1">// of the previous revision, instead of creating a new one.</span>
        <span class="kw2">var</span> prev_rev <span class="sy0">=</span> Rev.<span class="me1">DIFF</span><span class="sy0">;</span>
        <span class="kw2">var</span> prev_visible <span class="sy0">=</span> <span class="br0">[</span><span class="br0">]</span><span class="sy0">;</span>
        <span class="kw2">var</span> i<span class="sy0">;</span>
&nbsp;
        <span class="kw1">if</span> <span class="br0">(</span>is_diff_clean<span class="br0">)</span> <span class="br0">{</span>
            <span class="co1">// in case the Rev.DIFF version does not contain rev marks, then</span>
            <span class="co1">// we can reuse the objects for other revisions. Rev.DIFF version</span>
            <span class="co1">// is fully visible, so reflect that in the prev_visible array.</span>
            <span class="kw1">for</span> <span class="br0">(</span>i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> visible_by_line.<span class="me1">length</span><span class="sy0">;</span> i<span class="sy0">++</span><span class="br0">)</span> <span class="br0">{</span>
                prev_visible.<span class="me1">push</span><span class="br0">(</span>i<span class="br0">)</span><span class="sy0">;</span>
            <span class="br0">}</span>
        <span class="br0">}</span>
&nbsp;
        <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> rev <span class="sy0">=</span> Rev.<span class="me1">FIRST</span><span class="sy0">;</span> rev <span class="sy0">&lt;</span> Rev.<span class="me1">LAST</span><span class="sy0">;</span> <span class="sy0">++</span>rev<span class="br0">)</span> <span class="br0">{</span>
            res<span class="br0">[</span>rev<span class="br0">]</span> <span class="sy0">=</span> <span class="kw2">new</span> VisibilityMap<span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
            <span class="kw2">var</span> curr_visible <span class="sy0">=</span> <span class="br0">[</span><span class="br0">]</span><span class="sy0">;</span>
            <span class="kw1">for</span> <span class="br0">(</span>i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> visible_by_line.<span class="me1">length</span><span class="sy0">;</span> i<span class="sy0">++</span><span class="br0">)</span> <span class="br0">{</span>
                <span class="kw1">if</span> <span class="br0">(</span>visible_by_line<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">is_visible_on</span><span class="br0">(</span>rev<span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
                    curr_visible.<span class="me1">push</span><span class="br0">(</span>i<span class="br0">)</span><span class="sy0">;</span>
                <span class="br0">}</span>
            <span class="br0">}</span>
&nbsp;
            <span class="kw1">if</span> <span class="br0">(</span>curr_visible.<span class="me1">length</span> <span class="sy0">===</span> <span class="nu0">0</span><span class="br0">)</span> <span class="br0">{</span>
                <span class="kw1">continue</span><span class="sy0">;</span>
            <span class="br0">}</span>
&nbsp;
            <span class="co1">// Maybe nothing has changed from the previous revision and we</span>
            <span class="co1">// can simply keep the node created for the previous revision</span>
            <span class="kw1">if</span> <span class="br0">(</span>array_equal<span class="br0">(</span>curr_visible<span class="sy0">,</span> prev_visible<span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
                res<span class="br0">[</span>prev_rev<span class="br0">]</span>.<span class="me1">add</span><span class="br0">(</span>rev<span class="br0">)</span><span class="sy0">;</span>
            <span class="br0">}</span> <span class="kw1">else</span> <span class="br0">{</span>
                res<span class="br0">[</span>rev<span class="br0">]</span>.<span class="me1">add</span><span class="br0">(</span>rev<span class="br0">)</span><span class="sy0">;</span>
                prev_visible <span class="sy0">=</span> curr_visible<span class="sy0">;</span>
                prev_rev <span class="sy0">=</span> rev<span class="sy0">;</span>
            <span class="br0">}</span>
        <span class="br0">}</span>
&nbsp;
        <span class="kw1">return</span> res<span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="coMULTI">/** Utility function. Takes a revision map as returned by
        get_revision_map and produces a visibility map from that.
    */</span>
    StandardRevisionPlugin.<span class="me1">prototype</span>.<span class="me1">revision_map_to_visibility</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>revs<span class="br0">)</span> <span class="br0">{</span>
        <span class="kw2">var</span> visible <span class="sy0">=</span> <span class="kw2">new</span> VisibilityMap<span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> revs.<span class="me1">length</span><span class="sy0">;</span> <span class="sy0">++</span>i<span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> j <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> j <span class="sy0">&lt;</span> revs<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">length</span><span class="sy0">;</span> <span class="sy0">++</span>j<span class="br0">)</span> <span class="br0">{</span>
                visible.<span class="me1">add</span><span class="br0">(</span>revs<span class="br0">[</span>i<span class="br0">]</span><span class="br0">[</span>j<span class="br0">]</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="br0">}</span>
        <span class="br0">}</span>
        <span class="kw1">return</span> visible<span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="coMULTI">/** Utility function. Deletes lines from multi-line links (such as these
        in dsc tables) that have marks nearby.
        Returns true if no lines are left. @a titles and @a marks must both
        refer to the children of .t-lines elements.
     */</span>
    StandardRevisionPlugin.<span class="me1">prototype</span>.<span class="me1">delete_lines</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span>titles<span class="sy0">,</span> marks<span class="sy0">,</span> rev<span class="br0">)</span> <span class="br0">{</span>
        <span class="co1">// Delete the lines</span>
        <span class="kw2">var</span> num_deleted <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>
        <span class="kw2">var</span> num_total <span class="sy0">=</span> titles.<span class="me1">length</span><span class="sy0">;</span>
&nbsp;
        marks.<span class="me1">each</span><span class="br0">(</span><span class="kw2">function</span><span class="br0">(</span>index<span class="br0">)</span> <span class="br0">{</span>
            <span class="kw2">var</span> mark_span <span class="sy0">=</span> $<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span>.<span class="me1">children</span><span class="br0">(</span><span class="st0">'.t-mark-rev'</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="kw1">if</span> <span class="br0">(</span>mark_span.<span class="me1">length</span> <span class="sy0">&gt;</span> <span class="nu0">0</span><span class="br0">)</span> <span class="br0">{</span>
                <span class="kw2">var</span> mark <span class="sy0">=</span> get_mark<span class="br0">(</span>mark_span.<span class="me1">first</span><span class="br0">(</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
                <span class="kw1">if</span> <span class="br0">(</span><span class="sy0">!</span>should_be_shown<span class="br0">(</span>rev<span class="sy0">,</span> mark<span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
                    titles.<span class="me1">eq</span><span class="br0">(</span>index<span class="br0">)</span>.<span class="me1">remove</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
                    $<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span>.<span class="me1">remove</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
                    num_deleted<span class="sy0">++;</span>
                    <span class="kw1">return</span><span class="sy0">;</span>
                <span class="br0">}</span>
            <span class="br0">}</span>
            mark_span.<span class="me1">remove</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span> <span class="co1">// delete marks in any case</span>
        <span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
        <span class="co1">// Delete this if empty</span>
        <span class="kw1">return</span> <span class="br0">(</span>num_deleted <span class="sy0">===</span> num_total<span class="br0">)</span><span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="coMULTI">/** Creates the standard revision selection menu in the page and registers
        on_selection_change to be called whenever the selection changes.
    */</span>
    StandardRevisionPlugin.<span class="me1">prototype</span>.<span class="me1">create_selection_box</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
        <span class="kw2">var</span> head_parent<span class="sy0">;</span>
        <span class="kw1">switch</span> <span class="br0">(</span>mw.<span class="me1">config</span>.<span class="me1">get</span><span class="br0">(</span><span class="st0">'skin'</span><span class="br0">)</span><span class="br0">)</span> <span class="br0">{</span>
                <span class="kw1">case</span> <span class="st0">'cppreference'</span><span class="sy0">:</span>
                <span class="kw1">case</span> <span class="st0">'cppreference2'</span><span class="sy0">:</span> head_parent <span class="sy0">=</span> $<span class="br0">(</span><span class="st0">'#cpp-head-tools-right'</span><span class="br0">)</span><span class="sy0">;</span> <span class="kw1">break</span><span class="sy0">;</span>
                <span class="kw1">case</span> <span class="st0">'vector'</span><span class="sy0">:</span> head_parent <span class="sy0">=</span> $<span class="br0">(</span><span class="st0">'#right-navigation'</span><span class="br0">)</span><span class="sy0">;</span> <span class="kw1">break</span><span class="sy0">;</span>
                <span class="kw2">default</span><span class="sy0">:</span> <span class="kw1">return</span><span class="sy0">;</span>
        <span class="br0">}</span>
        <span class="kw1">this</span>.<span class="me1">select_div</span> <span class="sy0">=</span> $<span class="br0">(</span><span class="st0">'&lt;div/&gt;'</span><span class="br0">)</span>.<span class="me1">addClass</span><span class="br0">(</span><span class="st0">'stdrev-select'</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
        <span class="kw2">var</span> inner_div <span class="sy0">=</span> $<span class="br0">(</span><span class="st0">'&lt;div/&gt;'</span><span class="br0">)</span>.<span class="me1">appendTo</span><span class="br0">(</span><span class="kw1">this</span>.<span class="me1">select_div</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="kw2">var</span> span <span class="sy0">=</span> $<span class="br0">(</span><span class="st0">'&lt;span/&gt;'</span><span class="br0">)</span>.<span class="me1">addClass</span><span class="br0">(</span><span class="st0">'stdrev-text'</span><span class="br0">)</span>
                               .<span class="me1">text</span><span class="br0">(</span><span class="st0">'Standard revision: '</span><span class="br0">)</span>
                               .<span class="me1">appendTo</span><span class="br0">(</span>inner_div<span class="br0">)</span><span class="sy0">;</span>
        <span class="kw1">this</span>.<span class="me1">select</span> <span class="sy0">=</span> $<span class="br0">(</span><span class="st0">'&lt;select/&gt;'</span><span class="br0">)</span>.<span class="me1">appendTo</span><span class="br0">(</span>inner_div<span class="br0">)</span><span class="sy0">;</span>
&nbsp;
        <span class="kw1">for</span> <span class="br0">(</span><span class="kw2">var</span> i <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span> i <span class="sy0">&lt;</span> desc.<span class="me1">length</span><span class="sy0">;</span> <span class="sy0">++</span>i<span class="br0">)</span> <span class="br0">{</span>
            $<span class="br0">(</span><span class="st0">'&lt;option/&gt;'</span><span class="br0">)</span>.<span class="me1">text</span><span class="br0">(</span>desc<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">title</span><span class="br0">)</span>
                          .<span class="me1">attr</span><span class="br0">(</span><span class="st0">'value'</span><span class="sy0">,</span> desc<span class="br0">[</span>i<span class="br0">]</span>.<span class="me1">rev</span>.<span class="me1">toString</span><span class="br0">(</span><span class="br0">)</span><span class="br0">)</span>
                          .<span class="me1">appendTo</span><span class="br0">(</span><span class="kw1">this</span>.<span class="me1">select</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="br0">}</span>
&nbsp;
        <span class="kw1">this</span>.<span class="me1">select</span>.<span class="me1">one</span><span class="br0">(</span><span class="st0">'mouseover'</span><span class="sy0">,</span> <span class="kw1">this</span>.<span class="me1">prepare</span>.<span class="me1">bind</span><span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="kw1">this</span>.<span class="me1">select</span>.<span class="me1">change</span><span class="br0">(</span><span class="kw1">this</span>.<span class="me1">on_selection_change</span>.<span class="me1">bind</span><span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="kw1">this</span>.<span class="me1">select_div</span>.<span class="me1">prependTo</span><span class="br0">(</span>head_parent<span class="br0">)</span><span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="coMULTI">/** This function is called whenever the user changes the option selected
        in the selection box. The implementation hides the items that shouldn't
        be visible and reveals those that no longer need to be hidden (if any).
    */</span>
    StandardRevisionPlugin.<span class="me1">prototype</span>.<span class="me1">on_selection_change</span> <span class="sy0">=</span> <span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
        <span class="kw1">this</span>.<span class="me1">prepare</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="kw2">var</span> rev <span class="sy0">=</span> parseInt<span class="br0">(</span><span class="kw1">this</span>.<span class="me1">select</span>.<span class="me1">val</span><span class="br0">(</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="kw1">this</span>.<span class="me1">tracker</span>.<span class="me1">to_rev</span><span class="br0">(</span>rev<span class="br0">)</span><span class="sy0">;</span>
&nbsp;
        <span class="co1">// special treatment for rev boxes</span>
        <span class="kw1">if</span> <span class="br0">(</span><span class="kw1">this</span>.<span class="me1">curr_rev</span> <span class="sy0">===</span> Rev.<span class="me1">DIFF</span> <span class="sy0">&amp;&amp;</span> rev <span class="sy0">!==</span> Rev.<span class="me1">DIFF</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">this</span>.<span class="me1">for_all_scopes</span><span class="br0">(</span><span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
                <span class="kw1">this</span>.<span class="me1">rev_tables</span>.<span class="me1">each</span><span class="br0">(</span><span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
                    $<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span>.<span class="me1">addClass</span><span class="br0">(</span><span class="st0">'stdrev-rev-hide'</span><span class="br0">)</span><span class="sy0">;</span>
                <span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="br0">}</span>
        <span class="kw1">if</span> <span class="br0">(</span><span class="kw1">this</span>.<span class="me1">curr_rev</span> <span class="sy0">!==</span> Rev.<span class="me1">DIFF</span> <span class="sy0">&amp;&amp;</span> rev <span class="sy0">===</span> Rev.<span class="me1">DIFF</span><span class="br0">)</span> <span class="br0">{</span>
            <span class="kw1">this</span>.<span class="me1">for_all_scopes</span><span class="br0">(</span><span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
                <span class="kw1">this</span>.<span class="me1">rev_tables</span>.<span class="me1">each</span><span class="br0">(</span><span class="kw2">function</span><span class="br0">(</span><span class="br0">)</span> <span class="br0">{</span>
                    $<span class="br0">(</span><span class="kw1">this</span><span class="br0">)</span>.<span class="me1">removeClass</span><span class="br0">(</span><span class="st0">'stdrev-rev-hide'</span><span class="br0">)</span><span class="sy0">;</span>
                <span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span>
            <span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span>
        <span class="br0">}</span>
&nbsp;
        <span class="kw1">this</span>.<span class="me1">curr_rev</span> <span class="sy0">=</span> rev<span class="sy0">;</span>
    <span class="br0">}</span><span class="sy0">;</span>
&nbsp;
    <span class="kw2">var</span> plugin <span class="sy0">=</span> <span class="kw2">new</span> StandardRevisionPlugin<span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
    plugin.<span class="me1">create_selection_box</span><span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
&nbsp;
<span class="br0">}</span><span class="br0">)</span><span class="sy0">;</span></pre></div></div>                    <!-- /bodycontent -->
                                        <!-- printfooter -->
                    <div class="printfooter">
                    Retrieved from "<a href="https://en.cppreference.com/mwiki/index.php?title=MediaWiki:Gadget-standard_revisions.js&amp;oldid=134736">https://en.cppreference.com/mwiki/index.php?title=MediaWiki:Gadget-standard_revisions.js&amp;oldid=134736</a>"                    </div>
                    <!-- /printfooter -->
                                                            <!-- catlinks -->
                    <div id="catlinks" class="catlinks catlinks-allhidden"></div>                    <!-- /catlinks -->
                                                            <div class="visualClear"></div>
                    <!-- debughtml -->
                                        <!-- /debughtml -->
                </div>
                <!-- /bodyContent -->
            </div>
        </div>
        <!-- /content -->
        <!-- footer -->
        <div id="cpp-footer-base" class="noprint">
            <div id="footer">
                        <div id="cpp-navigation">
            <h5>Navigation</h5>
            <ul>
<li id="n-Support-us"><a href="http://www.cppreference.com/support" rel="nofollow">Support us</a></li><li id="n-recentchanges"><a href="https://en.cppreference.com/w/Special:RecentChanges" title="A list of recent changes in the wiki [r]" accesskey="r">Recent changes</a></li><li id="n-FAQ"><a href="https://en.cppreference.com/w/Cppreference:FAQ">FAQ</a></li><li id="n-Offline-version"><a href="https://en.cppreference.com/w/Cppreference:Archives">Offline version</a></li>            </ul>
        </div>
                        <div id="cpp-toolbox">
            <h5><span>Toolbox</span><a href="#"></a></h5>
            <ul>
<li id="t-whatlinkshere"><a href="./Special:WhatLinksHere/MediaWiki:Gadget-standard_revisions.js" title="A list of all wiki pages that link here [j]" accesskey="j">What links here</a></li><li id="t-recentchangeslinked"><a href="./Special:RecentChangesLinked/MediaWiki:Gadget-standard_revisions.js" title="Recent changes in pages linked from this page [k]" accesskey="k">Related changes</a></li><li id="t-upload"><a href="http://upload.cppreference.com/w/Special:Upload" title="Upload files [u]" accesskey="u">Upload file</a></li><li id="t-specialpages"><a href="https://en.cppreference.com/w/Special:SpecialPages" title="A list of all special pages [q]" accesskey="q">Special pages</a></li><li id="t-print"><a href="https://en.cppreference.com/mwiki/index.php?title=MediaWiki:Gadget-standard_revisions.js&amp;printable=yes" rel="alternate" title="Printable version of this page [p]" accesskey="p">Printable version</a></li><li id="t-permalink"><a href="https://en.cppreference.com/mwiki/index.php?title=MediaWiki:Gadget-standard_revisions.js&amp;oldid=134736" title="Permanent link to this revision of the page">Permanent link</a></li><li id="t-info"><a href="https://en.cppreference.com/mwiki/index.php?title=MediaWiki:Gadget-standard_revisions.js&amp;action=info">Page information</a></li>            </ul>
        </div>
                            <ul id="footer-info">
                                    <li id="footer-info-lastmod"> This page was last modified on 21 October 2021, at 18:51.</li>
                                    <li id="footer-info-viewcount">This page has been accessed 2,060 times.</li>
                            </ul>
                    <ul id="footer-places">
                                    <li id="footer-places-privacy"><a href="https://en.cppreference.com/w/Cppreference:Privacy_policy" title="Cppreference:Privacy policy">Privacy policy</a></li>
                                    <li id="footer-places-about"><a href="https://en.cppreference.com/w/Cppreference:About" title="Cppreference:About">About cppreference.com</a></li>
                                    <li id="footer-places-disclaimer"><a href="https://en.cppreference.com/w/Cppreference:General_disclaimer" title="Cppreference:General disclaimer">Disclaimers</a></li>
                            </ul>
                                    <ul id="footer-icons" class="noprint">
                                    <li id="footer-poweredbyico">
                                            <a href="https://www.mediawiki.org/"><img src="../mwiki/skins/common/images/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" width="88" height="31"></a>                                            <a href="http://qbnz.com/highlighter/"><img src="../../upload.cppreference.com/mwiki/images/2/2b/powered_by_geshi_88x31.png" alt="Powered by GeSHi" height="31" width="88"></a>                                            <a href="http://www.tigertech.net/referral/cppreference.com"><img src="../../upload.cppreference.com/mwiki/images/9/94/powered_by_tigertech_88x31.png" alt="Hosted by Tiger Technologies" height="31" width="88"></a>                                        </li>
                                </ul>
                        <div style="clear:both">
            </div>
            </div>
        </div>
        <!-- /footer -->
        



<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-2828341-1']);
_gaq.push(['_setDomainName', 'cppreference.com']);
_gaq.push(['_trackPageview']);
</script><!-- Served in 0.161 secs. -->
	
<!-- Cached 20211022115210 -->

</body></html>